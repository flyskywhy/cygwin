<html lang="en">
<head><link type="text/css" rel="stylesheet" href="texinfo.css" />
<title>monotone documentation</title>
<meta http-equiv="Content-Type" content="text/html">
<meta name="description" content="monotone documentation">
<meta name="generator" content="makeinfo 4.11">
<link title="Top" rel="top" href="#Top">
<link href="http://www.gnu.org/software/texinfo/" rel="generator-home" title="Texinfo Homepage">
<meta http-equiv="Content-Style-Type" content="text/css">
<style type="text/css"><!--
  pre.display { font-family:inherit }
  pre.format  { font-family:inherit }
  pre.smalldisplay { font-family:inherit; font-size:smaller }
  pre.smallformat  { font-family:inherit; font-size:smaller }
  pre.smallexample { font-size:smaller }
  pre.smalllisp    { font-size:smaller }
  span.sc    { font-variant:small-caps }
  span.roman { font-family:serif; font-weight:normal; } 
  span.sansserif { font-family:sans-serif; font-weight:normal; } 
--></style>
</head>
<body>
<h1 class="settitle">monotone documentation</h1>
<a name="Top"></a>

<h2 class="unnumbered">Top</h2>

<p>Monotone is a distributed version control tool. It can help automate
many tedious and error-prone tasks in group software development.
     <ul>
<li>Store multiple versions of files you are working on efficiently. 
<li>Transmit changes to files between you and your colleagues. 
<li>Merge changes you make with those your colleagues make. 
<li>Make notes about your opinion of the quality of versions of files. 
<li>Make decisions about using or ignoring versions, depending on the notes
you receive from others. 
</ul>

   <p>Please be aware that monotone is a slightly unorthodox version control
tool, and many of its concepts are similar &mdash; but subtly or
significantly different &mdash; from concepts with similar names in other
version control tools.

   <p>Complete table of contents

   <div class="contents">
<h2>Table of Contents</h2>
<ul>
<li><a name="toc_Top" href="#Top">Top</a>
<li><a name="toc_Concepts" href="#Concepts">1 Concepts</a>
<ul>
<li><a href="#Versions-of-files">1.1 Versions of files</a>
<li><a href="#Versions-of-trees">1.2 Versions of trees</a>
<li><a href="#Historical-records">1.3 Historical records</a>
<li><a href="#Certificates">1.4 Certificates</a>
<li><a href="#Storage-and-workflow">1.5 Storage and workflow</a>
<li><a href="#Forks-and-merges">1.6 Forks and merges</a>
<li><a href="#Branches">1.7 Branches</a>
<ul>
<li><a href="#Branches">1.7.1 Branch Names</a>
</li></ul>
</li></ul>
<li><a name="toc_Tutorial" href="#Tutorial">2 Tutorial</a>
<ul>
<li><a href="#Tutorial">2.1 Issues</a>
<ul>
<li><a href="#Tutorial">2.1.1 Standard Options</a>
<li><a href="#Tutorial">2.1.2 Revision Selectors</a>
</li></ul>
<li><a href="#Tutorial">2.2 The Fictional Project</a>
<li><a href="#Creating-a-Database">2.3 Creating a Database</a>
<li><a href="#Generating-Keys">2.4 Generating Keys</a>
<li><a href="#Starting-a-New-Project">2.5 Starting a New Project</a>
<li><a href="#Adding-Files">2.6 Adding Files</a>
<li><a href="#Committing-Work">2.7 Committing Work</a>
<li><a href="#Basic-Network-Service">2.8 Basic Network Service</a>
<li><a href="#Synchronising-Databases">2.9 Synchronising Databases</a>
<li><a href="#Making-Changes">2.10 Making Changes</a>
<li><a href="#Dealing-with-a-Fork">2.11 Dealing with a Fork</a>
<li><a href="#Branching-and-Merging">2.12 Branching and Merging</a>
<li><a href="#Network-Service-Revisited">2.13 Network Service Revisited</a>
</li></ul>
<li><a name="toc_Advanced-Uses" href="#Advanced-Uses">3 Advanced Uses</a>
<ul>
<li><a href="#Other-Transports">3.1 Other Transports</a>
<li><a href="#Selectors">3.2 Selectors</a>
<li><a href="#Restrictions">3.3 Restrictions</a>
<li><a href="#Scripting">3.4 Scripting</a>
<li><a href="#Inodeprints">3.5 Inodeprints</a>
<li><a href="#Merge-Conflicts">3.6 Merge Conflicts</a>
<ul>
<li><a href="#Merge-Conflicts">3.6.1 Conflict Types</a>
<li><a href="#Merge-Conflicts">3.6.2 Conflict Resolution</a>
</li></ul>
<li><a href="#Workspace-Collisions">3.7 Workspace Collisions</a>
<li><a href="#Quality-Assurance">3.8 Quality Assurance</a>
<li><a href="#Vars">3.9 Vars</a>
<li><a href="#Reserved-Files">3.10 Reserved Files</a>
<li><a href="#Reserved-Certs">3.11 Reserved Certs</a>
<li><a href="#Naming-Conventions">3.12 Naming Conventions</a>
<li><a href="#File-Attributes">3.13 File Attributes</a>
<li><a href="#Merging">3.14 Merging</a>
<li><a href="#Migrating-and-Dumping">3.15 Migrating and Dumping</a>
<li><a href="#Importing-from-CVS">3.16 Importing from CVS</a>
<li><a href="#Using-packets">3.17 Using packets</a>
</li></ul>
<li><a name="toc_CVS-Phrasebook" href="#CVS-Phrasebook">4 CVS Phrasebook</a>
<li><a name="toc_Command-Reference" href="#Command-Reference">5 Command Reference</a>
<ul>
<li><a href="#Tree">5.1 Tree</a>
<li><a href="#Workspace">5.2 Workspace</a>
<li><a href="#Network">5.3 Network</a>
<li><a href="#Informative">5.4 Informative</a>
<li><a href="#Key-and-Cert-Trust">5.5 Key and Cert Trust</a>
<li><a href="#Certificate">5.6 Certificate</a>
<li><a href="#Packet-I_002fO">5.7 Packet I/O</a>
<li><a href="#Database">5.8 Database</a>
<li><a href="#Automation">5.9 Automation</a>
<li><a href="#RCS">5.10 RCS</a>
</li></ul>
<li><a name="toc_Hook-Reference" href="#Hook-Reference">6 Hook Reference</a>
<ul>
<li><a href="#Hooks">6.1 Hooks</a>
<ul>
<li><a href="#Hooks">6.1.1 Event Notifications and Triggers</a>
<li><a href="#Hooks">6.1.2 User Defaults</a>
<li><a href="#Hooks">6.1.3 Netsync Permission Hooks</a>
<li><a href="#Hooks">6.1.4 Netsync Transport Hooks</a>
<li><a href="#Hooks">6.1.5 Trust Evaluation Hooks</a>
<li><a href="#Hooks">6.1.6 External Diff Tools</a>
<li><a href="#Hooks">6.1.7 External Merge Tools</a>
<li><a href="#Hooks">6.1.8 Selector Expansion</a>
<li><a href="#Hooks">6.1.9 Attribute Handling</a>
<li><a href="#Hooks">6.1.10 Validation Hooks</a>
</li></ul>
<li><a href="#Additional-Lua-Functions">6.2 Additional Lua Functions</a>
</li></ul>
<li><a name="toc_Special-Topics" href="#Special-Topics">7 Special Topics</a>
<ul>
<li><a href="#Internationalization">7.1 Internationalization</a>
<li><a href="#Hash-Integrity">7.2 Hash Integrity</a>
<li><a href="#Rebuilding-ancestry">7.3 Rebuilding ancestry</a>
<li><a href="#Mark_002dMerge">7.4 Mark-Merge</a>
<li><a href="#Regexps">7.5 Regular Expression Syntax</a>
<ul>
<li><a href="#Regexp-Summary">7.5.1 Regexp Syntax Summary</a>
<li><a href="#Regexp-Details">7.5.2 Regexp Details</a>
</li></ul>
</li></ul>
<li><a name="toc_Default-hooks" href="#Default-hooks">Appendix A Default hooks</a>
<li><a name="toc_General-Index" href="#General-Index">General Index</a>
</li></ul>
</div>

<p><a name="Concepts"></a>

<h2 class="chapter">1 Concepts</h2>

<p>This chapter should familiarize you with the concepts, terminology,
and behavior described in the remainder of the user manual.  Please
take a moment to read it, as later sections will assume familiarity
with these terms.

<p><a name="Versions-of-files"></a>

<h3 class="section">1.1 Versions of files</h3>

<p>Suppose you wish to modify a file <samp><span class="file">file.txt</span></samp> on your
computer. You begin with one <i>version</i> of the file, load it into
an editor, make some changes, and save the file again. Doing so
produces a new <i>version</i> of the file. We will say that the older
version of the file was a <dfn>parent</dfn>, and the new version is a
<dfn>child</dfn>, and that you have performed an <dfn>edit</dfn> between the
parent and the child. We may draw the relationship between parent and
child using a graph, where the arrow in the graph indicates the
direction of the edit, from parent to child.

   <div class="block-image"><img src="figures/parent-child.png" alt="figures/parent-child.png"></div>

   <p>We may want to identify the parent and the child precisely, for sake
of reference. To do so, we will compute a <i>cryptographic hash
function</i>, called <span class="sc">sha1</span>, of each version. The details of this
function are beyond the scope of this document; in summary, the <span class="sc">sha1</span>
function takes a version of a file and produces a short string of 20
bytes, which we will use to uniquely identify the version<a rel="footnote" href="#fn-1" name="fnd-1"><sup>1</sup></a>.  Now our
graph does not refer to some &ldquo;abstract&rdquo; parent and child, but rather
to the exact edit we performed between a specific parent and a
specific child.

   <div class="block-image"><img src="figures/parent-child-names-hashes.png" alt="figures/parent-child-names-hashes.png"></div>

   <p>When dealing with versions of files, we will dispense with writing out
&ldquo;file names&rdquo;, and identify versions <i>purely</i> by their <span class="sc">sha1</span>
value, which we will also refer to as their <dfn>file ID</dfn>. Using IDs
alone will often help us accommodate the fact that people often wish
to call files by different names. So now our graph of parent and child
is just a relationship between two versions, only identified by ID.

   <div class="block-image"><img src="figures/parent-child-hashes.png" alt="figures/parent-child-hashes.png"></div>

   <p>Version control systems, such as monotone, are principally concerned
with the storage and management of <i>multiple</i> versions of some files. 
One way to store multiple versions of a file is, literally, to save a
separate <i>complete</i> copy of the file, every time you make a
change. When necessary, monotone will save complete copies of your
files, compressed with the <code>zlib</code> compression format.

   <div class="block-image"><img src="figures/three-versions.png" alt="figures/three-versions.png"></div>

   <p>Often we find that successive versions of a file are very similar to
one another, so storing multiple complete copies is a waste of
space. In these cases, rather than store <i>complete</i> copies of each
version of a file, we store a compact description of only the
<i>changes</i> which are made between versions. Such a description of
changes is called a <dfn>delta</dfn>.

   <p>Storing deltas between files is, practically speaking, as good as
storing complete versions of files. It lets you undo changes from a
new version, by applying the delta backwards, and lets your friends
change their old version of the file into the new version, by applying
the delta forwards. Deltas are usually smaller than full files, so
when possible monotone stores deltas, using a modified <code>xdelta</code>
format. The details of this format are beyond the scope of this
document.

   <div class="block-image"><img src="figures/difference-between-versions.png" alt="figures/difference-between-versions.png"></div>

<p><a name="Versions-of-trees"></a>

<h3 class="section">1.2 Versions of trees</h3>

<p>After you have made many different files, you may wish to capture a
&ldquo;snapshot&rdquo; of the versions of all the files in a particular collection. 
Since files are typically collected into <i>trees</i> in a file system,
we say that you want to capture a <i>version of your tree</i>. Doing
so will permit you to undo changes to multiple files at once, or send
your friend a <i>set</i> of changes to many files at once.

   <p>To make a snapshot of a tree, we begin by writing a special file called
a <dfn>manifest</dfn>. In fact, monotone will write this file for us, but we
could write it ourselves too. It is just a plain text file, in a
structured but human-readable format used by several parts of monotone. 
Each file entry of a manifest binds a specific name, as a full path from
the root of the workspace, to a specific file ID, as the hash of its
content.  In this way, the manifest collects together the snapshot of
the file names and contents you have at this point in time; other
snapshots with other manifests can use different names for the same
file, or different contents for the same name.

   <p>Other entries in the manifest format name directories or store file
attrs, which we will cover later.

   <div class="block-image"><img src="figures/manifest.png" alt="figures/manifest.png"></div>

   <p>Now we note that a manifest is itself a file. Therefore a manifest can
serve as input to the <span class="sc">sha1</span> function, and thus every manifest has
an ID of its own. By calculating the <span class="sc">sha1</span> value of a manifest, we
capture the <i>state of our tree</i> in a single <dfn>manifest ID</dfn>. In
other words, the ID of the manifest essentially captures all the IDs
and file names of every file in our tree, combined. So we may treat
manifests and their IDs as <i>snapshots</i> of a tree of files, though
lacking the actual contents of the files themselves.

   <div class="block-image"><img src="figures/file-id-manifest-id.png" alt="figures/file-id-manifest-id.png"></div>

   <p>As with versions of files, we may decide to store manifests in their
entirety, or else we may store only a compact description of changes
which occur between different versions of manifests. As with files,
when possible monotone stores compact descriptions of changes between
manifests; when necessary it stores complete versions of manifests.

<p><a name="Historical-records"></a>

<h3 class="section">1.3 Historical records</h3>

<p>Suppose you sit down to edit some files. Before you start working, you
may record a manifest of the files, for reference sake. When you
finish working, you may record another manifest. These &ldquo;before and
after&rdquo; snapshots of the tree of files you worked on can serve as
historical records of the set of changes, or <dfn>changeset</dfn>, that you
made. In order to capture a &ldquo;complete&rdquo; view of history &ndash; both the
changes made and the state of your file tree on either side of those
changes &ndash; monotone builds a special composite file called a
<dfn>revision</dfn> each time you make changes. Like manifests, revisions
are ordinary text files which can be passed through the <span class="sc">sha1</span>
function and thus assigned a <dfn>revision ID</dfn>.

   <div class="block-image"><img src="figures/revision.png" alt="figures/revision.png"></div>

   <p>The content of a revision includes one or more changesets.  These
changesets make reference to file IDs, to describe how the tree changed. 
The revision also contains manifest IDs, as another way of describing
the tree &ldquo;before and after&rdquo; the changeset &mdash; storing this information
in two forms allows monotone to detect any bugs or corrupted data before
they can enter your history.  Finally and crucially, revisions also make
reference to <i>other revision IDs</i>. This fact &ndash; that revisions include
the IDs of other revisions &ndash; causes the set of revisions to join
together into a historical <i>chain of events</i>, somewhat like a &ldquo;linked
list&rdquo;.  Each revision in the chain has a unique ID, which includes
<i>by reference</i> all the revisions preceding it. Even if you undo a
changeset, and return to a previously-visited manifest ID during the
course of your edits, each revision will incorporate the ID of its
predecessor, thus forming a new unique ID for each point in history.

   <div class="block-image"><img src="figures/revision-chaining.png" alt="figures/revision-chaining.png"></div>

<p><a name="Certificates"></a>

<h3 class="section">1.4 Certificates</h3>

<p>Often, you will wish to make a <i>statement</i> about a revision, such as
stating the reason that you made some changes, or stating the time at
which you made the changes, or stating that the revision passes a test
suite. Statements such as these can be thought of, generally, as a
bundle of information with three parts:

     <ul>
<li>an <i>ID</i>, indicating which revision you are making a statement about
<li>a <i>name</i> indicating the type of statement you are making, such as
&ldquo;changelog&rdquo;, &ldquo;date&rdquo; or &ldquo;testresult&rdquo;
<li>a <i>value</i> indicating the remaining detail of the statement, such as
&ldquo;fixed a bug&rdquo;, &ldquo;March 9th&rdquo; or &ldquo;1&rdquo;
</ul>

   <p>For example, if you want to say that a particular revision was
composed on April 4, 2003, you might make a statement like this:

   <div class="block-image"><img src="figures/statement.png" alt="figures/statement.png"></div>

   <p>In an ideal world, these are all the parts of a statement we would
need in order to go about our work. In the real world, however, there
are sometimes malicious people who would make false or misleading
statements; so we need a way to verify that a particular person made a
particular statement about a revision. We therefore will add two more
pieces of information to our bundle:

     <ul>
<li>a <i>key</i> which identifies the person making a statement
<li>a <i>signature</i> &mdash; just a large number with particular properties &mdash;
certifying the fact that the person made the statement
</ul>

   <p>When these 2 items accompany a statement, we call the total bundle of
5 items a <dfn>certificate</dfn>, or <i>cert</i>. A cert makes a statement in
a secure fashion. The security of the signature in a cert is derived
from the <span class="sc">rsa</span> cryptography system, the details of which are beyond
the scope of this document.

   <div class="block-image"><img src="figures/cert.png" alt="figures/cert.png"></div>

   <p>Monotone uses certs extensively. Any &ldquo;extra&rdquo; information which needs
to be stored, transmitted or retrieved &mdash; above and beyond files,
manifests, and revisions &mdash; is kept in the form of certs. This
includes change logs, time and date records, branch membership,
authorship, test results, and more. When monotone makes a decision
about storing, transmitting, or extracting files, manifests, or
revisions, the decision is often based on certs it has seen, and the
trustworthiness you assign to those certs.

   <p>The <span class="sc">rsa</span> cryptography system &mdash; and therefore monotone itself &mdash;
requires that you exchange special &ldquo;public&rdquo; numbers with your
friends, before they will trust certificates signed by you. These
numbers are called <dfn>public keys</dfn>. Giving someone your public key
does not give them the power to <i>impersonate</i> you, only to verify
signatures made by you. Exchanging public keys should be done over a
trusted medium, in person, or via a trusted third party. Advanced
secure key exchange techniques are beyond the scope of this document.

<p><a name="Storage-and-workflow"></a>

<h3 class="section">1.5 Storage and workflow</h3>

<p>Monotone moves information in and out of four different types of
storage:

     <ul>
<li>a <i>keystore</i> in your home directory
<li>a <i>workspace</i> in the local file system
<li>a <i>local database</i> in the local file system
<li>a <i>remote database</i> elsewhere on the internet
</ul>

   <p>The <dfn>keystore</dfn> is a directory <samp><span class="file">.monotone/keys</span></samp> in your home directory
which contains copies of all your private keys. Each key is stored in a file
whose name is the key identifier with some characters converted to underscores. 
When you use a key to sign a cert, the public half of that key is copied into
your local database along with the cert.

   <p>All information passes <em>through</em> your local database, en route to
some other destination. For example, when changes are made in a
workspace, you may save those changes to your database, and later
you may synchronize your database with someone else's. Monotone will
not move information directly between a workspace and a remote
database, or between workspaces. Your local database is always
the &ldquo;switching point&rdquo; for communication.

   <div class="block-image"><img src="figures/general-workflow.png" alt="figures/general-workflow.png"></div>

   <p>A <dfn>workspace</dfn> is a tree of files in your file system, arranged
according to the list of file paths and IDs in a particular
manifest. A special directory called <samp><span class="file">_MTN</span></samp> exists in the root of
any workspace. Monotone keeps some special files in the <samp><span class="file">_MTN</span></samp>
directory, in order to track changes you make to your workspace.  If
you ever want to know if a directory is a monotone workspace, just
look for this <samp><span class="file">_MTN</span></samp> directory.

   <p>Aside from the special <samp><span class="file">_MTN</span></samp> directory, a workspace is just a
normal tree of files. You can directly edit the files in a workspace
using a plain text editor or other program; monotone will
automatically notice when you make any changes. If you wish to add
files, remove files, or move files within your workspace, you must
tell monotone explicitly what you are doing, as these actions cannot
be deduced.

   <p>If you do not yet have a workspace, you can <dfn>check out</dfn> a
workspace from a database, or construct one from scratch and
<dfn>add</dfn> it into a database. As you work, you will occasionally
<dfn>commit</dfn> changes you have made in a workspace to a database,
and <dfn>update</dfn> a workspace to receive changes that have arrived
in a database. Committing and updating take place purely between a
database and a workspace; the network is not involved.

   <div class="block-image"><img src="figures/local-workflow.png" alt="figures/local-workflow.png"></div>

   <p>A <dfn>database</dfn> is a single, regular file. You can copy or back it up
using standard methods. Typically you keep a database in your home
directory. Databases are portable between different machine types. You
can have multiple databases and divide your work between them, or keep
everything in a single database if you prefer. You can dump portions of
your database out as text, and read them back into other databases, or
send them to your friends.  Underneath, databases are accessed using a
standard, robust data manager, which makes using even very large
databases efficient.  In dire emergencies, you can directly examine and
manipulate a database using a simple SQL interface.

   <p>A database contains many files, manifests, revisions, and
certificates, some of which are not immediately of interest, some of
which may be unwanted or even false. It is a collection of information
received from network servers, workspaces, and other
databases. You can inspect and modify your databases without affecting
your workspaces, and vice-versa.

   <p>Monotone knows how to exchange information in your database with other
remote databases, using an interactive protocol called <dfn>netsync</dfn>. 
It supports three modes of exchange: pushing, pulling, and
synchronizing. A <dfn>pull</dfn> operation copies data from a remote
database to your local database. A <dfn>push</dfn> operation copies data
from your local database to a remote database. A <dfn>sync</dfn> operation
copies data both directions. In each case, only the data missing from
the destination is copied. The netsync protocol calculates the data to
send &ldquo;on the fly&rdquo; by exchanging partial hash values of each
database.

   <div class="block-image"><img src="figures/network-workflow.png" alt="figures/network-workflow.png"></div>

   <p>In general, work flow with monotone involves 3 distinct stages:

     <ul>
<li>When you <i>commit</i> changes from your workspace to your database,
your database stores the changes but does not communicate with the
network. Your commits happen immediately, without consulting any other
party, and do not require network connectivity.

     <li>When you are ready to <i>exchange</i> work with someone else, you can
push, pull, or sync with other databases on the network. When you talk
to other servers on the network, your database may change, but your
workspace will not. In fact, you do not need a workspace at all
when exchanging work.

     <li>When you <i>update</i> your workspace, some (but not all) of the
changes which your database received from the network are applied to
your workspace. The network is not consulted during updates. 
</ul>

   <p>The last stage of workflow is worth clarifying: monotone does
<em>not</em> blindly apply all changes it receives from a remote
database to your workspace.  Doing so would be very dangerous,
because remote databases are not always trustworthy systems. Rather,
monotone evaluates the certificates it has received along with the
changes, and decides which particular changes are safe and desirable
to apply to your workspace.

   <p>You can always adjust the criteria monotone uses to judge the
trustworthiness and desirability of changes in your database. But keep
in mind that it always uses <em>some</em> criteria; receiving changes
from a remote server is a <em>different</em> activity than applying
changes to a workspace. Sometimes you may receive changes which
monotone judges to be untrusted or bad; such changes may stay in your
database but will <em>not</em> be applied to your workspace.

   <p>Remote databases, in other words, are just untrusted &ldquo;buckets&rdquo; of
data, which you can trade with promiscuously. There is no trust
implied in communication.

<p><a name="Forks-and-merges"></a>

<h3 class="section">1.6 Forks and merges</h3>

<p>So far we have been talking about revisions as though each logically
follows exactly one revision before it, in a simple sequence of
revisions.

   <div class="block-image"><img src="figures/linear-history.png" alt="figures/linear-history.png"></div>

   <p>This is a rosy picture, but sometimes it does not work out this
way. Sometimes when you make new revisions, other people are
<i>simultaneously</i> making new revisions as well, and their revisions
might be derived from the same parent as yours, or contain different
changesets. Without loss of generality, we will assume simultaneous
edits only happen two-at-a-time; in fact many more edits may happen at
once but our reasoning will be the same.

   <p>We call this situation of simultaneous edits a <dfn>fork</dfn>, and will
refer to the two children of a fork as the <i>left child</i> and <i>right
child</i>. In a large collection of revisions with many people editing
files, especially on many different computers spread all around the
world, forks are a common occurrence.

   <div class="block-image"><img src="figures/fork.png" alt="figures/fork.png"></div>

   <p>If we analyze the changes in each child revision, we will often find
that the changeset between the parent and the left child are unrelated
to the changeset between the parent and the right child. When this
happens, we can usually <dfn>merge</dfn> the fork, producing a common
grandchild revision which contains both changesets.

   <div class="block-image"><img src="figures/merge.png" alt="figures/merge.png"></div>

<p><a name="Branches"></a>

<h3 class="section">1.7 Branches</h3>

<p>Sometimes, people intentionally produce forks which are <em>not
supposed to be merged</em>; perhaps they have agreed to work independently
for a time, or wish to change their files in ways which are not
logically compatible with each other. When someone produces a fork
which is supposed to last for a while (or perhaps permanently) we say
that the fork has produced a new <dfn>branch</dfn>. Branches tell monotone
which revisions you would like to merge, and which you would like to
keep separate.

   <p>You can see all the available branches using <samp><span class="command">mtn list branches</span></samp>.

   <p>Branches are indicated with certs.  The cert name <code>branch</code> is
reserved for use by monotone, for the purpose of identifying the
revisions which are members of a branch. A <code>branch</code> cert has a
symbolic &ldquo;branch name&rdquo; as its value. When we refer to &ldquo;a branch&rdquo;,
we mean all revisions with a common branch name in their <code>branch</code>
certs.

   <p>For example, suppose you are working on a program called &ldquo;wobbler&rdquo;. 
You might develop many revisions of wobbler and then decide to split
your revisions into a &ldquo;stable branch&rdquo; and an &ldquo;unstable branch&rdquo;, to
help organize your work. In this case, you might call the new branches
&ldquo;wobbler-stable&rdquo; and &ldquo;wobbler-unstable&rdquo;. From then on, all
revisions in the stable branch would get a cert with name <code>branch</code>
and value <code>wobbler-stable</code>; all revisions in the unstable branch
would get a cert with name <code>branch</code> and value
<code>wobbler-unstable</code>. When a <code>wobbler-stable</code> revision forks,
the children of the fork will be merged. When a
<code>wobbler-unstable</code> revision forks, the children of the fork will
be merged. However, the <code>wobbler-stable</code> and
<code>wobbler-unstable</code> branches will not be merged together, despite
having a common ancestor.

   <div class="block-image"><img src="figures/two-branches.png" alt="figures/two-branches.png"></div>

   <p>For each branch, the set of revisions with <em>no children</em> is
called the <dfn>heads</dfn> of the branch. Monotone can automatically
locate, and attempt to merge, the heads of a branch. If it fails to
automatically merge the heads, it may ask you for assistance or else
fail cleanly, leaving the branch alone.

   <p>For example, if a fork's left child has a child of its own (a &ldquo;left
grandchild&rdquo;), monotone will merge the fork's right child with the
left grandchild, since those revisions are the heads of the branch. It
will not merge the left child with the right child, because the left
child is not a member of the heads.

   <div class="block-image"><img src="figures/branch-heads.png" alt="figures/branch-heads.png"></div>

   <p>When there is only one revision in the heads of a branch, we say that
<i>the heads are merged</i>, or more generally that <i>the branch is
merged</i>, since the heads is the logical set of candidates for any
merging activity. If there are two or more revisions in the heads of a
branch, and you ask to merge the branch, monotone will merge them
two-at-a-time until there is only one.

<h4 class="subsection">1.7.1 Branch Names</h4>

<p>The branch names used in the above section are fine for an example, but
they would be bad to use in a real project.  The reason is, monotone
branch names must be <em>globally</em> unique, over all branches in the
world.  Otherwise, bad things can happen.  Fortunately, we have a handy
source of globally unique names &mdash; the DNS system.

   <p>When naming a branch, always prepend the reversed, fully qualified, domain name of a host that
you control or are otherwise authorized to use.  For example, monotone
development happens on the branch <code>net.venge.monotone</code>, because
<code>venge.net</code> belongs to monotone's primary author.  The idea is that
this way, you can coordinate with other people using a host to make sure
there are no conflicts &mdash; in the example, monotone's primary author can
be certain that no-one else using <code>venge.net</code> will start up a
different program named <code>monotone</code>.  If you work for Yoyodyne,
Inc. (owners of yoyodyne.com), then all your branch names should look
like <code>com.yoyodyne.</code><em>something</em>.

   <p>What the <em>something</em> part looks like is up to you, but
usually the first part is the project name (the <code>monotone</code> in
<code>net.venge.monotone</code>), and then possibly more stuff after that to
describe a particular branch.  For example, monotone's win32 support
was initially developed on the branch <code>net.venge.monotone.win32</code>.

   <p>(For more information, see <a href="#Naming-Conventions">Naming Conventions</a>.)

<p><a name="Tutorial"></a>

<h2 class="chapter">2 Tutorial</h2>

<p>This chapter illustrates the basic uses of monotone by means of an
example, fictional software project.

<h3 class="section">2.1 Issues</h3>

<p>Before we walk through the tutorial, there are two minor issues to
address: standard options and revision selectors.

<h4 class="subsection">2.1.1 Standard Options</h4>

<p>Before operating monotone, two important command-line options should
be explained.

     <ul>
<li>Most commands operate on a <i>database</i>, which is selected with
the <samp><span class="option">--db</span></samp> option. 
<li>Many commands operate on a subset of the database, called a
<i>branch</i>, which is selected with the <samp><span class="option">--branch</span></samp> option. 
</ul>

   <p>Monotone will cache the settings for these options in your workspace, so
ordinarily once you have checked out a project, you will not need to
specify them again.  We will therefore only mention these arguments in
the first example.

<h4 class="subsection">2.1.2 Revision Selectors</h4>

<p>Many commands require you to supply 40-character <span class="sc">sha1</span> values as
arguments, which identify revisions. These &ldquo;revision IDs&rdquo; are
tedious to type, so monotone permits you to supply &ldquo;revision
selectors&rdquo; rather than complete revision IDs. Selectors are a more
&ldquo;human friendly&rdquo; way of specifying revisions by combining certificate
values into unique identifiers. This &ldquo;selector&rdquo; mechanism can be
used anywhere a revision ID would normally be used. For details on
selector syntax, see <a href="#Selectors">Selectors</a>.

   <p>We are now ready to explore our fictional project.

<h3 class="section">2.2 The Fictional Project</h3>

<p>Our fictional project involves 3 programmers cooperating to write
firmware for a robot, the JuiceBot 7, which dispenses fruit juice. The
programmers are named Jim, Abe and Beth.

     <ul>
<li>Jim lives in Japan, and owns JuiceBot Inc. You will know when we're talking
about Jim, because everything he does involves the letter &ldquo;j&rdquo;. 
<li>Abe lives in Australia and writes code related to apple juice. You will
know when we're talking about Abe, because everything he does involves
the letter &ldquo;a&rdquo;. 
<li>Beth lives in Brazil and writes code related to banana juice. You will
know when we're talking about Beth, because everything she does involves
the letter &ldquo;b&rdquo;. 
</ul>

   <p>In our example the programmers work privately on laptops, and are
usually <em>disconnected</em> from the network. They share no storage
system. Thus when each programmer enters a command, it affects only
his or her own computer, unless otherwise stated.

   <p>In the following, our fictional project team will work through several
version control tasks. Some tasks must be done by each member of our
example team; other tasks involve only one member.

<p><a name="Creating-a-Database"></a>

<h3 class="section">2.3 Creating a Database</h3>

<p>The first step Jim, Abe and Beth each need to perform is to create a
new database. This is done with the <samp><span class="command">mtn db init</span></samp> command,
providing a <samp><span class="option">--db</span></samp> option to specify the location of the new
database. Each programmer creates their own database, which will
reside in their home directory and store all the revisions, files and
manifests they work on. Monotone requires this step as an explicit
command, to prevent spurious creation of databases when an invalid
<samp><span class="option">--db</span></samp> option is given.

   <p>In real life, most people prefer to keep one database for each project
they work on.  If we followed that convention here in the tutorial,
though, then all the databases would be called <code>juicebot.mtn</code>, and
that would make things more confusing to read.  So instead, we'll have
them each name their database after themselves.

   <p>Thus Jim issues the command:

<pre class="smallexample">     $ mtn db init --db=~/jim.mtn
</pre>
   <p>Abe issues the command:

<pre class="smallexample">     $ mtn db init --db=~/abe.mtn
</pre>
   <p>And Beth issues the command:

<pre class="smallexample">     $ mtn db init --db=~/beth.mtn
</pre>
   <p><a name="Generating-Keys"></a>

<h3 class="section">2.4 Generating Keys</h3>

<p>Now Jim, Abe and Beth must each generate an <span class="sc">rsa</span> key pair for
themselves. This step requires choosing a key identifier. Typical key
identifiers are similar to email addresses, possibly modified with
some prefix or suffix to distinguish multiple keys held by the same
owner. Our example programmers will use their email addresses at the
fictional &ldquo;juicebot.co.jp&rdquo; domain name. When we ask for a key to be
generated, monotone will ask us for a passphrase. This phrase is used
to encrypt the key when storing it on disk, as a security measure.

   <p>Jim does the following:

<pre class="smallexample">     $ mtn genkey jim@juicebot.co.jp
     mtn: generating key-pair 'jim@juicebot.co.jp'
     enter passphrase for key ID [jim@juicebot.co.jp] : <i>&lt;Jim enters his passphrase&gt;</i>
     confirm passphrase for key ID [jim@juicebot.co.jp]: <i>&lt;Jim confirms his passphrase&gt;</i>
     mtn: storing key-pair 'jim@juicebot.co.jp' in /home/jim/.monotone/keys
</pre>
   <p>Abe does something similar:

<pre class="smallexample">     $ mtn genkey abe@juicebot.co.jp
     mtn: generating key-pair 'abe@juicebot.co.jp'
     enter passphrase for key ID [abe@juicebot.co.jp] : <i>&lt;Abe enters his passphrase&gt;</i>
     confirm passphrase for key ID [abe@juicebot.co.jp]: <i>&lt;Abe confirms his passphrase&gt;</i>
     mtn: storing key-pair 'abe@juicebot.co.jp' in /home/abe/.monotone/keys
</pre>
   <p>as does Beth:

<pre class="smallexample">     $ mtn genkey beth@juicebot.co.jp
     mtn: generating key-pair 'beth@juicebot.co.jp'
     enter passphrase for key ID [beth@juicebot.co.jp] : <i>&lt;Beth enters her passphrase&gt;</i>
     confirm passphrase for key ID [beth@juicebot.co.jp]: <i>&lt;Beth confirms her passphrase&gt;</i>
     mtn: storing key-pair 'beth@juicebot.co.jp' in /home/beth/.monotone/keys
</pre>
   <p>Each programmer has now generated a key pair and placed it in their
keystore. Each can list the keys in their keystore, to ensure
the correct key was generated. For example, Jim might see this:

<pre class="smallexample">     $ mtn list keys
     
     [public keys]
     9e9e9ef1d515ad58bfaa5cf282b4a872d8fda00c jim@juicebot.co.jp   (*)
     (*) - only in /home/jim/.monotone/keys/
     
     
     [private keys]
     771ace046c27770a99e5fddfa99c9247260b5401 jim@juicebot.co.jp
</pre>
   <p>The hexadecimal string printed out before each key name is a
<em>fingerprint</em> of the key, and can be used to verify that the key
you have stored under a given name is the one you intended to
store. Monotone will never permit one keystore to store two keys with
the same name or the same fingerprint.

   <p>This output shows one private and one public key stored under the name
<code>jim@juicebot.co.jp</code>, so it indicates that Jim's key-pair has been
successfully generated and stored. On subsequent commands, Jim will need
to re-enter his passphrase in order to perform security-sensitive
tasks.

   <p>Pretty soon Jim gets annoyed when he has to enter his passphrase every
time he invokes <code>mtn</code> (and, more importantly, it simplifies the
tutorial text to skip the passphrase prompts) so he decides to use
<em>ssh-agent</em> to store his key. He does this by using the
<code>ssh_agent_export</code> command to export his key into a format that
ssh-agent can understand and adding it with <code>ssh-add</code>.

<pre class="smallexample">     $ mtn ssh_agent_export ~/.ssh/id_monotone
     enter passphrase for key ID [user@example.com]:
     enter new passphrase for key ID [user@example.com]:
     confirm passphrase for key ID [user@example.com]:
     $ chmod 600 ~/.ssh/id_monotone
</pre>
   <p>From now on, Jim just needs to add his key to ssh-agent when he logs in
and he will not need to enter his passphrase every time he uses monotone.

<pre class="smallexample">     $ ssh-agent /bin/bash
     $ ssh-add ~/.ssh/id_monotone
     Enter passphrase for /home/user/.ssh/id_monotone:
     Identity added: /home/user/.ssh/id_monotone (/home/user/.ssh/id_monotone)
     $ mtn ci -m"Changed foo to bar"
     $ mtn push
</pre>
   <p>The following procedure is deprecated and not suggested for general use
as it is very insecure.

   <p>Jim isn't very worried about security so he
decides to store his passphrase in his <samp><span class="file">monotonerc</span></samp> file.  He does
this by writing a <em>hook function</em> which returns the passphrase:

<pre class="smallexample">     $ mkdir ~/.monotone
     $ cat &gt;&gt;~/.monotone/monotonerc
     function get_passphrase(keypair_id)
       return "jimsekret"
     end
     ^D
</pre>
   <p>Now whenever monotone needs his passphrase, it will call this function
instead of prompting him to type it.  Note that we are appending the new
hook to the (possibly existing) file.  We do this to avoid losing other
changes by mistake; therefore, be sure to check that no other
<code>get_passphrase</code> function appears in the configuration file.

   <p>Abe and Beth do the same, with their secret passphrases.

<p><a name="Starting-a-New-Project"></a>

<h3 class="section">2.5 Starting a New Project</h3>

<p>Before he can begin work on the project, Jim needs to create a
<i>workspace</i> &mdash; a directory whose contents monotone will keep track
of.  Often, one works on projects that someone else has started, and
creates workspaces with the <samp><span class="command">checkout</span></samp> command, which you'll
learn about later.  Jim is starting a new project, though, so he does
something a little bit different.  He uses the <samp><span class="command">mtn setup</span></samp>
command to create a new workspace.

   <p>This command creates the named directory (if it doesn't already exist),
and creates the <samp><span class="file">_MTN</span></samp> directory within it.  The <samp><span class="file">_MTN</span></samp> directory
is how monotone recognizes that a directory is a workspace, and
monotone stores some bookkeeping files within it.  For instance, command
line values for the <samp><span class="option">--db</span></samp>, <samp><span class="option">--branch</span></samp> or <samp><span class="option">--key</span></samp>
options to the <samp><span class="command">setup</span></samp> command will be cached in a file called
<samp><span class="file">_MTN/options</span></samp>, so you don't have to keep passing them to monotone
all the time.

   <p>He chooses <code>jp.co.juicebot.jb7</code> as a branch name. (See
<a href="#Naming-Conventions">Naming Conventions</a> for more information about appropriate branch
names.)  Jim then creates his workspace:

<pre class="smallexample">     /home/jim$ mtn --db=jim.mtn --branch=jp.co.juicebot.jb7 setup juice
     /home/jim$ cd juice
     /home/jim/juice$
</pre>
   <p>Notice that Jim has changed his current directory to his newly created
workspace. For the rest of this example we will assume that everyone
issues all further monotone commands from their workspace
directories.

<p><a name="Adding-Files"></a>

<h3 class="section">2.6 Adding Files</h3>

<p>Next Jim decides to add some files to the project. He writes up
a file containing the prototypes for the JuiceBot 7:

<pre class="smallexample">     $ mkdir include
     $ cat &gt;include/jb.h
     /* Standard JuiceBot hw interface */
     
     #define FLOW_JUICE 0x1
     #define POLL_JUICE 0x2
     int spoutctl(int port, int cmd, void *x);
     
     /* JuiceBot 7 API */
     
     #define APPLE_SPOUT 0x7e
     #define BANANA_SPOUT 0x7f
     void dispense_apple_juice ();
     void dispense_banana_juice ();
     ^D
</pre>
   <p>Then adds a couple skeleton source files which he wants Abe and Beth
to fill in:

<pre class="smallexample">     $ mkdir src
     $ cat &gt;src/apple.c
     #include "jb.h"
     
     void
     dispense_apple_juice()
     {
       /* Fill this in please, Abe. */
     }
     ^D
     $ cat &gt;src/banana.c
     #include "jb.h"
     
     void
     dispense_banana_juice()
     {
       /* Fill this in please, Beth. */
     }
     ^D
</pre>
   <p>Now Jim tells monotone to add these files to its record of his
workspace.  He specifies one filename and one directory; monotone
recursively scans the directory and adds all its files.

<pre class="smallexample">     $ mtn add include/jb.h src
     mtn: adding include/jb.h to workspace manifest
     mtn: adding src/apple.c to workspace manifest
     mtn: adding src/banana.c to workspace manifest
</pre>
   <p>This command produces a record of Jim's intentions in a special file
called <samp><span class="file">_MTN/revision</span></samp>, stored in the workspace. The file is plain
text:

<pre class="smallexample">     $ cat _MTN/revision
     
     format_version "1"
     
     new_manifest [2098eddbe833046174de28172a813150a6cbda7b]
     
     old_revision []
     
     add_file "include/jb.h"
      content [3b12b2d0b31439bd50976633db1895cff8b19da0]
     
     add_file "src/apple.c"
      content [2650ffc660dd00a08b659b883b65a060cac7e560]
     
     add_file "src/banana.c"
      content [e8f147e5b4d5667f3228b7bba1c5c1e639f5db9f]
</pre>
   <p>You will never have to look at this file, but it is nice to know that
it is there.

   <p>Jim then gets up from his machine to get a coffee. When he returns
he has forgotten what he was doing. He asks monotone:

<pre class="smallexample">     $ mtn status
     Current branch: jp.co.juicebot.jb7
     Changes against parent :
       added   include/jb.h
       added   src/apple.c
       added   src/banana.c
</pre>
   <p>The output of this command tells Jim that his edits, so far,
constitute only the addition of some files.

   <p>Jim wants to see the actual details of the files he added, however, so
he runs a command which prints out the status <em>and</em> a GNU
&ldquo;unified diff&rdquo; of the patches involved in the changeset:

<pre class="smallexample">     $ mtn diff
     #
     # old_revision []
     #
     # add_file "include/jb.h"
     #  content [3b12b2d0b31439bd50976633db1895cff8b19da0]
     #
     # add_file "src/apple.c"
     #  content [2650ffc660dd00a08b659b883b65a060cac7e560]
     #
     # add_file "src/banana.c"
     #  content [e8f147e5b4d5667f3228b7bba1c5c1e639f5db9f]
     #
     ============================================================================
     --- include/jb.h
     +++ include/jb.h 3b12b2d0b31439bd50976633db1895cff8b19da0
     @ -0,0 +1,13 @
     +/* Standard JuiceBot hw interface */
     +
     +#define FLOW_JUICE 0x1
     +#define POLL_JUICE 0x2
     +#define SET_INTR 0x3
     +int spoutctl(int port, int cmd, void *x);
     +
     +/* JuiceBot 7 API */
     +
     +#define APPLE_SPOUT 0x7e
     +#define BANANA_SPOUT 0x7f
     +void dispense_apple_juice ();
     +void dispense_banana_juice ();
     ============================================================================
     --- src/apple.c
     +++ src/apple.c 2650ffc660dd00a08b659b883b65a060cac7e560
     @ -0,0 +1,7 @
     +#include "jb.h"
     +
     +void
     +dispense_apple_juice()
     +{
     +  /* Fill this in please, Abe. */
     +}
     ============================================================================
     --- src/banana.c
     +++ src/banana.c e8f147e5b4d5667f3228b7bba1c5c1e639f5db9f
     @ -0,0 +1,7 @
     +#include "jb.h"
     +
     +void
     +dispense_banana_juice()
     +{
     +  /* Fill this in please, Beth. */
     +}
</pre>
   <p><a name="Committing-Work"></a>

<h3 class="section">2.7 Committing Work</h3>

<p>Satisfied with the work he's done, Jim wants to save his changes.  He
then commits his workspace, which causes monotone to process the
<samp><span class="file">_MTN/revision</span></samp> file and record the file contents, manifest, and
revision into the database. Since he provided a branch name when he
ran <samp><span class="command">setup</span></samp>, monotone will use this as the default branch name
when he commits.

<pre class="smallexample">     $ mtn commit --message="initial checkin of project"
     mtn: beginning commit on branch 'jp.co.juicebot.jb7'
     mtn: committed revision 2e24d49a48adf9acf3a1b6391a080008cbef9c21
</pre>
   <p>When monotone committed Jim's revision, it updated <samp><span class="file">_MTN/revision</span></samp>
to record the workspace's new base revision ID. Jim can use this
revision ID in the future, as an argument to the <samp><span class="command">checkout</span></samp>
command, if he wishes to return to this revision:

<pre class="smallexample">     $ mtn automate get_base_revision_id
     2e24d49a48adf9acf3a1b6391a080008cbef9c21
</pre>
   <p>Monotone also generated a number of certificates attached to
the new revision, and made sure that the database contained a copy of Jim's
public key. These certs store metadata about the commit. Jim can
ask monotone for a list of certs on this revision.

<pre class="smallexample">     $ mtn ls certs 2e24d49a48adf9acf3a1b6391a080008cbef9c21
     -----------------------------------------------------------------
     Key   : jim@juicebot.co.jp
     Sig   : ok
     Name  : branch
     Value : jp.co.juicebot.jb7
     -----------------------------------------------------------------
     Key   : jim@juicebot.co.jp
     Sig   : ok
     Name  : date
     Value : 2004-10-26T02:53:08
     -----------------------------------------------------------------
     Key   : jim@juicebot.co.jp
     Sig   : ok
     Name  : author
     Value : jim@juicebot.co.jp
     -----------------------------------------------------------------
     Key   : jim@juicebot.co.jp
     Sig   : ok
     Name  : changelog
     Value : initial checkin of project
</pre>
   <p>The output of this command has a block for each cert found. Each block
has 4 significant pieces of information. The first indicates the
signer of the cert, in this case <code>jim@juicebot.co.jp</code>. The
second indicates whether this cert is &ldquo;ok&rdquo;, meaning whether the
<span class="sc">rsa</span> signature provided is correct for the cert data. The third is
the cert name, and the fourth is the cert value. This list shows us
that monotone has confirmed that, according to
<code>jim@juicebot.co.jp</code>, the revision
<code>2e24d49a48adf9acf3a1b6391a080008cbef9c21</code> is a member of the
branch <code>jp.co.juicebot.jb7</code>, written by
<code>jim@juicebot.co.jp</code>, with the given date and changelog.

   <p>It is important to keep in mind that revisions are not &ldquo;in&rdquo; or
&ldquo;out&rdquo; of a branch in any global sense, nor are any of these cert
values <i>true</i> or <i>false</i> in any global sense. Each cert indicates
that <i>some person</i> &ndash; in this case Jim &ndash; would like to associate a
revision with some value; it is up to you to decide if you want to
accept that association.

   <p>Jim can now check the status of his branch using the &ldquo;heads&rdquo;
command, which lists all the head revisions in the branch:

<pre class="smallexample">     $ mtn heads
     branch 'jp.co.juicebot.jb7' is currently merged:
     2e24d49a48adf9acf3a1b6391a080008cbef9c21 jim@juicebot.co.jp 2004-10-26T02:53:08
</pre>
   <p>The output of this command tells us that there is only one current
&ldquo;head&rdquo; revision in the branch <code>jp.co.juicebot.jb7</code>, and it is
the revision Jim just committed. A head revision is one without any
descendants. Since Jim has not committed any changes to this revision
yet, it has no descendants.

<p><a name="Basic-Network-Service"></a>

<h3 class="section">2.8 Basic Network Service</h3>

<p>Jim now decides he will make his base revision available to his
employees.  To do this, he arranges for Abe and Beth to synchronise
their databases with his, over the network.  There are two
pre-requisites for this: first, he has to get a copy of each of their
public keys; then, he has to tell monotone that the holders of those
keys are permitted to access his database. Finally, with these
pre-requisites in place, he needs to tell monotone to provide network
access to his database.

   <p>First, Abe exports his public key:

<pre class="smallexample">     $ mtn --db=~/abe.mtn pubkey abe@juicebot.co.jp &gt;~/abe.pubkey
</pre>
   <p>His public key is just a plain block of ASCII text:

<pre class="smallexample">     $ cat ~/abe.pubkey
     [pubkey abe@juicebot.co.jp]
     MIGdMA0GCSqGSIb3DQEBAQUAA4GLADCBhwKBgQCbaVff9SF78FiB/1nUdmjbU/TtPyQqe/fW
     CDg7hSg1yY/hWgClXE9FI0bHtjPMIx1kBOig09AkCT7tBXM9z6iGWxTBhSR7D/qsJQGPorOD
     DO7xovIHthMbZZ9FnvyB/BCyiibdWgGT0Gtq94OKdvCRNuT59e5v9L4pBkvajb+IzQIBEQ==
     [end]
</pre>
   <p>Beth also exports her public key:

<pre class="smallexample">     $ mtn --db=~/beth.mtn pubkey beth@juicebot.co.jp &gt;~/beth.pubkey
</pre>
   <p>Then Abe and Beth both send their keys to Jim.  The keys are not secret,
but the team members must be relatively certain that they are exchanging
keys with the person they intend to trust, and not some malicious person
pretending to be a team member. Key exchange may involve sending keys
over an encrypted medium, or meeting in person to exchange physical
copies, or any number of techniques. All that matters, ultimately, is
that Jim receives both Abe's and Beth's key in a way that he can be sure
of.

   <p>So eventually, after key exchange, Jim has the public key files in his
home directory. He tells monotone to read the associated key packets
into his database:

<pre class="smallexample">     $ cat ~/abe.pubkey ~/beth.pubkey | mtn --db=~/jim.mtn read
     mtn: read 2 packets
</pre>
   <p>Now Jim's monotone is able to identify Beth and Abe, and he is ready to
give them permission to access his database.  He does this by editing a
pair of small files in his <samp><span class="file">~/.monotone</span></samp> directory:

<pre class="smallexample">     $ cat &gt;&gt;~/.monotone/read-permissions
     pattern "*"
     allow "abe@juicebot.co.jp"
     allow "beth@juicebot.co.jp"
     ^D
     
     $ cat &gt;&gt;~/.monotone/write-permissions
     abe@juicebot.co.jp
     beth@juicebot.co.jp
     ^D
</pre>
   <p>These files are read by the default monotone hooks that will decide
whether remote monotone users will be allowed access to Jim's database,
identified by the named keys.

   <p>Jim then makes sure that his TCP port 4691 is open to incoming
connections, adjusting his firewall settings as necessary, and runs
the monotone <samp><span class="command">serve</span></samp> command:

<pre class="smallexample">     $ mtn --db=jim.mtn serve
</pre>
   <p>This command starts monotone listening on all network interfaces of
his laptop on the default port 4691, serving everything in his database.

<p><a name="Synchronising-Databases"></a>

<h3 class="section">2.9 Synchronising Databases</h3>

<p>With Jim's server preparations done, now Abe is ready to fetch Jim's
code. To do this he issues the monotone <samp><span class="command">sync</span></samp> command:

<pre class="smallexample">     $ mtn --db=abe.mtn sync jim-laptop.juicebot.co.jp "jp.co.juicebot.jb7*"
     mtn: setting default server to jim-laptop.juicebot.co.jp
     mtn: setting default branch include pattern to 'jp.co.juicebot.jb7*'
     mtn: setting default branch exclude pattern to ''
     mtn: connecting to jim-laptop.juicebot.co.jp
     mtn: first time connecting to server jim-laptop.juicebot.co.jp:4691
     mtn: I'll assume it's really them, but you might want to double-check
     mtn: their key's fingerprint: 9e9e9ef1d515ad58bfaa5cf282b4a872d8fda00c
     mtn: warning: saving public key for jim@juicebot.co.jp to database
     mtn: finding items to synchronize:
     mtn: bytes in | bytes out | revs in | revs out | revs written
     mtn:     2587 |      1025 |       1 |        0 |            1
     mtn: successful exchange with jim-laptop.juicebot.co.jp
</pre>
   <p>Abe now has, in his database, a copy of everything Jim put in the
branch. Therefore Abe can disconnect from the expensive network
connection he's on and work locally for a while. Remember that, in
monotone, work is done between workspaces in the filesystem and
the local database; network connectivity is necessary only when that
work is to be shared with others.

   <p>As we follow the juicebot team through the next several steps, we'll see
them run the <samp><span class="command">sync</span></samp> command again with Jim, and work will flow
both ways. The first time you <samp><span class="command">sync</span></samp> a new database, monotone
remembers the server and branch patterns you use, and makes them the
default for future operations.

   <p>At the end of each exchange, information about all changes in the branch
known to each database have been sent to the other party - including the
work of the third team member that had previously been exchanged. As
well as allowing each team member to learn about the others' work, this
also means that each party's laptop contains a <em>backup</em> of the
others' work too.

   <p>Jim, Abe and Beth will continue working like this while they're getting
started, and we'll revisit the issue of network service with them a
little later as the project grows.

<p><a name="Making-Changes"></a>

<h3 class="section">2.10 Making Changes</h3>

<p>Abe decides to do some work on his part of the code. He has a copy of
Jim's database contents, but cannot edit any of that data yet.  He
begins his editing by checking out the head of the
<code>jp.co.juicebot.jb7</code> branch into a workspace, so he can edit
it:

<pre class="smallexample">     $ mtn --db=abe.mtn --branch=jp.co.juicebot.jb7 checkout .
</pre>
   <p>Monotone unpacks the set of files in the head revision's manifest
directly into Abe's current directory.  (If he had specified something
other than <samp><span class="file">.</span></samp> at the end, monotone would have created that
directory and unpacked the files into it.)  Abe then opens up one of the
files, <samp><span class="file">src/apple.c</span></samp>, and edits it:

<pre class="smallexample">     $ vi src/apple.c
     <i>&lt;Abe writes some apple-juice dispensing code&gt;</i>
</pre>
   <p>The file <samp><span class="file">src/apple.c</span></samp> has now been <em>changed</em>. Abe gets
up to answer a phone call, and when he returns to his work he has
forgotten what he changed. He can ask monotone for details:

<pre class="smallexample">     $ mtn diff
     #
     # old_revision [2e24d49a48adf9acf3a1b6391a080008cbef9c21]
     #
     # patch "src/apple.c"
     #  from [2650ffc660dd00a08b659b883b65a060cac7e560]
     #    to [e2c418703c863eabe70f9bde988765406f885fd0]
     #
     ============================================================================
     --- src/apple.c 2650ffc660dd00a08b659b883b65a060cac7e560
     +++ src/apple.c e2c418703c863eabe70f9bde988765406f885fd0
     @ -1,7 +1,10 @
      #include "jb.h"
     
      void
      dispense_apple_juice()
      {
     -  /* Fill this in please, Abe. */
     +  spoutctl(APPLE_SPOUT, FLOW_JUICE, 1);
     +  while (spoutctl(APPLE_SPOUT, POLL_JUICE, 1) == 0)
     +    usleep (1000);
     +  spoutctl(APPLE_SPOUT, FLOW_JUICE, 0);
      }
</pre>
   <p>Satisfied with his day's work, Abe decides to commit.

<pre class="smallexample">     $ mtn commit
     mtn: beginning commit on branch 'jp.co.juicebot.jb7'
</pre>
   <p>Abe neglected to provide a <samp><span class="option">--message</span></samp> option specifying the
change log on the command line and the file <samp><span class="file">_MTN/log</span></samp> is empty
because he did not document his changes there.  Monotone therefore
invokes an external &ldquo;log message editor&rdquo; &mdash; typically an editor
like <samp><span class="command">vi</span></samp> &mdash; with an explanation of the changes being
committed and the opportunity to enter a log message.

<pre class="smallexample">     polling implementation of src/apple.c
     MTN:
     MTN: ----------------------------------------------------------------------
     MTN: Enter Log.  Lines beginning with `MTN:' are removed automatically
     MTN:
     MTN: format_version "1"
     MTN:
     MTN: new_manifest [b33cb337dccf21d6673f462d677a6010b60699d1]
     MTN:
     MTN: old_revision [2e24d49a48adf9acf3a1b6391a080008cbef9c21]
     MTN:
     MTN: patch "src/apple.c"
     MTN: from [2650ffc660dd00a08b659b883b65a060cac7e560]
     MTN:   to [e2c418703c863eabe70f9bde988765406f885fd0]
     MTN:
     MTN: ----------------------------------------------------------------------
     MTN:
</pre>
   <p>Abe enters a single line above the explanatory message, saying
&ldquo;polling implementation of src/apple.c&rdquo;. He then saves the file and
quits the editor. Monotone deletes all the lines beginning with
&ldquo;MTN:&rdquo; and leaves only Abe's short message. Returning to the shell,
Abe's commit completes:

<pre class="smallexample">     mtn: committed revision 70decb4b31a8227a629c0e364495286c5c75f979
</pre>
   <p>Abe then sends his new revision back to Jim:

<pre class="smallexample">     $ mtn sync
     mtn: connecting to jim-laptop.juicebot.co.jp
     mtn: finding items to synchronize:
     mtn:   certs |    keys | revisions
     mtn:       8 |       2 |         2
     mtn: bytes in | bytes out | revs in | revs out | revs written
     mtn:      615 |      2822 |       0 |        1 |            0
     mtn: successful exchange with jim-laptop.juicebot.co.jp
</pre>
   <p>Beth does a similar sequence. First she syncs her database with
Jim's:

<pre class="smallexample">     $ mtn --db=beth.mtn sync jim-laptop.juicebot.co.jp "jp.co.juicebot.jb7*"
     mtn: setting default server to jim-laptop.juicebot.co.jp
     mtn: setting default branch include pattern to 'jp.co.juicebot.jb7*'
     mtn: setting default branch exclude pattern to ''
     mtn: connecting to jim-laptop.juicebot.co.jp
     mtn: first time connecting to server jim-laptop.juicebot.co.jp:4691
     mtn: I'll assume it's really them, but you might want to double-check
     mtn: their key's fingerprint: 9e9e9ef1d515ad58bfaa5cf282b4a872d8fda00c
     mtn: warning: saving public key for jim@juicebot.co.jp to database
     mtn: finding items to synchronize:
     mtn: bytes in | bytes out | revs in | revs out | revs written
     mtn:     4601 |      1239 |       2 |        0 |            1
     mtn: verifying new revisions (this may take a while)
     mtn: bytes in | bytes out | revs in | revs out | revs written
     mtn:     4601 |      1285 |       2 |        0 |            2
     mtn: successful exchange with jim-laptop.juicebot.co.jp
</pre>
   <p>She checks out a copy of the tree from her database:

<pre class="smallexample">     $ mtn --db=beth.mtn --branch=jp.co.juicebot.jb7 checkout .
</pre>
   <p>She edits the file <samp><span class="file">src/banana.c</span></samp>:

<pre class="smallexample">     $ vi src/banana.c
     <i>&lt;Beth writes some banana-juice dispensing code&gt;</i>
</pre>
   <p>and logs her changes in <samp><span class="file">_MTN/log</span></samp> right away so she does not
forget what she has done like Abe.

<pre class="smallexample">     $ vi _MTN/log
     * src/banana.c: Added polling implementation
</pre>
   <p>Later, she commits her work.  Monotone again invokes an external editor
for her to edit her log message, but this time it fills in the messages
she's written so far, and she simply checks them over one last time
before finishing her commit:

<pre class="smallexample">     $ mtn commit
     mtn: beginning commit on branch 'jp.co.juicebot.jb7'
     mtn: committed revision 80ef9c9d251d39074d37e72abf4897e0bbae1cfb
</pre>
   <p>And she syncs with Jim again:

<pre class="smallexample">     $ mtn sync
     mtn: connecting to jim-laptop.juicebot.co.jp
     mtn: finding items to synchronize:
     mtn:   certs |    keys | revisions
     mtn:      12 |       3 |         3
     mtn: bytes in | bytes out | revs in | revs out | revs written
     mtn:      709 |      2879 |       0 |        1 |            0
     mtn: successful exchange with jim-laptop.juicebot.co.jp
</pre>
   <p><a name="Dealing-with-a-Fork"></a>

<h3 class="section">2.11 Dealing with a Fork</h3>

<p>Careful readers will note that, in the previous section, the JuiceBot
company's work was perfectly serialized:

     <ol type=1 start=1>
<li>Jim did some work
<li>Abe synced with Jim
<li>Abe did some work
<li>Abe synced with Jim
<li>Beth synced with Jim
<li>Beth did some work
<li>Beth synced with Jim
        </ol>

   <p>The result of this ordering is that Jim's work entirely preceded
Abe's work, which entirely preceded Beth's work. Moreover, each
worker was fully informed of the &ldquo;up-stream&rdquo; worker's actions, and
produced purely derivative, &ldquo;down-stream&rdquo; work:

     <ol type=1 start=1>
<li>Jim made revision 2e24d... 
<li>Abe changed revision 2e24d... into revision 70dec... 
<li>Beth derived revision 70dec... into revision 80ef9...
        </ol>

   <p>This is a simple, but sadly unrealistic, ordering of events. In real
companies or work groups, people often work in parallel,
<em>diverging</em> from commonly known revisions and <em>merging</em>
their work together, sometime after each unit of work is complete.

   <p>Monotone supports this diverge/merge style of operation naturally; any
time two revisions diverge from a common parent revision, we say that
the revision graph has a <dfn>fork</dfn> in it. Forks can happen at any
time, and require no coordination between workers. In fact any
interleaving of the previous events would work equally well; with one
exception: if forks were produced, someone would eventually have to
run the <samp><span class="command">merge</span></samp> command, and possibly resolve any conflicts
in the fork.

   <p>To illustrate this, we return to our workers Beth and Abe. Suppose Jim
sends out an email saying that the current polling juice dispensers
use too much CPU time, and must be rewritten to use the JuiceBot's
interrupt system. Beth wakes up first and begins working immediately,
basing her work off the revision 80ef9... which is currently in her
workspace:

<pre class="smallexample">     $ vi src/banana.c
     <i>&lt;Beth changes her banana-juice dispenser to use interrupts&gt;</i>
</pre>
   <p>Beth finishes and examines her changes:

<pre class="smallexample">     $ mtn diff
     #
     # old_revision [80ef9c9d251d39074d37e72abf4897e0bbae1cfb]
     #
     # patch "src/banana.c"
     #  from [7381d6b3adfddaf16dc0fdb05e0f2d1873e3132a]
     #    to [5e6622cf5c8805bcbd50921ce7db86dad40f2ec6]
     #
     ============================================================================
     --- src/banana.c 7381d6b3adfddaf16dc0fdb05e0f2d1873e3132a
     +++ src/banana.c 5e6622cf5c8805bcbd50921ce7db86dad40f2ec6
     @ -1,10 +1,15 @
      #include "jb.h"
     
     +static void
     +shut_off_banana()
     +{
     +  spoutctl(BANANA_SPOUT, SET_INTR, 0);
     +  spoutctl(BANANA_SPOUT, FLOW_JUICE, 0);
     +}
     +
      void
     -dispense_banana_juice()
     +dispense_banana_juice()
      {
     +  spoutctl(BANANA_SPOUT, SET_INTR, &amp;shut_off_banana);
        spoutctl(BANANA_SPOUT, FLOW_JUICE, 1);
     -  while (spoutctl(BANANA_SPOUT, POLL_JUICE, 1) == 0)
     -    usleep (1000);
     -  spoutctl(BANANA_SPOUT, FLOW_JUICE, 0);
      }
</pre>
   <p>She commits her work:

<pre class="smallexample">     $ mtn commit --message="interrupt implementation of src/banana.c"
     mtn: beginning commit on branch 'jp.co.juicebot.jb7'
     mtn: committed revision 8b41b5399a564494993063287a737d26ede3dee4
</pre>
   <p>And she syncs with Jim:

<pre class="smallexample">     $ mtn sync
</pre>
   <p>Unfortunately, before Beth managed to sync with Jim, Abe had woken up
and implemented a similar interrupt-based apple juice dispenser, but
his workspace is 70dec..., which is still &ldquo;upstream&rdquo; of
Beth's.

<pre class="smallexample">     $ vi apple.c
     <i>&lt;Abe changes his apple-juice dispenser to use interrupts&gt;</i>
</pre>
   <p>Thus when Abe commits, he unknowingly creates a fork:

<pre class="smallexample">     $ mtn commit --message="interrupt implementation of src/apple.c"
</pre>
   <p>Abe does not see the fork yet; Abe has not actually seen <em>any</em> of
Beth's work yet, because he has not synchronized with Jim. Since
he has new work to contribute, however, he now syncs:

<pre class="smallexample">     $ mtn sync
</pre>
   <p>Now Jim and Abe will be aware of the fork. Jim sees it when he sits
down at his desk and asks monotone for the current set of heads of
the branch:

<pre class="smallexample">     $ mtn heads
     mtn: branch 'jp.co.juicebot.jb7' is currently unmerged:
     39969614e5a14316c7ffefc588771f491c709152 abe@juicebot.co.jp 2004-10-26T02:53:16
     8b41b5399a564494993063287a737d26ede3dee4 beth@juicebot.co.jp 2004-10-26T02:53:15
</pre>
   <p>Clearly there are two heads to the branch: it contains an un-merged
fork. Beth will not yet know about the fork, but in this case it
doesn't matter: anyone can merge the fork, and since there are no
conflicts Jim does so himself:

<pre class="smallexample">     $ mtn merge
     mtn: starting with revision 1 / 2
     mtn: merging with revision 2 / 2
     mtn: [source] 39969614e5a14316c7ffefc588771f491c709152
     mtn: [source] 8b41b5399a564494993063287a737d26ede3dee4
     mtn: common ancestor 70decb4b31a8227a629c0e364495286c5c75f979 abe@juicebot.co.jp  2004-10-26T:02:50:01 found
     mtn: trying 3-way merge
     mtn: [merged] da499b9d9465a0e003a4c6b2909102ef98bf4e6d
     mtn: your workspaces have not been updated
</pre>
   <p>The output of this command shows Jim that two heads were found,
combined via a 3-way merge with their ancestor, and saved to a new
revision. This happened automatically, because the changes between the
common ancestor and heads did not conflict. If there had been a
conflict, monotone would have invoked an external merging tool to help
resolve it.

   <p>After merging, the branch has a single head again, and Jim updates
his workspace.

<pre class="smallexample">     $ mtn update
     mtn: selected update target da499b9d9465a0e003a4c6b2909102ef98bf4e6d
     mtn: updating src/apple.c to f088e24beb43ab1468d7243e36ce214a559bdc96
     mtn: updating src/banana.c to 5e6622cf5c8805bcbd50921ce7db86dad40f2ec6
     mtn: updated to base revision da499b9d9465a0e003a4c6b2909102ef98bf4e6d
</pre>
   <p>The update command selected an update target &mdash; in this case the newly merged
head &mdash; and performed an in-memory merge between Jim's workspace
and the chosen target. The result was then written to Jim's workspace. If
Jim's workspace had any uncommitted changes in it, they would have been
merged with the update in exactly the same manner as the merge of multiple
committed heads.

   <p>Monotone makes very little distinction between a &ldquo;pre-commit&rdquo; merge
(an update) and a &ldquo;post-commit&rdquo; merge. Both sorts of merge use the
exact same algorithm. The major difference concerns the recoverability
of the pre-merge state: if you commit your work first, and merge after
committing, then even if the merge somehow fails (due to difficulty in a
manual merge step, for instance), your committed state is still safe. 
If you update, on the other hand, you are requesting that monotone
directly modify your workspace, and while monotone will try hard not
to break anything, this process is inherently more open to error.  It is
therefore recommended that you commit your work <em>first</em>, before
merging.

   <p>If you have previously used another version control system, this may at
first seem surprising; there are some systems where you are
<em>required</em> to update, and risk the above problems, before you can
commit.  Monotone, however, was designed with this problem in mind, and
thus <em>always</em> allows you to commit before merging.  A good rule of
thumb is to only use <samp><span class="command">update</span></samp> in workspaces with no local
modifications, or when you actually want to work against a different
base revision (perhaps because finishing your change turns out to
require some fixes made in another revision, or because you discover
that you have accidentally started working against a revision that
contains unrelated bugs, and need to back out to a working revision for
testing).

<p><a name="Branching-and-Merging"></a>

<h3 class="section">2.12 Branching and Merging</h3>

<p>So by now you're familiar with making changes, sharing them with other
people, and integrating your changes with their changes.  Sometimes,
though, you may want to make some changes, and <em>not</em> integrate them
with other people's &mdash; or at least not right away.  One way to do this
would be to simply never run <samp><span class="command">mtn merge</span></samp>; but it would
quickly become confusing to try and keep track of which changes were in
which revisions.  This is where <em>branches</em> are useful.

   <p>Continuing our example, suppose that Jim is so impressed by Beth's work
on banana juice support that he assigns her to work on the JuiceBot 7's
surprise new feature: muffins.  In the mean time, Abe will continue
working on the JuiceBot's basic juice-related functions.

   <p>The changes required to support muffins are somewhat complicated, and
Beth is worried that her work might destabilize the program, and
interfere with Abe's work.  In fact, she isn't even sure her first
attempt will turn out to be the right approach; she might work on it for
a while and then decide it was a bad idea, and should be discarded.  For
all these reasons, she decides that she will work on a branch, and then
once she is satisfied with the new code, she will merge back onto the
mainline.

   <p>She decides that since main development is in branch
<code>jp.co.juicebot.jb7</code>, she will use branch
<code>jp.co.juicebot.jb7.muffins</code>.  So, she makes the first few edits to
the new muffins code, and commits it on a new branch by simply passing
<samp><span class="option">--branch</span></samp> to commit:

<pre class="smallexample">     $ mtn commit --branch=jp.co.juicebot.jb7.muffins --message='autobake framework'
     mtn: beginning commit on branch 'jp.co.juicebot.jb7.muffins'
     mtn: committed revision d33caefd61823ecbb605c39ffb84705dec449857
</pre>
   <p>That's all there is to it &mdash; there is now a
<code>jp.co.juicebot.jb7.muffins</code> branch, with her initial checkin on
it.  She can make further checkins from the same workspace, and they
will automatically go to the muffins branch; if anyone else wants to
help her work on muffins, they can check out that branch as usual.

   <p>Of course, while Beth is working on the new muffins code, Abe is still
making fixes to the main line.  Occasionally, Beth wants to integrate
his latest work into the muffins branch, so that her version doesn't
fall too far behind.  She does this by using the <samp><span class="command">propagate</span></samp>
command:

<pre class="smallexample">     $ mtn propagate jp.co.juicebot.jb7 jp.co.juicebot.jb7.muffins
     mtn: propagating jp.co.juicebot.jb7 -&gt; jp.co.juicebot.jb7.muffins
     mtn: [source] da003f115752ac6e4750b89aaca9dbba178ac80c
     mtn: [target] d0e5c93bb61e5fd25a0dadf41426f209b73f40af
     mtn: common ancestor 853b8c7ac5689181d4b958504adfb5d07fd959ab jim@juicebot.co.jp 2004-10-26T:12:44:23 found
     mtn: trying 3-way merge
     mtn: [merged] 89585b3c5e51a5a75f5d1a05dda859c5b7dde52f
</pre>
   <p>The <samp><span class="command">propagate</span></samp> merges all of the new changes on one branch onto
another.

   <p>When the muffins code is eventually stable and ready to be integrated
into the main line of development, she simply propagates the other way:

<pre class="smallexample">     $ mtn propagate jp.co.juicebot.jb7.muffins jp.co.juicebot.jb7
     mtn: propagating jp.co.juicebot.jb7.muffins -&gt; jp.co.juicebot.jb7
     mtn: [source] 4e48e2c9a3d2ca8a708cb0cc545700544efb5021
     mtn: [target] bd29b2bfd07644ab370f50e0d68f26dcfd3bb4af
     mtn: common ancestor 652b1035343281a0d2a5de79919f9a31a30c9028 jim@juicebot.co.jp 2004-10-26T:15:25:05 found
     mtn: [merged] 03f7495b51cc70b76872ed019d19dee1b73e89b6
</pre>
   <p>Monotone always records the full history of all merges, and is designed
to handle an arbitrarily complicated graph of changes.  You can make a
branch, then branch off from that branch, propagate changes between
arbitrary branches, and so on; monotone will track all of it, and do
something sensible for each merge.  Of course, it is still probably a
good idea to come up with some organization of branches and a plan for
which should be merged to which other ones.  Monotone may keep track of
graphs of arbitrary complexity &mdash; but you will have more trouble. 
Whatever arrangement of branches you come up with, though, monotone
should be able to handle it.

   <p>If you are unsure of the name of a branch, you can list all branches using
the <samp><span class="command">ls branches</span></samp> command.  This is very useful, but if you create
a lot of branches then the list can become very long and unwieldy.  To help
this monotone has the <samp><span class="command">suspend</span></samp> command which partially hides
revisions/branches you are no longer using.  Further commits on hidden branches
will automatically unhide the branches.

   <p>For example, if Beth is now finished with the muffins branch, she can stop
it from cluttering the list of branches by suspending the last revision in
that branch:

<pre class="smallexample">     $ mtn ls branches
     jp.co.juicebot.jb7
     jp.co.juicebot.jb7.muffins
     $ mtn heads
     mtn: branch 'jp.co.juicebot.jb7.muffins' is currently merged:
     4e48e2c9a3d2ca8a708cb0cc545700544efb5021 beth@juicebot.co.jp 2007-07-08T02:17:37
     $ mtn suspend 4e48e2c9a3d2ca8a708cb0cc545700544efb5021
     $ mtn ls branches
     jp.co.juicebot.jb7
</pre>
   <p><a name="Network-Service-Revisited"></a>

<h3 class="section">2.13 Network Service Revisited</h3>

<p>Up until now, Jim has been using his laptop and database as a sort of
&ldquo;central server&rdquo; for the company; Abe and Beth have been syncing with
Jim, and learning of each other's work via Jim's database.  This has
worked fine while the product has been in early development; Jim has
good network connectivity in Japan, and has been staying home
concentrating on programming.  He has been able to leave his laptop
connected and running all the time, while his employees in different
time-zones work and sync their databases.  This is now starting to
change, and two problems are starting to cause occasional difficulties.

     <ul>
<li>First, Jim is finding that he has to spend more of his time
travelling, demonstrating the new juicebot features to customers; thus
his laptop is spending more time disconnected from the network, or
connected at dynamic addresses where it's not convenient for Abe and
Beth to find him and sync.

     <p>This doesn't prevent them doing any work, but it does have some
uncomfortable consequences: they're more likely to have to manually
merge conflicting changes when they finally sync up and discover they've
both come up with slightly different fixes for the same bug in the
meantime, and they're more exposed to loss of work if one of them
suffers a disk failure before they've had a chance to sync that work
with another database.

     <li>Second, because Jim has been using the one database file both for his
own local work, and for serving to the others in the team, he
occasionally finds that the monotone serve process (busy syncing with
Abe or Beth) has a lock on the database, while he's trying to do local
work like updates or commits.

     <p>The level of project activity is picking up, and there are more and more
changes to be synced in the narrower window of time while Jim is
connected. He finds he sometimes needs to take down the server process
to do this local work, further exacerbating the first problem. 
</ul>

   <p>The juicebot team are resourceful, and by now quite used to working
independently.  While Jim has been away travelling, Abe and Beth have
come up with their own solution to the first problem: they'll run
servers from their databases, setting them up just like Jim did
previously.  That way, if Jim's database is offline, either Beth or Abe
can run the <samp><span class="command">serve</span></samp> command and provide access for the other to
<samp><span class="command">sync</span></samp> with.  Beth also has the idea to create a second database
for the <samp><span class="command">serve</span></samp> process, and to <samp><span class="command">sync</span></samp> her development
database with that server locally, avoiding locking contention between
multiple monotone processes on the one database file.

   <p>When Jim reappears, the next person to <samp><span class="command">sync</span></samp> with him will
often pass him information about both employees' work that they've
sync'ed with each other in the meantime, just as he used to do. In fact,
Jim now finds it more convenient to initiate the sync with one of the
other servers when he has a spare moment and dynamic connectivity from a
hotel room or airport.  Changes will flow between servers automatically
as clients access them and trade with one another.

   <p>This gets them by for a while, but there are still occasional
inconveniences.  Abe and Beth live in very different time-zones, and
don't always have reliable network connectivity, so sometimes Jim finds
that neither of them is online to sync with when he has the chance.  Jim
now also has several customers interested in beta-testing the new code,
and following changes as the bugs and issues they report are addressed.

   <p>Jim decides it's time for a permanent server they can all sync with;
this way, everyone always knows where to go to get the latest changes,
and people can push their changes out without first calling their
friends and making sure that they have their servers running.

   <p>Jim has rented some web server space on a service provider's shared
system for the JuiceBot Inc. public website, <code>www.juicebot.co.jp</code>;
he thinks this server will be a good place to host the central monotone
server too. He sets up a new monotone database on the server,
generates a new key specially for the server (so he doesn't have to
expose his own development private key on the shared system), and loads
in the team-members' keys:

<pre class="smallexample">     $ mtn --db=server.mtn db init
     $ mtn genkey monotone-server@www.juicebot.co.jp
     mtn: generating key-pair 'monotone-server@www.juicebot.co.jp'
     enter passphrase for key ID [monotone-server@www.juicebot.co.jp] : <i>&lt;Jim enters a new passphrase&gt;</i>
     confirm passphrase for key ID [monotone-server@www.juicebot.co.jp]: <i>&lt;Jim confirms the passphrase&gt;</i>
     mtn: storing key-pair 'monotone-server@www.juicebot.co.jp' in /home/jim/.monotone/keys
     $ cat abe.pubkey beth.pubkey jim.pubkey | mtn --db=server.mtn read
     mtn: read 3 packets
</pre>
   <p>For the team members, he sets up the permissions files on the server
much like before &mdash; except that of course he needs to also grant his
<code>jim@juicebot.co.jp</code> key permission to access the new server.  For
the beta-testers, Jim wants to allow them read-only access just to the
main JuiceBot 7 development line, but not to any of the sub-branches
where other experimental development is going on. He adds some lines at
the top of the <samp><span class="file">~/.monotone/read-permissions</span></samp> on the server, above
the broader permissions given to team-members. See the <a href="#Hook-Reference">Hook Reference</a> for <code>get_netsync_read_permitted</code> for more details; the
resulting file looks like this:

<pre class="smallexample">     comment "Provide beta-testers with specific read-only access"
     pattern "jp.co.juicebot.jb7"
     allow "beta1@juicebot.co.jp"
     allow "beta2@juicebot.co.jp"
     continue "true"
     
     comment "Fall-through, and allow staff access to all branches"
     pattern "*"
     allow "abe@juicebot.co.jp"
     allow "beth@juicebot.co.jp"
     allow "jim@juicebot.co.jp"
</pre>
   <p>Jim could log in and start the monotone process manually from his shell
account on the server, perhaps under a program like screen to let it
stay running while he's away. This would be one way of giving it the
server-key's passphrase each startup, but he wants to make sure that the
server is up all the time; if the host reboots while he's travelling and
the monotone server is down until he next logs in, things aren't much
better than before.  For the server to start automatically each time,
he'll need to use the <code>get_passphrase</code> hook in the server's
<samp><span class="file">monotonerc</span></samp> file again.

   <p>Because he's running on a shared server, Jim needs to be a little more
restrictive about which interfaces and addresses his new server process
will listen on. He should only accept connections at the address used
for his website, because some of the provider's other customers might
also want to publish their own monotone projects on this host.  Jim uses
the <samp><span class="option">--bind=</span><var>address</var><span class="option">:</span><var>port</var></samp> argument like so:

<pre class="smallexample">     $ mtn --db=server.mtn --bind=www.juicebot.co.jp serve
</pre>
   <p>This will start monotone listening on the default port (4691), but only
on the IP address associated with <code>www.juicebot.co.jp</code>.  Jim can do
this because his hosting provider has given him a dedicated IP address
for his website.  If the hosting provider offered only a single shared
IP address belonging to the server, each customer could bind a different
port number on that address.

   <p>While he's first testing the setup, Jim uses
<samp><span class="option">--bind=localhost:1234</span></samp>. This causes the monotone process to listen
only to port 1234 on the loopback interface 127.0.0.1, which is not
accessible from the network, so Jim doesn't expose an open port to the
rest of the world until he's satisfied with the permissions
configuration.  You can cause monotone to listen on all interfaces on
port 1234 by leaving out the address part like <samp><span class="option">--bind=:1234</span></samp>.

   <p>When he's satisfied the server is set up correctly, Jim does an initial
<samp><span class="command">sync</span></samp> with the new database, filling it with all the revision
history currently on his laptop. While Jim has been busy setting up the
server, Abe and Beth have kept working; the server will catch up with
their latest changes when they next sync, too.

   <p>All of the team members now want to sync with the new monotone server by
default.  Previously, they had been syncing with Jim's laptop by
default, even if they occasionally specified another team-member's
server on the command line when Jim was away, because monotone had
remembered the first server and branch patterns used in database
<a href="#Vars">Vars</a>.  These vars can be seen as follows:

<pre class="smallexample">     $ mtn list vars
     database: default-exclude-pattern
     database: default-include-pattern jp.co.juicebot.jb7*
     database: default-server jim-laptop.juicebot.co.jp
     known-servers: jim-laptop.juicebot.co.jp 9e9e9ef1d515ad58bfaa5cf282b4a872d8fda00c
     known-servers: abe-laptop.juicebot.co.jp a2bb16a183247af4133621f7f5aefb21a9d13855
     known-servers: www.juicebot.co.jp 120a99ch93b4f174432c13d3e3e9f2234aa92612
</pre>
   <p>The team members can reset their local database vars accordingly:

<pre class="smallexample">     $ mtn set database default-server www.juicebot.co.jp
</pre>
   <p>With their new server, the juicebot team have gained the convenience of
a readily available common point of reference for syncs.  However, they
also know that this is there only as a convenience, and doesn't prevent
them working as they did before:
     <ul>
<li>The team members can still sync with each other if needed.

     <p>Hopefully, their new server won't ever be down, but sometimes they might
be working together while away from ready network access &mdash; fixing up
the last few issues and finalising presentation materials while
travelling to a sales conference, for example.  The server will learn of
these changes on the next sync. 
<li>The team members continue to discover multiple heads and changes that
need merging, as before. Each team member can merge the heads, and will
produce the same revision id if they merge to the same result.

     <p>They now develop a new habit out of courtesy, though &mdash; they try not to
leave multiple heads and unmerged changes on the server, at least not
for long. This saves them from repeating work, and also helps prevent
confusion for the beta-testers.  When each team member is ready to
<samp><span class="command">sync</span></samp>, they develop the habit of doing a <samp><span class="command">pull</span></samp> from
the server first.  If new revisions were received from the server, they
first <samp><span class="command">merge</span></samp> their new revisions with the head(s) from the
server, and finally <samp><span class="command">sync</span></samp> to publish their merged changes as
one.  If the last <samp><span class="command">sync</span></samp> happens to pull in new revisions again
from the server, it means someone else has deposited new work at the
same time, and another <samp><span class="command">merge</span></samp> and <samp><span class="command">sync</span></samp> would probably
be polite. 
<li>Jim knows he doesn't have to keep a special backup of the new server's
contents; if the server should fail, all the contents of its database
can be found amongst the other team members (especially because no
commits are done on the server itself).

     <p>He does, however, take a copy of the server's private key, so he can
restore that if necessary. 
<li>In fact, Jim realises that he can now commit a copy of the web site's
current contents into monotone on a new branch,
<code>jp.co.juicebot.www</code>, and keep a backup of that content too.

     <p>Now he can use monotone to work on the website offline, and let other
team members add and edit the content; he can also preview changes
locally before updating the production content.  He keeps a workspace
checkout of this content in the webroot on the server, and runs a
monotone <samp><span class="command">update</span></samp> in there when he wants to bring the public web
site up to date. Later, he'll think about using monotone's <a href="#Quality-Assurance">Quality Assurance</a> mechanisms and Event Notification <a href="#Hooks">Hooks</a>, so that the
web server can update itself automatically when appropriate new
revisions are received. 
<li>Jim also knows that even if someone should break into the shared hosting
server and tamper with the database, they won't be able to inject
malicious code into the project, because all revisions are signed by the
team members, and he has set his <a href="#Trust-Evaluation-Hooks">Trust Evaluation Hooks</a> so he
doesn't trust the server key for signing revisions.

     <p>In monotone, the important trust consideration is on the <em>signed
content</em>, rather than on the <em>replication path</em> by which that
content arrived in your database. 
</ul>

<p><a name="Advanced-Uses"></a>

<h2 class="chapter">3 Advanced Uses</h2>

<p>This chapter covers slightly less common aspects of using
monotone. Some users of monotone will find these helpful, though
possibly not all. We assume that you have read through the taxonomy
and tutorial, and possibly spent some time playing with the program to
familiarize yourself with its operation.

<p><a name="Other-Transports"></a>

<h3 class="section">3.1 Other Transports</h3>

<p>Monotone's database synchronization system is based on a protocol
called netsync. By default, monotone transports this protocol over a
plain TCP connection, but this is not the only transport monotone can
use. It can also transport netsync through SSH, or any program which
can provide a full-duplex connection over <code>stdio</code>.

   <p>When a monotone client initiates a push, pull, or sync operation, it
parses the first command-line argument as a URI and calls a Lua hook
to convert that URI into a <dfn>connection command</dfn>. If the Lua hook
returns a connection command, monotone spawns the command locally and
speaks netsync over a pipe connected to the command's standard I/O
handles.

   <p>If the Lua hook does not return a connection command, monotone
attempts to parse the command-line argument as a TCP address &ndash; a
hostname with an optional port number &ndash; connects a TCP socket the
host and port, and speaks netsync over the socket.

   <p>By default, monotone understands two URI schemes:

     <ol type=1 start=1>
<li>SSH URIs, of the form
  <code>ssh://[</code><var>user</var><code>@]</code><var>hostname</var><code>[:</code><var>port</var><code>]/</code><var>path/to/db.mtn</var>,
  to synchronize between private databases on hosts accessible only
  through SSH.  (These paths are absolute; to refer to a path relative
  to a home directory, use
  <code>ssh://</code><var>host-part</var><code>/~/</code><var>relative/path.mtn</var> or
  <code>ssh://</code><var>host-part</var><code>/~</code><var>user</var><code>/</code><var>relative/path.mtn</var>.) 
<li>File URIs, of the form
  <code>file:</code><var>/path/to/db.mtn</var>, to synchronize between local databases.
        </ol>

   <p><code>ssh:</code> and <code>file:</code> are currently not supported on the native
Win32 platform; they are supported on Cygwin and all other platforms.

   <p>In the case of SSH URIs, the <samp><span class="command">ssh</span></samp> program must be in your
command execution path, either <var>$PATH</var> on Unix-like systems or
<var>%PATH%</var> on Windows systems. Monotone will execute <samp><span class="command">ssh</span></samp>
as a subprocess, running <samp><span class="command">mtn serve</span></samp> on the other end of the
SSH connection. You will need <samp><span class="command">mtn</span></samp> to be in the command
execution path of the remote shell environment.

   <p>In the case of File URIs, <samp><span class="command">mtn</span></samp> is run locally, so must be
in your command execution path.

   <p>In both cases, the database specified in the URI needs to exist already,
and will be locked for the duration of the synchronization
operation. Therefore, it must also be writable, even when monotone isn't
going to modify it, as it is the case for <samp><span class="command">pull</span></samp>.  Also note
that monotone's default transport authentication is <em>disabled</em> over
these transports, to reduce the complexity of configuration and
eliminate redundant protocol cost.

   <p>Additional URI schemes can be supported by customization of the Lua
hooks <code>get_netsync_connect_command</code> and
<code>use_transport_auth</code>. For details on these hooks, see
<a href="#Netsync-Transport-Hooks">Netsync Transport Hooks</a>.

<p><a name="Selectors"></a>

<h3 class="section">3.2 Selectors</h3>

<p>Revisions can be specified on the monotone command line, precisely, by
entering the entire 40-character hexadecimal <span class="sc">sha1</span> code. This can
be cumbersome, so monotone also allows a more general syntax called
&ldquo;selectors&rdquo; which is less precise but more &ldquo;human friendly&rdquo;. Any
command which expects a precise revision ID can also accept a selector
in its place; in fact a revision ID is just a special type of selector
which is very precise.

<h3 class="heading">Simple examples</h3>

<p>Some selector examples are helpful in clarifying the idea:

     <dl>
<dt><code>a432</code><dd>Revision IDs beginning with the string <code>a432</code>
<br><dt><code>graydon@pobox.com/2004-04</code><dd>Revisions written by <code>graydon@pobox.com</code> in April 2004. 
<br><dt><code>"jrh@example.org/2 weeks ago"</code><dd>Revisions written by <code>jrh@example.org</code> 2 weeks ago. 
<br><dt><code>graydon/net.venge.monotone.win32/yesterday</code><dd>Revisions in the <code>net.venge.monotone.win32</code> branch, written by
<code>graydon</code>, yesterday. 
</dl>

   <p>A moment's examination reveals that these specifications are &ldquo;fuzzy&rdquo;
and indeed may return multiple values, or may be ambiguous. When
ambiguity arises, monotone will inform you that more detail is
required, and list various possibilities. The precise specification
of selectors follows.

<h3 class="heading">Selectors in detail</h3>

<p>A selector is a combination of a selector type, which is a single
ASCII character, followed by a <code>:</code> character and a selector
string. All selectors strings except for selector type <code>c</code>
are just values. The value is matched against identifiers or certs,
depending on its type, in an attempt to match a single revision. 
Selectors are matched as prefixes. The current set of selection
types are:

     <dl>
<dt>Generic cert selector<dd>Uses selector type <code>c</code>.  The selector string has the syntax
<var>name</var> or <var>name</var><code>=</code><var>value</var>.  The former syntax will
select any revision that has a cert with that name, regardless of
value; the latter will match any revision that has a cert with that
name and value.  Values to match for can have shell wildcards.  For
example, <code>c:tag</code> matches all revisions that have a tag, and
<code>c:tag=monotone-0.25</code> will match the revision tagged
<code>monotone-0.25</code>.  (See also the <code>t</code> selector below.) 
<br><dt>Author selection<dd>Uses selector type <code>a</code>. For example, <code>a:graydon</code> matches
<code>author</code> certs where the cert value contains <code>graydon</code>. 
<br><dt>Branch selection<dd>Uses selector type <code>b</code>. For example, <code>b:net.venge.monotone</code> matches
<code>branch</code> certs where the cert value is <code>net.venge.monotone</code>. 
Values to match for can have shell wildcards.  If you give a bare <code>b:</code>
monotone will require you to be in a workspace, and will use the branch
value recorded in your _MTN/options file. 
<br><dt>Heads selection<dd>Uses selector type <code>h</code>. For example, <code>h:net.venge.monotone</code> matches
<code>branch</code> certs where the cert value is <code>net.venge.monotone</code> and
the associated revision is a head revision on that branch.  Values to match
for can have shell wildcards like the branch selector.  If you give a bare
<code>h:</code> monotone will require you to be in a workspace, and use the branch
recorded in your _MTN/options file. 
<br><dt>Date selection<dd>Uses selector type <code>d</code>. For example, <code>d:2004-04</code> matches
<code>date</code> certs where the cert value begins with
<code>2004-04</code>. This selector also accepts expanded date syntax (see below). 
<br><dt>"Earlier or equal than" selection<dd>Uses selector type <code>e</code>. For example, <code>e:2004-04-25</code> matches
<code>date</code> certs where the cert value is less or equal than
<code>2004-04-25T00:00:00</code>. If the time component is unspecified,
monotone will assume 00:00:00. This selector also accepts expanded date
syntax (see below)
<br><dt>"Later than" selection<dd>Uses selector type <code>l</code>. For example, <code>l:2004-04-25</code> matches
<code>date</code> certs where the cert value is strictly greater than
<code>2004-04-25T00:00:00</code>. If the time component is unspecified,
monotone will assume 00:00:00. This selector also accepts expanded date
syntax (see below)
<br><dt>Identifier selection<dd>Uses selector type <code>i</code>. For example, <code>i:0f3a</code> matches
revision IDs which begin with <code>0f3a</code>. 
<br><dt>Parent selection<dd>Uses selector type <code>p</code>. For example, <code>p:0f3a</code> matches the
revision IDs which are the parent of the revision ID which begins with
<code>0f3a</code>. If you give a bare <code>p:</code>, monotone will require you to be in
a workspace, and query the parent of the base workspace revision. 
<br><dt>Tag selection<dd>Uses selector type <code>t</code>. For example, <code>t:monotone-0.11</code> matches
<code>tag</code> certs where the cert value begins with <code>monotone-0.11</code>. 
Values to match for can have shell wildcards. 
</dl>

   <p>Further selector types may be added in the future.

<h3 class="heading">Composite selectors</h3>

<p>Selectors may be combined with the <code>/</code> character. The combination
acts as database intersection (or logical <code>and</code>). For example,
the selector <code>a:graydon/d:2004-04</code> can be used to select a
revision which has an <code>author</code> cert beginning with <code>graydon</code>
<em>as well as</em> a <code>date</code> cert beginning with <code>2004-04</code>. The
<code>/</code> character can be escaped using the <code>\</code> character if necessary.

<h3 class="heading">Selector expansion</h3>

<p>Before selectors are passed to the database, they are expanded using a
Lua hook: <code>expand_selector</code>. The default definition of this hook
attempts to guess a number of common forms for selection, allowing you
to omit selector types in many cases. For example, the hook guesses
that the typeless selector <code>jrh@example.org</code> is an author
selector, due to its syntactic form, so modifies it to read
<code>a:jrh@example.org</code>. This hook will generally assign a selector
type to values which &ldquo;look like&rdquo; partial hex strings, email
addresses, branch names, or date specifications. For the complete
source code of the hook, see <a href="#Hook-Reference">Hook Reference</a>.

<h3 class="heading">Expanding dates</h3>

<p>All date-related selectors (<code>d</code>, <code>e</code>, <code>l</code>) support an
English-like syntax similar to CVS.  This syntax is expanded to the
numeric format by a Lua hook: <code>expand_date</code>. 
The allowed date formats are:
     <dl>
<dt>now<dd>Expands to the current date and time. 
<br><dt>today<dd>Expands to today's date. <code>e</code> and <code>l</code> selectors assume time 00:00:00
<br><dt>yesterday<dd>Expands to yesterday's date. <code>e</code> and <code>l</code> selectors assume
time 00:00:00
<br><dt>&lt;number&gt; {minute|hour} &lt;ago&gt;<dd>Expands to today date and time, minus the specified <code>number</code> of
minutes|hours. 
<br><dt>&lt;number&gt; {day|week|month|year} &lt;ago&gt;<dd>Expands to today date, minus the specified <code>number</code> of
days|weeks|months|years. <code>e</code> and <code>l</code> selectors assume time
00:00:00
<br><dt>&lt;year&gt;-&lt;month&gt;[-day[Thour:minute:second]]<dd>Expands to the supplied year/month. The day and time component are
optional. If missing, <code>e</code> and <code>l</code> selectors assume the first
day of month and time 00:00:00. 
The time component, if supplied, must be complete to the second. 
</dl>

   <p>For the complete source code of the hook, see <a href="#Hook-Reference">Hook Reference</a>.

<h3 class="heading">Typeless selection</h3>

<p>If, after expansion, a selector still has no type, it is matched as a
special &ldquo;unknown&rdquo; selector type, which will match either a tag, an
author, or a branch. This costs slightly more database access, but
often permits simple selection using an author's login name and a
date. For example, the selector
<code>graydon/net.venge.monotone.win32/yesterday</code> would pass through
the selector <code>graydon</code> as an unknown selector; so long as there
are no branches or tags beginning with the string <code>graydon</code> this
is just as effective as specifying <code>a:graydon</code>.

<p><a name="Restrictions"></a>

<h3 class="section">3.3 Restrictions</h3>

<p>Several monotone commands accept optional <var>pathname...</var> arguments in
order to establish a &ldquo;restriction&rdquo;.  Restrictions are used to limit
the files and directories these commands examine for changes when
comparing the workspace to the revision it is based on. Restricting a
command to a specified set of files or directories simply ignores
changes to files or directories not included by the restriction.

   <p>The following commands all support restrictions using optional
<var>pathname...</var> arguments:

     <ul>
<li><samp><span class="command">status</span></samp>
<li><samp><span class="command">diff</span></samp>
<li><samp><span class="command">revert</span></samp>
<li><samp><span class="command">commit</span></samp>
<li><samp><span class="command">list known</span></samp>
<li><samp><span class="command">list unknown</span></samp>
<li><samp><span class="command">list ignored</span></samp>
<li><samp><span class="command">list missing</span></samp>
<li><samp><span class="command">list changed</span></samp>
</ul>

   <p>Including either the old or new name of a renamed file or directory will
cause both names to be included in a restriction. If in doubt, the
<samp><span class="command">status</span></samp> command can be used to &ldquo;test&rdquo; a set of pathnames to
ensure that the expected files are included or excluded by a
restriction.

   <p>Commands which support restrictions also support the
<samp><span class="option">--depth=</span><var>n</var> </samp> option, where <var>n</var> specifies the maximum
number of directories to descend. For example, <var>n</var>=0 disables
recursion, <var>n</var>=1 means descend at most one directory, and so on.

   <p>The <samp><span class="command">update</span></samp> command does not allow for updates to a
restricted set of files, which may be slightly different than other
version control systems. Partial updates don't really make sense in
monotone, as they would leave the workspace based on a revision that
doesn't exist in the database, starting an entirely new line of
development.

<h3 class="heading">Subdirectory restrictions</h3>

<p>The restrictions facility also allows commands to operate from within a
subdirectory of the workspace.  By default, the <i>entire workspace</i> is
always examined for changes. However, specifying an explicit "." 
pathname to a command will restrict it to the current subdirectory. 
Note that this is quite different from other version control systems and
may seem somewhat surprising.

   <p>The expectation is that requiring a single "." to restrict to the
current subdirectory should be simple to use. While the alternative,
defaulting to restricting to the current subdirectory, would require a
somewhat complicated ../../.. sequence to remove the restriction and
operate on the whole tree.

   <p>This default was chosen because monotone versions whole project trees
and generally expects to commit all changes in the workspace as a
single atomic unit. Other version control systems often version
individual files or directories and may not support atomic commits at
all.

   <p>When working from within a subdirectory of the workspace all
paths specified to monotone commands must be relative to the current
subdirectory.

<h3 class="heading">Finding a workspace</h3>

<p>Monotone only stores a single <samp><span class="file">_MTN</span></samp> directory at the root of a
workspace. Because of this, a search is done to find the <samp><span class="file">_MTN</span></samp>
directory in case a command is executed from within a subdirectory of a
workspace. Before a command is executed, the search for a workspace
directory is done by traversing parent directories until an
<samp><span class="file">_MTN</span></samp> directory is found or the filesystem root is reached. Upon
finding an <samp><span class="file">_MTN</span></samp> directory, the <samp><span class="file">_MTN/options</span></samp> file is read for
default options. The <samp><span class="option">--root</span></samp> option may be used to stop the
search early, before reaching the root of the physical filesystem.

   <p>Many monotone commands don't require a workspace and will simply
proceed with no default options if no <samp><span class="file">_MTN</span></samp> directory is found. 
However, some monotone commands do require a workspace and will fail
if no <samp><span class="file">_MTN</span></samp> directory can be found.

   <p>The <samp><span class="command">checkout</span></samp>, <samp><span class="command">clone</span></samp> and <samp><span class="command">setup</span></samp> commands
create a <i>new workspace</i> and initialize a new <samp><span class="file">_MTN/options</span></samp>
file based on their current option settings.

<p><a name="Scripting"></a>

<h3 class="section">3.4 Scripting</h3>

<p>People often want to write programs that call monotone &mdash; for example,
to create a graphical interface to monotone's functionality, or to
automate some task.  For most programs, if you want to do this sort of
thing, you just call the command line interface, and do some sort of
parsing of the output.  Monotone's output, however, is designed for
humans: it's localized, it tries to prompt the user with helpful
information depending on their request, if it detects that something
unusual is happening it may give different output in an attempt to make
this clear to the user, and so on.  As a result, it is not particularly
suitable for programs to parse.

   <p>Rather than trying to design output to work for both humans and
computers, and serving neither audience well, we elected to create a
separate interface to make programmatically extracting information from
monotone easier.  The command line interface has a command
<samp><span class="command">automate</span></samp>; this command has subcommands that print various sorts
of information on standard output, in simple, consistent, and easily
parseable form.

   <p>For details of this interface, see <a href="#Automation">Automation</a>.

<p><a name="Inodeprints"></a>

<h3 class="section">3.5 Inodeprints</h3>

<p>Fairly often, in order to accomplish its job, monotone has to look at
your workspace and figure out what has been changed in it since your
last commit.  Commands that do this include <samp><span class="command">status</span></samp>,
<samp><span class="command">diff</span></samp>, <samp><span class="command">update</span></samp>, <samp><span class="command">commit</span></samp>, and others.  There
are two different techniques it can use to do this.  The default, which
is sufficient for most projects, is to simply read every file in the
workspace, compute their <span class="sc">sha1</span> hash, and compare them to the
hashes monotone has stored.  This is very safe and reliable, and turns
out to be fast enough for most projects.  However, on very large
projects, ones whose source trees are many megabytes in size, it can
become unacceptably slow.

   <p>The other technique, known as <em>inodeprints</em>, is designed for this
situation.  When running in inodeprints mode, monotone does not read the
whole workspace; rather, it keeps a cache of interesting information
about each file (its size, its last modification time, and so on), and
skips reading any file for which these values have not changed.  This is
inherently somewhat less safe, and, as mentioned above, unnecessary for
most projects, so it is disabled by default.

   <p>If you do determine that it is necessary to use inodeprints with your
project, it is simple to enable them.  Simply run <samp><span class="command">mtn
refresh_inodeprints</span></samp>; this will enable inodeprints mode and generate an
initial cache.  If you ever wish to turn them off again, simply delete
the file <samp><span class="file">_MTN/inodeprints</span></samp>.  You can at any time delete or truncate
the <samp><span class="file">_MTN/inodeprints</span></samp> file; monotone uses it only as a cache and
will continue to operate correctly.

   <p>Normally, instead of enabling this up on a per-workspace basis, you
will want to simply define the <code>use_inodeprints</code> hook to return
<code>true</code>; this will automatically enable inodeprints mode in any new
workspaces you create.  See <a href="#Hook-Reference">Hook Reference</a> for details.

<p><a name="Merge-Conflicts"></a>

<h3 class="section">3.6 Merge Conflicts</h3>

<p>Several different types of conflicts may be encountered when merging
two revisions using the database merge commands <samp><span class="command">merge</span></samp>,
<samp><span class="command">explicit_merge</span></samp>, <samp><span class="command">propagate</span></samp> and
<samp><span class="command">merge_into_dir</span></samp> or when using the workspace merge commands
<samp><span class="command">update</span></samp>, <samp><span class="command">pluck</span></samp> and <samp><span class="command">merge_into_workspace</span></samp>. 
The <samp><span class="command">show_conflicts</span></samp> command can be used to list conflicts
between database revisions which would be encountered by the database
merge commands. Unfortunately, this command can't yet list conflicts
between a database revision and the current workspace revision which
would be encountered by the workspace merge commands.

<h4 class="subsection">3.6.1 Conflict Types</h4>

<p>Monotone versions both files and directories explicitly and it tracks
individual file and directory identity from birth to death so that
name changes throughout the full life-cycle can be tracked exactly. 
Partly because of these qualities, monotone also notices several types
of conflicts that other version control systems may not.

   <p>The two most common conflicts are described first, then all other
possible conflicts.

<h4 class="subheading">File Content Conflict</h4>

<p>This type of conflict is generally the one encountered most commonly
and represents conflicting changes made to lines of text within two
versions of a single file.

   <p>Monotone does not generally use CVS style conflict markers for content
conflicts. Instead it makes the content of both conflicting files and
the content of their common ancestor available for use with your
favorite merge tool. See the <code>merge3</code> hook for more information.

   <p>Alternatively, rather than using a merge tool it is possible to make
further changes to one or both of the conflicting file versions so
that they will merge cleanly. This can also be a very helpful strategy
if the merge conflicts are due to sections of text in the file being
moved from one location to another. Rather than struggling to merge
such conflicting changes with a merge tool, similar rearrangements can
be made to one of the conflicting files before redoing the merge.

<h4 class="subheading">Duplicate Name Conflict</h4>

<p>A duplicate name conflict occurs when two distinct files or
directories have been given the same name in the two merge parents. 
This can occur when each of the merge parents adds a new file or
directory with the conflicting name, or when one parent adds a new
file or directory with the conflicting name and the other renames an
existing file or directory to the conflicting name, or when both
parents rename an existing file or directory to the conflicting name.

   <p>In earlier versions of monotone (before version 0.39) this type of
conflict was referred to as a <em>rename target conflict</em> although
it doesn't necessarily have anything to do with renames.

   <p>There are two main situations in which duplicate name conflicts occur:

     <ul>
<li>Two people both realize a new file should be added, and commit it. In
this case, the files have the right name and the right contents, but
monotone reports a conflict because they were added separately.

     <li>Two people each decide to add new files with different content, and
accidently pick the same name. 
</ul>

   <p>These conflicts are reported when someone tries to merge the two
revisions containing the new files.

<h5 class="subsubheading">Same file</h5>

<p>For the first case, the conflict is resolved by <samp><span class="command">drop</span></samp>ing one
file. The contents should be manually merged first, in case they are
slightly different. Typically, a user will have one of the files in
their current workspace; the other can be retrieved via
<samp><span class="command">automate get_file_of</span></samp>; the revision id is shown in the merge
error message. The process can be confusing; here's a detailed
example.

   <p>Suppose Beth and Abe each commit a new file <samp><span class="file">checkout.sh</span></samp>. When
Beth attempts to merge the two heads, she gets a message like:

<pre class="smallexample">     mtn: 2 heads on branch 'testbranch'
     mtn: [left]  ae94e6677b8e31692c67d98744dccf5fa9ccffe5
     mtn: [right] dfdf50b19fb971f502671b0cfa6d15d69a0d04bb
     mtn: conflict: duplicate name 'checkout.sh'
     mtn: added as a new file on the left
     mtn: added as a new file on the right
     mtn: error: merge failed due to unresolved conflicts
</pre>
   <p>The file labeled <code>right</code> is the file in Beth's workspace. To
retrieve a copy of Abe's file, Beth executes:

<pre class="smallexample">     mtn automate get_file_of checkout.sh \
     --revision=ae94e6677b8e31692c67d98744dccf5fa9ccffe5 \
     &gt; checkout.sh-merge
</pre>
   <p>Now Beth manually merges (using her favorite merge tool)
<samp><span class="file">checkout.sh</span></samp> and <samp><span class="file">checkout.sh-merge</span></samp>, leaving the results in
<samp><span class="file">checkout.sh-merge</span></samp> (<em>not</em> in her copy).

   <p>Then Beth drops her copy, and commits that change:

<pre class="smallexample">     mtn drop checkout.sh
     mtn commit --message "resolving conflicting 'checkout.sh'"
</pre>
   <p>Now Beth can merge the two heads, and update her workspace:

<pre class="smallexample">     mtn merge
     mtn update
</pre>
   <p>This leaves a copy of Abe's original <samp><span class="file">checkout.sh</span></samp>. Beth
overwrites it with her merged version, and commits again:

<pre class="smallexample">     rm checkout.sh
     mv checkout.sh-merge checkout.sh
     mtn commit --message "resolving conflicting 'checkout.sh' - done"
</pre>
   <p>When Abe later syncs and updates, he will get the merged version.

<h5 class="subsubheading">Different files</h5>

<p>The second case, where two different files accidently have the same
name, is resolved by renaming one or both of them.

   <p>Suppose Beth and Abe each start working on different thermostat models
(say Honeywell and Westinghouse), but they both name the file
<samp><span class="file">thermostat</span></samp>. When Beth attempts to merge, she will get the same
error message as in the first case. When she retrieves Abe's file, she
will see that they should be different files. So she renames her file,
merges, and updates:

<pre class="smallexample">     mtn rename thermostat thermostat-honeywell
     mtn merge
     mtn update
</pre>
   <p>Now she has her file in <samp><span class="file">thermostat-honeywell</span></samp>, and Abe's in
<samp><span class="file">thermostat</span></samp>. She may rename Abe's file to
<samp><span class="file">thermostat-westinghouse</span></samp>, or ask Abe to do that.

   <p>If a project has a good file naming convention, this second case
should be rare.

<h4 class="subheading">Missing Root Conflict</h4>

<p>Monotone's merge strategy is sometimes referred to as
<em>die-die-die</em> merge, with reference to the fact that when a file
or directory is deleted there is no means of resurrecting it. Merging
the deletion of a file or directory will <em>always</em> result in that
file or directory being deleted.

   <p>A missing root conflict occurs when some directory has been moved to
the root directory in one of the merge parents and has been deleted in
the other merge parent. Because of die-die-die merge the result will
not contain the directory that has been moved to the root.

   <p>Missing root conflicts should be very rare because it is unlikely that
a project's root directory will change. It is even more unlikely that
a project's root directory will be changed to some other directory in
one merge parent and that this directory will also be deleted in the
other merge parent. Even still, a missing root directory conflict can
be easily resolved by moving another directory to the root in the
merge parent where the root directory was previously changed. Because
of die-die-die merge, no change to resolve the conflict can be made to
the merge parent that deleted the directory which was moved to the
root in the other merge parent.

   <p>See the <samp><span class="command">pivot_root</span></samp> command for more information on moving
another directory to the project root.

<h4 class="subheading">Invalid Name Conflict</h4>

<p>Monotone reserves the name <samp><span class="file">_MTN</span></samp> in a workspace root directory
for internal use and treats this name as <em>illegal</em> for a
versioned file or directory in the project root. This name is
<em>legal</em> for a versioned file or directory as long as it is not in
the project root directory.

   <p>An invalid name conflict occurs when some directory is moved to the
project root in one of the merge parents and a file or directory that
exists in this new root directory is renamed to <samp><span class="file">_MTN</span></samp> or a new
file or directory is added with the name <samp><span class="file">_MTN</span></samp> to this directory
in the other merge parent.

   <p>Invalid name conflicts should be very rare because it is unlikely that
a project's root directory will change. It is even more unlikely that
a project's root directory will change and the new root directory will
contain a file or directory named <samp><span class="file">_MTN</span></samp>. Even still, an invalid
name conflict can be easily resolved in several different ways. A
different root directory can be chosen, the offending <samp><span class="file">_MTN</span></samp> file
or directory can be renamed or deleted, or it can be moved to some
other subdirectory in the project.

   <p>See the <samp><span class="command">pivot_root</span></samp> command for more information on moving
another directory to the project root.

<h4 class="subheading">Directory Loop Conflict</h4>

<p>A directory loop conflict occurs when one directory is moved under a
second in one of the merge parents and the second directory is moved
under the first in the other merge parent.

   <p>Directory loop conflicts should be rare but can be easily resolved by
moving one of the conflicting directories out from under the other.

<h4 class="subheading">Orphaned Node Conflict</h4>

<p>An orphaned node conflict occurs when a directory and all of its
contents are deleted in one of the merge parents and further files or
directories are added to this deleted directory, or renamed into it,
in the other merge parent.

   <p>Orphaned node conflicts do happen occasionally but can be easily
resolved by renaming the orphaned files or directories out of the
directory that has been deleted and into another directory that exists
in both merge parents, or that has been added in the revision
containing the orphaned files or directories.

<h4 class="subheading">Multiple Name Conflict</h4>

<p>A multiple name conflict occurs when a single file or directory has
been renamed to two different names in the two merge parents. 
Monotone does not allow this and requires that each file and directory
has exactly one unique name.

   <p>Multiple name conflicts do happen occasionally but can be easily
resolved by renaming the conflicting file or directory in one or both
of the merge parents so that both agree on the name.

   <p>In earlier versions of monotone (those before version 0.39) this type
of conflict was referred to as a <em>name conflict</em>.

<h4 class="subheading">Attribute Conflict</h4>

<p>An attribute conflict occurs when a versioned attribute on a file or
directory is set to two different values by the two merge parents or
if one of the merge parents changes the attribute's value and the
other deletes the attribute entirely.

   <p>Attribute conflicts may happen occasionally but can be easily resolved
by ensuring that the attribute is set to the same value or is deleted
in both of the merge parents. Attributes are <em>not</em> merged using
the die-die-die rules and may be resurrected by simply setting their
values.

<h4 class="subsection">3.6.2 Conflict Resolution</h4>

<p>Resolving the different types of conflicts is accomplished by checking
out one of the conflicting revisions, making changes as described
above, committing these changes as a new revision and then running the
merge again using this new revision as one of the merge parents. This
process can be repeated as necessary to get two revisions into a state
where they will merge cleanly, or with a minimum of file content
conflicts.

<p><a name="Workspace-Collisions"></a>

<h3 class="section">3.7 Workspace Collisions</h3>

<p>Sometimes when you work on a project, several people make similar
changes in parallel.  When these changes occur in an existing file that
is known to both sides, monotone can merge the edits when the two
revisions meet (possibly after getting help to resolve content
conflicts).  Other kinds of changes cannot be merged so readily,
especially ones that involve files in your workspace that are not
tracked by monotone.

   <p>Workspace collisions can happen for many reasons; some examples include:
     <ul>
<li>You have a file in your workspace that is unknown to monotone (you
have not <samp><span class="command">add</span></samp>ed it).  Someone else has <samp><span class="command">add</span></samp>ed and
<samp><span class="command">commit</span></samp>ed a different file with the same name.  If you try to
<samp><span class="command">update</span></samp> your workspace to their revision, the added file in the
incoming revision will collide with your file over use of the name. 
<li>There is a directory which contains both versioned and unversioned files
(perhaps versioned sources, and unversioned object files built from the
sources).  Someone else <samp><span class="command">commit</span></samp>s a revision that
<samp><span class="command">drop</span></samp>s the versioned files <em>and</em> the containing
directory.  If you try to <samp><span class="command">update</span></samp> to this revision, your
directory will still contain the untracked files, and therefore cannot
be deleted. 
<li>You have an unversioned file in your workspace, and you're trying to
<samp><span class="command">update</span></samp> to a revision that <samp><span class="command">add</span></samp>s a directory with the
same name. 
</ul>

   <p>These examples describe collisions on <samp><span class="command">update</span></samp>; the same kinds
of things can happen with other commands that can bring changes into
your workspace, such as <samp><span class="command">checkout</span></samp> or <samp><span class="command">pluck</span></samp> too.

   <p>Monotone is careful to avoid hitting such collisions. Before changing
the workspace, it will try and detect the possibility of collisions, and
the command will fail, warning you about the names that collide.  The
file content in the database is safe and can be recovered at any time,
so monotone is conservative and will refuse to destroy the information
in your workspace contents.

   <p>However, monotone cannot detect all kinds of failures and collisions in
your workspace. For example:
     <ul>
<li>On some systems with case-insensitive and/or internationalised
filesystems, names that look distinct to monotone may in fact be
considered the same by the underlying platform. 
<li>If some other program is creating files in the workspace at the same
time as monotone, the colliding file might be created after the
collision check at the start. 
<li>Other kinds of unpredictable system errors, like permissions problems or
disk full conditions, might cause failures when monotone is rearranging
the workspace content. 
</ul>

   <p>These are all hopefully very rare occurrences. If such a filesystem
error <em>does</em> cause a failure part-way during a workspace
alteration, monotone will stop immediately rather than risk potentially
doing further damage, and your workspace may be left in an incomplete
state.  If this happens, you will need to resolve the issue and clean up
the workspace manually.  If you need to do so, understanding how
monotone manipulates the workspace is helpful.

   <p>When monotone applies renaming changes to the workspace, each file is
first <dfn>detached</dfn> from the workspace under its old name, then
<dfn>attached</dfn> under the new name. This is done by moving it to the
<samp><span class="file">_MTN/detached</span></samp> directory. Newly added files are created here
before being moved into place, too.  While inside <samp><span class="file">_MTN/detached</span></samp>,
the file or directory is named as a simple integer (these numbers come
from monotone's internal identification of the node).  If the detached
node is a directory, the directory is moved with all of its contents
(including unversioned files); this can help identify which directory
has been detached.

   <p>If a previous workspace alteration failed part-way, the
<samp><span class="file">_MTN/detached</span></samp> directory will still exist, and monotone will
refuse to attempt another alteration while the workspace is in this
inconsistent state. This also acts as a lock against multiple monotone
processes performing workspace alterations (but not other programs).

   <p>The best way to avoid a messy recovery from such a failure is simply to
ensure that you always <samp><span class="command">commit</span></samp> before trying to
<samp><span class="command">update</span></samp> (or <samp><span class="command">pluck</span></samp>, etc) other changes from the
database into your workspace. This ensures that your current workspace
contents are safely stored, and can be retrieved later (such as with
<samp><span class="command">revert</span></samp>).

<p><a name="Quality-Assurance"></a>

<h3 class="section">3.8 Quality Assurance</h3>

<p>Monotone was constructed to serve both as a version control tool and
as a quality assurance tool. The quality assurance features permit
users to ignore, or &ldquo;filter out&rdquo;, versions which do not meet their
criteria for quality. This section describes the way monotone
represents and reasons about quality information.

   <p>Monotone often views the collection of revisions as a directed graph,
in which revisions are the nodes and changes between revisions are the
edges. We call this the <dfn>revision graph</dfn>. The revision graph has a
number of important subgraphs, many of which overlap. For example,
each branch is a subgraph of the revision graph, containing only the
nodes carrying a particular <code>branch</code> cert.

   <p>Many of monotone's operations involve searching the revision graph for
the ancestors or descendants of a particular revision, or extracting
the &ldquo;heads&rdquo; of a subgraph, which is the subgraph's set of nodes with
no descendants. For example, when you run the <samp><span class="command">update</span></samp> command,
monotone searches the subgraph consisting of descendants of the base
revision of the current workspace, trying to locate a unique head to
update the base revision to.

   <p>Monotone's quality assurance mechanisms are mostly based on
restricting the subgraph each command operates on. There are two
methods used to restrict the subgraph:

     <ul>
<li>By restricting the set of trusted <code>branch</code> certificates, you
can require that specific code reviewers have approved of each edge in
the subgraph you focus on. 
<li>By restricting the set of trusted <code>testresult</code> certificates, you
can require that the <em>endpoints</em> of an update operation have a
certificate asserting that the revision in question passed a certain
test, or testsuite. 
</ul>

   <p>The evaluation of trust is done on a cert-by-cert basis by calling a
set of Lua hooks: <code>get_revision_cert_trust</code>,
<code>get_manifest_cert_trust</code> and <code>get_file_cert_trust</code>. These
hooks are only called when a cert has at least one good signature from
a known key, and are passed <em>all</em> the keys which have signed the
cert, as well as the cert's ID, name and value. The hook can then
evaluate the set of signers, as a group, and decide whether to grant
or deny trust to the assertion made by the cert.

   <p>The evaluation of testresults is controlled by the
<code>accept_testresult_change</code> hook. This hook is called when
selecting update candidates, and is passed a pair of tables describing
the <code>testresult</code> certs present on the source and proposed
destination of an update. Only if the change in test results are
deemed &ldquo;acceptable&rdquo; does monotone actually select an update target
to merge into your workspace.

   <p>For details on these hooks, see the <a href="#Hook-Reference">Hook Reference</a>.

<p><a name="Vars"></a>

<h3 class="section">3.9 Vars</h3>

<p>Every monotone database has a set of <em>vars</em> associated with it. 
Vars are simple configuration variables that monotone refers to in some
circumstances; they are used for configuration that monotone needs to be
able to modify itself, and that should be per-database (rather than
per-user or per-workspace, both of which are supported by
<samp><span class="file">monotonerc</span></samp> scripts).  Vars are local to a database, and never
transferred by netsync.

   <p>A var is a <em>name</em> = <em>value</em> pairing inside a <em>domain</em>. 
Domains define what the vars inside it are used for; for instance, one
domain might contain database-global settings, and particular vars
inside it would define things like that database's default netsync
server.  Another domain might contain key fingerprints for servers that
monotone has interacted with in the past, to detect man-in-the-middle
attacks; the vars inside this domain would map server names to their
fingerprints.

   <p>You can set vars with the <samp><span class="command">set</span></samp> command, delete them with the
<samp><span class="command">unset</span></samp> command, and see them with the <samp><span class="command">ls vars</span></samp>
command.  See the documentation for these specific commands for more
details.

<h3 class="heading">Existing vars</h3>

<p>There are several pre-defined domains that monotone knows about:

     <dl>
<dt><code>database</code><dd>Contains database-global configuration information.  Defined names are:
          <dl>
<dt><code>default-exclude-pattern</code><dd>The default branch exclusion glob pattern for netsync operations to
use. Automatically set by first use of netsync, and by any netsync
that uses the <samp><span class="option">--set-default</span></samp> option. 
<br><dt><code>default-include-pattern</code><dd>The default branch glob pattern for netsync operations to use. 
Automatically set by first use of netsync, and by any netsync that
uses the <samp><span class="option">--set-default</span></samp> option. 
<br><dt><code>default-server</code><dd>The default server for netsync operations to use.  Automatically set
by first use of netsync, and by any netsync that uses the
<samp><span class="option">--set-default</span></samp> option. 
</dl>

     <br><dt><code>known-servers</code><dd>Contains key hashes for servers that we have netsynced with in the
past.  Analogous to <samp><span class="command">ssh</span></samp>'s <samp><span class="file">known_hosts</span></samp> file, this is
needed to detect man-in-the-middle attacks.  Automatically set the first
time you netsync with any given server.  If that server's key later
changes, monotone will notice, and refuse to connect until you have run
<samp><span class="command">mtn unset known-servers </span><var>server-name</var></samp>.

   </dl>

<p><a name="Reserved-Files"></a>

<h3 class="section">3.10 Reserved Files</h3>

<p>A monotone workspace consists of control files and non-control
files. Each type of file can be versioned or non-versioned. These
classifications lead to four groups of files:

     <ul>
<li>versioned control files
<li>non-versioned control files
<li>versioned non-control files
<li>non-versioned non-control files
</ul>

   <p>Control files contain special content formatted for use by
monotone. Versioned files are recorded in a monotone database and have
their state tracked as they are modified.

   <p>If a control file is versioned, it is considered <em>part of</em> the
state of the workspace, and will be recorded as a manifest
entry. If a control file is not versioned, it is used to <em>manage</em>
the state of the workspace, but it not considered an intrinsic part
of it.

   <p>Most files you manage with monotone will be versioned non-control
files. For example, if you keep source code or documents in a monotone
database, they are versioned non-control files. Non-versioned,
non-control files in your workspace are generally temporary or junk
files, such as backups made by editors or object files made by
compilers. Such files are ignored by monotone.

<h3 class="heading">Identifying control files</h3>

<p>Control files are identified by their names. Non-control files can
have any name <em>except</em> the names reserved for control files. The
names of control files follow a regular pattern:

     <dl>
<dt>Versioned control files<dd>Any file name beginning with <samp><span class="file">.mtn-</span></samp>
<br><dt>Non-versioned control files<dd>Any file in the directory <samp><span class="file">_MTN/</span></samp>
</dl>

   <p>The general intention is that versioned control files are things that
you may want to edit directly.  In comparison, you should never have
to edit non-versioned control files directly; monotone should do that
for you whenever it is appropriate.  However, both are documented
here, just in case a situation arises where you need to go &ldquo;under the
hood&rdquo;.

<h3 class="heading">Existing control files</h3>

<p>The following control files are currently used. More control files may be added
in the future, but they will follow the patterns given above.

     <dl>
<dt><samp><span class="file">.mtn-ignore</span></samp><dd>Contains a list of regular expression patterns, one per line. If it exists,
any file with a name matching one of these patterns is
ignored. See <a href="#Regexps">Regexps</a>, for the syntax of these regular expressions. 
<br><dt><samp><span class="file">_MTN/wanted-testresults</span></samp><dd>Contains a list of testresult key names, one per line. If it exists, update
will only select revisions that do not have regressions according to the given
testresult keys. 
<br><dt><samp><span class="file">_MTN/revision</span></samp><dd>Contains the identity of the &ldquo;base&rdquo; revision of the workspace, and a
list of additions, deletions, and renames which have occurred in the
current workspace, relative to that version.

     <p>Every workspace has a base revision, which is the revision that was
originally checked out to create that workspace.  When the workspace
is committed, the base revision is considered to be the ancestor of
the committed revision. 
<br><dt><samp><span class="file">_MTN/options</span></samp><dd>Contains &ldquo;sticky&rdquo; command-line options such as <samp><span class="option">--db</span></samp> or
<samp><span class="option">--branch</span></samp>, such that you do not need to enter them repeatedly
after checking out a particular workspace. 
<br><dt><samp><span class="file">_MTN/log</span></samp><dd>Contains log messages to append to the &ldquo;changelog&rdquo; cert upon
commit. The user may add content to this file while they work.  Upon a
successful commit monotone will empty the file making it ready for the
next edit/commit cycle. 
<br><dt><samp><span class="file">_MTN/inodeprints</span></samp><dd>If this file exists, monotone considers the directory to be in
<a href="#Inodeprints">Inodeprints</a> mode, and uses this file to cache the inodeprints. 
<br><dt><samp><span class="file">_MTN/debug</span></samp><dd>If monotone detects a bug in itself or crashes, then before exiting it
dumps a log of its recent activity to this file, to aid in debugging. 
</dl>

<p><a name="Reserved-Certs"></a>

<h3 class="section">3.11 Reserved Certs</h3>

<p>Every certificate has a name. Some names have meaning which is built
in to monotone, others may be used for customization by a particular
user, site, or community. If you wish to define custom certificates,
you should prefix such certificate names with <code>x-</code>. For example,
if you want to make a certificate describing the existence of security
vulnerabilities in a revision, you might wish to create a certificate
called <code>x-vulnerability</code>.  Monotone reserves all names which do
not begin with <code>x-</code> for possible internal use. If an <code>x-</code>
certificate becomes widely used, monotone will likely adopt it as a
reserved cert name and standardize its semantics.

   <p>Most reserved certificate names have no meaning yet; some do. Usually
monotone is also responsible for <em>generating</em> many of these certs
as part of normal operation, such as during a <samp><span class="command">commit</span></samp>. Others
will be added explicitly via other commands, like <samp><span class="command">tag</span></samp> or
<samp><span class="command">approve</span></samp>.

   <p>As well as carrying other information, certs (and combinations of certs)
are useful for identifying revisions with <a href="#Selectors">Selectors</a>; in
particular, this is the primary purpose of the <code>tag</code> cert.

   <p>The pre-defined, reserved certificate names are:

     <dl>
<dt><code>author</code><dd>This cert's value is the name of a person who committed the revision
the cert is attached to. The cert is generated when you commit a
revision. It is displayed by the <samp><span class="command">log</span></samp> command.

     <br><dt><code>branch</code><dd>This cert's value is the name of a branch. A <code>branch</code> cert
associates a revision with a branch. The revision is said to be &ldquo;in
the branch&rdquo; named by the cert. The cert is generated when you commit
a revision, either directly with the <samp><span class="command">commit</span></samp> command or
indirectly with the <samp><span class="command">merge</span></samp> or <samp><span class="command">propagate</span></samp> commands. The
<code>branch</code> certs are read and directly interpreted by <em>many</em>
monotone commands, and play a fundamental role in organizing work in
any monotone database.

     <br><dt><code>changelog</code><dd>This cert's value is the change log message you provide when you
commit a revision. It is displayed by the <samp><span class="command">log</span></samp> command.

     <br><dt><code>comment</code><dd>This cert's value is an additional comment, usually provided after
committing, about a revision. Certs with the name <code>comment</code> will be
shown together with <code>changelog</code> certs by the <samp><span class="command">log</span></samp> command.

     <br><dt><code>date</code><dd>This cert's value is an ISO date string indicating the time at which a
revision was committed. It is displayed by the <samp><span class="command">log</span></samp> command, and
may be used as an additional heuristic or selection criterion in other
commands in the future.

     <br><dt><code>suspend</code><dd>This cert's value is the name of a branch (see the <code>branch</code> cert). 
This cert is generated by the <samp><span class="command">suspend</span></samp> command.  A suspended
revision is removed from the list of head revisions of a branch in most
cases.  A branch with all its heads suspended will not appear in the
list of branches.  Suspended revisions can still have children, and those
children are in no way affected by the suspend cert on their parent.

     <br><dt><code>tag</code><dd>This cert's value is a symbolic name given to a revision, which may be
used as a way of selecting the revision by name for later commands like
<samp><span class="command">checkout</span></samp>, <samp><span class="command">log</span></samp> or <samp><span class="command">diff</span></samp>.

     <br><dt><code>testresult</code><dd>This cert's value is interpreted as a boolean string, either <code>0</code>
or <code>1</code>. It is generated by the <samp><span class="command">testresult</span></samp> command and
represents the results of running a particular test on the underlying
revision. Typically you will make a separate signing key for each test
you intend to run on revisions. This cert influences the
<samp><span class="command">update</span></samp> algorithm.

   </dl>

<p><a name="Naming-Conventions"></a>

<h3 class="section">3.12 Naming Conventions</h3>

<p>Some names in monotone are private to your work, such as
filenames. Other names are potentially visible outside your project,
such as <span class="sc">rsa</span> key identifiers or branch names. It is possible that if
you choose such names carelessly, you will choose a name which someone
else in the world is using, and subsequently you may cause confusion
when your work and theirs is received simultaneously by some third
party.

   <p>We therefore recommend two naming conventions:

     <ul>
<li>For <span class="sc">rsa</span> keys, use the name of an active email address you
own. This will minimize conflicts, and also serves as a mnemonic to
associate your personal <em>identity</em> with signatures made with your
key. For example, monotone's primary author uses the key identifier
<code>graydon@pobox.com</code>.

     <li>For branch names, select any name you like but prefix it with the
&ldquo;inverted domain name&rdquo; of a DNS domain you control or are otherwise
authorized to use. This behavior mimics the package naming convention
in the java programming language. For example, monotone itself is
developed within the <code>net.venge.monotone</code> branch, because the
author owns the DNS domain <code>venge.net</code>. 
</ul>

<p><a name="File-Attributes"></a>

<h3 class="section">3.13 File Attributes</h3>

<p>Monotone contains a support for storing <dfn>persistent attributes</dfn> on
files and directories, generally known as <dfn>attrs</dfn> for short.  An
attr associates a simple name/value pair with a file or directory, and
is stored in the manifest.  Attrs are first-class versioned data; they
can be changed in a workspace, and those changes will be saved when
the workspace is committed.  The merger knows how to intelligently
merge attrs.

   <p>The attribute mechanism was originally motivated by the fact that some
people like to store executable programs in version control systems,
and would like the programs to remain executable when they check out a
workspace.  For example, the <samp><span class="command">configure</span></samp> shell script commonly
shipped with many programs should be executable.  Similarly, some
people would like to store devices, symbolic links, read-only files,
and all manner of extra attributes of a file, not directly related to
a file's data content.

   <p>Monotone comes with support for some attrs built-in; for instance, if
an executable file is given to <samp><span class="command">mtn add</span></samp>, then it will
automatically mark the new file with a <code>mtn:execute</code> attr, and
when the file is checked out later, the executable bit will be set
automatically.  (Of course, if it is checked out on Windows, which
does not support the executable bit, then the executable bit will not
be set.  However, monotone will still know that the attr is set, and
Windows users can view and modify the attr like anyone else.)

   <p>Attrs in the current workspace can be seen and modified using the
<samp><span class="command">mtn attr</span></samp> command; see <a href="#Workspace">Workspace</a>.  Attrs can also be found
by examining any manifest directly.

   <p>You can tell monotone to automatically take actions based on these
attributes by defining hooks; see the <code>attr_functions</code> entry in
<a href="#Hook-Reference">Hook Reference</a>.  Every time your workspace is written to,
monotone will run the corresponding hooks registered for each attr in
your workspace.  This way, you can extend the vocabulary of attrs
understood by monotone simply by writing new hooks.

   <p>You can make up your own attrs for anything you find useful; the
mechanism is fully general.  (If you make up some particularly useful
ones, we may even be interested in adding support to monotone proper.) 
We only ask that if you do use custom attrs, you use some prefix for
them besides <code>mtn:</code>; attrs beginning with <code>mtn:</code> are
reserved for monotone's own use.

<p><a name="Merging"></a>

<h3 class="section">3.14 Merging</h3>

<p>Monotone has two merging modes, controlled by the <code>manual_merge</code>
attribute. 
By default all files are merged in automatic mode, unless the
<code>manual_merge</code> attribute for that file is present and
<code>true</code>. 
In automatic mode files are merged without user intervention, using
monotone's internal three-way merging algorithm. 
Only if there are conflicts or an ancestor is not available monotone
switches to manual mode, essentially escalating the merging to the user. 
When working in manual mode, monotone invokes the <code>merge3</code> hook
to start an user defined external merge tool. 
If the tool terminates without writing the merged file, monotone aborts the
merging, reverting any changes made. 
By redefining the aforementioned hooks the user can not only choose a
preferred merge tool, but even select different programs for different
file types.  For example, gimp for .png files, OpenOffice.org for
.doc, and so on. 
Starting with monotone 0.20, the <code>manual_merge</code> attribute is
automatically set at add time for all &ldquo;binary&rdquo; files, i.e. all files
for which the <code>binary_file</code> hook returns true. 
Currently, this means all files with extension gif, jpeg, png, bz2, gz
and zip, plus files containing at least one of the following
bytes:

<pre class="smallexample">     0x00 thru 0x06
     0x0E thru 0x1a
     0x1c thru 0x1f
</pre>
   <p>The attribute could also be manually forced or removed using the
appropriate monotone commands. 
Remember that monotone switches to manual merging even if only one of
the files to be merged has the <code>manual_merge</code> attribute set.

<p><a name="Migrating-and-Dumping"></a>

<h3 class="section">3.15 Migrating and Dumping</h3>

<p>While the state of your database is logically captured in terms of a
packet stream, it is sometimes necessary or desirable (especially
while monotone is still in active development) to modify the SQL table
layout or storage parameters of your version database, or to make
backup copies of your database in plain text. These issues are not
properly addressed by generating packet streams: instead, you must use
<dfn>migration</dfn> or <dfn>dumping</dfn> commands.

   <p>The <samp><span class="command">mtn db migrate</span></samp> command is used to alter the SQL
schema of a database. The schema of a monotone database is identified
by a special hash of its generating SQL, which is stored in the
database's auxiliary tables. Each version of monotone knows which
schema version it is able to work with, and it will refuse to operate
on databases with different schemas. When you run the
<samp><span class="command">migrate</span></samp> command, monotone looks in an internal list of SQL
logic which can be used to perform in-place upgrades. It applies
entries from this list, in order, attempting to change the database it
<em>has</em> into the database it <em>wants</em>. Each step of this
migration is checked to ensure no errors occurred and the resulting
schema hashes to the intended value. The migration is attempted inside
a transaction, so if it fails &mdash; for example if the result of
migration hashes to an unexpected value &mdash; the migration is aborted.

   <p>If more drastic changes to the underlying database are made, such as
changing the page size of SQLite, or if you simply want to keep a
plain text version of your database on hand, the <samp><span class="command">mtn db
dump</span></samp> command can produce a plain ASCII SQL statement which generates
the state of your database. This dump can later be reloaded using the
<samp><span class="command">mtn db load</span></samp> command.

   <p>Note that when reloading a dumped database, the schema of the dumped
database is <em>included</em> in the dump, so you should not try to
<samp><span class="command">init</span></samp> your database before a <samp><span class="command">load</span></samp>.

<p><a name="Importing-from-CVS"></a>

<h3 class="section">3.16 Importing from CVS</h3>

<p>Monotone is capable of reading CVS files directly and importing them
into a database. This feature is still somewhat immature, but
moderately large &ldquo;real world&rdquo; CVS trees on the order of 1GB have
successfully been imported.

   <p>Note however that the machine requirements for CVS trees of this size
are not trivial: it can take several hours on a modern system to
reconstruct the history of such a tree and calculate the millions of
cryptographic certificates involved. We recommend experimenting with
smaller trees first, to get a feel for the import process.

   <p>We will assume certain values for this example which will differ in your case:
     <ul>
<li>Your domain name, <code>example.net</code> in this example. 
<li>Your key name, <code>import@example.net</code> in this example. 
<li>Your project name, <code>wobbler</code> in this example. 
<li>Your database name, <samp><span class="file">test.mtn</span></samp> in this example. 
<li>Your CVS repository path, <samp><span class="file">/usr/local/cvsroot</span></samp> in this example. 
<li>The CVS module name for your project, <code>wobbler</code> in this example. 
</ul>

   <p>Accounting for these differences at your site, the following is an
example procedure for importing a CVS repository &ldquo;from scratch&rdquo;, and
checking the resulting head version of the import out into a workspace:

<pre class="smallexample">     $ mtn --db=test.mtn db init
     $ mtn --db=test.mtn genkey import@example.net
     $ mtn --db=test.mtn --branch=net.example.wobbler cvs_import /usr/local/cvsroot/wobbler
     $ mtn --db=test.mtn --branch=net.example.wobbler checkout wobber-checkout
</pre>
   <p><a name="Using-packets"></a>

<h3 class="section">3.17 Using packets</h3>

<p>Suppose you made changes to your database, and want to send those
changes to someone else but for some reason you cannot use netsync.  Or
maybe you want to extract and inject individual revisions automatically
via an external program. In this case, you can convert the information
into packets. Packets are a convenient way to represent revisions and
other database contents as plain text with wrapped lines &ndash; just what
you need if you want to send them in the body of an email.

   <p>This is a tutorial on how to transfer single revisions between
databases by dumping them from one database to a text file and then
reading the dump into a second database.

   <p>We will create two databases, A and B, then create a few revisions in
A, and transfer part of them to B.

   <p>First we initialize the databases:

<pre class="smallexample">     $ mtn -d A db init
     $ mtn -d B db init
</pre>
   <p>Now set up a branch in A:

<pre class="smallexample">     $ mtn -d A setup -b test test
</pre>
   <p>And let's put some revisions in that branch:

<pre class="smallexample">     $ cd test/
     $ cat &gt; file
     xyz
     ^D
     $ mtn add file
     $ mtn ci -m "One"    <i>You may need to select a key and type a passphrase here</i>
     $ cat &gt; file2
     file 2 getting in
     ^D
     $ cat &gt; file
     ERASE
     ^D
     $ mtn add file2
     $ mtn ci -m "Two"
     $ cat &gt; file
     THIRD
     ^D
     $ mtn ci -m "Three"
</pre>
   <p>OK, that's enough.  Let's see what we have:

<pre class="smallexample">     $ cd ..
     $ mtn -d A automate select i: | mtn -d A automate toposort -
     a423db0ad651c74e41ab2529eca6f17513ccf714
     d14e89582ad9030e1eb62f563c8721be02ca0b65
     151f1fb125f19ebe11eb8bfe3a5798fcbea4e736
</pre>
   <p>Three revisions! Let's transfer the first one to the database B. First we
get the meta-information on that revision:

<pre class="smallexample">     $ mtn -d A automate get_revision a423db0ad651c74e41ab2529eca6f17513ccf714
     format_version "1"
     
     new_manifest [b6dbdbbe0e7f41e44d9b72f9fe29b1f1a4f47f18]
     
     old_revision []
     
     add_dir ""
     
     add_file "file"
      content [8714e0ef31edb00e33683f575274379955b3526c]
</pre>
   <p>OK, one file was added in this revision. We'll transfer it. Now, <em>ORDER MATTERS</em>! 
We should transfer:

     <ol type=1 start=1>
<li>The file data (fdata) and file deltas (fdeltas), if any
<li>The release data (rdata)
<li>The certs
        </ol>

   <p>In that order. This is because certs make reference to release data, and release data
makes reference to file data and file deltas.

<pre class="smallexample">     mtn -d A automate packet_for_fdata 8714e0ef31edb00e33683f575274379955b3526c &gt; PACKETS
     mtn -d A automate packet_for_rdata a423db0ad651c74e41ab2529eca6f17513ccf714 &gt;&gt; PACKETS
     mtn -d A automate packets_for_certs a423db0ad651c74e41ab2529eca6f17513ccf714 &gt;&gt; PACKETS
     mtn -d B read &lt; PACKETS
</pre>
   <p>This revision (a423db0ad651c74e41ab2529eca6f17513ccf714) was already sent to database
B. You may want to check the PACKETS file to see what the packets look like.

   <p>Now let's transfer one more revision:

<pre class="smallexample">     mtn -d A automate get_revision d14e89582ad9030e1eb62f563c8721be02ca0b65
     format_version "1"
     
     new_manifest [48a03530005d46ed9c31c8f83ad96c4fa22b8b28]
     
     old_revision [a423db0ad651c74e41ab2529eca6f17513ccf714]
     
     add_file "file2"
      content [d2178687226560032947c1deacb39d16a16ea5c6]
     
     patch "file"
      from [8714e0ef31edb00e33683f575274379955b3526c]
        to [8b52d96d4fab6c1e56d6364b0a2673f4111b228e]
</pre>
   <p>From what we see, in this revision we have one new file and one patch, so we do the
same we did before for them:

<pre class="smallexample">     mtn -d A automate packet_for_fdata d2178687226560032947c1deacb39d16a16ea5c6 &gt; PACKETS2
     mtn -d A automate packet_for_fdelta 8714e0ef31edb00e33683f575274379955b3526c 8b52d96d4fab6c1e56d6364b0a2673f4111b228e &gt;&gt; PACKETS2
     mtn -d A automate packet_for_rdata d14e89582ad9030e1eb62f563c8721be02ca0b65 &gt;&gt; PACKETS2
     mtn -d A automate packets_for_certs d14e89582ad9030e1eb62f563c8721be02ca0b65 &gt;&gt; PACKETS2
     mtn -d B read &lt; PACKETS2
</pre>
   <p>Fine. The two revisions should be in the second database now. 
Let's take a look at what's in each database:

<pre class="smallexample">     $ mtn -d A automate select i: | mtn -d A automate toposort -
     a423db0ad651c74e41ab2529eca6f17513ccf714
     d14e89582ad9030e1eb62f563c8721be02ca0b65
     151f1fb125f19ebe11eb8bfe3a5798fcbea4e736
     
     $ mtn -d B automate select i: | mtn -d B automate toposort -
     a423db0ad651c74e41ab2529eca6f17513ccf714
     d14e89582ad9030e1eb62f563c8721be02ca0b65
</pre>
   <p>Good! B has the two first revisions (as expected), and A has all three. However, a checkout
of that branch on B will not work, because the certificate signatures cannot be verified. 
We need to transfer the signatures too (suppose the key used had the ID <code>"johndoe@domain.com"</code>):

<pre class="smallexample">     mtn -d A pubkey johndoe@domain.com &gt; KEY_PACKETS
     mtn -d B read &lt; KEY_PACKETS
</pre>
   <p>Done.

<pre class="smallexample">     $ mtn -d B co -b test test-B
     $ ls test-B
     file2  _MTN  x
     $ more test-B/file2
     file 2 getting in
</pre>
   <p>And that's it! The revisions were successfully transferred.

<p><a name="CVS-Phrasebook"></a>

<h2 class="chapter">4 CVS Phrasebook</h2>

<p>This chapter translates common CVS commands into monotone commands. It
is an easy alternative to reading through the complete command
reference.

<h3 class="heading">Checking Out a Tree</h3>

<p><table summary=""><tr align="left"><td valign="top" width="40%">
<pre class="smallexample">     $ CVSROOT=:pserver:cvs.foo.com/wobbler
     $ cvs -d $CVSROOT checkout -r 1.2
</pre>
   <p></td><td valign="top" width="40%">
<pre class="smallexample">     $ mtn pull www.foo.com com.foo.wobbler*
     $ mtn checkout --revision=fe37 wobbler
</pre>
<p><br></td></tr></table>

   <p>The CVS command contacts a network server, retrieves a revision, and
stores it in your workspace. There are two cosmetic differences
with the monotone command: remote databases are specified by hostnames
and globs, and revisions are denoted by <span class="sc">sha1</span> values (or
selectors).

   <p>There is also one deep difference: pulling revisions into your
database is a separate step from checking out a single revision; after
you have pulled from a network server, your database will contain
<em>several</em> revisions, possibly the entire history of a
project. Checking out is a separate step, after communication, which
only copies a particular revision out of your database and into a named
directory.

<h3 class="heading">Committing Changes</h3>

<p><table summary=""><tr align="left"><td valign="top" width="40%">
<pre class="smallexample">     $ cvs commit -m "log message"
</pre>
   <p></td><td valign="top" width="40%">
<pre class="smallexample">     $ mtn commit --message="log message"
     $ mtn push www.foo.com com.foo.wobbler*
</pre>
<p><br></td></tr></table>

   <p>As with other networking commands, the communication step with
monotone is explicit: committing changes only saves them to the local
database. A separate command, <samp><span class="command">push</span></samp>, sends the changes to a
remote database.

<h3 class="heading">Undoing Changes</h3>

<p><table summary=""><tr align="left"><td valign="top" width="40%">
<pre class="smallexample">     $ cvs update -C file
</pre>
   <p></td><td valign="top" width="40%">
<pre class="smallexample">     $ mtn revert file
</pre>
<p><br></td></tr></table>

   <p>Unlike CVS, monotone includes a separate <samp><span class="command">revert</span></samp> command for
undoing local changes and restoring the workspace to the original
contents of the base revision. Because this can be dangerous,
<samp><span class="command">revert</span></samp> insists on an explicit argument to name the files or
directories to be reverted; use the current directory "<samp><span class="file">.</span></samp>" at the
top of the workspace to revert everything.  The <samp><span class="command">revert</span></samp> command
is also used to restore deleted files (with a convenient
<samp><span class="option">--missing</span></samp> option for naming these files).

   <p>In CVS, you would need to use <samp><span class="command">update</span></samp> to restore missing or
changed files, and you might get back a newer version of the file than
you started with. In monotone, <samp><span class="command">revert</span></samp> always takes you back to
where you started, and the <samp><span class="command">update</span></samp> command is only used to move
the workspace to a different (usually newer) base revision.

<h3 class="heading">Incorporating New Changes</h3>

<p><table summary=""><tr align="left"><td valign="top" width="40%">
<pre class="smallexample">     $ cvs update -d
</pre>
   <p></td><td valign="top" width="40%">
<pre class="smallexample">     $ mtn pull www.foo.com com.foo.wobbler*
     $ mtn merge
     $ mtn update
</pre>
<p><br></td></tr></table>

   <p>This command, like other networking commands, involves a separate
communication step with monotone. The extra command, <samp><span class="command">merge</span></samp>,
ensures that the branch your are working on has a unique head. You can
omit the <samp><span class="command">merge</span></samp> step if you only want <samp><span class="command">update</span></samp> to
examine descendants of your base revision, and ignore other heads on
your branch.

<h3 class="heading">Tagging Revisions</h3>

<p><table summary=""><tr align="left"><td valign="top" width="40%">
<pre class="smallexample">     $ cvs tag FOO_TAG .
</pre>
   <p></td><td valign="top" width="40%">
<pre class="smallexample">     $ mtn tag h: FOO_TAG
</pre>
<p><br></td></tr></table>

   <p>With CVS, tags are placed on individual files, and the closest thing to
identifying a consistent repository-wide revision is a set of files with
the same tag.  In monotone, all changes are part of a repository-wide
revision, and some of those revisions may be tagged.  Monotone has no
partial tags that apply only to a subset of files.

<h3 class="heading">Moving Workspace to Another Revision</h3>

<p><table summary=""><tr align="left"><td valign="top" width="40%">
<pre class="smallexample">     $ cvs update -r FOO_TAG -d
</pre>
   <p></td><td valign="top" width="40%">
<pre class="smallexample">     $ mtn update -r 830ac1a5f033825ab364f911608ec294fe37f7bc
     $ mtn update -r t:FOO_TAG
</pre>
<p><br></td></tr></table>

   <p>With a revision parameter, the <samp><span class="command">update</span></samp> command operates
similarly in monotone and CVS. One difference is that a subsequent
<samp><span class="command">commit</span></samp> will be based off the chosen revision in monotone,
while a <samp><span class="command">commit</span></samp> in the CVS case is not possible without going
back to the branch head again.  This version of <samp><span class="command">update</span></samp> can
thus be very useful if, for example, you discover that the tree you are
working against is somehow broken &mdash; you can <samp><span class="command">update</span></samp> to an
older non-broken version, and continue to work normally while waiting
for the tree to be fixed.

<h3 class="heading">Viewing Differences</h3>

<p><table summary=""><tr align="left"><td valign="top" width="40%">
<pre class="smallexample">     $ cvs diff
</pre>
   <p></td><td valign="top" width="40%">
<pre class="smallexample">     $ mtn diff
</pre>
   <p><br></td></tr><tr align="left"><td valign="top" width="40%">
<pre class="smallexample">     $ cvs diff -r 1.2 -r 1.4 myfile
</pre>
   <p></td><td valign="top" width="40%">
<pre class="smallexample">     $ mtn diff -r 3e7db -r 278df myfile
</pre>
<p><br></td></tr></table>

   <p>Monotone's <samp><span class="command">diff</span></samp> command is modeled on that of CVS, so the
main features are the same: <samp><span class="command">diff</span></samp> alone prints the
differences between your workspace and its base revision, whereas
<samp><span class="command">diff</span></samp> accompanied by two revision numbers prints the
difference between those two revisions. The major difference between
CVS and monotone here is that monotone's revision numbers are
<em>revision IDs</em>, rather than file IDs.  If one leaves off the file
argument, then diff can print the difference between two entire trees.

<h3 class="heading">Showing Workspace Status</h3>

<p><table summary=""><tr align="left"><td valign="top" width="40%">
<pre class="smallexample">     $ cvs status
</pre>
   <p></td><td valign="top" width="40%">
<pre class="smallexample">     $ mtn status
</pre>
<p><br></td></tr></table>

   <p>This command operates similarly in monotone and CVS. The only major
difference is that monotone's <samp><span class="command">status</span></samp> command always gives a
status of the whole tree, and outputs a more compact summary than CVS.

<h3 class="heading">Adding Directories and Files to Workspace</h3>

<p><table summary=""><tr align="left"><td valign="top" width="40%">
<pre class="smallexample">     $ cvs add dir
     $ cvs add dir/subdir
     $ cvs add dir/subdir/file.txt
</pre>
   <p></td><td valign="top" width="40%">
<pre class="smallexample">     $ mtn add dir/subdir/file.txt
</pre>
<p><br></td></tr></table>

   <p>Monotone does not explicitly store directories, so adding a file only
involves adding the file's complete path, including any directories. 
Directories are created as needed, and empty directories are ignored.

<h3 class="heading">Removing Directories and Files from Workspace</h3>

<p><table summary=""><tr align="left"><td valign="top" width="40%">
<pre class="smallexample">     $ rm file.txt
     $ cvs remove file.txt
</pre>
   <p></td><td valign="top" width="40%">
<pre class="smallexample">     $ mtn drop file.txt
</pre>
<p><br></td></tr></table>

   <p>Monotone does not require that you erase a file from the workspace
before you drop it. Dropping a file both removes its entry in the
manifest of the current revision and removes it from the filesystem.

<h3 class="heading">Viewing History</h3>

<p><table summary=""><tr align="left"><td valign="top" width="40%">
<pre class="smallexample">     $ cvs log [file]
</pre>
   <p></td><td valign="top" width="40%">
<pre class="smallexample">     $ mtn log [file]
</pre>
<p><br></td></tr></table>

   <p>Unlike CVS log, monotone log can also be used without a workspace; but
in this case you must pass a <samp><span class="option">--from</span></samp> revision argument to tell
monotone where to start displaying the log from.

<h3 class="heading">Importing a New Project</h3>

<p><table summary=""><tr align="left"><td valign="top" width="40%">
<pre class="smallexample">     $ cvs import wobbler vendor start
</pre>
   <p></td><td valign="top" width="40%">
<pre class="smallexample">     $ mtn --db=/path/to/database.mtn --branch=com.foo.wobbler setup .
     $ mtn add .
     $ mtn commit
</pre>
<p><br></td></tr></table>

   <p>The <samp><span class="command">setup</span></samp> command turns an ordinary directory into a
monotone workspace.  After that, you can add your files and commit
them as usual.

<h3 class="heading">Initializing a Repository</h3>

<p><table summary=""><tr align="left"><td valign="top" width="40%">
<pre class="smallexample">     $ cvs init -d /path/to/repository
</pre>
   <p></td><td valign="top" width="40%">
<pre class="smallexample">     $ mtn db init --db=/path/to/database.mtn
</pre>
<p><br></td></tr></table>

   <p>Monotone's &ldquo;repository&rdquo; is a single-file database, which is created
and initialized by this command. This file is only ever used by you,
and does not need to be in any special location, or readable by other
users.

<p><a name="Command-Reference"></a>

<h2 class="chapter">5 Command Reference</h2>

<p>Monotone has a large number of commands. To help navigate through them
all, commands are grouped into logical categories.

<p><a name="Tree"></a>

<h3 class="section">5.1 Tree</h3>

     <dl>
<dt><samp><span class="command">mtn cat </span><var>path</var></samp><a name="index-mtn-cat-_0040var_007bpath_007d-1"></a><dt><samp><span class="command">mtn cat --revision=</span><var>id</var> <var>path</var></samp><a name="index-mtn-cat-_002d_002drevision_003d_0040var_007bid_007d-_0040var_007bpath_007d-2"></a><dd>
Write the contents of a specific file <var>path</var> to standard output.

     <p>Without a <samp><span class="option">--revision</span></samp> argument, the command outputs the
contents of <var>path</var> as found in the current revision. This requires
the command be executed from within a workspace.

     <p>With an explicit <samp><span class="option">--revision</span></samp> argument, the command outputs
contents of <var>path</var> at that revision.

     <br><dt><samp><span class="command">mtn checkout --revision=</span><var>id</var> <var>directory</var></samp><a name="index-mtn-checkout-_002d_002drevision_003d_0040var_007bid_007d-_0040var_007bdirectory_007d-3"></a><dt><samp><span class="command">mtn co --revision=</span><var>id</var> <var>directory</var></samp><a name="index-mtn-co-_002d_002drevision_003d_0040var_007bid_007d-_0040var_007bdirectory_007d-4"></a><dt><samp><span class="command">mtn --branch=</span><var>branchname</var><span class="command"> checkout </span><var>directory</var></samp><a name="index-mtn-_002d_002dbranch_003d_0040var_007bbranchname_007d-checkout-_0040var_007bdirectory_007d-5"></a><dt><samp><span class="command">mtn --branch=</span><var>branchname</var><span class="command"> co </span><var>directory</var></samp><a name="index-mtn-_002d_002dbranch_003d_0040var_007bbranchname_007d-co-_0040var_007bdirectory_007d-6"></a><dd>
These commands copy a revision <var>id</var> out of your database,
recording the chosen revision (the <dfn>base revision</dfn>) in the file
<samp><var>directory</var><span class="file">/_MTN/revision</span></samp>. These commands then copy every
file version listed in the revision's manifest to paths under
<var>directory</var>. For example, if the revision's manifest contains
these entries:

     <pre class="smallexample">          dir ""
          
             file "Makefile"
          content [84e2c30a2571bd627918deee1e6613d34e64a29e]
          
             file "include/hello.h"
          content [c61af2e67eb9b81e46357bb3c409a9a53a7cdfc6]
          
             file "src/hello.c
          content [97dfc6fd4f486df95868d85b4b81197014ae2a84]
</pre>
     <p>Then the following files are created:
     <pre class="smallexample">          <var>directory</var>/
          <var>directory</var>/Makefile
          <var>directory</var>/include/hello.h
          <var>directory</var>/src/hello.c
</pre>
     <p>If you wish to <samp><span class="command">checkout</span></samp> in the current directory, you can
supply the special name <samp><span class="file">.</span></samp> (a single period) for
<var>directory</var>. When running <samp><span class="command">checkout</span></samp> into an existing
directory, it is sometimes possible for <a href="#Workspace-Collisions">Workspace Collisions</a> to
occur.

     <p>If no <var>id</var> is provided, as in the latter two commands, you
<em>must</em> provide a <var>branchname</var>; monotone will attempt to infer
<var>id</var> as the unique head of <var>branchname</var> if it exists.

     <br><dt><samp><span class="command">mtn clone --branch=</span><var>branchname</var> <var>address</var> <var>directory</var></samp><a name="index-mtn-clone-_002d_002dbranch_003d_0040var_007bbranchname_007d-_0040var_007baddress_007d-_0040var_007bdirectory_007d-7"></a><dd>
The clone command is a helper command that performs the roles of a
number of other commands all at once.  Firstly, it constructs a new
database.  It then populates this database by <samp><span class="command">pull</span></samp>ing any data
in the branch <var>branchname</var> from the remote database, <var>address</var>. 
Finally, it copies the files out of the newly created database into a
local directory, just as <samp><span class="command">checkout</span></samp> would.  The created
database is placed in the new workspace as <samp><var>directory</var><span class="file">/_MTN/mtn.db</span></samp>.

     <br><dt><samp><span class="command">mtn disapprove </span><var>id</var></samp><a name="index-mtn-disapprove-_0040var_007bid_007d-8"></a><dd>
This command records a disapproval of the changes between <var>id</var>'s
ancestor and <var>id</var>. It does this by committing the <i>inverse</i>
changes as a new revision descending from <var>id</var>. The new revision
will show up as a new head and thus a subsequent <samp><span class="command">merge</span></samp> will
incorporate the inverse of the disapproved changes in the other head(s).

     <p>Conceptually, <samp><span class="command">disapprove</span></samp>s contract is that disapprove(A) gives a
revision B such that whenever B is merged with a descendant D of A the merge
will result in what D &ldquo;would have looked like&rdquo; if A had never happened.

     <p>Note that as a consequence of this contract the <samp><span class="command">disapprove</span></samp> command
only works if <var>id</var> has exactly one ancestor, since it hasn't been
worked out how to generate such a descendant in the multi-ancestor case.

     <br><dt><samp><span class="command">mtn heads --branch=</span><var>branchname</var></samp><a name="index-mtn-heads-_002d_002dbranch_003d_0040var_007bbranchname_007d-9"></a><dd>This command lists the &ldquo;heads&rdquo; of <var>branchname</var>.

     <p>The &ldquo;heads&rdquo; of a branch is the set of revisions which are members of
the branch, but which have no descendants. These revisions are
generally the &ldquo;newest&rdquo; revisions committed by you or your
colleagues, at least in terms of ancestry. The heads of a branch may
not be the newest revisions, in terms of time, but synchronization of
computer clocks is not reliable, so monotone usually ignores time.

     <br><dt><samp><span class="command">mtn merge [--branch=</span><var>branchname</var><span class="command">]</span></samp><a name="index-mtn-merge-_005b_002d_002dbranch_003d_0040var_007bbranchname_007d_005d-10"></a><dd>This command merges the &ldquo;heads&rdquo; of <var>branchname</var>, if there are
multiple heads, and commits the results to the database, marking the
resulting merged revision as a member of <var>branchname</var>. The merged
revision will contain each of the head revision IDs as ancestors.

     <p>Merging is performed by repeated pairwise merges: two heads are
selected, then their least common ancestor is located in the ancestry
graph and these 3 revisions are provided to the built-in 3-way merge
algorithm. The process then repeats for each additional head, using
the result of each previous merge as an input to the next.

     <br><dt><samp><span class="command">mtn propagate </span><var>sourcebranch</var> <var>destbranch</var></samp><a name="index-mtn-propagate-_0040var_007bsourcebranch_007d-_0040var_007bdestbranch_007d-11"></a><dd>This command takes a unique head from <var>sourcebranch</var> and merges it
with a unique head of <var>destbranch</var>, using the least common
ancestor of the two heads for a 3-way merge. The resulting revision is
committed to <var>destbranch</var>. If
either <var>sourcebranch</var> or <var>destbranch</var> has multiple heads,
<samp><span class="command">propagate</span></samp> aborts, doing nothing.

     <p>The purpose of <samp><span class="command">propagate</span></samp> is to copy all the changes on
<var>sourcebranch</var>, since the last <samp><span class="command">propagate</span></samp>, to
<var>destbranch</var>. This command supports the idea of making separate
branches for medium-length development activities, such as
maintenance branches for stable software releases, trivial bug fix
branches, public contribution branches, or branches devoted to the
development of a single module within a larger project.

     <br><dt><samp><span class="command">mtn explicit_merge </span><var>id</var> <var>id</var> <var>destbranch</var></samp><a name="index-mtn-explicit_005fmerge-_0040var_007bid_007d-_0040var_007bid_007d-_0040var_007bdestbranch_007d-12"></a><dd>This command merges exactly the two <var>id</var>s you give it, and places
the result in branch <var>destbranch</var>.  It is useful when you need more
control over the merging process than <samp><span class="command">propagate</span></samp> or <samp><span class="command">merge</span></samp>
give you.  For instance, if you have a branch with three heads, and you
only want to merge two of them, you can use this command.  Or if you
have a branch with two heads, and you want to propagate one of them to
another branch, again, you can use this command.

     <br><dt><samp><span class="command">mtn merge_into_dir </span><var>sourcebranch</var> <var>destbranch</var> <var>dir</var></samp><a name="index-mtn-merge_005finto_005fdir-_0040var_007bsourcebranch_007d-_0040var_007bdestbranch_007d-_0040var_007bdir_007d-13"></a><dd>This command takes a unique head from <var>sourcebranch</var> and merges it
into a unique head of <var>destbranch</var>, as a directory. The resulting
revision is committed to <var>destbranch</var>. If either <var>sourcebranch</var> or
<var>destbranch</var> has multiple heads, <samp><span class="command">merge_into_dir</span></samp> aborts, doing
nothing.

     <p>The purpose of <samp><span class="command">merge_into_dir</span></samp> is to permit a project to contain
another project in such a way that <samp><span class="command">propagate</span></samp> can be used to keep
the contained project up-to-date. It is meant to replace the use of nested
checkouts in many circumstances.

     <p>Note that <samp><span class="command">merge_into_dir</span></samp> <em>does not</em> permit changes made to the
contained project in <var>destbranch</var> to be propagated back to
<var>sourcebranch</var>. Attempting this would lead to <var>sourcebranch</var> containing
both projects nested as in <var>destbranch</var> instead of only the project
originally in <var>sourcebranch</var>, which is almost certainly not what would be
intended.

     <br><dt><samp><span class="command">mtn import --branch=</span><var>branch</var><span class="command"> [--message=</span><var>message</var><span class="command">] [--dry-run] </span><var>dir</var></samp><a name="index-mtn-import-_002d_002dbranch_003d_0040var_007bbranch_007d-_005b_002d_002dmessage_003d_0040var_007bmessage_007d_005d-_005b_002d_002ddry_002drun_005d-_0040var_007bdir_007d-14"></a><br><dt><samp><span class="command">mtn import --revision=</span><var>revision</var><span class="command"> [--message=</span><var>message</var><span class="command">] [--dry-run] </span><var>dir</var></samp><a name="index-mtn-import-_002d_002drevision_003d_0040var_007brevision_007d-_005b_002d_002dmessage_003d_0040var_007bmessage_007d_005d-_005b_002d_002ddry_002drun_005d-_0040var_007bdir_007d-15"></a><dd>This command imports the contents of the given directory and commits it
to the head of the given branch or as a child of the given revision (and
consequently into the branch that revision resides in).

     <p>If the given branch doesn't exist, it is created automatically.  If the
branch already exists, any missing files are dropped and any unknown
files are added before committing.

     <p>If <samp><span class="command">--dry-run</span></samp> is given, no commit is done. 
</dl>

<p><a name="Workspace"></a>

<h3 class="section">5.2 Workspace</h3>

     <dl>
<dt><samp><span class="command">mtn setup [</span><var>directory</var><span class="command">]</span></samp><a name="index-mtn-setup-_005b_0040var_007bdirectory_007d_005d-16"></a><dd>This command prepares <var>directory</var> as a monotone workspace,
by creating and populating the <samp><span class="file">_MTN</span></samp> directory with basic
information.  This information must include at least the branch and the
database to be used, both of which will be placed in the
<samp><span class="file">_MTN/options</span></samp> file.

     <p>This can be used with an empty directory to start a new blank project,
or within an existing directory full of files, prior to using
<samp><span class="command">mtn commit</span></samp>. If no directory is specified, the current
directory is used.

     <br><dt><samp><span class="command">mtn add </span><var>pathname...</var></samp><a name="index-mtn-add-_0040var_007bpathname_002e_002e_002e_007d-17"></a><br><dt><samp><span class="command">mtn add --unknown</span></samp><a name="index-mtn-add-_002d_002dunknown-18"></a><dd>This command places &ldquo;add&rdquo; entries for the paths specified in
<var>pathname...</var> in the workspace's &ldquo;work list&rdquo;. The work list of
your workspace is stored in <samp><span class="file">_MTN/revision</span></samp>, and is a list of
explicit pathname changes you wish to commit at some future time, such
as addition, removal or renaming of files.

     <p>As a convenience, the <samp><span class="option">--unknown</span></samp> option can be used; this
option will cause all of the files listed by <samp><span class="command">mtn list
unknown</span></samp> to be added.

     <p>While this command places an &ldquo;add&rdquo; entry on your work list, it does
not immediately affect your database. When you <samp><span class="command">commit</span></samp> your
workspace, monotone will use the work list to build a new revision,
which it will then commit to the database. The new revision will have
any added entries inserted in its manifest.

     <br><dt><samp><span class="command">mtn [--no-respect-ignore] mkdir </span><var>directory...</var></samp><a name="index-mtn-_005b_002d_002dno_002drespect_002dignore_005d-mkdir-_0040var_007bdirectory_002e_002e_002e_007d-19"></a><dd>This command creates a directory in the filesystem relative to your
current location and adds it to your workspace's &ldquo;work list&rdquo;.  The
changes are not reflected in your database until such time as you
perform a commit.  If you use the <samp><span class="option">--no-respect-ignore</span></samp> flag,
entries in .mtn-ignore will not be honored.

     <br><dt><samp><span class="command">mtn [--bookkeep-only] drop </span><var>pathname...</var></samp><a name="index-mtn-_005b_002d_002dbookkeep_002donly_005d-drop-_0040var_007bpathname_002e_002e_002e_007d-20"></a><dt><samp><span class="command">mtn drop --missing</span></samp><a name="index-mtn-drop-_002d_002dmissing-21"></a><dd>This command places &ldquo;drop&rdquo; entries for the paths specified in
<var>pathname...</var> in the workspace's &ldquo;work list&rdquo; and deletes
the file from the workspace. The work list of
your workspace is stored in <samp><span class="file">_MTN/revision</span></samp>, and is a list of
explicit pathname changes you wish to commit at some future time, such
as addition, removal, or renaming of files.  This command also removes
any attributes on <var>pathname</var>; see <a href="#File-Attributes">File Attributes</a> for more
details.  If you use the <samp><span class="option">--missing</span></samp> flag it will add drop
entries for any paths that monotone is tracking for which you have
already removed the files from the filesystem, in addition to all those
specified in <var>pathname...</var>.

     <p>While this command places a &ldquo;drop&rdquo; entry on your work list, it does
not immediately affect your database. When you <samp><span class="command">commit</span></samp> your
workspace, monotone will use the work list to build a new revision,
which it will then commit to the database. The new revision will have
any dropped entries removed from its manifest.

     <p>There are situations in which <samp><span class="command">drop</span></samp> will tell monotone
to remove the file from the revision at commit time, but where it will
<em>not</em> to remove the file from the workspace immediately.  One
is if the <samp><span class="option">--bookkeep-only</span></samp> option is supplied.  Another is
if a file has un-committed changes or if a directory is not empty.

     <br><dt><samp><span class="command">mtn [--bookkeep-only] rename </span><var>src</var> <var>dst</var></samp><a name="index-mtn-_005b_002d_002dbookkeep_002donly_005d-rename-_0040var_007bsrc_007d-_0040var_007bdst_007d-22"></a><br><dt><samp><span class="command">mtn [--bookkeep-only] mv </span><var>src</var> <var>dst</var></samp><a name="index-mtn-_005b_002d_002dbookkeep_002donly_005d-mv-_0040var_007bsrc_007d-_0040var_007bdst_007d-23"></a><dt><samp><span class="command">mtn [--bookkeep-only] rename </span><var>src1</var> <var>...</var> <var>dst/</var></samp><a name="index-mtn-_005b_002d_002dbookkeep_002donly_005d-rename-_0040var_007bsrc1_007d-_0040var_007b_002e_002e_002e_007d-_0040var_007bdst_002f_007d-24"></a><dt><samp><span class="command">mtn [--bookkeep-only] mv </span><var>src1</var> <var>...</var> <var>dst/</var></samp><a name="index-mtn-_005b_002d_002dbookkeep_002donly_005d-mv-_0040var_007bsrc1_007d-_0040var_007b_002e_002e_002e_007d-_0040var_007bdst_002f_007d-25"></a><dd>This command places &ldquo;rename&rdquo; entries for the paths specified in
<var>src</var> and <var>dst</var> in the workspace's &ldquo;work list&rdquo;. The second form
renames a number of source paths to the given destination. The work
list of your workspace is stored in <samp><span class="file">_MTN/revision</span></samp>, and is a list of
explicit pathname changes you wish to commit at some future time, such
as addition, removal, or renaming of files.  This command also moves any
attributes on <var>src</var> to <var>dst</var>; see <a href="#File-Attributes">File Attributes</a> for more
details, and, unless the <samp><span class="option">--bookkeep-only</span></samp> option is supplied, it
will rename the files immediately in the filesystem.  In the case where
<var>dst</var> must be a directory (multiple <var>src</var> items), exists
physically in the filesystem as a directory or is specified as a
directory by convention (a trailing /), it will be automatically added
to the workspace if it is not already versioned.

     <br><dt><samp><span class="command">mtn commit</span></samp><a name="index-mtn-commit-26"></a><br><dt><samp><span class="command">mtn ci</span></samp><a name="index-mtn-ci-27"></a><dt><samp><span class="command">mtn commit --message=</span><var>logmsg</var><span class="command"> [--message=</span><var>logmsg</var><span class="command">...]</span></samp><a name="index-mtn-commit-_002d_002dmessage_003d_0040var_007blogmsg_007d-_005b_002d_002dmessage_003d_0040var_007blogmsg_007d_002e_002e_002e_005d-28"></a><dt><samp><span class="command">mtn ci --message=</span><var>logmsg</var><span class="command"> [--message=</span><var>logmsg</var><span class="command">...]</span></samp><a name="index-mtn-ci-_002d_002dmessage_003d_0040var_007blogmsg_007d-_005b_002d_002dmessage_003d_0040var_007blogmsg_007d_002e_002e_002e_005d-29"></a><dt><samp><span class="command">mtn commit --message-file=</span><var>logfile</var></samp><a name="index-mtn-commit-_002d_002dmessage_002dfile_003d_0040var_007blogfile_007d-30"></a><dt><samp><span class="command">mtn ci --message-file=</span><var>logfile</var></samp><a name="index-mtn-ci-_002d_002dmessage_002dfile_003d_0040var_007blogfile_007d-31"></a><dt><samp><span class="command">mtn commit </span><var>pathname...</var></samp><a name="index-mtn-commit-_0040var_007bpathname_002e_002e_002e_007d-32"></a><dt><samp><span class="command">mtn ci </span><var>pathname...</var></samp><a name="index-mtn-ci-_0040var_007bpathname_002e_002e_002e_007d-33"></a><dt><samp><span class="command">mtn commit --message=</span><var>logmsg</var><span class="command"> [--message=</span><var>logmsg</var><span class="command">...] </span><var>pathname...</var></samp><a name="index-mtn-commit-_002d_002dmessage_003d_0040var_007blogmsg_007d-_005b_002d_002dmessage_003d_0040var_007blogmsg_007d_002e_002e_002e_005d-_0040var_007bpathname_002e_002e_002e_007d-34"></a><dt><samp><span class="command">mtn ci --message=</span><var>logmsg</var><span class="command"> [--message=</span><var>logmsg</var><span class="command">...] </span><var>pathname...</var></samp><a name="index-mtn-ci-_002d_002dmessage_003d_0040var_007blogmsg_007d-_005b_002d_002dmessage_003d_0040var_007blogmsg_007d_002e_002e_002e_005d-_0040var_007bpathname_002e_002e_002e_007d-35"></a><dt><samp><span class="command">mtn commit --message-file=</span><var>logfile</var> <var>pathname...</var></samp><a name="index-mtn-commit-_002d_002dmessage_002dfile_003d_0040var_007blogfile_007d-_0040var_007bpathname_002e_002e_002e_007d-36"></a><dt><samp><span class="command">mtn ci --message-file=</span><var>logfile</var> <var>pathname...</var></samp><a name="index-mtn-ci-_002d_002dmessage_002dfile_003d_0040var_007blogfile_007d-_0040var_007bpathname_002e_002e_002e_007d-37"></a><dd>
This command looks at your workspace, decides which files have
changed, and saves the changes to your database. It does this by
loading the revision named in <samp><span class="file">_MTN/revision</span></samp>, locating the base
manifest for your workspace, applying any pathname changes described
in <samp><span class="file">_MTN/revision</span></samp>, and then comparing the updated base manifest
to the files it finds in your workspace, to determine which files have
been edited.

     <p>For each edited file, a delta is copied into the database. Then the
newly constructed manifest is recorded (as a delta) and finally the
new revision.  Once all these objects are recorded in you database,
<samp><span class="command">commit</span></samp> updates <samp><span class="file">_MTN/revision</span></samp> to indicate that the base
revision is now the newly created revision, and that there are no
pathname changes to apply.

     <p>Specifying pathnames to <samp><span class="command">commit</span></samp> restricts the set of changes
that are visible and results in only a partial commit of the workspace. 
Changes to files not included in the specified set of pathnames will be
ignored and will remain in the workspace until they are included in a
future commit. With a partial commit, only the relevant entries in
<samp><span class="file">_MTN/revision</span></samp> will be removed and other entries will remain for
future commits.

     <p>From within a subdirectory of the workspace the <samp><span class="command">commit</span></samp> command
will, by default, include <em>all changes</em> in the workspace. 
Specifying only the pathname "." will restrict <samp><span class="command">commit</span></samp> to files
changed within the current subdirectory of the workspace.

     <p>The <samp><span class="option">--message</span></samp> and <samp><span class="option">--message-file</span></samp> options are mutually
exclusive.  Both provide a <var>logmsg</var> describing the commit. 
<samp><span class="option">--message-file</span></samp> actually specifies the name of the file containing
the log message, while <samp><span class="option">--message</span></samp> provides it directly.

     <p>Multiple <samp><span class="option">--message</span></samp> options may be provided on the command line. 
The log message will be formed by concatenating the <samp><span class="option">--message</span></samp>
options provided, with each one starting at the beginning of a new line.

     <p>The <samp><span class="file">_MTN/log</span></samp> file can be edited by the user during their daily
work to record the changes made to the workspace. When running the
<samp><span class="command">commit</span></samp> command without a <var>logmsg</var> supplied, the contents of
the <samp><span class="file">_MTN/log</span></samp> file will be read and passed to the Lua hook
<code>edit_comment</code> as a second parameter named <var>user_log_content</var>. 
The log message will be prepended with a 'magic' string that must be
removed to confirm the commit.  This allows the user to easily cancel a
commit, without emptying the entire log message.  If the commit is
successful, the <samp><span class="file">_MTN/log</span></samp> file is cleared of all content making it
ready for another edit/commit cycle.

     <p>If a <samp><span class="option">--branch</span></samp> option is specified, the <samp><span class="command">commit</span></samp> command
commits to this branch (creating it if necessary).  The branch becomes
the new default branch of the workspace.

     <p>The <samp><span class="command">commit</span></samp> command also synthesizes a number of
certificates, which it attaches to the new manifest version and copies
into your database:
          <ul>
<li>An <code>author</code> cert, indicating the person responsible for the changes
leading to the new revision.  Normally this defaults to your signing key
or the return value of the <code>get_author</code> hook; you may override this
by passing the <samp><span class="option">--author</span></samp> option to commit.  This is useful when
committing a patch on behalf of someone else, or when importing &ldquo;by
hand&rdquo; from another version control system. 
<li>A <code>branch</code> cert, indicating the branch the committed revision
belongs to. 
<li>A <code>date</code> cert, indicating when the new revision was created. 
Normally this defaults to the current time; you may override this by
passing the <samp><span class="option">--date</span></samp> option to commit.  This is useful when
importing &ldquo;by hand&rdquo; from another version control system. 
<li>A <code>changelog</code> cert, containing the &ldquo;log message&rdquo; for these
changes.  If you provided <var>logmsg</var> on the command line, this text
will be used, otherwise <samp><span class="command">commit</span></samp> will run the Lua hook
<code>edit_comment (</code><var>commentary</var><code>, </code><var>user_log_content</var><code>)</code>, which
typically invokes an external editor program, in which you can compose
and/or review your log message for the change. 
</ul>

     <br><dt><samp><span class="command">mtn revert </span><var>pathname...</var></samp><a name="index-mtn-revert-_0040var_007bpathname_002e_002e_002e_007d-38"></a><dt><samp><span class="command">mtn revert --missing </span><var>pathname...</var></samp><a name="index-mtn-revert-_002d_002dmissing-_0040var_007bpathname_002e_002e_002e_007d-39"></a><dd>This command changes your workspace, so that changes you have made
since the last checkout or update are discarded. The command is
restricted the set of files or directories given as arguments.  To
revert the entire workspace, use <samp><span class="command">revert</span></samp> "." in the
top-level directory. Specifying "." in a subdirectory will restrict
<samp><span class="command">revert</span></samp> to files changed within the current subdirectory.

     <p>If the flag <samp><span class="option">--missing</span></samp> is given it reverts (ie, restores) any
files which monotone has listed in its manifest, but which have been
deleted from the workspace.  Only missing files matching the given
file or directory arguments are reverted.

     <br><dt><samp><span class="command">mtn update</span></samp><a name="index-mtn-update-40"></a><dt><samp><span class="command">mtn update --revision=</span><var>revision</var></samp><a name="index-mtn-update-_002d_002drevision_003d_0040var_007brevision_007d-41"></a><dd>Without a <samp><span class="option">--revision</span></samp> argument, this command incorporates
&ldquo;recent&rdquo; changes found in your database into your workspace. It
does this by performing 3 separate stages. If any of these stages
fails, the update aborts, doing nothing. The stages are:

          <ul>
<li>Examine the ancestry graph of revisions in your database, and (subject
to trust evaluation) select the set of all descendants of your
workspace's base revision. Call this set the &ldquo;candidates&rdquo; of the
update. 
<li>Remove any candidates which lack acceptable testresult
certificates. From the remaining candidates, select the deepest child
by ancestry and call it the &ldquo;target&rdquo; of the update. 
<li>Merge the target of the update with the workspace, in memory, and
if the merge is successful, write the result over top of the workspace. 
</ul>

     <p>With an explicit <samp><span class="option">--revision</span></samp> argument, the command uses that revision
as the update target instead of finding an acceptable candidate.

     <p>The effect is always to take whatever changes you have made in the
workspace, and to &ldquo;transpose&rdquo; them onto a new revision, using
monotone's 3-way merge algorithm to achieve good results.  Note that
with the explicit <samp><span class="option">--revision</span></samp> argument, it is possible to update
&ldquo;backwards&rdquo; or &ldquo;sideways&rdquo; in history &mdash; for example, reverting to
an earlier revision, or if your branch has two heads, updating to the
other.  In all cases, the end result will be whatever revision you
specified, with your local changes (and only your local changes)
applied.

     <p>If a <samp><span class="option">--branch</span></samp> option is specified, the <samp><span class="command">update</span></samp> command
tries to select the revision to update to from this branch.  The branch
becomes the new default branch of the workspace (even if you also
specify an explicit <samp><span class="option">--revision</span></samp> argument).

     <p>When running <samp><span class="command">update</span></samp>, it is sometimes possible for
<a href="#Workspace-Collisions">Workspace Collisions</a> to occur.

     <br><dt><samp><span class="command">mtn pluck --revision=</span><var>to</var></samp><a name="index-mtn-pluck-_002d_002drevision_003d_0040var_007bto_007d-42"></a><dt><samp><span class="command">mtn pluck --revision=</span><var>from</var><span class="command"> --revision=</span><var>to</var></samp><a name="index-mtn-pluck-_002d_002drevision_003d_0040var_007bfrom_007d-_002d_002drevision_003d_0040var_007bto_007d-43"></a><dd>
This command takes changes made at any point in history, and attempts to
edit your current workspace to include those changes.  The end result is
identical to running <samp><span class="command">mtn diff </span><samp><span class="option">-r</span></samp> <var>from</var>
<samp><span class="option">-r</span></samp> <var>to</var><span class="command"> | patch </span><samp><span class="option">-p0</span></samp></samp>, except that this command
uses monotone's merger, and thus intelligently handles renames,
conflicts, and so on.

     <p>If only one revision is given, applies the changes made in <var>to</var> as
compared with <var>to</var>'s parent.  If two revisions are given, applies
the changes made to get from <var>from</var> to <var>to</var>.

     <p>Note that this is not a true cherrypick operation.  A true cherrypick,
as that word is used in version control theory, involves applying some
changes out of context, and then recording the identity between the
original changes and the newly applied changes for the use of later
merges.  This command does the first part, not the second.  As far as
monotone is concerned, the changes made by <samp><span class="command">mtn pluck</span></samp> are
exactly like those made in an editor; the command is simply a
convenient way to make certain edits quickly.  In practice, this is
rarely a problem.  <samp><span class="command">mtn pluck</span></samp> should almost always be used
between branches that will never be merged &mdash; for instance,
backporting fixes from a development branch to a stable branch.

     <p>When you use <samp><span class="command">pluck</span></samp> you are going behind monotone's back, and
reducing its ability to help you keep track of what has happened in
your history.  Never use <samp><span class="command">pluck</span></samp> where a true merging command
like <samp><span class="command">merge</span></samp>, <samp><span class="command">propagate</span></samp>, or <samp><span class="command">explicit_merge</span></samp>
will do.  If you find yourself using <samp><span class="command">pluck</span></samp> often, you should
consider carefully whether there is any way to change your workflow to
reduce your need for <samp><span class="command">pluck</span></samp>ing.

     <p>When running <samp><span class="command">pluck</span></samp>, it is sometimes possible for
<a href="#Workspace-Collisions">Workspace Collisions</a> to occur.

     <br><dt><samp><span class="command">mtn refresh_inodeprints</span></samp><a name="index-mtn-refresh_005finodeprints-44"></a><dd>This command puts the current workspace into <a href="#Inodeprints">Inodeprints</a> mode,
if it was not already, and forces a full inodeprints cache refresh. 
After running this command, you are guaranteed that your workspace is
in inodeprints mode, and that the inodeprints cache is accurate and up
to date.

     <br><dt><samp><span class="command">mtn pivot_root [--bookkeep-only] pivot_root </span><var>new_root</var> <var>put_old</var></samp><a name="index-mtn-pivot_005froot-_005b_002d_002dbookkeep_002donly_005d-pivot_005froot-_0040var_007bnew_005froot_007d-_0040var_007bput_005fold_007d-45"></a><dd>Most users will never need this command.  It is primarily useful in
certain tricky cases where one wishes to combine several projects
into one, or split one project into several. See also <samp><span class="command">merge_into_dir</span></samp>.

     <p>Its effect is to rename the directory whose name is currently
<var>new_root</var> to become the root directory of the versioned tree, and
to at the same time rename the directory that is currently the root of
the versioned tree to have the name <var>put_old</var>.  Conceptually, it
is equivalent to executing the following commands in the root of the
workspace:

     <pre class="smallexample">          $ mtn rename . <var>new_root</var>/<var>put_old</var>
          $ mtn rename <var>new_root</var> .
</pre>
     <p>Except, of course, that these <samp><span class="command">rename</span></samp> commands are illegal,
because after the first command the tree has no root at all, and there
is a directory loop.  This illegality is the only reason for
<samp><span class="command">pivot_root</span></samp>'s existence; internally, the result is treated
exactly like two renames, including with respect to merges and
updates.

     <p>The use of <samp><span class="option">--bookkeep-only</span></samp> with this command is not
recommended.  It causes the changes to be made in monotone's
records, but not in the filesystem itself.

     <p>When running <samp><span class="command">pivot_root</span></samp>, it is sometimes possible for
<a href="#Workspace-Collisions">Workspace Collisions</a> to occur.

</dl>

<p><a name="Network"></a>

<h3 class="section">5.3 Network</h3>

     <dl>
<dt><samp><span class="command">mtn serve [--bind=[</span><var>address</var><span class="command">][:</span><var>port</var><span class="command">]]</span></samp><a name="index-mtn-serve-_005b_002d_002dbind_003d_005b_0040var_007baddress_007d_005d_005b_003a_0040var_007bport_007d_005d_005d-46"></a><br><dt><samp><span class="command">mtn serve --stdio [--no-transport-auth]</span></samp><a name="index-mtn-serve-_002d_002dstdio-_005b_002d_002dno_002dtransport_002dauth_005d-47"></a><dt><samp><span class="command">mtn pull [--set-default] [</span><var>uri-or-address</var><span class="command">] [</span><var>glob</var><span class="command"> [...] [--exclude=</span><var>exclude-glob</var><span class="command">]]]</span></samp><a name="index-mtn-pull-_005b_002d_002dset_002ddefault_005d-_005b_0040var_007buri_002dor_002daddress_007d_005d-_005b_0040var_007bglob_007d-_005b_002e_002e_002e_005d-_005b_002d_002dexclude_003d_0040var_007bexclude_002dglob_007d_005d_005d_005d-48"></a><dt><samp><span class="command">mtn push [--set-default] [</span><var>uri-or-address</var><span class="command">] [</span><var>glob</var><span class="command"> [...] [--exclude=</span><var>exclude-glob</var><span class="command">]]]</span></samp><a name="index-mtn-push-_005b_002d_002dset_002ddefault_005d-_005b_0040var_007buri_002dor_002daddress_007d_005d-_005b_0040var_007bglob_007d-_005b_002e_002e_002e_005d-_005b_002d_002dexclude_003d_0040var_007bexclude_002dglob_007d_005d_005d_005d-49"></a><dt><samp><span class="command">mtn sync [--set-default] [</span><var>uri-or-address</var><span class="command">] [</span><var>glob</var><span class="command"> [...] [--exclude=</span><var>exclude-glob</var><span class="command">]]]</span></samp><a name="index-mtn-sync-_005b_002d_002dset_002ddefault_005d-_005b_0040var_007buri_002dor_002daddress_007d_005d-_005b_0040var_007bglob_007d-_005b_002e_002e_002e_005d-_005b_002d_002dexclude_003d_0040var_007bexclude_002dglob_007d_005d_005d_005d-50"></a><dd>
These commands operate the &ldquo;netsync&rdquo; protocol built into
monotone. This is a custom protocol for rapidly synchronizing two
monotone databases using a hash tree index. The protocol is &ldquo;peer to
peer&rdquo;, but requires one peer to listen for incoming connections (the
server) and the other peer (the client) to connect to the server. When
run with <samp><span class="option">--stdio</span></samp>, the server listens for a single connection
then terminates. When run with <samp><span class="option">--bind</span></samp>, or with neither
option, the server listens for TCP connections and serves them
continuously, until it is shut down.

     <p>The network <var>address</var> given to <samp><span class="command">serve</span></samp> as an argument to
<samp><span class="option">--bind</span></samp> should be a host name to listen on, optionally
followed by a colon and a port number. The default port number is
4691. If no <samp><span class="option">--bind</span></samp> option is given, the server listens on
port 4691 of every network interface.

     <p>If <samp><span class="command">serve</span></samp> is run with <samp><span class="option">--stdio</span></samp>, a single netsync
session is served over the <code>stdin</code> and <code>stdout</code> file
descriptors. If <samp><span class="option">--no-transport-auth</span></samp> is provided along with
<samp><span class="option">--stdio</span></samp>, transport authentication and access control mechanisms
are disabled. Only use <samp><span class="option">--no-transport-auth</span></samp> if you are certain
that the transport channel in use already provides sufficient
authentication and authorization facilities.

     <p>The <var>uri-or-address</var> arguments given to <samp><span class="command">push</span></samp>,
<samp><span class="command">pull</span></samp>, and <samp><span class="command">sync</span></samp> can be of two possible forms. If
the argument is a URI, a Lua hook may transform the URI into a
connection command, and execute the command as a transport channel for
netsync. If the argument is a simple hostname (with optional port
number), monotone will use a TCP socket to the specified host and port
as a transport channel for netsync.

     <p>The <var>glob</var> parameters indicate a set of branches to exchange. 
Multiple <var>glob</var> and <samp><span class="option">--exclude</span></samp> options can be specified;
every branch which matches a <var>glob</var> exactly, and does not match an
<var>exclude-glob</var>, will be indexed and made available for
synchronization.

     <p>For example, perhaps Bob and Alice wish to synchronize their
<code>net.venge.monotone.win32</code> and <code>net.venge.monotone.i18n</code>
branches. Supposing Alice's computer has hostname
<code>alice.someisp.com</code>, then Alice might run:

     <pre class="smallexample">          $ mtn --bind=alice.someisp.com serve
</pre>
     <p>And Bob might run

     <pre class="smallexample">          $ mtn sync alice.someisp.com "net.venge.monotone*"
</pre>
     <p>When the operation completes, all branches matching
<code>net.venge.monotone*</code> will be synchronized between Alice and Bob's
databases.

     <p>The <samp><span class="command">pull</span></samp>, <samp><span class="command">push</span></samp>, and <samp><span class="command">sync</span></samp> commands only
require you pass <var>address</var> and <var>glob</var> the first time you use one
of them; monotone will memorize this use and in the future default to
the same server and glob.  For instance, if Bob wants to <samp><span class="command">sync</span></samp>
with Alice again, he can simply run:

     <pre class="smallexample">          $ mtn sync
</pre>
     <p>Of course, he can still <samp><span class="command">sync</span></samp> with other people and other
branches by passing an address or address plus globs on the command
line; this will not affect his default affinity for Alice.  If you ever
do want to change your defaults, simply pass the <samp><span class="option">--set-default</span></samp>
option when connecting to the server and branch pattern that you want to
make the new default.

     <p>In the server, different permissions can be applied to each branch; see
the hooks <code>get_netsync_read_permitted</code> and
<code>get_netsync_write_permitted</code> (see <a href="#Hook-Reference">Hook Reference</a>).

     <p>If a <samp><span class="option">--pid-file</span></samp> option is specified, the command
<samp><span class="command">serve</span></samp> will create the specified file and record the process
identifier of the server in the file.  This file can then be read to
identify specific monotone server processes.

     <p>The syntax for patterns is very simple.  <code>*</code> matches 0 or more
arbitrary characters.  <code>?</code> matches exactly 1 arbitrary character. 
<code>{foo,bar,baz}</code> matches &ldquo;foo&rdquo;, or &ldquo;bar&rdquo;, or &ldquo;baz&rdquo;.  These
can be combined arbitrarily.  A backslash, <code>\</code>, can be prefixed to
any character, to match exactly that character &mdash; this might be useful
in case someone, for some odd reason, decides to put a &ldquo;*&rdquo; into their
branch name.

</dl>

<p><a name="Informative"></a>

<h3 class="section">5.4 Informative</h3>

     <dl>
<dt><samp><span class="command">mtn status</span></samp><a name="index-mtn-status-51"></a><dt><samp><span class="command">mtn status </span><var>pathname...</var></samp><a name="index-mtn-status-_0040var_007bpathname_002e_002e_002e_007d-52"></a><dd>
This command prints a description of the &ldquo;status&rdquo; of your workspace. 
In particular, it prints:
          <ul>
<li>The branch currently selected in <samp><span class="file">_MTN/options</span></samp> for the
workspace. 
<li>The revision id of the &ldquo;parent&rdquo; revision of the workspace, on which
your in-progress changes are based. 
<li>A list of logical changes between the base and current manifest
versions, such as adds, drops, renames, and patches. 
</ul>

     <p>Specifying optional <var>pathname...</var> arguments to the <samp><span class="command">status</span></samp>
command restricts the set of changes that are visible and results in
only a partial status of the workspace. Changes to files not included
in the specified set of pathnames will be ignored.

     <p>From within a subdirectory of the workspace the <samp><span class="command">status</span></samp> command
will, by default, include <em>all changes</em> in the workspace. 
Specifying only the pathname "." will restrict <samp><span class="command">status</span></samp> to files
changed within the current subdirectory of the workspace.

     <br><dt><samp><span class="command">mtn log</span></samp><a name="index-mtn-log-53"></a><dt><samp><span class="command">mtn log [--last=</span><var>n</var><span class="command">] [--next=</span><var>n</var><span class="command">] [--from=</span><var>id</var><span class="command"> [...]] [--to=</span><var>id</var><span class="command"> [...]] [--brief] [--no-merges] [--no-files] [--diffs] [</span><var>file</var><span class="command"> [...]]</span></samp><a name="index-mtn-log-_005b_002d_002dlast_003d_0040var_007bn_007d_005d-_005b_002d_002dnext_003d_0040var_007bn_007d_005d-_005b_002d_002dfrom_003d_0040var_007bid_007d-_005b_002e_002e_002e_005d_005d-_005b_002d_002dto_003d_0040var_007bid_007d-_005b_002e_002e_002e_005d_005d-_005b_002d_002dbrief_005d-_005b_002d_002dno_002dmerges_005d-_005b_002d_002dno_002dfiles_005d-_005b_002d_002ddiffs_005d-_005b_0040var_007bfile_007d-_005b_002e_002e_002e_005d_005d-54"></a><dd>
This command prints out a log, in reverse-ancestry order, of small
history summaries.  Each summary contains author, date, changelog and
comment information associated with a revision.

     <p>If <samp><span class="option">--brief</span></samp> is given, the output consists of one line per revision
with the revision ID, the author, the date and the branches (separated
with commas).

     <p>If <samp><span class="option">--last=</span></samp><var>n</var> is given, at most <var>n</var> log entries will be
given.

     <p>If <samp><span class="option">--next=</span></samp><var>n</var> is given, at most <var>n</var> log entries towards
the current head revision will be given from the workspace's base
revision in forward-ancestry order.  This is useful to review changes
that will be applied to the workspace when <samp><span class="command">update</span></samp> is run.

     <p>If <samp><span class="option">--from=</span></samp><var>id</var> is given, the command starts tracing back through
history from these revisions, otherwise it starts from the base revision of
your workspace.

     <p>If <samp><span class="option">--to=</span></samp><var>id</var> is given, log will only print entries for revisions
that would not also be printed when logging from the revisions specified in
<samp><span class="option">--to</span></samp>. This is useful for reviewing changes between two points
in history.

     <p>By default, the log entries for merge nodes are shown.  If
<samp><span class="option">--no-merges</span></samp> is given, the log entries for these nodes will be
excluded.

     <p>If <samp><span class="option">--no-files</span></samp> is given, the log output excludes the list of
files changed in each revision.

     <p>Specifying <samp><span class="option">--diffs</span></samp> causes the log output to include a unified
diff of the changes in each revision.

     <p>If one or more files are given, the command will only log the revisions
where those files are changed.

     <br><dt><samp><span class="command">mtn annotate </span><var>file</var></samp><a name="index-mtn-annotate-_0040var_007bfile_007d-55"></a><dt><samp><span class="command">mtn annotate [--revision=</span><var>id</var><span class="command">] [--revs-only] </span><var>file</var></samp><a name="index-mtn-annotate-_005b_002d_002drevision_003d_0040var_007bid_007d_005d-_005b_002d_002drevs_002donly_005d-_0040var_007bfile_007d-56"></a><dd>
Dumps an annotated copy of the file to stdout. The output is in the form
&lt;short revision id&gt;.. by &lt;author&gt; &lt;date&gt;: &lt;line&gt; Only the first 8
characters of the revision id are displayed, the author cert value is
truncated at the first <code>@</code> or space character and the date field
is truncated to remove the time of day.

     <p>If <samp><span class="option">--revs-only</span></samp> is specified, each line of the file is
translated to &lt;revision id&gt;: &lt;line&gt; in the output, where &lt;revision id&gt;
is the revision in which that line of the file was last edited.

     <br><dt><samp><span class="command">mtn complete file </span><var>partial-id</var></samp><a name="index-mtn-complete-file-_0040var_007bpartial_002did_007d-57"></a><dt><samp><span class="command">mtn complete [--brief] key </span><var>partial-id</var></samp><a name="index-mtn-complete-_005b_002d_002dbrief_005d-key-_0040var_007bpartial_002did_007d-58"></a><dt><samp><span class="command">mtn complete [--brief] revision </span><var>partial-id</var></samp><a name="index-mtn-complete-_005b_002d_002dbrief_005d-revision-_0040var_007bpartial_002did_007d-59"></a><dd>
These commands print out all known completions of a partial <span class="sc">sha1</span>
value, listing completions which are <code>file</code>, <code>manifest</code> or
<code>revision</code> IDs depending on which variant is used. For
example, suppose you enter this command and get this result:

     <pre class="smallexample">          $ mtn complete revision fa36
          fa36deead87811b0e15208da2853c39d2f6ebe90
          fa36b76dd0139177b28b379fe1d56b22342e5306
          fa36965ec190bee14c5afcac235f1b8e2239bb2a
</pre>
     <p>Then monotone is telling you that there are 3 revisions it knows
about, in its database, which begin with the 4 hex digits
<code>fa36</code>. This command is intended to be used by programmable
completion systems, such as those in <samp><span class="command">bash</span></samp> and <samp><span class="command">zsh</span></samp>.

     <p>The complete command for keys and revisions have a <samp><span class="option">--verbose</span></samp> option. 
Programmable completion systems can use <samp><span class="option">--verbose</span></samp> output to
present users with additional information about each completion option.

     <p>For example, verbose output for <code>revision</code> looks like this:
     <pre class="smallexample">          $ mt complete revision 01f
          01f5da490941bee1f0000f0561fc62eabfb2fa23 graydon@dub.net 2003-12-03T03:14:35
          01f992577bd8bcdcade0f89e724fd5dc2d2bbe8a kinetik@orcon.nz 2005-05-11T05:19:29
          01faad191d8d0474777c70b4d606782942333a78 kinetik@orcon.nz 2005-04-11T04:24:01
</pre>
     <br><dt><samp><span class="command">mtn diff [--unified] [--show-encloser]</span></samp><a name="index-mtn-diff-_005b_002d_002dunified_005d-_005b_002d_002dshow_002dencloser_005d-60"></a><dt><samp><span class="command">mtn diff --context [--show-encloser]</span></samp><a name="index-mtn-diff-_002d_002dcontext-_005b_002d_002dshow_002dencloser_005d-61"></a><dt><samp><span class="command">mtn diff --external [--diff-args=</span><var>argstring</var><span class="command">]</span></samp><a name="index-mtn-diff-_002d_002dexternal-_005b_002d_002ddiff_002dargs_003d_0040var_007bargstring_007d_005d-62"></a><dt><samp><span class="command">mtn diff </span><var>pathname...</var></samp><a name="index-mtn-diff-_0040var_007bpathname_002e_002e_002e_007d-63"></a><dt><samp><span class="command">mtn diff --revision=</span><var>id</var></samp><a name="index-mtn-diff-_002d_002drevision_003d_0040var_007bid_007d-64"></a><dt><samp><span class="command">mtn diff --revision=</span><var>id</var> <var>pathname...</var></samp><a name="index-mtn-diff-_002d_002drevision_003d_0040var_007bid_007d-_0040var_007bpathname_002e_002e_002e_007d-65"></a><dt><samp><span class="command">mtn diff --revision=</span><var>id1</var><span class="command"> --revision=</span><var>id2</var></samp><a name="index-mtn-diff-_002d_002drevision_003d_0040var_007bid1_007d-_002d_002drevision_003d_0040var_007bid2_007d-66"></a><dt><samp><span class="command">mtn diff --revision=</span><var>id1</var><span class="command"> --revision=</span><var>id2</var> <var>pathname...</var></samp><a name="index-mtn-diff-_002d_002drevision_003d_0040var_007bid1_007d-_002d_002drevision_003d_0040var_007bid2_007d-_0040var_007bpathname_002e_002e_002e_007d-67"></a><dd>
These commands print out GNU &ldquo;unified diff format&rdquo; textual difference
listings between various manifest versions. With no <samp><span class="option">--revision</span></samp>
options, <samp><span class="command">diff</span></samp> will print the differences between the
base revision and the current revision in the workspace.

     <p>With one <samp><span class="option">--revision</span></samp> option, <samp><span class="command">diff</span></samp> will print the
differences between the revision <var>id</var> and the current revision in
the workspace.  With two <samp><span class="option">--revision</span></samp> options <samp><span class="command">diff</span></samp>
will print the differences between revisions <var>id1</var> and <var>id2</var>,
ignoring any workspace.

     <p>In all cases, monotone will print a textual summary &ndash; identical to
the summary presented by <samp><span class="command">mtn status</span></samp> &ndash; of the logical
differences between revisions in lines proceeding the diff. These
lines begin with a single hash mark <code>#</code>, and should be ignored by
a program processing the diff, such as <samp><span class="command">patch</span></samp>.

     <p>Specifying pathnames to the <samp><span class="command">diff</span></samp> command restricts the set of
changes that are visible and results in only a partial diff between
two revisions. Changes to files not included in the specified set of
pathnames will be ignored.

     <p>From within a subdirectory of the workspace the <samp><span class="command">diff</span></samp> command
will, by default, include <em>all changes</em> in the workspace. 
Specifying only the pathname "." will restrict <samp><span class="command">diff</span></samp> to files
changed within the current subdirectory of the workspace.

     <p>The output format of <samp><span class="command">diff</span></samp> is controlled by the options
<samp><span class="option">--unified</span></samp>, <samp><span class="option">--context</span></samp>, <samp><span class="option">--show-encloser</span></samp>, and
<samp><span class="option">--external</span></samp>.  By default, monotone uses its built-in diff
algorithm to produce a listing in &ldquo;unified diff&rdquo; format (analogous
to running the program <samp><span class="command">diff </span><samp><span class="option">-u</span></samp></samp>); you can also explicitly
request this with <samp><span class="option">--unified</span></samp>.  The built-in diff algorithm can
also produce &ldquo;context diff&rdquo; format (analogous to <samp><span class="command">diff </span><samp><span class="option">-c</span></samp></samp>),
which you request by specifying <samp><span class="option">--context</span></samp>.  The short options
that <samp><span class="command">diff</span></samp> accepts for these modes, <samp><span class="option">-u</span></samp> and
<samp><span class="option">-c</span></samp>, also work.

     <p>In either of these modes, you can request that monotone print the name
of the top-level code construct that encloses each &ldquo;hunk&rdquo; of
changes, with <samp><span class="option">--show-encloser</span></samp>.  The options that
<samp><span class="command">diff</span></samp> accepts for this mode, <samp><span class="option">-p</span></samp> and
<samp><span class="option">--show-c-function</span></samp>, also work.  Monotone finds the enclosing
construct by scanning backward from the first changed line in each
hunk for a line that matches a regular expression.  The default
regular expression is correct for many programming languages.  You can
adjust the expression used with the Lua hook
<code>get_encloser_pattern</code>; <a href="#Hooks">Hooks</a>.  For the regular expression
syntax, See <a href="#Regexps">Regexps</a>.

     <p><samp><span class="option">--unified</span></samp> requests the &ldquo;unified diff&rdquo; format, the default. 
<samp><span class="option">--context</span></samp> requests the &ldquo;context diff&rdquo; format (analogous to
running the program <samp><span class="command">diff </span><samp><span class="option">-c</span></samp></samp>).  Both of these formats are
generated directly by monotone, using its built-in diff algorithm.

     <p>Sometimes, you may want more flexibility in output formats; for these
cases, you can use <samp><span class="option">--external</span></samp>, which causes monotone to invoke
an external program to generate the actual output.  By default, the
external program is <code>diff</code>, and you can use the option
<samp><span class="option">--diff-args</span></samp> to pass additional arguments controlling
formatting.  The actual invocation of <samp><span class="command">diff</span></samp>, default arguments
passed to it, and so on, are controlled by the hook
<code>external_diff</code>; see <a href="#Hooks">Hooks</a> for more details.

     <br><dt><samp><span class="command">mtn list certs </span><var>id</var></samp><a name="index-mtn-list-certs-_0040var_007bid_007d-68"></a><br><dt><samp><span class="command">mtn ls certs </span><var>id</var></samp><a name="index-mtn-ls-certs-_0040var_007bid_007d-69"></a><dd>
These commands will print out a list of certificates associated with
a particular revision <var>id</var>. Each line of the print out will
indicate:
          <ul>
<li>Whether the signature on the certificate is <code>ok</code> or <code>bad</code>
<li>The key ID of the signer of the certificate
<li>The name of the certificate
<li>The value of the certificate
</ul>

     <p>For example, this command lists the certificates associated with a
particular version of monotone itself, in the monotone development
branch:

     <pre class="smallexample">          $ mtn list certs 4a96
          mtn: expanding partial id '4a96'
          mtn: expanded to '4a96a230293456baa9c6e7167cafb3c5b52a8e7f'
          -----------------------------------------------------------------
          Key   : graydon@pobox.com
          Sig   : ok
          Name  : author
          Value : graydon@dub.venge.net
          -----------------------------------------------------------------
          Key   : graydon@pobox.com
          Sig   : ok
          Name  : branch
          Value : monotone
          -----------------------------------------------------------------
          Key   : graydon@pobox.com
          Sig   : ok
          Name  : date
          Value : 2003-10-17T03:20:27
          -----------------------------------------------------------------
          Key   : graydon@pobox.com
          Sig   : ok
          Name  : changelog
          Value : 2003-10-16  graydon hoare  &lt;graydon@pobox.com&gt;
                :
                :         * sanity.hh: Add a const version of idx().
                :         * diff_patch.cc: Change to using idx() everywhere.
                :         * cert.cc (find_common_ancestor): Rewrite to recursive
                :         form, stepping over historic merges.
                :         * tests/t_cross.at: New test for merging merges.
                :         * testsuite.at: Call t_cross.at.
                :
</pre>
     <br><dt><samp><span class="command">mtn list keys</span></samp><a name="index-mtn-list-keys-70"></a><br><dt><samp><span class="command">mtn ls keys</span></samp><a name="index-mtn-ls-keys-71"></a><dt><samp><span class="command">mtn list keys </span><var>pattern</var></samp><a name="index-mtn-list-keys-_0040var_007bpattern_007d-72"></a><dt><samp><span class="command">mtn ls keys </span><var>pattern</var></samp><a name="index-mtn-ls-keys-_0040var_007bpattern_007d-73"></a><dd>These commands list <span class="sc">rsa</span> keys held in your keystore and current database. 
They do not print out any cryptographic information; they simply list the
names of public and private keys you have on hand.

     <p>If <var>pattern</var> is provided, it is used as a glob to limit the keys
listed. Otherwise all keys in your database are listed.

     <br><dt><samp><span class="command">mtn list branches</span></samp><a name="index-mtn-list-branches-74"></a><br><dt><samp><span class="command">mtn ls branches</span></samp><a name="index-mtn-ls-branches-75"></a><dd>
This command lists all known branches in your database.

     <br><dt><samp><span class="command">mtn list tags</span></samp><a name="index-mtn-list-tags-76"></a><br><dt><samp><span class="command">mtn ls tags</span></samp><a name="index-mtn-ls-tags-77"></a><dd>
This command lists all known tags in your database.

     <br><dt><samp><span class="command">mtn list vars</span></samp><a name="index-mtn-list-vars-78"></a><br><dt><samp><span class="command">mtn ls vars</span></samp><a name="index-mtn-ls-vars-79"></a><br><dt><samp><span class="command">mtn list vars </span><var>domain</var></samp><a name="index-mtn-list-vars-_0040var_007bdomain_007d-80"></a><br><dt><samp><span class="command">mtn ls vars </span><var>domain</var></samp><a name="index-mtn-ls-vars-_0040var_007bdomain_007d-81"></a><dd>
This command lists all vars in your database, or all vars within a given
<var>domain</var>.  See <a href="#Vars">Vars</a> for more information.

     <br><dt><samp><span class="command">mtn list known</span></samp><a name="index-mtn-list-known-82"></a><br><dt><samp><span class="command">mtn ls known</span></samp><a name="index-mtn-ls-known-83"></a><dt><samp><span class="command">mtn list known </span><var>pathname...</var></samp><a name="index-mtn-list-known-_0040var_007bpathname_002e_002e_002e_007d-84"></a><dt><samp><span class="command">mtn ls known </span><var>pathname...</var></samp><a name="index-mtn-ls-known-_0040var_007bpathname_002e_002e_002e_007d-85"></a><dd>
This command lists all files which would become part of the manifest of
the next revision if you committed your workspace at this point.

     <p>Specifying pathnames to the <samp><span class="command">list known</span></samp> command restricts
the set of paths that are searched for manifest files. Files not
included in the specified set of pathnames will not be listed.

     <p>From within a subdirectory of the workspace the <samp><span class="command">list
known</span></samp> command will, by default, search the entire workspace. 
Specifying only the pathname "." will restrict the search for known
files to the current subdirectory of the workspace.

     <br><dt><samp><span class="command">mtn list unknown</span></samp><a name="index-mtn-list-unknown-86"></a><br><dt><samp><span class="command">mtn ls unknown</span></samp><a name="index-mtn-ls-unknown-87"></a><dt><samp><span class="command">mtn list unknown </span><var>pathname...</var></samp><a name="index-mtn-list-unknown-_0040var_007bpathname_002e_002e_002e_007d-88"></a><dt><samp><span class="command">mtn ls unknown </span><var>pathname...</var></samp><a name="index-mtn-ls-unknown-_0040var_007bpathname_002e_002e_002e_007d-89"></a><dd>
This command lists all files in your workspace that monotone is
either ignoring or knows nothing about.

     <p>Specifying pathnames to the <samp><span class="command">list unknown</span></samp> command restricts the
set of paths that are searched for unknown files. Unknown files not
included in the specified set of pathnames will not be listed.

     <p>From within a subdirectory of the workspace the <samp><span class="command">list
unknown</span></samp> command will, by default, search the entire workspace. 
Specifying only the pathname "." will restrict the search for unknown
files to the current subdirectory of the workspace.

     <br><dt><samp><span class="command">mtn list ignored</span></samp><a name="index-mtn-list-ignored-90"></a><br><dt><samp><span class="command">mtn ls ignored</span></samp><a name="index-mtn-ls-ignored-91"></a><dt><samp><span class="command">mtn list ignored </span><var>pathname...</var></samp><a name="index-mtn-list-ignored-_0040var_007bpathname_002e_002e_002e_007d-92"></a><dt><samp><span class="command">mtn ls ignored </span><var>pathname...</var></samp><a name="index-mtn-ls-ignored-_0040var_007bpathname_002e_002e_002e_007d-93"></a><dd>
This command lists all files in your workspace that monotone is
intentionally ignoring, due to the results of the <code>ignore_file
(</code><var>filename</var><code>)</code> hook.

     <p>Specifying pathnames to the <samp><span class="command">list ignored</span></samp> command restricts the
set of paths that are searched for ignored files. Ignored files not
included in the specified set of pathnames will not be listed.

     <p>From within a subdirectory of the workspace the <samp><span class="command">list
ignored</span></samp> command will, by default, search the entire workspace. 
Specifying only the pathname "." will restrict the search for ignored
files to the current subdirectory of the workspace.

     <br><dt><samp><span class="command">mtn list missing</span></samp><a name="index-mtn-list-missing-94"></a><br><dt><samp><span class="command">mtn ls missing</span></samp><a name="index-mtn-ls-missing-95"></a><dt><samp><span class="command">mtn list missing </span><var>pathname...</var></samp><a name="index-mtn-list-missing-_0040var_007bpathname_002e_002e_002e_007d-96"></a><dt><samp><span class="command">mtn ls missing </span><var>pathname...</var></samp><a name="index-mtn-ls-missing-_0040var_007bpathname_002e_002e_002e_007d-97"></a><dd>
This command lists all files in your workspace's base manifest,
which are not present in the workspace.

     <p>Specifying pathnames to the <samp><span class="command">list missing</span></samp> command restricts the
set of paths that are searched for missing files. Missing files not
included in the specified set of pathnames will not be listed.

     <p>From within a subdirectory of the workspace the <samp><span class="command">list
missing</span></samp> command will, by default, search the entire workspace. 
Specifying only the pathname "." will restrict the search for missing
files to the current subdirectory of the workspace.

     <br><dt><samp><span class="command">mtn list changed</span></samp><a name="index-mtn-list-changed-98"></a><br><dt><samp><span class="command">mtn ls changed</span></samp><a name="index-mtn-ls-changed-99"></a><dt><samp><span class="command">mtn list changed </span><var>pathname...</var></samp><a name="index-mtn-list-changed-_0040var_007bpathname_002e_002e_002e_007d-100"></a><dt><samp><span class="command">mtn ls changed </span><var>pathname...</var></samp><a name="index-mtn-ls-changed-_0040var_007bpathname_002e_002e_002e_007d-101"></a><dd>
This command lists all files in your workspace that have changed
compared to the base revision, including files that are dropped, added
or renamed.

     <p>Specifying pathnames to the <samp><span class="command">list changed</span></samp> command restricts
the set of paths that are checked for changes. Files not included in the
specified set of pathnames will not be listed.

     <p>From within a subdirectory of the workspace the <samp><span class="command">list
changed</span></samp> command will, by default, search the entire workspace. 
Specifying only the pathname "." will restrict the search for known
files to the current subdirectory of the workspace.

     <br><dt><samp><span class="command">mtn show_conflicts </span><var>rev</var> <var>rev</var></samp><a name="index-mtn-show_005fconflicts-_0040var_007brev_007d-_0040var_007brev_007d-102"></a><dd>
This command shows what conflicts would need to be resolved in order to merge
the given revisions. 
</dl>

<p><a name="Key-and-Cert-Trust"></a>

<h3 class="section">5.5 Key and Cert Trust</h3>

     <dl>
<dt><samp><span class="command">mtn genkey </span><var>keyid</var></samp><a name="index-mtn-genkey-_0040var_007bkeyid_007d-103"></a><dd>
This command generates an <span class="sc">rsa</span> public/private key pair, using a
system random number generator, and stores it in your keystore under
the key name <var>keyid</var>.

     <p>The private half of the key is stored in an encrypted form, so that anyone
who can read your keystore cannot extract your private key and use it. 
You must provide a passphrase for your key when it is generated, which is used
to determine the encryption key. In the future you will need to enter this
passphrase again each time you sign a certificate, which happens every
time you <samp><span class="command">commit</span></samp> to your database. You can tell monotone to
automatically use a certain passphrase for a given key using the
<code>get_passphrase(</code><var>keypair_id</var><code>)</code>, but this significantly
increases the risk of a key compromise on your local computer. Be
careful using this hook.

     <p>The public key is stored in the database; the public and private keys
are stored in the keystore. This allows copying the database without
copying the private key.

     <p>The location of the keystore is specified by the <samp><span class="option">--keydir</span></samp>
option; it defaults to the value stored in <samp><span class="file">_MTN/options</span></samp> for
commands executed in a workspace, or to
the system default (<samp><span class="file">~/.monotone/keys</span></samp> on Unix and Cygwin,
<samp><span class="file">%APPDATA%/monotone/keys</span></samp> on native Win32).

     <br><dt><samp><span class="command">mtn dropkey </span><var>keyid</var></samp><a name="index-mtn-dropkey-_0040var_007bkeyid_007d-104"></a><dd>
This command drops the public and/or private key. If both exist, both
are dropped, if only one exists, it is dropped. This command should
be used with caution as changes are irreversible without a backup of
the key(s) that were dropped.

     <br><dt><samp><span class="command">mtn passphrase </span><var>id</var></samp><a name="index-mtn-passphrase-_0040var_007bid_007d-105"></a><dd>
This command lets you change the passphrase of the private half of the
key <var>id</var>.

     <br><dt><samp><span class="command">mtn trusted </span><var>id</var> <var>certname</var> <var>certval</var> <var>signers</var></samp><a name="index-mtn-trusted-_0040var_007bid_007d-_0040var_007bcertname_007d-_0040var_007bcertval_007d-_0040var_007bsigners_007d-106"></a><dd>
This command lets you test your revision trust hook
<code>get_revision_cert_trust</code> (see <a href="#Hook-Reference">Hook Reference</a>).  You pass it
a revision ID, a certificate name, a certificate value, and one or more
key IDs, and it will tell you whether, under your current settings,
Monotone would trust a cert on that revision with that value signed by
those keys.

     <br><dt><samp><span class="command">mtn ssh_agent_add</span></samp><a name="index-mtn-ssh_005fagent_005fadd-107"></a><dd>
This command will add your monotone keys to your current ssh-agent session. 
You will be asked for the passphrase for each of your monotone private keys
and they will be added to the ssh-agent. Once this is done you should be able
to type <em>ssh-add -l</em> and see your monotone key listed. When you
subsequently use these keys through monotone it will use ssh-agent for signing
without asking your for your passphrase.

     <p>This command is mainly for use in a session script as monotone will automatically
add your keys to ssh-agent on first use if it is available. For example the
following two examples are equivalent:

     <pre class="smallexample">          $ mtn ssh_agent_add
          enter passphrase for key ID [user@example.com]:
          $ mtn ci -m"Changed foo to bar"
          $ mtn push -k user@example.com
</pre>
     <pre class="smallexample">          $ mtn ci -m"Changed foo to bar"
          enter passphrase for key ID [user@example.com]:
          $ mtn push -k user@example.com
</pre>
     <p>In the second example, monotone automatically added the key to ssh-agent, making
entering the passphrase not needed during the push.

     <br><dt><samp><span class="command">mtn ssh_agent_export </span><var>filename</var></samp><a name="index-mtn-ssh_005fagent_005fexport-_0040var_007bfilename_007d-108"></a><dd>
This command will export your private key in a format that ssh-agent
can read (PKCS8, PEM). You will be asked for your current key's password
and a new password to encrypt the key with. The key will be printed to
stdout. Once you have put this key in a file simply add it to ssh-agent
and you will only have to enter your key password once as ssh-agent
will cache the key for you.

     <pre class="smallexample">          $ mtn ssh_agent_export ~/.ssh/id_monotone
          enter passphrase for key ID [user@example.com]:
          enter new passphrase for key ID [user@example.com]:
          confirm passphrase for key ID [user@example.com]:
          $ chmod 600 ~/.ssh/id_monotone
          $ ssh-agent /bin/bash
          $ ssh-add ~/.ssh/id_monotone
          Enter passphrase for /home/user/.ssh/id_monotone:
          Identity added: /home/user/.ssh/id_monotone (/home/user/.ssh/id_monotone)
          $ mtn ci -m"Changed foo to bar"
          $ mtn push -k user@example.com
</pre>
     <p>You can also use the <samp><span class="option">--ssh-sign</span></samp> option to control whether ssh-agent will
be used for signing. If set to <em>yes</em>, ssh-agent will be used to sign. If your
key has not been added to ssh-agent monotone will fall back to its internal signing
code and ask you for your password. If set to <em>only</em>, monotone will sign only
with ssh-agent. If set to <em>no</em>, monotone will always use its internal signing
code even if ssh-agent is running and has your monotone key loaded. If set to
<em>check</em>, monotone will sign with both ssh-agent (if your key is loaded into
it) and monotone's internal signing code, then compare the results. <em>check</em>
will be removed at some future time as it is meant only for testing and will not
work with all signing algorithms.

</dl>

<p><a name="Certificate"></a>

<h3 class="section">5.6 Certificate</h3>

     <dl>
<dt><samp><span class="command">mtn cert </span><var>id</var> <var>certname</var></samp><a name="index-mtn-cert-_0040var_007bid_007d-_0040var_007bcertname_007d-109"></a><dt><samp><span class="command">mtn cert </span><var>id</var> <var>certname</var> <var>certval</var></samp><a name="index-mtn-cert-_0040var_007bid_007d-_0040var_007bcertname_007d-_0040var_007bcertval_007d-110"></a><dd>
These commands create a new certificate with name <var>certname</var>, for a
revision with version <var>id</var>.  The <var>id</var> argument can be a selector
using certs already on the revision, such as <code>h:</code><var>branchname</var>.

     <p>If <var>certval</var> is provided, it is the value of the certificate. 
Otherwise the certificate value is read from <code>stdin</code>.

     <br><dt><samp><span class="command">mtn approve </span><var>id</var></samp><a name="index-mtn-approve-_0040var_007bid_007d-111"></a><dd>
This command is a synonym for <samp><span class="command">mtn cert </span><var>id</var><span class="command"> branch
</span><var>branchname</var></samp> where <var>branchname</var> is the current branch name
(either deduced from the workspace or from the <samp><span class="option">--branch</span></samp>
option).

     <br><dt><samp><span class="command">mtn comment </span><var>id</var></samp><a name="index-mtn-comment-_0040var_007bid_007d-112"></a><dt><samp><span class="command">mtn comment </span><var>id</var> <var>comment</var></samp><a name="index-mtn-comment-_0040var_007bid_007d-_0040var_007bcomment_007d-113"></a><dd>
These commands are synonyms for <samp><span class="command">mtn cert </span><var>id</var><span class="command">
comment </span><var>comment</var></samp>. If <var>comment</var> is not provided, it is read
from <code>stdin</code>.

     <br><dt><samp><span class="command">mtn suspend </span><var>id</var></samp><a name="index-mtn-suspend-_0040var_007bid_007d-114"></a><dd>
This command is a synonym for <samp><span class="command">mtn cert </span><var>id</var><span class="command"> suspend
</span><var>branchname</var></samp> where <var>branchname</var> is the current branch name
(either deduced from the workspace or from the <samp><span class="option">--branch</span></samp>
option).

     <br><dt><samp><span class="command">mtn tag </span><var>id</var> <var>tagname</var></samp><a name="index-mtn-tag-_0040var_007bid_007d-_0040var_007btagname_007d-115"></a><dd>
This command associates the symbolic name <var>tagname</var> with the
revision <var>id</var>, so that symbolic name can later be used in
<a href="#Selectors">Selectors</a> for specifying revisions for commands like
<samp><span class="command">update</span></samp> or <samp><span class="command">diff</span></samp>.

     <p>This command is a synonym for <samp><span class="command">mtn cert </span><var>id</var><span class="command"> tag
</span><var>tagname</var></samp>.

     <br><dt><samp><span class="command">mtn testresult </span><var>id</var><span class="command"> 0</span></samp><a name="index-mtn-testresult-_0040var_007bid_007d-0-116"></a><dt><samp><span class="command">mtn testresult </span><var>id</var><span class="command"> 1</span></samp><a name="index-mtn-testresult-_0040var_007bid_007d-1-117"></a><dd>
These commands are synonyms for <samp><span class="command">mtn cert </span><var>id</var><span class="command">
testresult 0</span></samp> or <samp><span class="command">mtn cert </span><var>id</var><span class="command"> testresult 1</span></samp>.

</dl>

<p><a name="Packet-I%2fO"></a>
<a name="Packet-I_002fO"></a>

<h3 class="section">5.7 Packet I/O</h3>

<p>Monotone can produce and consume data in a convenient, portable form
called <dfn>packets</dfn>. A packet is a sequence of ASCII text, wrapped at
70-columns and easily sent through email or other transports. If you
wish to manually transmit a piece of information &ndash; for example a
public key &ndash; from one monotone database to another, it is often
convenient to read and write packets.

   <p><em>Note:</em> earlier versions of monotone queued and replayed packet
streams for their networking system. This older networking system has
been removed, as the netsync protocol has several properties which
make it a superior communication system. However, the packet I/O
facility will remain in monotone as a utility for moving individual
data items around manually.

     <dl>
<dt><samp><span class="command">mtn automate packets_for_certs </span><var>id</var></samp><a name="index-mtn-automate-packets_005ffor_005fcerts-_0040var_007bid_007d-118"></a><dd>
This command prints out an <code>rcert</code> packet for each cert in your
database associated with <var>id</var>. These can be used to transport
certificates safely between monotone databases.  See <a href="#Automation">Automation</a>
for details of this command.

     <br><dt><samp><span class="command">mtn automate packet_for_fdata </span><var>id</var></samp><a name="index-mtn-automate-packet_005ffor_005ffdata-_0040var_007bid_007d-119"></a><dt><samp><span class="command">mtn automate packet_for_rdata </span><var>id</var></samp><a name="index-mtn-automate-packet_005ffor_005frdata-_0040var_007bid_007d-120"></a><dd>
These commands print out an <code>fdata</code> or <code>rdata</code> packet for
the file, manifest or revision <var>id</var> in your database.  These can
be used to transport files or revisions, in their entirety, safely
between monotone databases.  See <a href="#Automation">Automation</a> for details of these
commands.

     <br><dt><samp><span class="command">mtn automate packet_for_fdelta </span><var>id1</var> <var>id2</var></samp><a name="index-mtn-automate-packet_005ffor_005ffdelta-_0040var_007bid1_007d-_0040var_007bid2_007d-121"></a><dd>
This command prints out an <code>fdelta</code> packet for the differences
between file versions <var>id1</var> and <var>id2</var>, in your database. 
These can be used to transport file differences safely between
monotone databases.  See <a href="#Automation">Automation</a> for details of this
command.

     <br><dt><samp><span class="command">mtn privkey </span><var>keyid</var></samp><a name="index-mtn-privkey-_0040var_007bkeyid_007d-122"></a><dt><samp><span class="command">mtn pubkey </span><var>keyid</var></samp><a name="index-mtn-pubkey-_0040var_007bkeyid_007d-123"></a><dd>
These commands print out an <code>keypair</code> or <code>pubkey</code> packet for
the <span class="sc">rsa</span> key <var>keyid</var>. These can be used to transport public or
private keys safely between monotone databases.

     <br><dt><samp><span class="command">mtn read</span></samp><a name="index-mtn-read-124"></a><br><dt><samp><span class="command">mtn read </span><var>file1</var> <var>file2...</var></samp><a name="index-mtn-read-_0040var_007bfile1_007d-_0040var_007bfile2_002e_002e_002e_007d-125"></a><dd>
This command reads packets from files or <code>stdin</code> and stores them
in your database.

   </dl>

<p><a name="Database"></a>

<h3 class="section">5.8 Database</h3>

     <dl>
<dt><samp><span class="command">mtn set </span><var>domain</var> <var>name</var> <var>value</var></samp><a name="index-mtn-set-_0040var_007bdomain_007d-_0040var_007bname_007d-_0040var_007bvalue_007d-126"></a><dd>
Associates the value <var>value</var> to <var>name</var> in domain <var>domain</var>. 
See <a href="#Vars">Vars</a> for more information.

     <br><dt><samp><span class="command">mtn unset </span><var>domain</var> <var>name</var></samp><a name="index-mtn-unset-_0040var_007bdomain_007d-_0040var_007bname_007d-127"></a><dd>
Deletes any value associated with <var>name</var> in <var>domain</var>.  See
<a href="#Vars">Vars</a> for more information.

     <br><dt><samp><span class="command">mtn db init --db=</span><var>dbfile</var></samp><a name="index-mtn-db-init-_002d_002ddb_003d_0040var_007bdbfile_007d-128"></a><dd>
This command initializes a new monotone database at <var>dbfile</var>.

     <br><dt><samp><span class="command">mtn db info --db=</span><var>dbfile</var></samp><a name="index-mtn-db-info-_002d_002ddb_003d_0040var_007bdbfile_007d-129"></a><dd>
This command prints information about the monotone database <var>dbfile</var>,
including its schema version and various table size statistics.

     <br><dt><samp><span class="command">mtn db version --db=</span><var>dbfile</var></samp><a name="index-mtn-db-version-_002d_002ddb_003d_0040var_007bdbfile_007d-130"></a><dd>
This command prints out just the schema version of the monotone
database <var>dbfile</var>.

     <br><dt><samp><span class="command">mtn db dump --db=</span><var>dbfile</var></samp><a name="index-mtn-db-dump-_002d_002ddb_003d_0040var_007bdbfile_007d-131"></a><dd>
This command dumps an SQL statement representing the entire state of
<var>dbfile</var> to the standard output stream. It is a very low-level
command, and produces the most &ldquo;recoverable&rdquo; dumps of your database
possible. It is sometimes also useful when migrating databases between
variants of the underlying SQLite database format.

     <br><dt><samp><span class="command">mtn db load --db=</span><var>dbfile</var></samp><a name="index-mtn-db-load-_002d_002ddb_003d_0040var_007bdbfile_007d-132"></a><dd>
This command applies a raw SQL statement, read from the standard input
stream, to the database <var>dbfile</var>. It is most useful when loading
a database dumped with the <samp><span class="command">dump</span></samp> command.

     <p>Note that when reloading a dumped database, the schema of the dumped
database is <em>included</em> in the dump, so you should not try to
<samp><span class="command">init</span></samp> your database before a <samp><span class="command">load</span></samp>.

     <br><dt><samp><span class="command">mtn db migrate --db=</span><var>dbfile</var></samp><a name="index-mtn-db-migrate-_002d_002ddb_003d_0040var_007bdbfile_007d-133"></a><dd>
This command attempts to migrate the database <var>dbfile</var> to the
newest schema known by the version of monotone you are currently
running.  If the migration fails, no changes should be made to the
database.

     <p>If you have important information in your database, you should back up
a copy of it before migrating, in case there is an untrapped error
during migration.

     <br><dt><samp><span class="command">mtn db check --db=</span><var>dbfile</var></samp><a name="index-mtn-db-check-_002d_002ddb_003d_0040var_007bdbfile_007d-134"></a><dd>
Monotone always works hard to verify the data it creates and accesses. 
For instance, if you have hard drive problems that corrupt data in
monotone's database, and you attempt to retrieve this data, then
monotone will notice the problem and stop, instead of silently giving
you garbage data.

     <p>However, it's also nice to notice such problems early, and in rarely
used parts of history, while you still have backups.  That's what this
command is for.  It systematically checks the database <var>dbfile</var> to
ensure that it is complete and consistent. The following problems are
detected:

          <ul>
<li>missing files
that are referenced by their <span class="sc">sha1</span> hash from some manifest but do not
exist in the database.  This is a serious problem; it means that your
history is not fully reconstructible.  You can fix it by finding the
file with the given hash, and loading it into your database with
<samp><span class="command">fload</span></samp>.

          <li>unreferenced files
that exist in the database but are not referenced by their <span class="sc">sha1</span>
hash from any existing manifest.  In itself, this only indicates some
wasted space, and is not a problem; it's possible it could arise under
normal use (for instance, in some strange corner cases following an
incomplete netsync).  It could also arise, though, as a symptom of some
other more serious problem.

          <li>missing manifests
that are referenced by their <span class="sc">sha1</span> hash from some revision but do
not exist in the database.  This is a serious problem; it means that
your history is not fully reconstructible.  You can fix it by finding a
database containing the manifest, and using <samp><span class="command">mdata</span></samp> on that
database to create a manifest data packet, which can be loaded into your
database with <samp><span class="command">read</span></samp>.

          <li>unreferenced manifests
that exist in the database but are not referenced by their <span class="sc">sha1</span>
hash from any existing revision.  In itself, this only indicates some
wasted space, and is not a problem; it's possible it could arise under
normal use (for instance, if you have run <samp><span class="command">db kill_rev_locally</span></samp>,
or in some strange-but-harmless corner cases following an incomplete
netsync).  It could also arise, though, as a symptom of some other more
serious problem.

          <li>incomplete manifests
that exist in the database but contain references to files that do not
exist in the database.  For diagnosis and solution, see &ldquo;missing
files&rdquo; above.

          <li>missing revisions
that are referenced by their <span class="sc">sha1</span> hash from some other revision or
revision cert but do not exist in the database.  This may be a serious
problem; it may indicate that your history is not fully reconstructible
(if the reference is from another revision) or that someone is creating
bogus certs (if the reference is from a cert).  You can fix it by
finding a database containing the revision, and using <samp><span class="command">rdata</span></samp> on
that database to create a revision data packet, which can be loaded into
your database with <samp><span class="command">read</span></samp>.

          <li>incomplete revisions
that exist in the database but contain references to missing manifests,
incomplete manifests or missing revisions.  This always occurs with some
more detailed error; see above.

          <li>revisions with mismatched parents
that disagree with the cached revision ancestry on their parent
revisions.  This may cause problems in using the database, and suggests
the presence of a bug in monotone's caching system, but does not involve
data loss.

          <li>revisions with mismatched children
that disagree with the cached revision ancestry on their child
revisions.  This may cause problems in using the database, and suggests
the presence of a bug in monotone's caching system, but does not involve
data loss.

          <li>revisions with bad history
that exist in the database but fail monotone's normal sanity checks for
consistent and correct history.  This is a serious problem; it indicates
that your history record is somehow malformed.  This should not be
possible, since monotone carefully checks every revision before storing
it into the database, but if it does, then please request assistance on
the monotone mailing list.  Fixing this generally means you may lose
some history &mdash; for instance, renames may be degraded into delete/add
pairs &mdash; but the actual contents of every revision will still be
reproducible.

          <li>revisions with missing certs
that exist in the database lacking at least one author, branch,
changelog or date cert. All revisions are expected to have at least one
of each of these certs.  In itself, this is not necessarily a problem,
but it is peculiar, and some operations such as netsync may behave
strangely.

          <li>revisions with mismatched certs
that exist in the database with differing numbers of author, changelog
and date certs. These certs are expected to appear together, as each
revision committed should have an author, changelog and date associated
with it.  In itself, this is not a problem, but it is peculiar.  All
operations should behave normally.

          <li>missing keys
that have been used to sign certs but do not exist in the database.  In
itself, this is not a problem, except that monotone will ignore any
certs signed by the missing key.  You can fix it by finding a database
containing the key in question, and using <samp><span class="command">pubkey</span></samp> on that
database to create a public key packet, which can be loaded into your
database with <samp><span class="command">read</span></samp>.

          <li>certs with bad signatures
that exist in the database with signatures that are invalid.  In itself,
this is not a problem, except that monotone will ignore any such certs. 
You may also wish to find out who is creating certs with bad
signatures; it may indicate some kind of security attack.

          <li>certs with unchecked signatures
that exist in the database but cannot have their signatures checked
because the signing key is missing.  In itself, this is not a problem,
except that monotone will ignore any certs signed by the missing key. 
You can fix it by finding a database containing the key in question, and
using <samp><span class="command">pubkey</span></samp> on that database to create a public key packet,
which can be loaded into your database with <samp><span class="command">read</span></samp>.

     </ul>

     <p>This command also verifies that the <span class="sc">sha1</span> hash of every file, manifest,
and revision is correct.

     <br><dt><samp><span class="command">mtn db kill_rev_locally </span><var>id</var></samp><a name="index-mtn-db-kill_005frev_005flocally-_0040var_007bid_007d-135"></a><dd>
This command &ldquo;kills&rdquo;, i.e., deletes, a given revision, as well as any
certs attached to it.  It has an ugly name because it is a dangerous
command; it permanently and irrevocably deletes historical information
from your database.  If you execute this command in a workspace, whose
parent revision is the one you are about to delete, the killed revision
is re-applied to this workspace which makes it possible for you to fix
a problem and commit again later on easily. For this to work, the
workspace may not have any changes and/or missing files.

     <p>There are a number of other caveats with this command:
          <ul>
<li>It can only be applied to revisions that have no descendants.  If you
want to kill a revision that has descendants, you must kill all of the
descendants first. 
<li>It only removes the revision from your local database (hence the
&ldquo;locally&rdquo; in the command name).  If you have already pushed this
revision out to another database, then the next time you pull from that
database it may come back again.  There is no way to delete a revision
from somebody else's database except to ask them to delete it for you. 
<li>It does not actually delete the revision's files or manifest from your
database.  If you run this command, and then run <samp><span class="command">db check</span></samp>, it
will note that you have an &ldquo;unreferenced manifest&rdquo;.  If you wish to
eliminate this data for good (and thus free up the space), you may use
netsync to <samp><span class="command">pull</span></samp> from your current database into a new
database; this creates a copy of your old database, without the
unreferenced data.  However, having this data in your database will not
cause any problems, and acts as a safety net; if you later realize that
you do, after all, need to retrieve the data in <var>id</var>, then
<samp><span class="command">db check</span></samp> will let you see which manifest it was, and with some
work you can extract <var>id</var>'s data. 
</ul>

     <br><dt><samp><span class="command">mtn db kill_branch_certs_locally </span><var>branch</var></samp><a name="index-mtn-db-kill_005fbranch_005fcerts_005flocally-_0040var_007bbranch_007d-136"></a><dd>
This command &ldquo;kills&rdquo; a branch by deleting all branch certs with that
branch name. You should consider carefully whether you want to use it,
because it can irrevocably delete important information. It does not
modify or delete any revisions or any of the other certificates on
revisions in the branch; it simply removes the branch certificates
matching the given branch name. Because of this, it can leave
revisions without any branch certificate at all. As with <samp><span class="command">db
kill_rev_locally</span></samp>, it only deletes the information from your local
database; if there are other databases that you sync with which have
revisions in this branch, the branch certificates will reappear when
you sync, unless the owners of those databases also delete those
certificates locally.

     <br><dt><samp><span class="command">mtn db kill_tag_locally </span><var>tag</var></samp><a name="index-mtn-db-kill_005ftag_005flocally-_0040var_007btag_007d-137"></a><dd>
This command &ldquo;kills&rdquo; a tag by deleting all tag certs with that tag
name. You should consider carefully whether you want to use it, because
it can irrevocably delete important information. It does not modify or
delete any revisions, or any of the other certificates on tagged
revisions; it simply removes all tag certificates with the given name. 
As with <samp><span class="command">db kill_rev_locally</span></samp>, it only deletes the information
from your local database; if there are other databases that you sync
with which have this tag, the tag certificates will reappear when you
sync, unless the owners of those databases also delete those
certificates locally.

     <br><dt><samp><span class="command">mtn db execute </span><var>sql-statement</var></samp><a name="index-mtn-db-execute-_0040var_007bsql_002dstatement_007d-138"></a><dd>
This is a debugging command which executes <var>sql-statement</var> against
your database, and prints any results of the expression in a tabular
form.  It can be used to investigate the state of your database, or
help diagnose failures.

</dl>

<p><a name="Automation"></a>

<h3 class="section">5.9 Automation</h3>

<p>This section contains subcommands of the <samp><span class="command">mtn automate</span></samp> command,
used for scripting monotone.  All give output on <code>stdout</code>; they may
also give useful chatter on <code>stderr</code>, including warnings and error
messages.

     <dl>
<dt><samp><span class="command">mtn automate interface_version</span></samp><a name="index-mtn-automate-interface_005fversion-139"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
None.

          <br><dt><strong>Added in:</strong><dd>
0.0

          <br><dt><strong>Purpose:</strong><dd>
Prints version of the automation interface.  Major number increments
whenever a backwards incompatible change is made to the <samp><span class="command">automate</span></samp>
command; minor number increments whenever any change is made (but is
reset when major number increments).

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          1.2
     </pre>

          <br><dt><strong>Output format:</strong><dd>
A decimal number, followed by &ldquo;.&rdquo; (full stop/period), followed by a
decimal number, followed by a newline, followed by end-of-file.  The
first decimal number is the major version, the second is the minor version.

          <br><dt><strong>Error conditions:</strong><dd>
None.

     </dl>

     <br><dt><samp><span class="command">mtn automate heads [</span><var>branch</var><span class="command">]</span></samp><a name="index-mtn-automate-heads-_005b_0040var_007bbranch_007d_005d-140"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
One branch name,  <var>branch</var>. If none is given, the current default branch is used.

          <br><dt><strong>Added in:</strong><dd>
0.0

          <br><dt><strong>Purpose:</strong><dd>
Prints the heads of branch <var>branch</var>.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          28ce076c69eadb9b1ca7bdf9d40ce95fe2f29b61
          75156724e0e2e3245838f356ec373c50fa469f1f
     </pre>

          <br><dt><strong>Output format:</strong><dd>
Zero or more lines, each giving the ID of one head of the given branch. 
Each line consists of a revision ID, in hexadecimal, followed by a
newline.  The lines are printed in alphabetically sorted order.

          <br><dt><strong>Error conditions:</strong><dd>
If the given branch contains no members or does not exist, then no lines are printed.

     </dl>

     <br><dt><samp><span class="command">mtn automate ancestors </span><var>rev1</var><span class="command"> [</span><var>rev2</var><span class="command"> [...]]</span></samp><a name="index-mtn-automate-ancestors-_0040var_007brev1_007d-_005b_0040var_007brev2_007d-_005b_002e_002e_002e_005d_005d-141"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
One or more revision IDs, <var>rev1</var>, <var>rev2</var>, etc.

          <br><dt><strong>Added in:</strong><dd>
0.2

          <br><dt><strong>Purpose:</strong><dd>
Prints the ancestors of one or more revisions.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          28ce076c69eadb9b1ca7bdf9d40ce95fe2f29b61
          75156724e0e2e3245838f356ec373c50fa469f1f
     </pre>

          <br><dt><strong>Output format:</strong><dd>
Zero or more lines, each giving the ID of one ancestor of the given
revisions.  Each line consists of a revision ID, in hexadecimal,
followed by a newline.  The lines are printed in alphabetically sorted
order.

          <p>The output does not include <var>rev1</var>, <var>rev2</var>, etc., except if
<var>rev2</var> is itself an ancestor of <var>rev1</var>, then <var>rev2</var> will be
included in the output.

          <br><dt><strong>Error conditions:</strong><dd>
If any of the revisions do not exist, prints nothing to stdout, prints
an error message to stderr, and exits with status 1.

     </dl>

     <br><dt><samp><span class="command">mtn automate common_ancestors </span><var>rev1</var><span class="command"> [</span><var>rev2</var><span class="command"> [...]]</span></samp><a name="index-mtn-automate-common_005fancestors-_0040var_007brev1_007d-_005b_0040var_007brev2_007d-_005b_002e_002e_002e_005d_005d-142"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
One or more revision IDs, <var>rev1</var>, <var>rev2</var>, etc.

          <br><dt><strong>Added in:</strong><dd>
2.1

          <br><dt><strong>Purpose:</strong><dd>
Prints all revisions which are ancestors of all of the revisions given as
arguments.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          28ce076c69eadb9b1ca7bdf9d40ce95fe2f29b61
          75156724e0e2e3245838f356ec373c50fa469f1f
     </pre>

          <br><dt><strong>Output format:</strong><dd>
Zero or more lines, each giving the ID of one common ancestor of all the given
revisions.  Each line consists of a revision ID, in hexadecimal,
followed by a newline.  The lines are printed in alphabetically sorted
order.

          <p>The output will include one of the argument revisions only if that revision is
an ancestor of all other revisions given as arguments.

          <br><dt><strong>Error conditions:</strong><dd>
If any of the revisions do not exist, prints nothing to stdout, prints
an error message to stderr, and exits with status 1.

     </dl>

     <br><dt><samp><span class="command">mtn automate parents </span><var>rev</var></samp><a name="index-mtn-automate-parents-_0040var_007brev_007d-143"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
One revision ID, <var>rev</var>.

          <br><dt><strong>Added in:</strong><dd>
0.2

          <br><dt><strong>Purpose:</strong><dd>
Prints the immediate parents of a revision.  This is like a
non-recursive version of <samp><span class="command">automate ancestors</span></samp>.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          28ce076c69eadb9b1ca7bdf9d40ce95fe2f29b61
          75156724e0e2e3245838f356ec373c50fa469f1f
     </pre>

          <br><dt><strong>Output format:</strong><dd>
Zero or more lines, each giving the ID of one parent of the given
revision.  Each line consists of a revision ID, in hexadecimal,
followed by a newline.  The lines are printed in alphabetically sorted
order.

          <br><dt><strong>Error conditions:</strong><dd>
If the given revision <var>rev</var> does not exist, prints nothing to
stdout, prints an error message to stderr, and exits with status 1.

     </dl>

     <br><dt><samp><span class="command">mtn automate descendents </span><var>rev1</var><span class="command"> [</span><var>rev2</var><span class="command"> [...]]</span></samp><a name="index-mtn-automate-descendents-_0040var_007brev1_007d-_005b_0040var_007brev2_007d-_005b_002e_002e_002e_005d_005d-144"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
One or more revision IDs, <var>rev1</var>, <var>rev2</var>, etc.

          <br><dt><strong>Added in:</strong><dd>
0.1

          <br><dt><strong>Purpose:</strong><dd>
Prints the descendants of one or more revisions.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          28ce076c69eadb9b1ca7bdf9d40ce95fe2f29b61
          75156724e0e2e3245838f356ec373c50fa469f1f
     </pre>

          <br><dt><strong>Output format:</strong><dd>
Zero or more lines, each giving the ID of one descendant of the given
revisions.  Each line consists of a revision ID, in hexadecimal,
followed by a newline.  The lines are printed in alphabetically sorted
order.

          <p>The output does not include <var>rev1</var>, <var>rev2</var>, etc., except that if
<var>rev2</var> is itself a descendant of <var>rev1</var>, then <var>rev2</var> will be
included in the output.

          <br><dt><strong>Error conditions:</strong><dd>
If any of the revisions do not exist, prints nothing to stdout, prints
an error message to stderr, and exits with status 1.

     </dl>

     <br><dt><samp><span class="command">mtn automate children </span><var>rev</var></samp><a name="index-mtn-automate-children-_0040var_007brev_007d-145"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
One revision ID, <var>rev</var>.

          <br><dt><strong>Added in:</strong><dd>
0.2

          <br><dt><strong>Purpose:</strong><dd>
Prints the immediate children of a revision.  This is like a
non-recursive version of <samp><span class="command">automate descendents</span></samp>.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          28ce076c69eadb9b1ca7bdf9d40ce95fe2f29b61
          75156724e0e2e3245838f356ec373c50fa469f1f
     </pre>

          <br><dt><strong>Output format:</strong><dd>
Zero or more lines, each giving the ID of one child of the given
revision.  Each line consists of a revision ID, in hexadecimal,
followed by a newline.  The lines are printed in alphabetically sorted
order.

          <br><dt><strong>Error conditions:</strong><dd>
If the given revision <var>rev</var> does not exist, prints nothing to
stdout, prints an error message to stderr, and exits with status 1.

     </dl>

     <br><dt><samp><span class="command">mtn automate graph</span></samp><a name="index-mtn-automate-graph-146"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
None.

          <br><dt><strong>Added in:</strong><dd>
0.2

          <br><dt><strong>Purpose:</strong><dd>
Prints out the complete ancestry graph of this database.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          0c05e8ec9c6af4224672c7cc4c9ef05ae8bdb794
          27ebcae50e1814e35274cb89b5031a423c29f95a 5830984dec5c41d994bcadfeab4bf1bf67747b89
          4e284617c80bec7da03925062a84f715c1b042bd 27ebcae50e1814e35274cb89b5031a423c29f95a 657c756d24fb65213d59f4ae07e117d830dcc95b
     </pre>

          <br><dt><strong>Output format:</strong><dd>
Zero or more lines, each giving ancestry information for one revision. 
Each line begins with a revision ID.  Following this are zero or more
space-prefixed revision IDs.  Each revision ID after the first is a
parent (in the sense of <samp><span class="command">automate parents</span></samp>) of the first.  For
instance, in the above sample output,
0c05e8ec9c6af4224672c7cc4c9ef05ae8bdb794 is a root node,
27ebcae50e1814e35274cb89b5031a423c29f95a has one parent, and
4e284617c80bec7da03925062a84f715c1b042bd has two parents, i.e., is a
merge node.

          <p>The output as a whole is alphabetically sorted by line; additionally,
the parents within each line are alphabetically sorted.

          <br><dt><strong>Error conditions:</strong><dd>
None.

     </dl>

     <br><dt><samp><span class="command">mtn automate erase_ancestors [</span><var>rev1</var><span class="command"> [</span><var>rev2</var><span class="command"> [...]]]</span></samp><a name="index-mtn-automate-erase_005fancestors-_005b_0040var_007brev1_007d-_005b_0040var_007brev2_007d-_005b_002e_002e_002e_005d_005d_005d-147"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
One or more revision IDs, <var>rev1</var>, <var>rev2</var>, etc.

          <br><dt><strong>Added in:</strong><dd>
0.1

          <br><dt><strong>Purpose:</strong><dd>
Prints all arguments, except those that are an ancestor of some other
argument.  One way to think about this is that it prints the minimal
elements of the given set, under the ordering imposed by the &ldquo;child
of&rdquo; relation.  Another way to think of it is if the arguments formed a
branch, then we would print the heads of that branch.  If there
are no arguments, prints nothing.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          28ce076c69eadb9b1ca7bdf9d40ce95fe2f29b61
          75156724e0e2e3245838f356ec373c50fa469f1f
     </pre>

          <br><dt><strong>Output format:</strong><dd>
Zero or more lines, each giving the ID of one descendant of the given
revisions.  Each line consists of a revision ID, in hexadecimal,
followed by a newline.  The lines are printed in alphabetically sorted
order.

          <br><dt><strong>Error conditions:</strong><dd>
If any of the revisions do not exist, prints nothing to stdout, prints
an error message to stderr, and exits with status 1.

     </dl>

     <br><dt><samp><span class="command">mtn automate toposort [</span><var>rev1</var><span class="command"> [</span><var>rev2</var><span class="command"> [...]]]</span></samp><a name="index-mtn-automate-toposort-_005b_0040var_007brev1_007d-_005b_0040var_007brev2_007d-_005b_002e_002e_002e_005d_005d_005d-148"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
One or more revision IDs, <var>rev1</var>, <var>rev2</var>, etc.

          <br><dt><strong>Added in:</strong><dd>
0.1

          <br><dt><strong>Purpose:</strong><dd>
Prints all arguments, topologically sorted.  I.e., if <var>rev1</var> is an
ancestor of <var>rev2</var>, then <var>rev1</var> will appear before <var>rev2</var> in
the output; if <var>rev2</var> is an ancestor of <var>rev1</var>, then <var>rev2</var>
will appear before <var>rev1</var> in the output; and if neither is an
ancestor of the other, then they may appear in either order.  If there
are no arguments, prints nothing.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          28ce076c69eadb9b1ca7bdf9d40ce95fe2f29b61
          75156724e0e2e3245838f356ec373c50fa469f1f
     </pre>

          <br><dt><strong>Output format:</strong><dd>
A list of revision IDs, in hexadecimal, each followed by a newline. 
Revisions are printed in topologically sorted order.

          <br><dt><strong>Error conditions:</strong><dd>
If any of the revisions do not exist, prints nothing to stdout, prints
an error message to stderr, and exits with status 1.

     </dl>

     <br><dt><samp><span class="command">mtn automate ancestry_difference </span><var>new</var><span class="command"> [</span><var>old1</var><span class="command"> [</span><var>old2</var><span class="command"> [...]]]</span></samp><a name="index-mtn-automate-ancestry_005fdifference-_0040var_007bnew_007d-_005b_0040var_007bold1_007d-_005b_0040var_007bold2_007d-_005b_002e_002e_002e_005d_005d_005d-149"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
A &ldquo;new&rdquo; revision ID <var>new</var>, followed by zero or more &ldquo;old&rdquo;
revision IDs <var>old1</var>, <var>old2</var>, etc.

          <br><dt><strong>Added in:</strong><dd>
0.1

          <br><dt><strong>Purpose:</strong><dd>
Prints all ancestors of the revision <var>new</var>, that are not also
ancestors of one of the old revisions.  For purposes of this command,
&ldquo;ancestor&rdquo; is an inclusive term; for example, if <var>new</var> is an
ancestor of <var>old1</var>, it will not be printed; but if <var>new</var> is not
an ancestor of any of the &ldquo;old&rdquo; revisions, then it will be. 
Similarly, <var>old1</var> will never be printed, because it is considered to
be an ancestor of itself.  The reason for the names is that if <var>new</var>
a new revision, and <var>old1</var>, <var>old2</var>, etc. are revisions that you
have processed before, then this command tells you which revisions are
new since then.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          28ce076c69eadb9b1ca7bdf9d40ce95fe2f29b61
          75156724e0e2e3245838f356ec373c50fa469f1f
     </pre>

          <br><dt><strong>Output format:</strong><dd>
A list of revision IDs, in hexadecimal, each followed by a newline. 
Revisions are printed in topologically sorted order.

          <br><dt><strong>Error conditions:</strong><dd>
If any of the revisions do not exist, prints nothing to stdout, prints
an error message to stderr, and exits with status 1.

     </dl>

     <br><dt><samp><span class="command">mtn automate leaves</span></samp><a name="index-mtn-automate-leaves-150"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
None.

          <br><dt><strong>Added in:</strong><dd>
0.1

          <br><dt><strong>Purpose:</strong><dd>
Prints the leaves of the revision graph, i.e. all revision that have no
children.  This is similar, but not identical to the functionality of
<samp><span class="command">heads</span></samp>, which prints every revision in a branch, that has no
descendants in that branch.  If every revision in the database was in
the same branch, then they would be identical.  Generally, every leaf is
the head of some branch, but not every branch head is a leaf.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          28ce076c69eadb9b1ca7bdf9d40ce95fe2f29b61
          75156724e0e2e3245838f356ec373c50fa469f1f
     </pre>

          <br><dt><strong>Output format:</strong><dd>
Zero or more lines, each a leaf of the revision graph.  Each line
consists of a revision ID, in hexadecimal, followed by a newline.  The
lines are printed in alphabetically sorted order.

          <br><dt><strong>Error conditions:</strong><dd>
None.

     </dl>

     <br><dt><samp><span class="command">mtn automate roots</span></samp><a name="index-mtn-automate-roots-151"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
None.

          <br><dt><strong>Added in:</strong><dd>
4.3

          <br><dt><strong>Purpose:</strong><dd>
Prints the roots of the revision graph, i.e. all revisions that have
no parents.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          276264b0b3f1e70fc1835a700e6e61bdbe4c3f2f
     </pre>

          <br><dt><strong>Output format:</strong><dd>
Zero or more lines, each a root of the revision graph.  Each line
consists of a revision ID, in hexadecimal, followed by a newline.  The
lines are printed in alphabetically sorted order.

          <br><dt><strong>Error conditions:</strong><dd>
None.

     </dl>

     <br><dt><samp><span class="command">mtn automate branches</span></samp><a name="index-mtn-automate-branches-152"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
None.

          <br><dt><strong>Added in:</strong><dd>
2.2

          <br><dt><strong>Purpose:</strong><dd>
Prints all branch certs present in the revision graph, that are not
excluded by the Lua hook <code>ignore_branch</code>.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          net.venge.monotone
          net.venge.monotone.win32
     </pre>

          <br><dt><strong>Output format:</strong><dd>
Zero or more lines, each the name of a branch. The lines are printed
in alphabetically sorted order.

          <br><dt><strong>Error conditions:</strong><dd>
None.

     </dl>

     <br><dt><samp><span class="command">mtn automate tags [</span><var>branch_pattern</var><span class="command">]</span></samp><a name="index-mtn-automate-tags-_005b_0040var_007bbranch_005fpattern_007d_005d-153"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
A branch pattern (optional).

          <br><dt><strong>Added in:</strong><dd>
2.2

          <br><dt><strong>Purpose:</strong><dd>
If a branch pattern is given, prints all tags that are attached to
revisions on branches matched by the pattern; otherwise prints all
tags of the revision graph.

          <p>If a branch name is ignored by means of the Lua hook
<code>ignore_branch</code>, it is neither printed, nor can it be matched by
a pattern.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          format_version "1"
          
               tag "monotree-0.3"
          revision [35cff8e8ba14155f5f7ddf7965073f514fd60f61]
            signer "njs@pobox.com"
          branches "net.venge.monotone.contrib.monotree"
          
               tag "monotree-0.2"
          revision [5d288b39b49613b0d9dca8ece6b9a42c3773f35b]
            signer "njs@pobox.com"
          branches "net.venge.monotone.contrib.monotree"
          
               tag "monotree-0.1"
          revision [8a121346ce2920b6f85df68b3b620de96bd14a8d]
            signer "njs@pobox.com"
          branches "net.venge.monotone.contrib" "net.venge.monotone.contrib.monotree"
          
               tag "monotree-0.4"
          revision [f1afc520474f83c58262896ede027ef77226046e]
            signer "njs@pobox.com"
          branches "net.venge.monotone.contrib.monotree"
     </pre>

          <br><dt><strong>Output format:</strong><dd>
There is one basic_io stanza for each tag.

          <p>All stanzas are formatted by basic_io. Stanzas are separated by a
blank line. Values will be escaped, '\' to '\\' and '"' to '\"'.

          <p>Each stanza has exactly the following four entries:

               <dl>
<dt><samp><span class="option">'tag'</span></samp><dd>the value of the tag cert, i.e. the name of the tag

               <br><dt><samp><span class="option">'revision'</span></samp><dd>the hexadecimal id of the revision the tag is attached to

               <br><dt><samp><span class="option">'signer'</span></samp><dd>the name of the key used to sign the tag cert

               <br><dt><samp><span class="option">'branches'</span></samp><dd>a (possibly empty) list of all branches the tagged revision is on
</dl>

          <p>Stanzas are printed in arbitrary order.

          <br><dt><strong>Error conditions:</strong><dd>
A run-time exception occurs if an illegal branch pattern is
specified.

     </dl>

     <br><dt><samp><span class="command">mtn automate select </span><var>selector</var></samp><a name="index-mtn-automate-select-_0040var_007bselector_007d-154"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
One selector (or combined selector).

          <br><dt><strong>Added in:</strong><dd>
0.2

          <br><dt><strong>Purpose:</strong><dd>
Print all revisions that match the given selector.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          28ce076c69eadb9b1ca7bdf9d40ce95fe2f29b61
          75156724e0e2e3245838f356ec373c50fa469f1f
     </pre>

          <br><dt><strong>Output format:</strong><dd>
Zero or more lines, each giving the ID of one revision that matches the
given selector.  Each line consists of a revision ID, in hexadecimal,
followed by a newline.  Revision ids are printed in alphabetically
sorted order.

          <br><dt><strong>Error conditions:</strong><dd>
None.

     </dl>

     <br><dt><samp><span class="command">mtn automate identify </span><var>path</var></samp><a name="index-mtn-automate-identify-_0040var_007bpath_007d-155"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
A file path.

          <br><dt><strong>Added in:</strong><dd>
4.3

          <br><dt><strong>Purpose:</strong><dd>
Prints the file ID (aka hash) of the given file.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          6265ab1312fbe38bdc3aafa92441139cb2b779b0
     </pre>

          <br><dt><strong>Output format:</strong><dd>
A single line with the file's ID, in hexadecimal, followed by a newline.

          <br><dt><strong>Error conditions:</strong><dd>
If the file does not exists, is a special file or not readable, prints an
error message to stderr and exists with status 1. A single file path only
consisting of "-" is disallowed since it collides with the UNIX stdin
marker.

     </dl>

     <br><dt><samp><span class="command">mtn automate inventory [</span><samp><span class="option">options...</span></samp><span class="command">] [</span><var>files...</var><span class="command">]</span></samp><a name="index-mtn-automate-inventory-_005b_0040option_007boptions_002e_002e_002e_007d_005d-_005b_0040var_007bfiles_002e_002e_002e_007d_005d-156"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
One or more file paths (optional). If present, only show an inventory for the
given files or directories (and their sub-directories).

               <dl>
<dt><samp><span class="option">--depth=</span><var>n</var></samp><dd>Maximum number of directories to descend.

               <br><dt><samp><span class="option">--exclude=</span><var>exclude-glob</var></samp><dd>File or directory to exclude.

               <br><dt><samp><span class="option">--no-ignored</span></samp><dd>Don't output ignored files or directories.

               <br><dt><samp><span class="option">--no-unknown</span></samp><dd>Don't output unknown directories.

               <br><dt><samp><span class="option">--no-unchanged</span></samp><dd>Don't output files that are known but not changed in any way.

               <br><dt><samp><span class="option">--no-corresponding-renames</span></samp><dd>If restricted to a renamed path, do not output the corresponding old / new
paths for this restriction.

          </dl>

          <br><dt><strong>Changes:</strong><dd>
               <ul>
<li>7.0 &ndash; added options <samp><span class="option">--no-ignored</span></samp>, <samp><span class="option">--no-unknown</span></samp>,
<samp><span class="option">--no-unchanged</span></samp> and <samp><span class="option">--no-corresponding-renames</span></samp>
<li>6.0 &ndash; converted to basic_io format (restriction support, various fixes)
<li>1.0 &ndash; initial, line-based format
</ul>

          <br><dt><strong>Purpose:</strong><dd>
Prints the inventory of every file found in the workspace or its
associated base and revision manifests. Each unique path is
listed in a basic_io stanza. Stanzas are separated by blank lines.

          <br><dt><strong>Sample output:</strong><dd>
All basic status cases:
<pre class="verbatim">          
              path "added"
          new_type "file"
           fs_type "file"
            status "added" "known"
           changes "content"
          
              path "attributes_altered"
          old_type "file"
          new_type "file"
           fs_type "file"
            status "known"
           changes "attrs"
          
              path "dropped"
          old_type "file"
           fs_type "none"
            status "dropped"
          
             path "ignored~"
          fs_type "file"
           status "ignored"
          
              path "missing"
          old_type "file"
          new_type "file"
           fs_type "none"
            status "missing"
          
              path "original"
          old_type "file"
          new_path "renamed"
           fs_type "none"
            status "rename_source"
          
              path "patched"
          old_type "file"
          new_type "file"
           fs_type "file"
            status "known"
           changes "content"
          
              path "patched_and_attributes_altered"
          old_type "file"
          new_type "file"
           fs_type "file"
            status "known"
           changes "content" "attrs"
          
              path "renamed"
          new_type "file"
          old_path "original"
           fs_type "file"
            status "rename_target" "known"
          
              path "unchanged"
          old_type "file"
          new_type "file"
           fs_type "file"
            status "known"
          
             path "unknown"
          fs_type "file"
           status "unknown"
     </pre>

          <p>Two files swapped in both the revision manifest and the workspace:
<pre class="verbatim">          
              path "original"
          old_type "file"
          new_path "unchanged"
          new_type "file"
          old_path "unchanged"
           fs_type "file"
            status "rename_source" "rename_target" "known"
          
              path "unchanged"
          old_type "file"
          new_path "original"
          new_type "file"
          old_path "original"
           fs_type "file"
            status "rename_source" "rename_target" "known"
     </pre>

          <p>Recorded in the revision manifest that two files were swapped, but
they were not actually swapped in the workspace. Thus they both appear
as patched:
<pre class="verbatim">          
              path "original"
          old_type "file"
          new_path "unchanged"
          new_type "file"
          old_path "unchanged"
           fs_type "file"
            status "rename_source" "rename_target" "known"
           changes "content"
          
              path "unchanged"
          old_type "file"
          new_path "original"
          new_type "file"
          old_path "original"
           fs_type "file"
            status "rename_source" "rename_target" "known"
           changes "content"
          
     </pre>

          <p>Rename (in the manifest and the workspace) <samp><span class="file">foo</span></samp> to <samp><span class="file">bar</span></samp>;
add (in the manifest and the workspace) new file <samp><span class="file">foo</span></samp>:
<pre class="verbatim">          
              path "foo"
          old_type "file"
          new_path "bar"
          new_type "file"
           fs_type "file"
            status "rename_source" "added" "known"
          
              path "bar"
          new_type "file"
          old_path "foo"
           fs_type "file"
            status "rename_target" "known"
     </pre>

          <p>Rotated files <samp><span class="file">foo</span></samp> -&gt; <samp><span class="file">bar</span></samp> -&gt; <samp><span class="file">baz</span></samp> -&gt; <samp><span class="file">foo</span></samp> (in
the manifest and the workspace):
<pre class="verbatim">          
              path "foo"
          old_type "file"
          new_path "bar"
          new_type "file"
          old_path "baz"
           fs_type "file"
            status "rename_source" "rename_target" "known"
          
              path "bar"
          old_type "file"
          new_path "baz"
          new_type "file"
          old_path "foo"
           fs_type "file"
            status "rename_source" "rename_target" "known"
          
              path "baz"
          old_type "file"
          new_path "foo"
          new_type "file"
          old_path "bar"
           fs_type "file"
            status "rename_source" "rename_target" "known"
     </pre>

          <p>Recorded in the revison manifest the rotation of files <samp><span class="file">foo</span></samp> -&gt;
<samp><span class="file">bar</span></samp> -&gt; <samp><span class="file">baz</span></samp> -&gt; <samp><span class="file">foo</span></samp>, but the actual files in the
workspace were not moved, so monotone interprets all files as having
been patched:
<pre class="verbatim">          
              path "foo"
          old_type "file"
          new_path "bar"
          new_type "file"
          old_path "baz"
           fs_type "file"
            status "rename_source" "rename_target" "known"
           changes "content"
          
              path "bar"
          old_type "file"
          new_path "baz"
          new_type "file"
          old_path "foo"
           fs_type "file"
            status "rename_source" "rename_target" "known"
           changes "content"
          
              path "baz"
          old_type "file"
          new_path "foo"
          new_type "file"
          old_path "bar"
           fs_type "file"
            status "rename_source" "rename_target" "known"
           changes "content"
     </pre>

          <p>Dropped from the manifest but not removed in the workspace and thus
unknown:
<pre class="verbatim">          
              path "dropped"
          old_type "file"
           fs_type "file"
            status "dropped" "unknown"
     </pre>

          <p>Added in the manifest but not in the workspace, and thus missing:
<pre class="verbatim">          
              path "added"
          new_type "file"
           fs_type "none"
            status "added" "missing"
     </pre>

          <p>Recorded a rename in the manifest, but not moved in the workspace,
and thus unknown source and missing target:
<pre class="verbatim">          
              path "original"
          old_type "file"
          new_path "renamed"
           fs_type "file"
            status "rename_source" "unknown"
          
              path "renamed"
          new_type "file"
          old_path "original"
           fs_type "none"
            status "rename_target" "missing"
     </pre>

          <p>Moved in the workspace but no rename recorded in the manifest, and
thus missing source and unknown target:
<pre class="verbatim">          
              path "original"
          old_type "file"
          new_type "file"
           fs_type "none"
            status "missing"
          
             path "renamed"
          fs_type "file"
           status "unknown"
     </pre>

          <p>Renamed in the manifest and the workspace and patched:
<pre class="verbatim">          
              path "original"
          old_type "file"
          new_path "renamed"
           fs_type "none"
            status "rename_source"
          
              path "renamed"
          new_type "file"
          old_path "original"
           fs_type "file"
            status "rename_target" "known"
           changes "content"
     </pre>

          <p>Renamed and restricted to <samp><span class="file">original</span></samp> or <samp><span class="file">renamed</span></samp>:
<pre class="verbatim">          
              path "original"
          old_type "file"
          new_path "renamed"
           fs_type "none"
            status "rename_source"
          
              path "renamed"
          new_type "file"
          old_path "original"
           fs_type "file"
            status "rename_target" "known"
           changes "content"
     </pre>

          <p>Renamed and restricted to <samp><span class="file">original</span></samp> with the <samp><span class="option">--no-corresponding-renames</span></samp> option:
<pre class="verbatim">          
              path "original"
          old_type "file"
          new_path "renamed"
           fs_type "none"
            status "rename_source"
     </pre>

          <p>Renamed and restricted to <samp><span class="file">renamed</span></samp> with the <samp><span class="option">--no-corresponding-renames</span></samp> option:
<pre class="verbatim">          
              path "renamed"
          new_type "file"
          old_path "original"
           fs_type "file"
            status "rename_target" "known"
           changes "content"
     </pre>

          <p>File is missing, an unversioned directory is in the way:
<pre class="verbatim">          
              path "missing_file"
          old_type "file"
          new_type "file"
           fs_type "directory"
            status "invalid"
           changes "content"
     </pre>

          <p>Directory is missing, an unversioned file is in the way:
<pre class="verbatim">          
              path "missing_directory"
          old_type "directory"
          new_type "directory"
           fs_type "file"
            status "invalid"
     </pre>

          <p>Directory <samp><span class="file">source</span></samp> renamed to <samp><span class="file">target</span></samp>, <samp><span class="file">target</span></samp> is missing, an
unversioned file is in the way:
<pre class="verbatim">          
              path "source"
          old_type "directory"
          new_path "target"
           fs_type "none"
            status "rename_source"
          
              path "source/a"
          old_type "file"
          new_path "target/a"
           fs_type "none"
            status "rename_source"
          
              path "target"
          new_type "directory"
          old_path "source"
           fs_type "file"
            status "rename_target" "invalid"
          
              path "target/a"
          new_type "file"
          old_path "source/a"
           fs_type "none"
            status "rename_target" "missing"
     </pre>

          <br><dt><strong>Output format:</strong><dd>
Each path is printed in one basic_io stanza. Stanzas are separated by
a blank line. Each stanza starts with a <code>path</code> line, and contains
up to seven lines. The order of the lines is not important, and may
change in future revisions, except that the first line will always be
<code>path</code>.

               <dl>
<dt><samp><span class="option">path</span></samp><dd>The file or directory path, relative to the workspace root. The file
either exists in the workspace, or is listed in the base or revision
manifest. 
<samp><span class="option">path</span></samp> is always output.

               <br><dt><samp><span class="option">old_type</span></samp><dd>The type of the node in the base manifest. 
&ldquo;type&rdquo; is either <samp><span class="option">file</span></samp> or <samp><span class="option">directory</span></samp>. 
<samp><span class="option">old_type</span></samp> is output for all old nodes (i.e. unchanged or dropped paths
and rename sources).

               <br><dt><samp><span class="option">new_type</span></samp><dd>The type of the node in the revision manifest. 
&ldquo;type&rdquo; is either <samp><span class="option">file</span></samp> or <samp><span class="option">directory</span></samp>. 
<samp><span class="option">new_type</span></samp> is output for all new nodes (i.e. unchanged or added paths
and rename targets).

               <br><dt><samp><span class="option">fs_type</span></samp><dd>The type of the node in the workspace (also called the filesystem). 
&ldquo;type&rdquo; is either <samp><span class="option">file</span></samp>, <samp><span class="option">directory</span></samp> or <samp><span class="option">none</span></samp>
(if the path does not exist in the file system). 
<samp><span class="option">fs_type</span></samp> is always output.

               <br><dt><samp><span class="option">old_path</span></samp><dd>The old path for the node, if it has been renamed in the revision
manifest. 
<samp><span class="option">old_path</span></samp> is only output for rename targets.

               <br><dt><samp><span class="option">new_path</span></samp><dd>The new path for the node, if it has been renamed in the revision
manifest. 
<samp><span class="option">new_path</span></samp> is only output for rename sources.

               <br><dt><samp><span class="option">status</span></samp><dd><samp><span class="option">status</span></samp> is always output. Its value is one or more of:

                    <dl>
<dt><samp><span class="option">rename_source</span></samp><dd><var>path</var> is part of a rename and denotes the old name of a renamed node.

                    <br><dt><samp><span class="option">rename_target</span></samp><dd><var>path</var> is part of a rename and denotes the new name of a renamed node.

                    <br><dt><samp><span class="option">added</span></samp><dd><var>path</var> has been added in the revision manifest, but not existent in the
base manifest.

                    <br><dt><samp><span class="option">dropped</span></samp><dd><var>path</var> has been deleted in the revision manifest and the workspace.

                    <br><dt><samp><span class="option">missing</span></samp><dd><var>path</var> has been deleted in the workspace, but still exists in the revision
manifest.

                    <br><dt><samp><span class="option">ignored</span></samp><dd><var>path</var> is ignored by monotone.

                    <br><dt><samp><span class="option">known</span></samp><dd><var>path</var> exists in the workspace, and in the revision manifest.

                    <br><dt><samp><span class="option">unknown</span></samp><dd><var>path</var> exists in the workspace, but not in the revision manifest, i.e. 
is unversioned.

                    <br><dt><samp><span class="option">invalid</span></samp><dd><var>path</var> is versioned and exists in the workspace and revision manifest, but
with incompatible types (a versioned missing file is replaced by an
unversioned directory and vice versa). 
</dl>

               <br><dt><samp><span class="option">changes</span></samp><dd>
                    <dl>
   <dt><samp><span class="option">content</span></samp><dd>   The contents of a file have been changed.

                    <br><dt><samp><span class="option">attrs</span></samp><dd>   The attributes of a path (file or directory) have been changed.

               </dl>
               </dl>

          <br><dt><strong>Error conditions:</strong><dd>
When executed from outside of a workspace directory, prints an error
message to stderr, and exits with status 1.

     </dl>

     <br><dt><samp><span class="command">mtn automate certs </span><var>id</var></samp><a name="index-mtn-automate-certs-_0040var_007bid_007d-157"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
A revision ID <var>id</var>, for which any certificates will be printed.

          <br><dt><strong>Added in:</strong><dd>
1.0

          <br><dt><strong>Purpose:</strong><dd>
Prints all certificates associated with the given revision ID. 
Each certificate is contained in a basic IO stanza. For each certificate,
the following values are provided:
<pre class="verbatim">          
          'key'
                a string indicating the key used to sign this certificate.
          'signature'
                a string indicating the status of the signature. Possible
                values of this string are:
                      'ok'        : the signature is correct
                      'bad'       : the signature is invalid
                      'unknown'   : signature was made with an unknown key
          'name'
                the name of this certificate
          'value'
                the value of this certificate
          'trust'
                is this certificate trusted by the defined trust metric?
                Possible values of this string are:
                      'trusted'   : this certificate is trusted
                      'untrusted' : this certificate is not trusted
     </pre>

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
                key "emile@alumni.reed.edu"
          signature "ok"
               name "author"
              value "emile@alumni.reed.edu"
              trust "trusted"
          
                key "emile@alumni.reed.edu"
          signature "ok"
               name "branch"
              value "net.venge.monotone"
              trust "trusted"
          
                key "emile@alumni.reed.edu"
          signature "ok"
               name "changelog"
              value "propagate from branch 'net.venge.monotone.annotate' (head 76a886ef7c8ae12a4bba5fc2bd252557bf863aff)
                      to branch 'net.venge.monotone' (head 2490479a4e4e99243fead6d627d78291fde592f0)
          "
              trust "trusted"
          
                key "emile@alumni.reed.edu"
          signature "ok"
               name "date"
              value "2005-05-20T20:19:25"
              trust "trusted"
     </pre>

          <br><dt><strong>Output format:</strong><dd>
All stanzas are formatted by basic_io. Stanzas are separated
by a blank line. Values will be escaped, '\' to '\\' and
'"' to '\"'.

          <br><dt><strong>Error conditions:</strong><dd>
If a certificate is signed with an unknown public key, a
warning message is printed to stderr. If the revision specified is unknown
or invalid prints an error message to stderr and exits with status 1.

     </dl>

     <br><dt><samp><span class="command">mtn automate stdio</span></samp><a name="index-mtn-automate-stdio-158"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
none

          <br><dt><strong>Changes:</strong><dd>
               <ul>
<li>3.1 &ndash; Added the 'o' item to the recognized input. This change should not
break anything. 
<li>1.0 &ndash; Initial version. 
</ul>

          <br><dt><strong>Purpose:</strong><dd>
Allow multiple automate commands to be run from one instance of monotone.

          <br><dt><strong>Sample input:</strong><dd>
<pre class="verbatim">          
          l6:leavese
          l7:parents40:0e3171212f34839c2e3263e7282cdeea22fc5378e
          o3:key11:foo@bar.come l4:cert40:0e3171212f34839c2e3263e7282cdeea22fc53783:foo3:bare
     </pre>

          <br><dt><strong>Input format:</strong><dd>
<pre class="verbatim">          
          [ 'o' &lt;string> &lt;string> [ &lt;string> &lt;string> [ ... ] ] 'e' ]
          'l' &lt;string> [ &lt;string> [ ... ] ] 'e'
     </pre>

          <p>The input is a series of commands. The command name plus arguments are
provided as 'l' &lt;string&gt; [&lt;string&gt; ...] 'e', where &lt;string&gt; = &lt;size&gt; colon
&lt;data&gt; . This may optionally be preceded by a set of key=value pairs
(command options) as 'o' &lt;string&gt; &lt;string&gt; [&lt;string&gt; &lt;string&gt; ...] 'e', where
strings come in pairs, key followed by value. For flag options that
don't take values, specify the second string as zero length; <code>0:</code>.

          <p>The space between the ending 'e' of one group of strings and the beginning
'l' or 'o' of the next is reserved. Any characters other than whitespace
will cause an error.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          0:0:l:205:0e3171212f34839c2e3263e7282cdeea22fc5378
          1f4ef73c3e056883c6a5ff66728dd764557db5e6
          2133c52680aa2492b18ed902bdef7e083464c0b8
          23501f8afd1f9ee037019765309b0f8428567f8a
          2c295fcf5fe20301557b9b3a5b4d437b5ab8ec8c
          1:0:l:41:7706a422ccad41621c958affa999b1a1dd644e79
     </pre>

          <br><dt><strong>Output format:</strong><dd>
The output consists of one or more packets for each command. 
A packet looks like:

          <p>&lt;command number&gt;:&lt;err code&gt;:&lt;last?&gt;:&lt;size&gt;:&lt;output&gt;

          <p>&lt;command number&gt; is a decimal number specifying which command this output
is from. It is 0 for the first command, and increases by one each time.

          <p>&lt;err code&gt; is 0 for success, 1 for a syntax error, and 2 for any other error.

          <p>&lt;last?&gt; is 'l' if this is the last piece of output for this command, and 'm'
if there is more output to come.

          <p>&lt;size&gt; is the number of bytes in the output.

          <p>&lt;output&gt; is a piece of the output of the command.

          <p>All but the last packet for a given command will have the
&lt;last?&gt; field set to 'm'.

          <br><dt><strong>Error conditions:</strong><dd>
If a badly formatted or invalid command is received, or a command is
given with invalid arguments or options, prints an error message to
standard error and exits with nonzero status. Errors in the commands run
through this interface do not affect the exit status. Instead, the &lt;err code&gt;
field in the output is set to 2, and the output of the command becomes
whatever error message would have been given.

     </dl>

     <br><dt><samp><span class="command">mtn automate get_revision </span><var>id</var></samp><a name="index-mtn-automate-get_005frevision-_0040var_007bid_007d-159"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
The argument <var>id</var> specifies the revision id for which the changeset
information should be printed.

          <br><dt><strong>Added in:</strong><dd>
1.0

          <br><dt><strong>Changed in:</strong><dd>
7.0 (<var>id</var> is now mandatory)

          <br><dt><strong>Purpose:</strong><dd>
Prints change information for the specified revision id.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          format_version "1"
          
          new_manifest [bfe2df785c07bebeb369e537116ab9bb7a4b5e19]
          
          old_revision [429fea55e9e819a046843f618d90674486695745]
          
          patch "ChangeLog"
           from [7dc21d3a46c6ecd94685ab21e67b131b32002f12]
             to [234513e3838d423b24d5d6c98f70ce995c8bab6e]
          
          patch "std_hooks.lua"
           from [0408707bb6b97eae7f8da61af7b35364dbd5a189]
             to [d7bd0756c48ace573926197709e53eb24dae5f5f]
     </pre>

          <br><dt><strong>Output format:</strong><dd>
There are several changes that are described; each of these is described by
a different basic_io stanza. The first string pair of each stanza indicates the
type of change represented.

          <p>All stanzas are formatted by basic_io. Stanzas are separated
by a blank line. Values will be escaped, '\' to '\\' and
'"' to '\"'.

          <p>Possible values of this first value are along with an ordered list of
basic_io formatted stanzas that will be provided are:

          <pre class="verbatim">          
          'format_version'
                used in case this format ever needs to change.
                format: ('format_version', the string "1")
                occurs: exactly once
          'new_manifest'
                represents the new manifest associated with the revision.
                format: ('new_manifest', manifest id)
                occurs: exactly one
          'old_revision'
                represents a parent revision.
                format: ('old_revision', revision id)
                occurs: either one or two times
          'delete
                represents a file or directory that was deleted.
                format: ('delete', path)
                occurs: zero or more times
          'rename'
                represents a file or directory that was renamed.
                format: ('rename, old filename), ('to', new filename)
                occurs: zero or more times
          'add_dir'
                represents a directory that was added.
                format: ('add_dir, path)
                occurs: zero or more times
          'add_file'
                represents a file that was added.
                format: ('add_file', path), ('content', file id)
                occurs: zero or more times
          'patch'
                represents a file that was modified.
                format: ('patch', filename), ('from', file id), ('to', file id)
                occurs: zero or more times
          'clear'
                represents an attr that was removed.
                format: ('clear', filename), ('attr', attr name)
                occurs: zero or more times
          'set'
                represents an attr whose value was changed.
                format: ('set', filename), ('attr', attr name), ('value', attr value)
                occurs: zero or more times
     </pre>

          <p>These stanzas will always occur in the order listed here; stanzas of
the same type will be sorted by the filename they refer to. The 'delete'
and following stanzas will be grouped under the corresponding 'old_revision'
one.

          <br><dt><strong>Error conditions:</strong><dd>
If the revision specified is unknown or invalid prints an error message
to stderr and exits with status 1.

     </dl>

     <br><dt><samp><span class="command">mtn automate get_current_revision [--exclude </span><var>excl</var><span class="command">] [--depth=</span><var>depth</var><span class="command">] [</span><var>path</var><span class="command"> ...]</span></samp><a name="index-mtn-automate-get_005fcurrent_005frevision-_005b_002d_002dexclude-_0040var_007bexcl_007d_005d-_005b_002d_002ddepth_003d_0040var_007bdepth_007d_005d-_005b_0040var_007bpath_007d-_002e_002e_002e_005d-160"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
One or more <var>path</var> arguments restrict the revision to these paths,
otherwise all changes in workspace are taken into account.

          <p>Options <var>excl</var> and <var>depth</var> work just like in <var>mtn commit</var>.

          <br><dt><strong>Added in:</strong><dd>
7.0

          <br><dt><strong>Purpose:</strong><dd>
Prints change information for the current workspace, optionally restricted by
one or more paths.

          <br><dt><strong>Sample output:</strong><dd>
See <var>automate get_revision</var>

          <br><dt><strong>Output format:</strong><dd>
See <var>automate get_revision</var>

          <br><dt><strong>Error conditions:</strong><dd>
If the command is executed outside of a workspace, there are no changes in the
current workspace or the restriction is invalid or has no recorded changes,
prints an error message to stderr and exits with status 1.

     </dl>

     <br><dt><samp><span class="command">mtn automate get_base_revision_id</span></samp><a name="index-mtn-automate-get_005fbase_005frevision_005fid-161"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
None.

          <br><dt><strong>Added in:</strong><dd>
2.0

          <br><dt><strong>Purpose:</strong><dd>
Prints the revision id the current workspace is based on. This is the
&ldquo;old_revision&rdquo; value stored in <samp><span class="file">_MTN/revision</span></samp>.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          28ce076c69eadb9b1ca7bdf9d40ce95fe2f29b61
     </pre>

          <br><dt><strong>Output format:</strong><dd>
One line containing the base revision ID of the current workspace.

          <br><dt><strong>Error conditions:</strong><dd>
If no workspace book keeping _MTN directory is found, prints an error
message to stderr, and exits with status 1.

     </dl>

     <br><dt><samp><span class="command">mtn automate get_current_revision_id</span></samp><a name="index-mtn-automate-get_005fcurrent_005frevision_005fid-162"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
None.

          <br><dt><strong>Added in:</strong><dd>
2.0

          <br><dt><strong>Purpose:</strong><dd>
Prints the revision id of the current workspace. This is the id
of the revision that would be committed by an unrestricted commit
in the workspace.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          28ce076c69eadb9b1ca7bdf9d40ce95fe2f29b61
     </pre>

          <br><dt><strong>Output format:</strong><dd>
One line containing the current revision id ID of the current workspace.

          <br><dt><strong>Error conditions:</strong><dd>
If no workspace book keeping _MTN directory is found, prints an error
message to stderr, and exits with status 1.

     </dl>

     <br><dt><samp><span class="command">mtn automate get_manifest_of</span></samp><a name="index-mtn-automate-get_005fmanifest_005fof-163"></a><br><dt><samp><span class="command">mtn automate get_manifest_of </span><var>revid</var></samp><a name="index-mtn-automate-get_005fmanifest_005fof-_0040var_007brevid_007d-164"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
Specifying the optional <var>revid</var> argument outputs the manifest for the
revision with the specified ID. Otherwise, outputs the manifest for the
current workspace.  (You can think of leaving the argument blank
as meaning &ldquo;give me the manifest of THIS&rdquo;.)

          <br><dt><strong>Added in:</strong><dd>
2.0

          <br><dt><strong>Purpose:</strong><dd>
Prints the contents of the manifest associated with the given roster.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          format_version "1"
          
          dir ""
          
             file ".htaccess"
          content [e3915658cb464d05f21332e03d30dca5d94fe776]
          
             file "AUTHORS"
          content [80d8f3f75c9b517ec462233e155f7dfb93379f67]
          
             file "ChangeLog"
          content [fc74a48c7f73eedcbe1ea709755fbe819b29736c]
          
             file "LICENSE"
          content [dfac199a7539a404407098a2541b9482279f690d]
          
             file "README"
          content [440eec971e7bb61ccbb61634deb2729bb25931cd]
          
             file "TODO"
          content [e0ea26c666b37c5f98ccf80cb933d021ee55c593]
          
             file "branch.psp"
          content [b28ece354969314ce996f3030569215d685973d6]
          
             file "common.py"
          content [1fdb62e05fb2a9338d2c72ddc58de3ab2b3976fe]
          
             file "config.py.example"
          content [64cb5898e3a026b4782c343ca4386585e0c3c275]
          
             file "error.psp"
          content [7152c3ff110418aca5d23c374ea9fb92a0e98379]
          
             file "fileinbranch.psp"
          content [5d8536100fdf51d505b6f20bc9c16aa78d4e86a8]
          
             file "headofbranch.psp"
          content [981df124a0b5655a9f78c42504cfa8c6f02b267a]
          
             file "help.psp"
          content [a43d0588a69e622b2afc681678c2a5c3b3b1f342]
          
             file "html.py"
          content [18a8bffc8729d7bfd71d2e0cb35a1aed1854fa74]
          
             file "index.psp"
          content [c621827db187839e1a7c6e51d5f1a7f6e0aa560c]
          
             file "monotone.py"
          content [708b61436dce59f47bd07397ce96a1cfabe81970]
          
             file "revision.psp"
          content [a02b1c161006840ea8685e461fd07f0e9bb145a3]
          
             file "rss_feed.gif"
          content [027515fd4558abf317d54c437b83ec6bc76e3dd8]
          
             file "tags.psp"
          content [638140d6823eee5844de37d985773be75707fa25]
          
             file "tarofbranch.psp"
          content [be83f459a152ffd49d89d69555f870291bc85311]
          
             file "test.py"
          content [e65aace9237833ec775253cfde97f59a0af5bc3d]
             attr "mtn:execute" "true"
          
             file "utility.py"
          content [fb51955563d64e628e0e67e4acca1a1abc4cd989]
          
             file "viewmtn.css"
          content [8d04b3fc352a860b0e3240dcb539c1193705398f]
          
             file "viewmtn.py"
          content [7cb5c6b1b1710bf2c0fa41e9631ae43b03424a35]
          
             file "wrapper.py"
          content [530290467a99ca65f87b74f653bf462b28c6cda9]
     </pre>

          <br><dt><strong>Output format:</strong><dd>
There is one basic_io stanza for each file or directory in the
manifest.

          <p>All stanzas are formatted by basic_io. Stanzas are separated
by a blank line. Values will be escaped, '\' to '\\' and
'"' to '\"'.

          <p>Possible values of this first value are along with an ordered list of
basic_io formatted stanzas that will be provided are:

          <pre class="verbatim">          
          'format_version'
                used in case this format ever needs to change.
                format: ('format_version', the string "1")
                occurs: exactly once
          'dir':
                represents a directory.  The path "" (the empty string) is used
                to represent the root of the tree.
                format: ('dir', pathname)
                occurs: one or more times
          'file':
                represents a file.
                format: ('file', pathname), ('content', file id)
                occurs: zero or more times
     </pre>

          <p>In addition, 'dir' and 'file' stanzas may have attr information
included.  These are appended to the stanza below the basic dir/file
information, with one line describing each attr.  These lines take the
form ('attr', attr name, attr value).

          <p>Stanzas are sorted by the path string.

          <br><dt><strong>Error conditions:</strong><dd>
If the revision ID specified is unknown or invalid prints an error
message to stderr and exits with status 1.

     </dl>

     <br><dt><samp><span class="command">mtn automate get_attributes </span><var>path</var></samp><a name="index-mtn-automate-get_005fattributes-_0040var_007bpath_007d-165"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
The argument <var>path</var> determines which path's attributes should be printed.

          <br><dt><strong>Added in:</strong><dd>
3.0

          <br><dt><strong>Renamed from </strong><samp><span class="command">attributes</span></samp><strong> to </strong><samp><span class="command">get_attributes</span></samp><strong> in:</strong><dd>
5.0

          <br><dt><strong>Purpose:</strong><dd>
Prints all attributes of the given file and the attribute states.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          format_version "1"
          
           attr "foo" "bar"
          state "added"
          
           attr "baz" "bat"
          state "dropped"
          
           attr "foobar" "foobat"
          state "unchanged"
     </pre>

          <br><dt><strong>Output format:</strong><dd>
There is one basic_io stanza for each attribute of the given file.

          <p>All stanzas are formatted by basic_io. Stanzas are separated
by a blank line and ordered by attribute name. Values will be
escaped, '\' to '\\' and '"' to '\"'.

          <p>Each attribute stanza also contains another entry which tells the status
of attribute. This entry can have one of the following four values:

               <ul>
<li>'added': the attribute has just been added to the file
<li>'dropped': the attribute has just been dropped from the file
<li>'unchanged': the attribute has not been changed since the last revision
<li>'changed': the attribute has been changed since the last revision
</ul>

          <p>The status 'changed' can come up if an attribute foo has been dropped and
added afterwards with another value, like

          <pre class="verbatim">          
          $ mtn attr drop file.txt foo ; mtn attr set file.txt foo baz
     </pre>

          <p>If an attribute has been dropped, the output will still return the previously
set value of the dropped attribute for convenience (obviously this is no longer
recorded in the current workspace).

          <p>The complete format:

          <pre class="verbatim">          
          'format_version'
                used in case this format ever needs to change.
                format: ('format_version', the string "1")
                occurs: exactly once
          'attr':
                represents an attribute.
                format: ('attr', key, value), ('state', [unchanged|changed|added|dropped])
                occurs: zero or more times
     </pre>

          <br><dt><strong>Error conditions:</strong><dd>
If the path specified is unknown in the new workspace revision, prints an error
message to stderr and exits with status 1.

     </dl>

     <br><dt><samp><span class="command">mtn automate set_attribute </span><var>path</var> <var>key</var> <var>value</var></samp><a name="index-mtn-automate-set_005fattribute-_0040var_007bpath_007d-_0040var_007bkey_007d-_0040var_007bvalue_007d-166"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
A path, an attribute key and an attribute value.

          <br><dt><strong>Added in:</strong><dd>
5.0

          <br><dt><strong>Purpose:</strong><dd>
Edits the current workspace revision and inserts the given attribute key and
value for the specified path. Note that this change is not committed and
therefor behaves exactly like <samp><span class="command">mtn attr set </span><var>key</var> <var>value</var></samp>.

          <br><dt><strong>Output format:</strong><dd>
This command does not print out anything if successful.

          <br><dt><strong>Error conditions:</strong><dd>
If the path specified is unknown in the new workspace revision, prints an error
message to stderr and exits with status 1.

     </dl>

     <br><dt><samp><span class="command">mtn automate drop_attribute </span><var>path</var><span class="command"> [</span><var>key</var><span class="command">]</span></samp><a name="index-mtn-automate-drop_005fattribute-_0040var_007bpath_007d-_005b_0040var_007bkey_007d_005d-167"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
A path and an attribute key (optional).

          <br><dt><strong>Added in:</strong><dd>
5.0

          <br><dt><strong>Purpose:</strong><dd>
Removes an attribute from the current workspace revision for the specified path. 
If no attribute key is given, all attributes of this path are removed. Note that
this change is not committed and therefor behaves exactly like
<samp><span class="command">mtn attr drop </span><var>path</var><span class="command"> [</span><var>key</var><span class="command">]</span></samp>.

          <br><dt><strong>Output format:</strong><dd>
This command does not print out anything if successful.

          <br><dt><strong>Error conditions:</strong><dd>
If the path specified is unknown in the new workspace revision or the attribute
key is not found for this path, prints an error message to stderr and exits with
status 1.

     </dl>

     <br><dt><samp><span class="command">mtn automate content_diff [--revision=</span><var>id1</var><span class="command"> [--revision=</span><var>id2</var><span class="command">]] [</span><var>files</var><span class="command"> ...]</span></samp><a name="index-mtn-automate-content_005fdiff-_005b_002d_002drevision_003d_0040var_007bid1_007d-_005b_002d_002drevision_003d_0040var_007bid2_007d_005d_005d-_005b_0040var_007bfiles_007d-_002e_002e_002e_005d-168"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
One or more <var>file</var> arguments restrict the diff output to these files,
otherwise all changed files in the given revision(s) and/or current workspace
are considered.

          <p>If zero or more revisions are given, the command behaves as follows:

               <ul>
<li>no revision: the diff is done between the workspace revision and the
parent (base) revision of this workspace
<li>one revision: the diff is done between the workspace revision and the
given revision <samp><span class="option">id1</span></samp>,
<li>two revisions: the diff is done between <samp><span class="option">id1</span></samp> and <samp><span class="option">id2</span></samp>; no
workspace is needed in this case. 
</ul>

          <br><dt><strong>Added in:</strong><dd>
4.0

          <br><dt><strong>Purpose:</strong><dd>
Prints the content changes between two revisions or a revision and the current
workspace. This command differs from <samp><span class="command">mtn diff</span></samp> in that way that it only
outputs content changes and keeps quite on renames or drops, as the header of
<samp><span class="command">mtn diff</span></samp> is omitted (this is what <samp><span class="command">mtn automate get_revision</span></samp>
already provides).

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          ============================================================
          --- guitone/res/i18n/guitone_de.ts      9857927823e1d6a0339b531c120dcaadd22d25e9
          +++ guitone/res/i18n/guitone_de.ts      0b4715dc296b1955b0707923d45d79ca7769dd3f
          @@ -1,6 +1,14 @@
           &lt;?xml version="1.0" encoding="utf-8"?>
           &lt;!DOCTYPE TS>&lt;TS version="1.1">
           &lt;context>
          +    &lt;name>AncestryGraph&lt;/name>
          +    &lt;message>
          [...]
     </pre>

          <br><dt><strong>Output format:</strong><dd>
The GNU unified diff format. If there have been no content changes, the output
is empty.

          <br><dt><strong>Error conditions:</strong><dd>
If more than two revisions are given or a workspace is required, but
not found, prints to stderr and exits with status 1. If one or more file
restrictions can't be applied, the command prints to stderr and exits as well.

     </dl>

     <br><dt><samp><span class="command">mtn automate get_file </span><var>id</var></samp><a name="index-mtn-automate-get_005ffile-_0040var_007bid_007d-169"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
The  <var>id</var> argument specifies the file hash of the file to be output.

          <br><dt><strong>Added in:</strong><dd>
1.0

          <br><dt><strong>Purpose:</strong><dd>
Prints the contents of the specified file.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          If you've downloaded a release, see INSTALL for installation
          instructions.  If you've checked this out, the generated files are not
          included, and you must use "autoreconf --install" to create them.
          
          "make html" for docs, or read the .info file and / or man page.
     </pre>

          <br><dt><strong>Output format:</strong><dd>
The file contents are output without modification.

          <br><dt><strong>Error conditions:</strong><dd>
If the file id specified is unknown or invalid prints an error message
to stderr and exits with status 1.

     </dl>

     <br><dt><samp><span class="command">mtn automate get_file_of </span><var>filename</var><span class="command"> [--revision=</span><var>id</var><span class="command">]</span></samp><a name="index-mtn-automate-get_005ffile_005fof-_0040var_007bfilename_007d-_005b_002d_002drevision_003d_0040var_007bid_007d_005d-170"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
The  <var>filename</var> argument specifies the filename of the file to be output.

          <p>If a revision <var>id</var> is given, the file's contents in that specific revision
are printed. If no revision is given, the workspace's revision is used.

          <br><dt><strong>Added in:</strong><dd>
4.0

          <br><dt><strong>Purpose:</strong><dd>
Prints the contents of the specified file.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          If you've downloaded a release, see INSTALL for installation
          instructions.  If you've checked this out, the generated files are not
          included, and you must use "autoreconf --install" to create them.
          
          "make html" for docs, or read the .info file and / or man page.
     </pre>

          <br><dt><strong>Output format:</strong><dd>
The file contents are output without modification.

          <br><dt><strong>Error conditions:</strong><dd>
If the filename specified is unknown in the given revision or invalid, or
if the given revision is unknown, prints an error message to stderr and exits
with status 1.

     </dl>

     <br><dt><samp><span class="command">mtn automate get_option </span><var>option</var></samp><a name="index-mtn-automate-get_005foption-_0040var_007boption_007d-171"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
The <var>option</var> argument specifies the option name of the option to be output.

          <br><dt><strong>Added in:</strong><dd>
3.1

          <br><dt><strong>Purpose:</strong><dd>
Prints an option from _MTN/option of the current workspace.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          net.venge.monotone
     </pre>

          <br><dt><strong>Output format:</strong><dd>
The option value is written out without modification.

          <br><dt><strong>Error conditions:</strong><dd>
If the option is unknown, prints an error message to stderr and exits
with status 1.

     </dl>

     <br><dt><samp><span class="command">mtn automate keys</span></samp><a name="index-mtn-automate-keys-172"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
None.

          <br><dt><strong>Added in:</strong><dd>
1.1

          <br><dt><strong>Purpose:</strong><dd>
Print all keys in basic_io format.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
                      name "tbrownaw@gmail.com"
               public_hash [475055ec71ad48f5dfaf875b0fea597b5cbbee64]
              private_hash [7f76dae3f91bb48f80f1871856d9d519770b7f8a]
           public_location "database" "keystore"
          private_location "keystore"
          
                     name "tomfa@debian.org"
              public_hash [3ac4afcd86af28413b0a23b7d22b9401e15027fc]
          public_location "database"
          
                      name "underwater@fishtank.net"
               public_hash [115fdc73d87a5e9901d018462b21a1f53eca33a1]
              private_hash [b520d2cfe7d30e4ea1725fc4f34646fc5469b13d]
           public_location "keystore"
          private_location "keystore"
          
     </pre>

          <br><dt><strong>Output format:</strong><dd>
For each key, a basic_io stanza is printed. The public_location and
private_location items may have multiple values as shown above for public_location, one value for each place that the key is stored. If the
private key does not exist, then the private_hash and private_location
items will be absent. The keys are ordered alphabetically by name.

          <br><dt><strong>Error conditions:</strong><dd>
None.

     </dl>

     <br><dt><samp><span class="command">mtn automate packet_for_rdata </span><var>id</var></samp><a name="index-mtn-automate-packet_005ffor_005frdata-_0040var_007bid_007d-173"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
The <var>id</var> specifies the revision to output an rdata packet for.

          <br><dt><strong>Added in:</strong><dd>
2.0

          <br><dt><strong>Purpose:</strong><dd>
Prints the revision data in packet format

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          [rdata bdf3b10b5df0f17cc6c1b4b3351d84701bda59ed]
          H4sIAAAAAAAA/0XQS27DMAwE0L1PIfgArb4kte62NzACg5SoJEBsF7aRurev0UVzgJl5mLas
          E+/jU9ftvsymd33Xzfo9Tjzfm267GSgGwVarz6Valx0KtFYwii9VqUFCqJQ5X7puedRx1ef9
          r2rwHlSbi+BUSrF4xn1p0RInkmxTbmwREp/BL97LzfQfN56v+rlc+860dZnMED01jhILkURJ
          Ul0KPpGN1ueUwDHyiXF66Ywx+2IGD+0Uqg8aCzikAEzZNRXPmJKlkhMxSHuNzrofx/uq2/J4
          6njV/bZsu/zMPOlbOY4XJSD5KOrwXGdwpDGdfotZayQHKTAi5fRPqUWKcAMMIQfAjOK0nkfm
          6tFacjYgBPV46X4BtlpiNYUBAAA=
          [end]
     </pre>

          <br><dt><strong>Output format:</strong><dd>
Revision data in <samp><span class="command">monotone read</span></samp> compatible packet format.

          <br><dt><strong>Error conditions:</strong><dd>
If <var>id</var> is unknown or invalid prints an error message to stderr
and exits with status 1.

     </dl>

     <br><dt><samp><span class="command">mtn automate packet_for_certs </span><var>id</var></samp><a name="index-mtn-automate-packet_005ffor_005fcerts-_0040var_007bid_007d-174"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
The <var>id</var> specifies the revision to output cert packets for.

          <br><dt><strong>Added in:</strong><dd>
2.0

          <br><dt><strong>Purpose:</strong><dd>
Prints the certs associated with a revision in packet format

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          [rcert bdf3b10b5df0f17cc6c1b4b3351d84701bda59ed
                 branch
                 njs@pobox.com
                 bmV0LnZlbmdlLm1vbm90b25l]
          K90i1XHHmaMEMuwbPifFweLThJl0m7jigh2Qq6Z7TBwNJ6IMOjXWCizv73cacZ1CtzxFDVwQ
          SlqhNWiPQWxdcMp+Uuo+V8IFMKmvxVSTuVDukLMuNAQqpGL5S+a+tEj68NMq+KLKuL8kAAPc
          RoFD7GQlTS35S3RHWA4cnvqn+8U=
          [end]
          [rcert bdf3b10b5df0f17cc6c1b4b3351d84701bda59ed
                 date
                 njs@pobox.com
                 MjAwNi0wNC0wOFQxMTo1MDowMA==]
          araz9A8x6AlK6m6UhwnhUhk7cdyxeE2nvzj2gwaDvkaBxOq4SN23/wnaPqUXx1Ddn8smzyRY
          HN08xloYc0yNChp3wjbqx20REcsTg3XE4rN/sgCbqqw5hVT22a5ZhqkfkDeoeJvan0R0UBax
          ngKYo9eLuABNlmFX2onca75JW1E=
          [end]
          [rcert bdf3b10b5df0f17cc6c1b4b3351d84701bda59ed
                 author
                 njs@pobox.com
                 bmpzQHBvYm94LmNvbQ==]
          BLPOYhgLsAN+w7CwOsv9GfXnG3u7RNF1DTrWdn0AnYE1e+ptgTeMVWUI18H4OGL0B7wm08rv
          Pxk/hvsb8fBn1Kf5HDDO2pbjJ0xVzI9+p+TR0y5jJNZlVSTj+nvtPgvK9NzsdooYWnwlWmJv
          bOkAzQcZb8NMh8pbQkdHbR5uzMo=
          [end]
          [rcert bdf3b10b5df0f17cc6c1b4b3351d84701bda59ed
                 changelog
                 njs@pobox.com
                 MjAwNi0wNC0wOCAgTmF0aGFuaWVsIFNtaXRoICA8bmpzQHBvYm94LmNvbT4KCgkqIG5ldHh4
          L3Jlc29sdmVfZ2V0aG9zdGJ5bmFtZS5jeHggKHJlc29sdmVfaG9zdG5hbWUpOiAjaWZkZWYg
          b3V0CglXaW4zMi1pbmNvbXBhdGlibGUgZXJyb3IgcmVwb3J0aW5nIGNhbGwuCg==]
          Ncl4L/oEPctzVQixTKA6FrLceeHnLiXfeyeFDNmtUFYg9BMUcjWkeyKmaWknLvOcHortxjto
          K6pQ9E8S7zI+TpzFAhssg5a///rFL0+2GJU3t6pcHs6LC0Q4tbqzwKd/5+8GwT1gphbM1wm7
          KuzKthwqD3pp49GbgTrp8iWMTr0=
          [end]
     </pre>

          <br><dt><strong>Output format:</strong><dd>
Cert data in <samp><span class="command">monotone read</span></samp> compatible packet format.

          <br><dt><strong>Error conditions:</strong><dd>
If <var>id</var> is unknown or invalid prints an error message to stderr
and exits with status 1.

     </dl>

     <br><dt><samp><span class="command">mtn automate packet_for_fdata </span><var>id</var></samp><a name="index-mtn-automate-packet_005ffor_005ffdata-_0040var_007bid_007d-175"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
The <var>id</var> specifies the file to output an fdata packet for.

          <br><dt><strong>Added in:</strong><dd>
2.0

          <br><dt><strong>Purpose:</strong><dd>
Prints the file data in packet format

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          [fdata 229c7f621b65f7e4970ae5aaec993812b9daa1d4]
          H4sIAAAAAAAA/z2OO27DMBBEe51ioMaNrJzBpQAjTXKBBTW0CJPcgFw6yO1DCkG62Q/em83j
          R9vlRez6naPKzh2CwkipXFBJbO8fn7f7HV4LQq4mMYoFzdMYSnMj1xXY/lnuoHt2kB2hQpst
          PREPZhaxvvchskIKkdU6xsXWvQsk76MOUquGVolZmmmh0+xxvf7JZ5jCFXbU4KZ1muYkT+Kw
          FOez5q6uLuh9+9eoQawhez3Fp+VtHJNkfMmDHfALzWYfcAgBAAA=
          [end]
     </pre>

          <br><dt><strong>Output format:</strong><dd>
File data in <samp><span class="command">monotone read</span></samp> compatible packet format.

          <br><dt><strong>Error conditions:</strong><dd>
If <var>id</var> is unknown or invalid prints an error message to stderr
and exits with status 1.

     </dl>

     <br><dt><samp><span class="command">mtn automate packet_for_fdelta </span><var>from-id</var> <var>to-id</var></samp><a name="index-mtn-automate-packet_005ffor_005ffdelta-_0040var_007bfrom_002did_007d-_0040var_007bto_002did_007d-176"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
The <var>from-id</var> specifies the file to use as the base of the delta,
and <var>to-id</var> specifies the file to use as the target of the delta.

          <br><dt><strong>Added in:</strong><dd>
2.0

          <br><dt><strong>Purpose:</strong><dd>
Prints the file delta in packet format

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          [fdelta 597049a62d0a2e6af7df0b19f4945ec7d6458727
                  229c7f621b65f7e4970ae5aaec993812b9daa1d4]
          H4sIAAAAAAAA/0WOy0oEMRBF9/mKS2/c9LQg4t5lw+BGf6BIKtNhkpSkKop/b9II7m49OOfu
          eHp5dnvEj/SHL0aQ75qFAgcQGmcm5RXKjP3t/eP1ekWUhlTVKGeyJNXNoXU/s27AP8sf7O8D
          ZEdSSLd1JMaNKzeysY8ps4Iao4oNjM99eFdQDbMOSldDV8ZC3aSxlxpxufzJF5jANx6oyS2b
          c0uhO+OwkpezZhCvK0bf8TVrMLZUo5zi0/I4j4UqPunGA+B+AfHvKEIPAQAA
          [end]
     </pre>

          <br><dt><strong>Output format:</strong><dd>
File delta data in <samp><span class="command">monotone read</span></samp> compatible packet format.

          <br><dt><strong>Error conditions:</strong><dd>
If <var>from-id</var> or <var>to-id</var> is unknown or invalid prints an error
message to stderr and exits with status 1.

     </dl>

     <br><dt><samp><span class="command">mtn automate get_content_changed </span><var>id</var> <var>file</var></samp><a name="index-mtn-automate-get_005fcontent_005fchanged-_0040var_007bid_007d-_0040var_007bfile_007d-177"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
The <var>id</var> specifies a revision ID, from which content change calculations will be based. 
and <var>file</var> specifies the file for which to calculate revisions in which it was last changed.

          <br><dt><strong>Added in:</strong><dd>
4.0

          <br><dt><strong>Purpose:</strong><dd>
Returns a list of revision IDs in which the content  was most recently changed, relative to the revision ID specified as <var>id</var>. This equates to a content mark following the *-merge algorithm.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
            content_mark [276264b0b3f1e70fc1835a700e6e61bdbe4c3f2f]
     </pre>

          <br><dt><strong>Output format:</strong><dd>
Zero or more basic_io stanzas, each specifying a revision ID in which a content mark is set.

          <p>The complete format:
<pre class="verbatim">          
          'content_mark'
                   the hexadecimal id of the revision the content mark is attached to
     </pre>

          <br><dt><strong>Error conditions:</strong><dd>
If <var>id</var> or <var>file</var> is unknown or invalid prints an error
message to stderr and exits with status 1.

     </dl>

     <br><dt><samp><span class="command">mtn automate get_corresponding_path </span><var>source_id</var> <var>file</var> <var>target_id</var></samp><a name="index-mtn-automate-get_005fcorresponding_005fpath-_0040var_007bsource_005fid_007d-_0040var_007bfile_007d-_0040var_007btarget_005fid_007d-178"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
The <var>source_id</var> specifies a revision ID in which <var>file</var> is current extant. 
and <var>file</var> specifies the file whose name in <var>target_id</var> is to be determined;
<var>target_id</var> specifies a revision ID.

          <br><dt><strong>Added in:</strong><dd>
4.0

          <br><dt><strong>Purpose:</strong><dd>
Given a the file name <var>file</var> in the source revision <var>source_id</var>, a filename
will if possible be returned naming the file in the target revision <var>target_id</var>. 
This allows the same file to be matched between revisions, accounting
for renames and other changes.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          file "foo"
     </pre>

          <br><dt><strong>Output format:</strong><dd>
Zero or one basic_io stanzas. Zero stanzas will be output if the file does not exist within the target revision; this is not considered an error. If the file does exist in the target revision, a single stanza with the  following details is output.

          <p>The complete format:
<pre class="verbatim">          
             'file'
                   the file name corresponding to "file name" (arg 2) in the target revision
     </pre>

          <br><dt><strong>Error conditions:</strong><dd>
If the revision IDs <var>source_id</var> or <var>target_id</var> are unknown or invalid prints an error
message to stderr and exits with status 1. If the file path <var>file</var> does not exist in the
revision <var>source_id</var> or is invalid, prints an error message to stderr and exits with status
1. Note that <var>file</var> not existing in the revision <var>target_id</var> is not an error.

     </dl>

     <br><dt><samp><span class="command">mtn automate get_db_variables [</span><var>domain</var><span class="command">]</span></samp><a name="index-mtn-automate-get_005fdb_005fvariables-_005b_0040var_007bdomain_007d_005d-179"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
The optional <var>domain</var> restricts the output to variables only within
this domain.

          <br><dt><strong>Changes:</strong><dd>
               <ul>
<li>7.0 &ndash; converted output to basic_io, renamed to 'get_db_variables'
<li>4.1 &ndash; added as 'db_get'
</ul>

          <br><dt><strong>Purpose:</strong><dd>
Reads and outputs database variables. For more information about variables,
see <a href="#Vars">Vars</a>.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          domain "database"
           entry "default-exclude-pattern" ""
           entry "default-include-pattern" "net.venge.monotone*"
           entry "default-server" "monotone.ca"
          
          domain "known-servers"
           entry "monotone.ca" "3e6f5225bc2fffacbc20c9de37ff2dae1e20892e"
           entry "monotone.mtn-host.prjek.net" "a52f85615cb2445989f525bf17a603250381a751"
           entry "venge.net" "70a0f283898a18815a83df37c902e5f1492e9aa2"
     </pre>

          <br><dt><strong>Output format:</strong><dd>
basic_io-formatted stanzas. Each stanza starts with a 'domain', followed by one
or more 'entry' lines. Each 'entry' contains the <var>name</var> and the <var>value</var>
of the respective database variable.

          <br><dt><strong>Error conditions:</strong><dd>
If the domain is unknown or no variables where found, prints an error message
to stderr and exits with status 1.

     </dl>

     <br><dt><samp><span class="command">mtn automate set_db_variable </span><var>domain</var> <var>name</var> <var>value</var></samp><a name="index-mtn-automate-set_005fdb_005fvariable-_0040var_007bdomain_007d-_0040var_007bname_007d-_0040var_007bvalue_007d-180"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
The <var>domain</var> and <var>name</var> specify the database variable
which is changed to <var>value</var>.

          <br><dt><strong>Changes:</strong><dd>
               <ul>
<li>7.0 &ndash; renamed to 'set_db_variable'
<li>4.1 &ndash; added as 'db_set'
</ul>

          <br><dt><strong>Purpose:</strong><dd>
Change a database variable, see also <a href="#Vars">Vars</a>.

          <br><dt><strong>Sample usage:</strong><dd>
<pre class="verbatim">          
          mtn automate set_db_variable database default-server off.net
     </pre>

          <br><dt><strong>Output format:</strong><dd>
No output.

          <br><dt><strong>Error conditions:</strong><dd>
None.

     </dl>

     <br><dt><samp><span class="command">mtn automate drop_db_variables </span><var>domain</var><span class="command"> [</span><var>name</var><span class="command">]</span></samp><a name="index-mtn-automate-drop_005fdb_005fvariables-_0040var_007bdomain_007d-_005b_0040var_007bname_007d_005d-181"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
The <var>domain</var> and <var>name</var> specify the database variable
which should be dropped. If <var>name</var> is ommitted, all database
variables in the <var>domain</var> are dropped.

          <br><dt><strong>Added in:</strong><dd>
7.0

          <br><dt><strong>Purpose:</strong><dd>
Drops one or more database variables, see also <a href="#Vars">Vars</a>.

          <br><dt><strong>Sample usage:</strong><dd>
<pre class="verbatim">          
          mtn automate drop_db_variables known-servers
     </pre>

          <br><dt><strong>Output format:</strong><dd>
No output.

          <br><dt><strong>Error conditions:</strong><dd>
If the specific variable or any variables in the given domain are not found,
prints to stderr and exits with status 1.

     </dl>

     <br><dt><samp><span class="command">mtn automate put_file [</span><var>base-id</var><span class="command">] </span><var>contents</var></samp><a name="index-mtn-automate-put_005ffile-_005b_0040var_007bbase_002did_007d_005d-_0040var_007bcontents_007d-182"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
The optional <var>base-id</var> specifies a file-id on which the contents are
based on. This is used for delta encoding. <var>contents</var> are the contents of
the new file.

          <br><dt><strong>Added in:</strong><dd>
4.1

          <br><dt><strong>Purpose:</strong><dd>
Preparation of a workspace-less commit. 
See also <samp><span class="command">automate put_revision</span></samp>. Normally used via
<samp><span class="command">automate stdio</span></samp>.

          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          70a0f283898a18815a83df37c902e5f1492e9aa2
     </pre>

          <br><dt><strong>Output format:</strong><dd>
The sha1 sum of the contents, hex encoded.

          <br><dt><strong>Error conditions:</strong><dd>
If the optional base id is unknown prints an error message to stderr and
exits with status 1.

     </dl>

     <br><dt><samp><span class="command">mtn automate put_revision </span><var>revision-data</var></samp><a name="index-mtn-automate-put_005frevision-_0040var_007brevision_002ddata_007d-183"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
<var>revision-data</var> is the new revision. See example below.  Note that
the new_manifest entry is ignored &ndash; <samp><span class="command">put_revision</span></samp> will
ignore whatever you put here and calculate the correct manifest id
itself.  (However, for now, you must put 40 hex digits here &ndash; it's
just that which particular digits you put are entirely irrelevant. 
All zeros is a good choice.)  Monotone will also canonicalize your
whitespace automatically.  You do not need to worry about getting just
the right amount of indentation in front of each line.  However,
everything else about your revision must be valid.

          <br><dt><strong>Added in:</strong><dd>
4.1

          <br><dt><strong>Purpose:</strong><dd>
Workspace-less commit. Normally used via <samp><span class="command">automate stdio</span></samp>.

          <br><dt><strong>Sample argument:</strong><dd>
          <pre class="smallexample">               format_version "1"
               
               new_manifest [0000000000000000000000000000000000000004]
               
               old_revision []
               
               add_dir ""
               
               add_file "foo"
               content [5bf1fd927dfb8679496a2e6cf00cbe50c1c87145]
</pre>
          <br><dt><strong>Sample output:</strong><dd>
<pre class="verbatim">          
          4c2c1d846fa561601254200918fba1fd71e6795d
     </pre>

          <br><dt><strong>Output format:</strong><dd>
The new revision id, hex encoded.

          <br><dt><strong>Error conditions:</strong><dd>
If the changeset is invalid prints an error message to stderr and
exits with status 1. May abort on invalid formats.  If the revision is
already present in the database, prints a message to stderr noting
this fact, but otherwise works as normal.

     </dl>

     <br><dt><samp><span class="command">mtn automate cert </span><var>revision</var> <var>name</var> <var>value</var></samp><a name="index-mtn-automate-cert-_0040var_007brevision_007d-_0040var_007bname_007d-_0040var_007bvalue_007d-184"></a><dd>
          <dl>
<dt><strong>Arguments:</strong><dd>
<var>revision</var> is an existing revision, <var>name</var> is the certificate name
and <var>value</var> its value.

          <br><dt><strong>Added in:</strong><dd>
4.1

          <br><dt><strong>Purpose:</strong><dd>
<samp><span class="command">automate stdio</span></samp> capable variant of <samp><span class="command">mtn cert</span></samp>. To sign the
cert with a specific private key, use <samp><span class="option">--key</span></samp>.

          <br><dt><strong>Sample usage:</strong><dd>
<pre class="verbatim">          
          mtn automate cert 4c2c1d846fa561601254200918fba1fd71e6795d author tester@test.net
     </pre>

          <br><dt><strong>Output format:</strong><dd>
No output.

          <br><dt><strong>Error conditions:</strong><dd>
If the revision is invalid prints an error message to stderr and
exits with status 1.

     </dl>

   </dl>

<p><a name="RCS"></a>

<h3 class="section">5.10 RCS</h3>

     <dl>
<dt><samp><span class="command">mtn rcs_import </span><var>filename...</var></samp><a name="index-mtn-rcs_005fimport-_0040var_007bfilename_002e_002e_002e_007d-185"></a><dd>
This command imports all the file versions in each RCS file listed in
<var>filename...</var>.  These files should be raw RCS files, ending in
<code>,v</code>. Monotone parses them directly and inserts them into your
database.  Note that this does not do any revision reconstruction, and
is only useful for debugging.

     <br><dt><samp><span class="command">mtn cvs_import </span><var>pathname</var></samp><a name="index-mtn-cvs_005fimport-_0040var_007bpathname_007d-186"></a><dd>
This command imports all the file versions in each RCS file found in the
tree of files starting at <var>pathname</var>, then reconstructs the
tree-wide history of logical changes by comparing RCS time stamps and
change log entries. For each logical tree-wide change, monotone
synthesizes a manifest and revision, and commits them (along with all
associated file deltas) to your database. It also copies all change log
entries, author identifiers, and date stamps to manifest certificates.

     <p>In normal use, <var>pathname</var> will be a CVS module, though it is
possible to point it at a directory within a module as well.  Whatever
directory you point it at will become the root of monotone's version of
the tree.

</dl>

<p><a name="Hook-Reference"></a>

<h2 class="chapter">6 Hook Reference</h2>

<p>Monotone's behavior can be customized and extended by writing
<dfn>hook functions</dfn>, which are written in the
<a href="http://www.lua.org">Lua</a> programming language. At certain points
in time, when monotone is running, it will call a hook function to
help it make a decision or perform some action.  If you provide a hook
function definition which suits your preferences, monotone will
execute it. This way you can modify how monotone behaves.

   <p>You can put new definitions for any of these hook functions in a file
<samp><span class="file">$HOME/.monotone/monotonerc</span></samp>, or in your workspace in
<samp><span class="file">_MTN/monotonerc</span></samp>, both of which will be read every time monotone
runs. Definitions in <samp><span class="file">_MTN/monotonerc</span></samp> shadow (override)
definitions made in your <samp><span class="file">$HOME/.monotone/monotonerc</span></samp>. You can also tell
monotone to interpret extra hook functions from any other <var>file</var>
using the <samp><span class="option">--rcfile=</span><var>file</var></samp> option; hooks defined in files
specified on the command-line will shadow hooks from the the automatic
files. 
By specifying <samp><span class="option">--rcfile=</span><var>directory</var></samp> you can automatically
load all the files contained into <var>directory</var>.

   <p>Monotone provides some default hooks, see <a href="#Default-hooks">Default hooks</a> for their
complete source. When writing new hooks, it may be helpful to reuse some code
from the default ones. Since Lua is a lexically scoped language with closures,
this can be achieved with the following code:

<pre class="smallexample">     do
         local old_hook = default_hook
         function default_hook(arg)
             if not old_hook(arg) then
                 -- do other stuff
             end
         end
     end
</pre>
   <p>Now the default hook is trapped in a variable local to this block, and can
only be seen by the new hook. Since in Lua variables default to the global
scope, the new hook is seen from inside monotone.

   <p>Monotone also makes available to hook writers a number of helper
functions exposing functionality not available with standard Lua.

<p><a name="Hooks"></a>

<h3 class="section">6.1 Hooks</h3>

<p>This section documents the existing hook functions and their default
definitions.

<h4 class="subsection">6.1.1 Event Notifications and Triggers</h4>

<p>There are a number of hooks that are called when noteworthy events
occur, such as commits or new revisions arriving over the network. These
hooks can be used to feed the events into external notification systems,
such as generating email.

   <p>By default, these hooks are undefined, so no special external actions
are taken.

     <dl>
<dt><code>note_commit (</code><var>new_id</var><code>, </code><var>revision</var><code>, </code><var>certs</var><code>)</code><a name="index-note_005fcommit-_0028_0040var_007bnew_005fid_007d_002c-_0040var_007brevision_007d_002c-_0040var_007bcerts_007d_0029-187"></a><dd>
Called by monotone after the version <var>new_id</var> is committed. The
second parameter, <var>revision</var> is the text of the revision, what would
be given by <samp><span class="command">mtn automate get_revision </span><var>new_id</var></samp>. The third
parameter, <var>certs</var>, is a Lua table containing the set of certificate
names and values committed along with this version. There is no default
definition for this hook.

     <p>Note that since the <var>certs</var> table does not contain cryptographic
or trust information, and only contains one entry per cert name, it is
an incomplete source of information about the committed version. This
hook is only intended as an aid for integrating monotone with informal
commit-notification systems such as mailing lists or news services. It
should not perform any security-critical operations.

     <br><dt><code>note_netsync_start (</code><var>session_id</var><code>, </code><var>my_role</var><code>, </code><var>sync_type</var><code>,</code><a name="index-note_005fnetsync_005fstart-_0028_0040var_007bsession_005fid_007d_002c-_0040var_007bmy_005frole_007d_002c-_0040var_007bsync_005ftype_007d_002c-188"></a><dd><var>remote_host</var>, <var>remote_keyname</var>, <var>includes</var>, <var>excludes</var>)

     <p>Called by monotone before any other of the netsync notification hooks
are called.  The <var>session_id</var> helps keep track of the current netsync
session in case several are happening at the same time, and is used
throughout all netsync notification hooks.

     <p>The other arguments are:

          <dl>
<dt><var>my_role</var><dd>
This will be either "client" or "server".

          <br><dt><var>sync_type</var><dd>
This will be one of "sync", "push", or "pull".

          <br><dt><var>remote_host</var><dd>
The network address of the remote host. At the client, this will be the name
it was told to connect to; at the server, this will use the numerical IP address
the connection was received from.

          <br><dt><var>remote_keyname</var><dd>
The name of the key being used by the other end of the connection. This may be
set to "-unknown-" at the server if the key used by the client is not present
at the server.

          <br><dt><var>includes</var><strong> and </strong><var>excludes</var><dd>
The include and exclude patterns used by the client.

     </dl>

     <br><dt><code>note_netsync_revision_received (</code><var>new_id</var><code>, </code><var>revision</var><code>, </code><var>certs</var><code>, </code><var>session_id</var><code>)</code><a name="index-note_005fnetsync_005frevision_005freceived-_0028_0040var_007bnew_005fid_007d_002c-_0040var_007brevision_007d_002c-_0040var_007bcerts_007d_002c-_0040var_007bsession_005fid_007d_0029-189"></a><dd>
Called by monotone after the revision <var>new_id</var> is received through
netsync. <var>revision</var> is the text of the revision, what would be given
by <samp><span class="command">mtn automate get_revision </span><var>new_id</var></samp>. <var>certs</var> is a
Lua table containing one subtable for each cert attached to the revision
<var>new_id</var>. These subtables have fields named "key", "name", and
"value", containing the signing key for the cert, the name of the cert,
and the value of the cert. There is no default definition for this hook. 
<var>session_id</var> is used together with <code>note_netsync_start</code> and
<code>note_netsync_end</code>.  If you're not interested in that type of
tracking, you can ignore that variable entirely.

     <br><dt><code>note_netsync_cert_received (</code><var>rev_id</var><code>, </code><var>key</var><code>, </code><var>name</var><code>, </code><var>value</var><code>, </code><var>session_id</var><code>)</code><a name="index-note_005fnetsync_005fcert_005freceived-_0028_0040var_007brev_005fid_007d_002c-_0040var_007bkey_007d_002c-_0040var_007bname_007d_002c-_0040var_007bvalue_007d_002c-_0040var_007bsession_005fid_007d_0029-190"></a><dd>
Called by monotone after a cert is received through netsync, if the revision
that the cert is attached to was not also received in the same netsync
operation. <var>rev_id</var> is the revision id that the cert is attached to,
<var>key</var> is the key that the cert is signed with, <var>name</var> is the name
of the cert, and <var>value</var> is the cert value. There is no default
definition for this hook. 
<var>session_id</var> is used together with <code>note_netsync_start</code> and
<code>note_netsync_end</code>.  If you're not interested in that type of
tracking, you can ignore that variable entirely.

     <br><dt><code>note_netsync_pubkey_received (</code><var>keyname</var><code>, </code><var>session_id</var><code>)</code><a name="index-note_005fnetsync_005fpubkey_005freceived-_0028_0040var_007bkeyname_007d_002c-_0040var_007bsession_005fid_007d_0029-191"></a><dd>
Called by monotone after a pubkey is received through netsync. <var>keyname</var>
is the name of the key received. There is no default definition for this hook. 
<var>session_id</var> is used together with <code>note_netsync_start</code> and
<code>note_netsync_end</code>.  If you're not interested in that type of
tracking, you can ignore that variable entirely.

     <br><dt><code>note_netsync_end (</code><var>session_id</var><code>, </code><var>status</var><code>,</code><a name="index-note_005fnetsync_005fend-_0028_0040var_007bsession_005fid_007d_002c-_0040var_007bstatus_007d_002c-192"></a><dd><var>bytes_in</var>, <var>bytes_out</var>, <var>certs_in</var>, <var>certs_out</var>,
<var>revs_in</var>, <var>revs_out</var>, <var>keys_in</var>, <var>keys_out</var>)

     <p>Called by monotone after all other the netsync notification hooks have
been called.  This hook would usually be used for post-netsync purposes,
like collecting all the data from all other netsync notification hooks,
make some nice output from them and finally send the result somewhere. 
It could also be used to prepare parallel databases with all the data
to be displayed through something like viewmtn.

     <p><var>status</var> is a three digit integer that tells whether there was an error,
and if so what kind of error it was:

          <dl>
<dt><strong>200</strong><dd>
No error, connection successful.

          <br><dt><strong>211</strong><dd>
The connection was interrupted after some data may have been transferred.

          <br><dt><strong>212</strong><dd>
The connection was interrupted before any data could be transferred.

          <br><dt><strong>412</strong><dd>
The request is not permitted.

          <br><dt><strong>422</strong><dd>
The client tried to use a key that the server doesn't know about.

          <br><dt><strong>432</strong><dd>
The client and server have different epochs for a branch.

          <br><dt><strong>512</strong><dd>
Protocol error (source/sink confusion).

          <br><dt><strong>521</strong><dd>
Protocol error (packet received at a time when it doesn't make sense).

          <br><dt><strong>532</strong><dd>
The client did not identify itself correctly. (Possible replay attack?)

     </dl>

     <p>In general, 2xx means there was no error, 4xx means there was a permissions
error, and 5xx means there was a protocol error. xx1 means some data may
have been transferred, xx2 means no data was transferred, and xx0 means all
data was transferred.

     <br><dt><code>note_mtn_startup (...)</code><a name="index-note_005fmtn_005fstartup-_0028_002e_002e_002e_0029-193"></a><dd>
Called by monotone when it is first started, this hook was added so that
usage of monotone could be monitored for user interface testing.  Note
that by default, no monitoring occurs.  The arguments to the hook
function are the arguments to monotone, without the initial
<samp><span class="command">mtn</span></samp> command.  They can be accessed through the lua <var>arg</var>
variable as in this example:

     <pre class="smallexample">          function note_mtn_startup(...)
              print("Beginning note_mtn_startup")
              for i = 1,arg.n do
                  print(arg[i])
              end
              print("Ending note_mtn_startup")
          end
</pre>
     </dl>

<h4 class="subsection">6.1.2 User Defaults</h4>

<p>These are hooks that can be used to provide smart, context-sensitive
default values for a number of parameters the user might otherwise be
prompted for.

     <dl>
<dt><code>get_branch_key (</code><var>branchname</var><code>)</code><a name="index-get_005fbranch_005fkey-_0028_0040var_007bbranchname_007d_0029-194"></a><dd>
Returns a string which is the name of an <span class="sc">rsa</span> private key used to sign
certificates in a particular branch <var>branchname</var>. There is no
default definition for this hook. The command-line option
<samp><span class="option">--key=</span><var>keyname</var></samp> overrides any value returned from this
hook function. If you have only one private key in your database, you
do not need to define this function or provide a
<samp><span class="option">--key=</span><var>keyname</var></samp> option; monotone will guess that you want
to use the unique private key.

     <br><dt><code>get_netsync_key(</code><var>server</var><code>, </code><var>include</var><code>, </code><var>exclude</var><code>)</code><a name="index-get_005fnetsync_005fkey_0028_0040var_007bserver_007d_002c-_0040var_007binclude_007d_002c-_0040var_007bexclude_007d_0029-195"></a><dd>
Returns a string which is the name of the key to use to authenticate
the given netsync connection. When called by the <samp><span class="command">serve</span></samp> command,
<var>server</var> is the address monotone is listening on, <var>include</var> is
<samp><span class="option">"*"</span></samp>, and <var>exclude</var> is <samp><span class="option">""</span></samp>.

     <p>There is no default definition of this hook. The command-line option
<samp><span class="option">--key=</span><var>keyname</var></samp> overrides any value returned from this
hook function.

     <br><dt><code>get_passphrase (</code><var>keypair_id</var><code>)</code><a name="index-get_005fpassphrase-_0028_0040var_007bkeypair_005fid_007d_0029-196"></a><dd>
Returns a string which is the passphrase used to encrypt the private
half of <var>keypair_id</var> in your database, using the <span class="sc">arc4</span> symmetric
cipher.  <var>keypair_id</var> is a Lua string containing the label that you
used when you created your key &mdash; something like
<code>"nicole@example.com"</code>.  This hook has no default definition. If
this hook is not defined or returns false, monotone will prompt you for
a passphrase each time it needs to use a private key.

     <br><dt><code>get_author (</code><var>branchname</var><code>, </code><var>keypair_id</var><code>)</code><a name="index-get_005fauthor-_0028_0040var_007bbranchname_007d_002c-_0040var_007bkeypair_005fid_007d_0029-197"></a><dd>
Returns a string which is used as a value for automatically generated
<code>author</code> certificates when you commit changes to
<var>branchname</var> with the keypair identity <var>keypair_id</var>.  Generally
this hook remains undefined, and monotone selects your signing key name
for the author certificate. You can use this hook to override that
choice, if you like.

     <p>This hook has no default definition, but a couple of possible
definitions might be:
     <pre class="smallexample">          function get_author(branchname, keypair_id)
                  -- Key pair identity ignored.
                  local user = os.getenv("USER")
                  local host = os.getenv("HOSTNAME")
                  if ((user == nil) or (host == nil)) then return nil end
                  return string.format("%s@%s", user, host)
          end
</pre>
     <pre class="smallexample">          function get_author(branchname, keypair_id)
                  -- Branch name ignored.
                  if (keypair_id == "joe@example.com") then
                          return "Joe Random &lt;joe@example.com&gt;"
                  end
                  return keypair_id
          end
</pre>
     <br><dt><code>edit_comment (</code><var>commentary</var><code>, </code><var>user_log_message</var><code>)</code><a name="index-edit_005fcomment-_0028_0040var_007bcommentary_007d_002c-_0040var_007buser_005flog_005fmessage_007d_0029-198"></a><dd>
Returns a log entry for a given set of changes, described in
<var>commentary</var>.  The commentary is identical to the output of
<samp><span class="command">mtn status</span></samp>. This hook is intended to interface with
some sort of editor, so that you can interactively document each
change you make. The result is used as the value for a
<code>changelog</code> certificate, automatically generated when you commit
changes.

     <p>The contents of <samp><span class="file">_MTN/log</span></samp> are read and passed as
<var>user_log_message</var>. This allows you to document your changes as
you proceed instead of waiting until you are ready to commit. Upon
a successful commit, the contents of <samp><span class="file">_MTN/log</span></samp> are erased setting
the system up for another edit/commit cycle.

     <p>For the default definition of this hook, see <a href="#Default-hooks">Default hooks</a>.

     <br><dt><code>persist_phrase_ok ()</code><a name="index-persist_005fphrase_005fok-_0028_0029-199"></a><dd>
Returns <code>true</code> if you want monotone to remember the passphrase of
a private key for the duration of a single command, or <code>false</code> if
you want monotone to prompt you for a passphrase for each certificate
it generates. Since monotone often generates several certificates in
quick succession, unless you are very concerned about security you
probably want this hook to return <code>true</code>.

     <p>The default definition of this hook is:
     <pre class="smallexample">          function persist_phrase_ok()
                  return true
          end
</pre>
     <br><dt><code>use_inodeprints ()</code><a name="index-use_005finodeprints-_0028_0029-200"></a><dd>
Returns <code>true</code> if you want monotone to automatically enable
<a href="#Inodeprints">Inodeprints</a> support in all workspaces.  Only affects working
copies created after you modify the hook.

     <p>The default definition of this hook is:
     <pre class="smallexample">          function use_inodeprints()
                  return false
          end
</pre>
     <br><dt><code>ignore_file (</code><var>filename</var><code>)</code><a name="index-ignore_005ffile-_0028_0040var_007bfilename_007d_0029-201"></a><dd>
Returns <code>true</code> if <var>filename</var> should be ignored while adding,
dropping, or moving files. Otherwise returns <code>false</code>. This is
most important when performing recursive actions on directories, which
may affect multiple files simultaneously.

     <p>The default definition of this hook recognises a number of common file
types and extensions for temporary and generated file types that users
typically don't want to track. If the file <samp><span class="file">.mtn-ignore</span></samp> exists,
this hook will read a list of regular expressions from the file, one per
line, and ignore all files matching one of these expressions. For the
default definition of this hook, see <a href="#Default-hooks">Default hooks</a>.

     <br><dt><code>ignore_branch (</code><var>branchname</var><code>)</code><a name="index-ignore_005fbranch-_0028_0040var_007bbranchname_007d_0029-202"></a><dd>
Returns <code>true</code> if <var>branchname</var> should be ignored while listing
branches. Otherwise returns <code>false</code>. This hook has no default
definition, therefore the default behavior is to list all branches.

   </dl>

<h4 class="subsection">6.1.3 Netsync Permission Hooks</h4>

<p>These hooks are used when running a netsync server, via
<samp><span class="command">mtn serve</span></samp>. They are evaluated by the server for each new
connection, based on the certificate used for authentication by the
client.  Note that a long-running server will need to be restarted in
order to reload the hook definitions if the <samp><span class="file">montonerc</span></samp> file is
changed.

     <dl>
<dt><code>get_netsync_read_permitted (</code><var>branch</var><code>, </code><var>identity</var><code>)</code><a name="index-get_005fnetsync_005fread_005fpermitted-_0028_0040var_007bbranch_007d_002c-_0040var_007bidentity_007d_0029-203"></a><dd>
Returns <code>true</code> if a peer authenticated as key <var>identity</var>
should be allowed to read from your database certs, revisions,
manifests, and files associated with <var>branch</var>; otherwise <code>false</code>. 
The default definition of this hook reads a file <samp><span class="file">read-permissions</span></samp> in
the configuration directory. This file looks like
     <pre class="smallexample">          pattern "net.example.project.{private,security}*"
          allow "joe@example.net"
          allow "jim@example.net"
          
          comment "everyone can read these branches"
          pattern "net.example.{public,project}*"
          allow "*"
</pre>
     <p>This example allows everyone access to branches <code>net.example.project</code> and
<code>net.example.public</code> and their sub-branches, except for the branches in
<code>net.example.project.security</code> and <code>net.example.project.private</code>,
which are only readable by Joe and Jim.

     <p>The file is divided into stanzas of one <code>pattern</code> line followed by any
number of <code>allow</code> and <code>deny</code> lines, and possibly a <code>continue</code>
line. Anything from the unquoted word <code>comment</code> until the next unquoted
word is ignored. A stanza is processed if the argument to
<code>pattern</code> is a glob that matches <var>branch</var>. Any keys which match an
<code>allow</code> line are given access, and any keys which match a <code>deny</code> line
are denied access. If there is a <code>continue "true"</code> line, then if the key
is not granted or denied access in this stanza the next matching stanza will be
processed. If there is not a <code>continue "true"</code> line, then any key which
has not been given access will be denied access even if it doesn't match any
<code>deny</code> lines. Thus, deny lines are redundant unless there is also a
<code>continue "true"</code> line.

     <p>If a client connects anonymously, this hook will be called with a
<var>identity</var> of <code>nil</code>.

     <p>Note that the <var>identity</var> value is a key ID (such as
&ldquo;<code>graydon@pobox.com</code>&rdquo;) but will correspond to a <em>unique</em>
key fingerprint (hash) in your database. Monotone will not permit two
keys in your database to have the same ID. Make sure you confirm the
key fingerprints of each key in your database, as key ID strings are
&ldquo;convenience names&rdquo;, not security tokens.

     <br><dt><code>get_netsync_write_permitted (</code><var>identity</var><code>)</code><a name="index-get_005fnetsync_005fwrite_005fpermitted-_0028_0040var_007bidentity_007d_0029-204"></a><dd>
Returns <code>true</code> if a peer authenticated as key <var>identity</var> should
be allowed to write into your database certs, revisions, manifests, and
files; otherwise <code>false</code>. The default definition of this hook reads a file
<samp><span class="file">write-permissions</span></samp> in the configuration directory which contains a list
of keys, one per line, which are allowed write access. The special value
<code>*</code> means to allow access to anyone whose public key we already have.

     <p>If a client connects anonymously, it will be unconditionally denied
write access; this hook will <em>not</em> be called with a <var>identity</var>
of <code>nil</code>.

     <p>Note that the <var>identity</var> value is a key ID (such as
&ldquo;<code>graydon@pobox.com</code>&rdquo;) but will correspond to a <em>unique</em>
key fingerprint (hash) in your database. Monotone will not permit two
keys in your database to have the same ID. Make sure you confirm the
key fingerprints of each key in your database, as key ID strings are
&ldquo;convenience names&rdquo;, not security tokens.

     <p>Note also that, unlike the equivalent read permission hook, the write
permission hook does not take a <var>branch</var> name as an argument.  There
is presently no way to selectively grant write access to different
branches via netsync, for a number of reasons. Contributions in the
database from different authors can be selectively trusted using the
<a href="#Trust-Evaluation-Hooks">Trust Evaluation Hooks</a> instead.

   </dl>

   <p><a name="Netsync-Transport-Hooks"></a>

<h4 class="subsection">6.1.4 Netsync Transport Hooks</h4>

<p>When a monotone client initiates a netsync connection, these hooks are
called to attempt to parse the host argument provided on the command
line. If the hooks fail or return nil, monotone will interpret the
host argument as a network name (possibly with a port number) and open
a TCP socket.

     <dl>
<dt><code>get_netsync_connect_command (</code><var>uri</var><code>, </code><var>args</var><code>)</code><a name="index-get_005fnetsync_005fconnect_005fcommand-_0028_0040var_007buri_007d_002c-_0040var_007bargs_007d_0029-205"></a><dd>
Returns a table describing a command to run to connect to the
specified host. The <var>uri</var> argument is a table containing
between 0 and 7 components:

          <ul>
<li><code>uri["scheme"]</code>, such as <code>"ssh"</code> or <code>"file"</code>
<li><code>uri["user"]</code>, the name of a remote user
<li><code>uri["host"]</code>, the name or address of a remote host
<li><code>uri["port"]</code>, a network port number
<li><code>uri["path"]</code>, a filesystem path
<li><code>uri["query"]</code>, for additional parameters
<li><code>uri["fragment"]</code>, to describe a sub-location within the remote resource
</ul>

     <p>The <var>args</var> argument is a table containing between 0 and 3
components:

          <ul>
<li><code>args["include"]</code>, the branch pattern to include
<li><code>args["exclude"]</code>, the branch pattern to exclude
<li><code>args["debug"]</code>, whether to run the connection in debug mode
</ul>

     <p>The default definition of this hook follows:

     <pre class="smallexample">          function get_netsync_connect_command(uri, args)
          
                  local argv = nil
          
                  if uri["scheme"] == "ssh"
                          and uri["host"]
                          and uri["path"] then
          
                          argv = { "ssh" }
                          if uri["user"] then
                                  table.insert(argv, "-l")
                                  table.insert(argv, uri["user"])
                          end
                          if uri["port"] then
                                  table.insert(argv, "-p")
                                  table.insert(argv, uri["port"])
                          end
          
                          table.insert(argv, uri["host"])
                  end
          
                  if uri["scheme"] == "file" and uri["path"] then
                          argv = { }
                  end
          
                  if argv then
          
                          table.insert(argv, get_mtn_command(uri["host"]))
          
                          if args["debug"] then
                                  table.insert(argv, "--debug")
                          else
                                  table.insert(argv, "--quiet")
                          end
          
                          table.insert(argv, "--db")
                          table.insert(argv, uri["path"])
                          table.insert(argv, "serve")
                          table.insert(argv, "--stdio")
                          table.insert(argv, "--no-transport-auth")
          
                          if args["include"] then
                                  table.insert(argv, args["include"])
                          end
          
                          if args["exclude"] then
                                  table.insert(argv, "--exclude")
                                  table.insert(argv, args["exclude"])
                          end
                  end
                  return argv
          end
</pre>
     <br><dt><code>use_transport_auth (</code><var>uri</var><code>)</code><a name="index-use_005ftransport_005fauth-_0028_0040var_007buri_007d_0029-206"></a><dd>
Returns a boolean indicating whether monotone should use transport
authentication mechanisms when communicating with <var>uri</var>. If this
hook fails, the return value is assumed to be <code>true</code>. The form of
the <var>uri</var> argument is a table, identical to the table provided as
an argument to <code>get_netsync_connect_command</code>.

     <p>Note that the return value of this hook must "match" the semantics of
the command returned by <code>get_netsync_connect_command</code>. In
particular, if this hook returns <code>false</code>, the <samp><span class="command">serve</span></samp>
command line arguments passed to the remote end of the connection
should include the <samp><span class="option">--no-transport-auth</span></samp> option. A mismatch
between this hook's return value and the command line returned by
<code>get_netsync_connect_command</code> will cause a communication failure,
as the local and remote monotone processes will have mismatched
authentication assumptions.

     <pre class="smallexample">          function use_transport_auth(uri)
                  if uri["scheme"] == "ssh"
                  or uri["scheme"] == "file" then
                          return false
                  else
                          return true
                  end
          end
</pre>
     <br><dt><code>get_mtn_command(</code><var>host</var><code>)</code><a name="index-get_005fmtn_005fcommand_0028_0040var_007bhost_007d_0029-207"></a><dd>
Returns a string containing the monotone command to be executed on
<var>host</var> when communicating over <samp><span class="command">ssh</span></samp>.  The <var>host</var>
argument is a string containing the name of the host to which
<samp><span class="command">ssh</span></samp> is connecting, from the server URI.  This is useful when
there are multiple monotone binaries on the remote host, or the
monotone binary is not in the default path.

     <pre class="smallexample">          function get_mtn_command(host)
              return "mtn"
          end
</pre>
     </dl>

   <p><a name="Trust-Evaluation-Hooks"></a>

<h4 class="subsection">6.1.5 Trust Evaluation Hooks</h4>

<p>Monotone makes heavy use of certs to provide descriptive information
about revisions. In many projects, not all developers should have the
same privileges, or be trusted for the same purposes (indeed, some
signers might be automated robots, with very specific purposes).

   <p>These hooks allow the user to configure which signers will be trusted to
make which kinds of assertions using certs. Monotone uses these certs when
selecting available revisions for commands such as <samp><span class="command">update</span></samp>.

   <p>Each user, or even each workspace, can have their own
implementation of these hooks, and thus a different filtered view of
valid revisions, according to their own preferences and purposes.

     <dl>
<dt><code>get_revision_cert_trust (</code><var>signers</var><code>, </code><var>id</var><code>, </code><var>name</var><code>, </code><var>val</var><code>)</code><a name="index-get_005frevision_005fcert_005ftrust-_0028_0040var_007bsigners_007d_002c-_0040var_007bid_007d_002c-_0040var_007bname_007d_002c-_0040var_007bval_007d_0029-208"></a><dd>
Returns whether or not you <em>trust</em> the assertion
<var>name</var>=<var>value</var> on a given revision <var>id</var>, given a valid
signature from all the keys in <var>signers</var>. The <var>signers</var>
parameter is a table containing all the key names which signed this
cert, the other three parameters are strings.

     <p>The default definition of this hook simply returns <code>true</code>, which
corresponds to a form of trust where every key which is defined in
your database is trusted. This is a <em>weak</em> trust setting; you
should change it to something stronger. A possible example of a
stronger trust function (along with a utility function for computing
the intersection of tables) is the following:

     <pre class="smallexample">          function intersection(a,b)
             local s={}
             local t={}
             for k,v in pairs(a) do s[v] = 1 end
             for k,v in pairs(b) do if s[v] ~= nil then table.insert(t,v) end end
             return t
          end
          
          function get_revision_cert_trust(signers, id, name, val)
             local trusted_signers = { "bob@happyplace.example.com",
                                       "friend@trustedplace.example.com",
                                       "myself@home.example.com" }
             local t = intersection(signers, trusted_signers)
          
             if t == nil then return false end
          
             if    (name ~= "branch" and table.getn(t) &gt;= 1)
                or (name == "branch" and table.getn(t) &gt;= 2)
             then
                return true
             else
                return false
             end
          end
</pre>
     <p>In this example, any revision certificate is trusted if it is signed
by at least one of three &ldquo;trusted&rdquo; keys, unless it is an
<code>branch</code> certificate, in which case it must be signed by
<em>two</em> or more trusted keys. This is one way of requiring that
the revision has been approved by an extra &ldquo;reviewer&rdquo; who used the
<samp><span class="command">approve</span></samp> command.

     <br><dt><code>accept_testresult_change (</code><var>old_results</var><code>, </code><var>new_results</var><code>)</code><a name="index-accept_005ftestresult_005fchange-_0028_0040var_007bold_005fresults_007d_002c-_0040var_007bnew_005fresults_007d_0029-209"></a><dd>
This hook is used by the update algorithm to determine whether a
change in test results between update source and update target is
acceptable. The hook is called with two tables, each of which maps a
signing key &ndash; representing a particular testsuite &ndash; to a boolean
value indicating whether or not the test run was successful. The
function should return <code>true</code> if you consider an update from the
version carrying the <var>old_results</var> to the version carrying the
<var>new_results</var> to be acceptable.

     <p>The default definition of this hook follows:

     <pre class="smallexample">          function accept_testresult_change(old_results, new_results)
             for test,res in pairs(old_results)
             do
                if res == true and new_results[test] ~= true
                then
               return false
                end
             end
             return true
          end
</pre>
     <p>This definition accepts only those updates which preserve the set of
<code>true</code> test results from update source to target. If no test
results exist, this hook has no affect; but once a <code>true</code> test
result is present, future updates will require it. If you want a more
lenient behavior you must redefine this hook.

   </dl>

<h4 class="subsection">6.1.6 External Diff Tools</h4>

<p>Differences between files can be shown in a number of ways, varying
according to user preference and file type. These hooks allow
customisation of the way file differences are shown.

     <dl>
<dt><code>get_encloser_pattern (</code><var>file_path</var><code>)</code><a name="index-get_005fencloser_005fpattern-_0028_0040var_007bfile_005fpath_007d_0029-210"></a><dd>
Called for each file when <samp><span class="command">diff</span></samp> is given the
<samp><span class="option">--show-encloser</span></samp> option (and <em>not</em> the
<samp><span class="option">--external</span></samp> option).  <var>file_path</var> is the pathname of the
file that is being diffed.  The hook should return a string constant
containing a regular expression; this regular expression will be used
to find lines that, in that file, name the &ldquo;top-level&rdquo; constructs
enclosing each &ldquo;hunk&rdquo; of changes.  The default is
<code>^[[:alnum:]$_]</code>, which is correct for many programming
languages; a few text authoring packages, like Texinfo, have special
regular expressions that match their particular syntax.  If you have a
better regular expression for some language, you can add it to this
hook; and if you send it to the monotone developers, we will likely
make it the default for that language.  See <a href="#Regexps">Regexps</a>, for the
regular expression syntax.

     <br><dt><code>external_diff (</code><var>file_path</var><code>, </code><var>old_data</var><code>, </code><var>new_data</var><code>, </code><var>is_binary</var><code>, </code><var>diff_args</var><code>, </code><var>old_rev</var><code>, </code><var>new_rev</var><code>)</code><a name="index-external_005fdiff-_0028_0040var_007bfile_005fpath_007d_002c-_0040var_007bold_005fdata_007d_002c-_0040var_007bnew_005fdata_007d_002c-_0040var_007bis_005fbinary_007d_002c-_0040var_007bdiff_005fargs_007d_002c-_0040var_007bold_005frev_007d_002c-_0040var_007bnew_005frev_007d_0029-211"></a><dd>
Called for each file when <samp><span class="command">diff</span></samp> is given the
<samp><span class="option">--external</span></samp> option.  <var>file_path</var> is the pathname of the
file that is being diffed.  <var>old_data</var> and <var>new_data</var> are the
data contents of the old and the new file.  If the data is binary,
<var>is_binary</var> will be true, otherwise false.  <var>old_rev</var> and
<var>new_rev</var> are the revision IDs of the old and new data.

     <p>If an extra arguments are given via <samp><span class="option">--diff-args</span></samp>, the string
will be passed in as <var>diff_args</var>.  Otherwise <var>diff_args</var> will
be nil.

     <p>The default implementation of this hook calls the program <samp><span class="command">diff</span></samp>,
and if <samp><span class="option">--diff-args</span></samp> were not passed, takes default arguments
from the Lua variable <code>external_diff_default_args</code>.  You can
override this variable in your configuration file, without overriding
the whole hook.

   </dl>

<h4 class="subsection">6.1.7 External Merge Tools</h4>

<p>Monotone often needs to merge together the work of multiple distributed
developers, and uses these hooks to help this process when the merge
does not automatically succeed.  Often these hooks will be used to invoke
an external interactive merge tool.

   <p>The <a href="#Default-hooks">Default hooks</a> include helper functions used by the hooks below
to invoke a number of external merge tools known to monotone, and you
can override or extend these hooks if you have a preferred tool, or if
you have a tool specific to certain file types.

     <dl>
<a name="merge3"></a><dt><code>merge3 (</code><var>ancestor_path</var><code>, </code><var>left_path</var><code>, </code><var>right_path</var><code>, </code><var>merged_path</var><code>, </code><var>ancestor_text</var><code>, </code><var>left_text</var><code>, </code><var>right_text</var><code>)</code><a name="index-merge3-_0028_0040var_007bancestor_005fpath_007d_002c-_0040var_007bleft_005fpath_007d_002c-_0040var_007bright_005fpath_007d_002c-_0040var_007bmerged_005fpath_007d_002c-_0040var_007bancestor_005ftext_007d_002c-_0040var_007bleft_005ftext_007d_002c-_0040var_007bright_005ftext_007d_0029-212"></a><dd>
This hook is called to resolve merges that monotone could not resolve
automatically.  The actual ancestor, left, and right contents of the
file are passed in the <var>ancestor_text</var>, <var>left_text</var>, and
<var>right_text</var> strings.  In addition, the hook is given the names
that this file had in the ancestor (<var>ancestor_path</var>), left
(<var>left_path</var>), and right (<var>right_path</var>) trees, and the name it
will end up having in the merged tree (<var>merged_path</var>).  These
paths are useful for merge tools that can display the names of files
in their GUI, since the actual path names are likely more meaningful
than the temporary file names the merge tool will actually be working
on.

     <p>Returns a string, which should be the merger of the given texts.  The
default definition of this hook delegates the actual merge to the
result of <a href="#get_005fpreferred_005fmerge3_005fcommand">get_preferred_merge3_command</a>.  The default definition
of <a href="#get_005fpreferred_005fmerge3_005fcommand">get_preferred_merge3_command</a> checks to see if the
<samp><span class="env">MTN_MERGE</span></samp> environment variable, or the Lua variable
<code>merger</code> are set to the name of a merge tool that it recognizes,
and if not, then simply searches for whatever is installed on the
local system.  For details, see the code in <a href="#Default-hooks">Default hooks</a>.

     <p><a name="get_005fpreferred_005fmerge3_005fcommand"></a><br><dt><code>get_preferred_merge3_command(</code><var>tbl</var><code>)</code><a name="index-get_005fpreferred_005fmerge3_005fcommand_0028_0040var_007btbl_007d_0029-213"></a><dd>
Returns the results of running an external merge on three strings. 
<var>tbl</var> wraps up the various arguments for each merge command and
is always provided by <a href="#merge3">merge3</a>. If there is a particular editor
that you would like to use to perform merge3 operations, override
this hook to specify it.

   </dl>

<h4 class="subsection">6.1.8 Selector Expansion</h4>

<p>Monotone's selectors are a powerful mechanism used to refer to revisions
with symbolic names or groupings. Thanks to the hooks described in this
section, it is possible to use various forms of shorthand in selection
strings; these hooks are designed to recognise shorthand patterns and
expand them to their full form.

   <p>For more detail on the use of selectors, see <a href="#Selectors">Selectors</a>.

     <dl>
<dt><code>expand_selector (</code><var>str</var><code>)</code><a name="index-expand_005fselector-_0028_0040var_007bstr_007d_0029-214"></a><dd>
Attempts to expand <var>str</var> as a selector. Expansion generally means
providing a type prefix for the selector, such as <code>a:</code> for authors
or <code>d:</code> for dates. This hook is called once for each element of a
combined selector string (between <code>/</code> separators) prior to
evaluation of the selector. For the default definition of this hook, see
<a href="#Default-hooks">Default hooks</a>.

     <br><dt><code>expand_date (</code><var>str</var><code>)</code><a name="index-expand_005fdate-_0028_0040var_007bstr_007d_0029-215"></a><dd>
Attempts to expand <var>str</var> as a date expression. Expansion means
recognizing and interpreting special words such as <code>yesterday</code> or
<code>6 months ago</code> and converting them into well formed date
expressions. For the default definition of this hook, see <a href="#Default-hooks">Default hooks</a>.

   </dl>

<h4 class="subsection">6.1.9 Attribute Handling</h4>

<p>Some files in a project are special; they may require different handling
(such as binary or structured files that should always be manually
merged &ndash; see <a href="#Merging">Merging</a>), or they may represent executable scripts
or programs.

   <p>Monotone allows each file (or directory) in a repository to carry
arbitrary <a href="#File-Attributes">File Attributes</a>.  Persistent attributes are stored
each revision's manifest. The hooks in this section allow files to be
automatically recognised as having certain attributes at the time
they're added, and for custom triggers to be invoked on each file
according to its attributes when the workspace is changed.

     <dl>
<dt><code>attr_functions [</code><var>attribute</var><code>] (</code><var>filename</var><code>, </code><var>value</var><code>)</code><a name="index-attr_005ffunctions-_005b_0040var_007battribute_007d_005d-_0028_0040var_007bfilename_007d_002c-_0040var_007bvalue_007d_0029-216"></a><dd>
This is not a hook function, but a <em>table</em> of hook
functions. Each entry in the table <code>attr_functions</code>, at table
entry <var>attribute</var>, is a function taking a file name <var>filename</var>
and a attribute value <var>value</var>. The function should &ldquo;apply&rdquo; the
attribute to the file, possibly in a platform-specific way.

     <p>Hook functions from this table are called for each existing attr,
after any command which modifies the workspace. This facility can
be used to extend monotone's understanding of files with
platform-specific attributes, such as permission bits, access control
lists, or special file types.

     <p>By default, there is only one entry in this table, for the <code>mtn:execute</code>
attribute. Its definition is:

     <pre class="smallexample">          attr_functions["mtn:execute"] =
            function(filename, value)
                  if (value == "true") then
                   make_executable(filename)
                end
             end
</pre>
     <br><dt><code>attr_init_functions [</code><var>attribute</var><code>] (</code><var>filename</var><code>)</code><a name="index-attr_005finit_005ffunctions-_005b_0040var_007battribute_007d_005d-_0028_0040var_007bfilename_007d_0029-217"></a><dd>
This is not a hook function, but a <em>table</em> of hook
functions. Each entry in the table <code>attr_init_functions</code>, at
table entry <var>attribute</var>, is a function taking a file (or
directory) name <var>filename</var>. Each function defines the attributes
that should be set on the file named <var>filename</var>. This table of
hook functions is called once for each file during an <dfn>add</dfn>.

     <p>By default, there are only two entries in this table, for the
<code>mtn:execute</code> and <code>mtn:manual_merge</code> attributes. Their
definition is:

     <pre class="smallexample">          attr_init_functions["mtn:execute"] =
             function(filename)
                if (is_executable(filename)) then
                  return "true"
                else
                  return nil
                end
             end
          attr_init_functions["mtn:manual_merge"] =
             function(filename)
                if (binary_file(filename)) then
                  return "true" -- binary files must be merged manually
                else
                  return nil
                end
             end
</pre>
     <p>The <code>binary_file</code> function is also defined as a Lua hook. See
<a href="#Default-hooks">Default hooks</a>.

   </dl>

<h4 class="subsection">6.1.10 Validation Hooks</h4>

<p>If there is a policy decision to make, Monotone defines certain hooks to
allow a client to validate or reject certain behaviors.

     <dl>
<dt><code>validate_commit_message (</code><var>message</var><code>, </code><var>revision_text</var><code>, </code><var>branchname</var><code>)</code><a name="index-validate_005fcommit_005fmessage-_0028_0040var_007bmessage_007d_002c-_0040var_007brevision_005ftext_007d_002c-_0040var_007bbranchname_007d_0029-218"></a><dd>
This hook is called after the user has entered his/her commit message. 
<var>message</var> is the commit message that the user has entered and
<var>revision_text</var> is the full text of the changes for this revision,
which can be parsed with the parse_basic_io function. The <var>branchname</var> on
which the new revision will be committed if all goes well is passed in as the third
parameter. 
If the hook finds the commit message satisfactory, it can return <code>true,
""</code>. If it finds fault, then it can return <code>false, reason</code> where
<var>reason</var> is the reason the message was rejected. By default, this hook
rejects empty log messages.

   </dl>

<p><a name="Additional-Lua-Functions"></a>

<h3 class="section">6.2 Additional Lua Functions</h3>

<p>This section documents the additional Lua functions made available to
hook writers.

     <dl>
<dt><code>alias_command(</code><var>original</var><code>, </code><var>alias</var><code>)</code><a name="index-alias_005fcommand_0028_0040var_007boriginal_007d_002c-_0040var_007balias_007d_0029-219"></a><dd>
This function adds a new alias for a monotone command.  A call to this function would
normally be placed directly in the <samp><span class="file">monotonerc</span></samp> file, rather than in a hook function.

     <br><dt><code>existonpath(</code><var>possible_command</var><code>)</code><a name="index-existonpath_0028_0040var_007bpossible_005fcommand_007d_0029-220"></a><dd>
This function receives a string containing the name of an external
program and returns 0 if it exists on path and is executable, -1
otherwise. 
As an example, <code>existonpath("xxdiff")</code> returns 0 if the
program xxdiff is available. 
On Windows, this function automatically appends &ldquo;.exe&rdquo; to the
program name. In the previous example, <code>existonpath</code> would search
for &ldquo;xxdiff.exe&rdquo;.

     <br><dt><code>get_confdir()</code><a name="index-get_005fconfdir_0028_0029-221"></a><dd>
Returns the path to the configuration directory, either implied or given
with <samp><span class="option">--confdir</span></samp>.

     <br><dt><code>get_ostype()</code><a name="index-get_005fostype_0028_0029-222"></a><dd>
Returns the operating system flavor as a string.

     <br><dt><code>guess_binary_file_contents(</code><var>filespec</var><code>)</code><a name="index-guess_005fbinary_005ffile_005fcontents_0028_0040var_007bfilespec_007d_0029-223"></a><dd>
Returns true if the file appears to be binary, i.e. contains one or
more of the following characters:
     <pre class="smallexample">          0x00 thru 0x06
          0x0E thru 0x1a
          0x1c thru 0x1f
</pre>
     <br><dt><code>include(</code><var>scriptfile</var><code>)</code><a name="index-include_0028_0040var_007bscriptfile_007d_0029-224"></a><dd>
This function tries to load and execute the script contained into
scriptfile.  It returns true for success and false if there is an
error.

     <br><dt><code>includedir(</code><var>scriptpath</var><code>)</code><a name="index-includedir_0028_0040var_007bscriptpath_007d_0029-225"></a><dd>
This function loads and executes in alphabetical order all the scripts
contained into the directory scriptpath. 
If one of the scripts has an error, the functions doesn't process the
remaining scripts and immediately returns false.

     <br><dt><code>includedirpattern(</code><var>scriptpath</var><code>, </code><var>pattern</var><code>)</code><a name="index-includedirpattern_0028_0040var_007bscriptpath_007d_002c-_0040var_007bpattern_007d_0029-226"></a><dd>
This function loads and executes in alphabetical order all the scripts
contained into the directory scriptpath that match the given pattern. 
If one of the scripts has an error, the functions doesn't process the
remaining scripts and immediately returns false.

     <br><dt><code>is_executable(</code><var>filespec</var><code>)</code><a name="index-is_005fexecutable_0028_0040var_007bfilespec_007d_0029-227"></a><dd>
This function returns true if the file is executable, false
otherwise.  On Windows this function returns always false.

     <br><dt><code>kill(</code><var>pid</var><code> [, </code><var>signal</var><code>])</code><a name="index-kill_0028_0040var_007bpid_007d-_005b_002c-_0040var_007bsignal_007d_005d_0029-228"></a><dd>
This function calls the kill() C library function on POSIX systems and
TerminateProcess on Win32 (in that case <var>pid</var> is the process
handle).  If the optional <var>signal</var> parameter is missing, SIGTERM
will be used. 
Returns 0 on success, -1 on error.

     <br><dt><code>make_executable(</code><var>filespec</var><code>)</code><a name="index-make_005fexecutable_0028_0040var_007bfilespec_007d_0029-229"></a><dd>
This function marks the named file as executable.  On Windows has no
effect.

     <br><dt><code>match(</code><var>glob</var><code>, </code><var>string</var><code>)</code><a name="index-match_0028_0040var_007bglob_007d_002c-_0040var_007bstring_007d_0029-230"></a><dd>
Returns true if <var>glob</var> matches <var>str</var>, return false otherwise.

     <br><dt><code>mkstemp(</code><var>template</var><code>)</code><a name="index-mkstemp_0028_0040var_007btemplate_007d_0029-231"></a><dd>
Like its C library counterpart,  mkstemp creates a unique name and
returns a file descriptor for the newly created file. 
The value of template should be a pointer to a character buffer loaded
with a null-terminated string that consists of contiguous, legal file
ad path name characters followed by six Xs. 
The function mkstemp replaces the Xs by an alpha-numeric sequence
that is chosen to ensure that no file in the chosen directory has that
name. 
Furthermore, subsequent calls to mkstemp within the same process
each yield different file names. 
Unlike other implementations, monotone mkstemp allows the template
string to contain a complete path, not only a filename, allowing users
to create temporary files outside the current directory.

     <p><strong>Important notice:</strong><br>
To create a temporary file, you must use the <code>temp_file()</code>
function, unless you need to run monotone with the <samp><span class="option">--nostd</span></samp>
option.  <code>temp_file()</code> builds on <code>mkstemp()</code> and creates a
file in the standard TMP/TEMP directories. 
For the definition of <code>temp_file()</code>, see <a href="#Default-hooks">Default hooks</a>.

     <br><dt><code>mtn_automate( ... )</code><a name="index-mtn_005fautomate_0028-_002e_002e_002e-_0029-232"></a><dd>
The <code>mtn_automate</code> Lua function calls the Monotone
<samp><span class="command">automate</span></samp> command passed in its arguments. The result of the
call is a pair consisting of a boolean return code, indicating whether
the call was successful or not, and a string being the <code>stdout</code>
output from the <samp><span class="command">automate</span></samp> command. This function is not for use
in ordinary Lua hooks, but rather for Lua based commands as defined by
the Lua function <code>register_command</code>.

     <br><dt><code>parse_basic_io(</code><var>data</var><code>)</code><a name="index-parse_005fbasic_005fio_0028_0040var_007bdata_007d_0029-233"></a><dd>
Parse the string <var>data</var>, which should be in basic_io format. It returns nil
if it can't parse the string; otherwise it returns a table. This will be a list
of all statements, with each entry being a table having a "name" element that is
the symbol beginning the statement and a "values" element that is a list of all
the arguments.

     <p>For example, given this as input:

     <pre class="smallexample">          thingy "foo" "bar"
          thingy "baz"
          spork
          frob "oops"
</pre>
     <p>The output table will be:
     <pre class="smallexample">          {
             1 = { name = "thingy", values = { 1 = "foo", 2 = "bar" } },
             2 = { name = "thingy", values = { 1 = "baz" } },
             3 = { name = "spork", values = { } },
             4 = { name = "frob", values = { 1 = "oops" } }
          }
</pre>
     <br><dt><code>regex.search(</code><var>regexp</var><code>, </code><var>string</var><code>)</code><a name="index-regex_002esearch_0028_0040var_007bregexp_007d_002c-_0040var_007bstring_007d_0029-234"></a><dd>
Returns true if a match for <var>regexp</var> is found in <var>str</var>, return
false otherwise.  See <a href="#Regexps">Regexps</a>, for the syntax of <var>regexp</var>.

     <br><dt><code>register_command(</code><var>name</var><code>, </code><var>params</var><code>, </code><var>abstract</var><code>, </code><var>description</var><code>, </code><var>function</var><code>)</code><a name="index-register_005fcommand_0028_0040var_007bname_007d_002c-_0040var_007bparams_007d_002c-_0040var_007babstract_007d_002c-_0040var_007bdescription_007d_002c-_0040var_007bfunction_007d_0029-235"></a><dd>
Add a command named <var>name</var> to the <var>user</var> command group in monotone.  This function is
normally called directly from a <samp><span class="file">monotonerc</span></samp> file rather than a hook.  When the user issues the
registered command, monotone will call the lua <var>function</var> name supplied.  That function would
then normally use mtn_automate() calls to service the request.

     <br><dt><code>server_request_sync(</code><var>what</var><code>, </code><var>address</var><code>, </code><var>include</var><code>, </code><var>exclude</var><code>)</code><a name="index-server_005frequest_005fsync_0028_0040var_007bwhat_007d_002c-_0040var_007baddress_007d_002c-_0040var_007binclude_007d_002c-_0040var_007bexclude_007d_0029-236"></a><dd>
Initiate a netsync connection to the server at <var>address</var>, with the
given include and exclude patterns, of type <samp><span class="option">sync</span></samp>, <samp><span class="option">push</span></samp>,
or <samp><span class="option">pull</span></samp>, as given by the <var>what</var> argument.

     <p>When called by a monotone instance which is not running the <samp><span class="option">serve</span></samp>
command, this function has no effect.

     <br><dt><code>sleep(</code><var>seconds</var><code>)</code><a name="index-sleep_0028_0040var_007bseconds_007d_0029-237"></a><dd>
Makes the calling process sleep for the specified number of seconds.

     <br><dt><code>spawn(</code><var>executable</var><code> [, </code><var>args ...</var><code>])</code><a name="index-spawn_0028_0040var_007bexecutable_007d-_005b_002c-_0040var_007bargs-_002e_002e_002e_007d_005d_0029-238"></a><dd>
Starts the named executable with the given arguments.  Returns the
process PID on POSIX systems, the process handle on Win32 or -1 if
there was an error. 
Calls fork/execvp on POSIX, CreateProcess on Win32.

     <p><strong>Important notice:</strong><br>
To spawn a process and wait for its completion, use the <code>execute()</code>
function, unless you need to run monotone with the <samp><span class="option">--nostd</span></samp>
option.  <code>execute()</code> builds on <code>spawn()</code> and <code>wait()</code>
in a standardized way.

     <br><dt><code>spawn_pipe(</code><var>executable</var><code> [, </code><var>args ...</var><code>])</code><a name="index-spawn_005fpipe_0028_0040var_007bexecutable_007d-_005b_002c-_0040var_007bargs-_002e_002e_002e_007d_005d_0029-239"></a><dd>
Like spawn(), but returns three values, where the first two are the
subprocess' standard input and standard output, and the last is the
process PID on POSIX systems, the process handle on Win32 or -1 if
there was an error.

     <br><dt><code>spawn_redirected(</code><var>infile</var><code>, </code><var>outfile</var><code>, </code><var>errfile</var><code>, </code><var>executable</var><code> [, </code><var>args ...</var><code>])</code><a name="index-spawn_005fredirected_0028_0040var_007binfile_007d_002c-_0040var_007boutfile_007d_002c-_0040var_007berrfile_007d_002c-_0040var_007bexecutable_007d-_005b_002c-_0040var_007bargs-_002e_002e_002e_007d_005d_0029-240"></a><dd>
Like spawn(), but with standard input, standard output and standard
error redirected to the given files.

     <br><dt><code>wait(</code><var>pid</var><code>)</code><a name="index-wait_0028_0040var_007bpid_007d_0029-241"></a><dd>
Wait until the process with given PID (process handle on Win32) exits. 
Returns two values: a result value and the exit code of the waited-for
process. 
The exit code is meaningful only if the result value is 0.

   </dl>

<p><a name="Special-Topics"></a>

<h2 class="chapter">7 Special Topics</h2>

<p>This chapter describes some &ldquo;special&rdquo; issues which are not directly
related to monotone's <em>use</em>, but which are occasionally of
interest to people researching monotone or trying to learn the
specifics of how it works. Most users can ignore these sections.

<p><a name="Internationalization"></a>

<h3 class="section">7.1 Internationalization</h3>

<p>Monotone initially dealt with only ASCII characters, in file path
names, certificate names, key names, and packets. Some
conservative extensions are provided to permit internationalized
use. These extensions can be summarized as follows:

     <ul>
<li>Monotone uses GNU gettext to provide localized progress and error
messages. Translations may or may not exist for your locale, but the
infrastructure is present to add them.

     <li>All command-line arguments are mapped from your local character set to
UTF-8 before processing. This means that monotone can <em>only</em>
handle key names, file names and certificate names which map cleanly
into UTF-8.

     <li>Monotone's control files are stored in UTF-8. This includes: revisions
and manifests, both inside the database and when written to the
<samp><span class="file">_MTN/</span></samp> directory of the workspace; the <samp><span class="file">_MTN/options</span></samp> and
<samp><span class="file">_MTN/revision</span></samp> files. Converting these files to any other
character set will cause monotone to break; do not do so.

     <li>File path names in the workspace are converted to the locale's
character set (determined via the LANG or CHARSET environment
variables) before monotone interacts with the file system. If you are
accustomed to being able to use file names in your locale's character
set, this should &ldquo;just work&rdquo; with monotone.

     <li>Key and cert names, and similar &ldquo;name-like&rdquo; entities are subject to
some cleaning and normalization, and conversion into network-safe
subsets of ASCII (typically ACE). Generally, you should be able to use
&ldquo;sensible&rdquo; strings in your locale's character set as names, but they
may appear mangled or escaped in certain contexts such as network
transmission.

     <li>Monotone's transmission and storage forms are otherwise
unchanged. Packets and database contents are 7-bit clean ASCII.

   </ul>

   <p>The remainder of this section is a precise specification of monotone's
internationalization behavior.

<h3 class="heading">General Terms</h3>

     <dl>
<dt>Character set conversion<dd>The process of mapping a string of bytes representing wide characters
from one encoding to another. Per-file character set conversions are
specified by a Lua hook <code>get_charset_conv</code> which takes a filename
and returns a table of two strings: the first represents the
"internal" (database) charset, the second represents the "external"
(file system) charset.

     <br><dt>LDH<dd>Letters, digits, and hyphen: the set of ASCII bytes <code>0x2D</code>,
<code>0x30..0x39</code>, <code>0x41..0x5A</code>, and <code>0x61..0x7A</code>.

     <br><dt>stringprep<dd>RFC 3454, a general framework for mapping, normalizing, prohibiting
and bidirectionality checking for international names prior to use in
public network protocols.

     <br><dt>nameprep<dd>RFC 3491, a specific profile of stringprep, used for preparing
international domain names (IDNs)

     <br><dt>punycode<dd>RFC 3492, a "bootstring" encoding of Unicode into ASCII.

     <br><dt>IDNA<dd>RFC 3490, international domain names for applications, a combination
of the above technologies (nameprep, punycoding, limiting to LDH
characters) to form a specific "ASCII compatible encoding" (ACE) of
Unicode, signified by the presence of an "unlikely" ACE prefix string
"xn&ndash;". IDNA is intended to make it possible to use Unicode relatively
"safely" over legacy ASCII-based applications. the general picture of
an IDNA string is this:

     <pre class="smallexample">                {ACE-prefix}{LDH-sanitized(punycode(nameprep(UTF-8-string)))}
</pre>
     <p>It is important to understand that IDNA encoding does <em>not</em>
preserve the input string: it both prohibits a wide variety of
possible strings and normalizes non-equal strings to supposedly
"equivalent" forms.

     <p>By default, monotone does <em>not</em> decode IDNA when printing to the
console (IDNA names are ASCII, which is a subset of UTF-8, so this
normal form conversion can still apply, albeit oddly). this behavior
is to protect users against security problems associated with
malicious use of "similar-looking" characters. If the hook
<code>display_decoded_idna</code> returns true, IDNA names are decoded for
display.

</dl>

<h3 class="heading">Filenames</h3>

     <ul>
<li>Filenames are subject to normal form conversion.

     <li>Filenames are subject to an additional normal form stage which adjusts
for platform name semantics, for example changing the Windows
<code>0x5C</code> '\' path separator to <code>0x2F</code> '/'. This extra
processing is performed by boost::filesystem.

     <li>FIXME: Monotone does not properly handle case insensitivity on Windows.

     <li>A filename (in normal form) is constrained to be a nonempty sequence
of path components, separated by byte <code>0x2F</code> (ASCII / ), and
without a leading or trailing <code>0x2F</code>.

     <li>A path component is a nonempty sequence of any UTF-8 character codes
except the path separator byte <code>0x2F</code> and any ASCII "control codes"
(<code>0x00..0x1F</code> and <code>0x7F</code>).

     <li>The path components "." and ".." are prohibited.

     <li>Manifests and revisions are constructed from the normal form
(UTF-8). The LC_COLLATE locale category is <em>not</em> used to sort
manifest or revision entries.

</ul>

<h3 class="heading">File contents</h3>

     <ul>
<li>Files are subject to character set conversion and line ending
conversion.

     <li>File SHA1 values are calculated from the internal form of the
conversions. If the external form of a file differs from the internal
form, running a 3rd party program such as <samp><span class="command">sha1sum</span></samp> will produce
different results than those entries shown in a corresponding manifest.

</ul>

<h3 class="heading">UI messages</h3>

<p>UI messages are displayed via calls to <code>gettext()</code>.

<h3 class="heading">Host names</h3>

<p>Host names are read on the command-line and subject to normal form
conversion. Host names are then split at <code>0x2E</code> (ASCII '.'), each
component is subject to IDNA encoding, and the components are
rejoined.

   <p>After processing, host names are stored internally as ASCII. The
invariant is that a host name inside monotone contains only sequences
of LDH separated by <code>0x2E</code>.

<h3 class="heading">Cert names</h3>

<p>Read on the command line and subject to normal form conversion and
IDNA encoding as a single component. The invariant is that a cert name
inside monotone is a single LDH ASCII string.

<h3 class="heading">Cert values</h3>

<p>Cert values may be either text or binary, depending on the return
value of the hook <code>cert_is_binary</code>. If binary, the cert value is
never printed to the screen (the literal string "&lt;binary&gt;" is
displayed, instead), and is never subjected to line ending or
character conversion. If text, the cert value is subject to normal
form conversion, as well as having all UTF-8 codes corresponding to
ASCII control codes (<code>0x0..0x1F</code> and <code>0x7F</code>) prohibited in
the normal form, except <code>0x0A</code> (ASCII LF).

<h3 class="heading">Var domains</h3>

<p>Read on the command line and subject to normal form conversion and IDNA
encoding as a single component. The invariant is that a var domain
inside monotone is a single LDH ASCII string.

<h3 class="heading">Var names and values</h3>

<p>Var names and values are assumed to be text, and subject to normal form
conversion.

<h3 class="heading">Key names</h3>

<p>Read on the command line and subject to normal form conversion and
IDNA encoding as an email address (split and joined at '.' and '@'
characters). The invariant is that a key name inside monotone contains
only LDH, <code>0x2E</code> (ASCII '.') and <code>0x40</code> (ASCII '@')
characters.

<h3 class="heading">Packets</h3>

<p>Packets are 7-bit ASCII. The characters permitted in packets are
the union of these character sets:

     <ul>
<li>The 65 characters of base64 encoding (64 coding + "=" pad). 
<li>The 16 characters of hex encoding. 
<li>LDH, '@' and '.' characters, as required for key and cert names. 
<li>'[' and ']', the packet delimiters. 
<li>ASCII codes 0x0D (CR), 0x0A (LF), 0x09 (HT), and 0x20 (SP). 
</ul>

<p><a name="Hash-Integrity"></a>

<h3 class="section">7.2 Hash Integrity</h3>

<p>Some proponents of a competing, proprietary version control system
have suggested, in a
<a href="http://www.usenix.org/events/hotos03/tech/full_papers/henson/henson_html/">usenix paper</a>, that the use of a cryptographic hash function such as
<span class="sc">sha1</span> as an identifier for a version is unacceptably unsafe. This
section addresses the argument presented in that paper and describes
monotone's additional precautions.

   <p>To summarize our position:
     <ul>
<li>the analysis in the paper is wrong,
<li>even if it were right, monotone is sufficiently safe. 
</ul>

<h3 class="heading">The analysis is wrong</h3>

<p>The paper displays a fundamental lack of understanding about what a
<em>cryptographic</em> hash function is, and how it differs from a
normal hash function. Furthermore it confuses accidental collision
with attack scenarios, and mixes up its analysis of the risk involved
in each. We will try to untangle these issues here.

   <p>A cryptographic hash function such as <span class="sc">sha1</span> is more than just a
uniform spread of inputs to an output range. Rather, it must be
designed to withstand attempts at:

     <ul>
<li>reversal: deriving an input value from the output
<li>collision: finding two different inputs which hash to the same output
</ul>

   <p>Collision is the problem the paper is concerned with. Formally, an
n-bit cryptographic hash should cost 2^n work units to collide
against a given value, and sqrt(2^n) tries to find a random
pair of colliding values. This latter probability is sometimes called
the hash's &ldquo;birthday paradox probability&rdquo;.

<h4 class="subheading">Accidental collision</h4>

<p>One way of measuring these bounds is by measuring how single-bit
changes in the input affect bits in the hash output. The <span class="sc">sha1</span>
hash has a strong <em>avalanche property</em>, which means that flipping
<em>any one bit</em> in the input will cause on average half the 160
bits in the output code to change. The fanciful <span class="sc">val1</span> hash
presented in the paper does not have such a property &mdash; flipping its
first bit when all the rest are zero causes <em>no change</em> to any of
the 160 output bits &mdash; and is completely unsuited for use as a
<em>cryptographic hash</em>, regardless of the general shape of its
probability distribution.

   <p>The paper also suggests that birthday paradox probability cannot be
used to measure the chance of accidental <span class="sc">sha1</span> collision on &ldquo;real
inputs&rdquo;, because birthday paradox probability assumes a uniformly
random sample and &ldquo;real inputs&rdquo; are not uniformly random. The paper
is wrong: the inputs to <span class="sc">sha1</span> are not what is being measured (and
in any case can be arbitrarily long); the collision probability being
measured is of <em>output space</em>. On output space, the hash is
designed to produce uniformly random spread, even given nearly
identical inputs. In other words, it is <em>a primary design
criterion</em> of such a hash that a birthday paradox probability is a
valid approximation of its collision probability.

   <p>The paper's characterization of risk when hashing &ldquo;non-random
inputs&rdquo; is similarly deceptive. It presents a fanciful case of a
program which is <em>storing</em> every possible 2kb block in a
file system addressed by <span class="sc">sha1</span> (the program is trying to find a
<span class="sc">sha1</span> collision). While this scenario <em>will</em> very likely
encounter a collision <em>somewhere</em> in the course of storing all
such blocks, the paper neglects to mention that we only expect it to
collide after storing about 2^80 of the 2^16384 possible
such blocks (not to mention the requirements for compute time to
search, or disk space to store 2^80 2kb blocks).

   <p>Noting that monotone can only store 2^41 bytes in a database,
and thus probably some lower number (say 2^32 or so) active
rows, we consider such birthday paradox probability well out of
practical sight. Perhaps it will be a serious concern when
multi-yottabyte hard disks are common.

<h4 class="subheading">Collision attacks</h4>

<p>Setting aside accidental collisions, then, the paper's underlying
theme of vulnerability rests on the assertion that someone will break
<span class="sc">sha1</span>. Breaking a cryptographic hash usually means finding a way
to collide it trivially. While we note that <span class="sc">sha1</span> has in fact
resisted attempts at breaking for 8 years already, we cannot say that
it will last forever. Someone might break it. We can say, however,
that finding a way to trivially collide it only changes the resistance
to <em>active attack</em>, rather than the behavior of the hash on
benign inputs.

   <p>Therefore the vulnerability is not that the hash might suddenly cease
to address benign blocks well, but merely that additional security
precautions might become a requirement to ensure that blocks are
benign, rather than malicious. The paper fails to make this
distinction, suggesting that a hash becomes &ldquo;unusable&rdquo; when it is
broken. This is plainly not true, as a number of systems continue to
get useful low collision hashing behavior &mdash; just not good security
behavior &mdash; out of &ldquo;broken&rdquo; cryptographic hashes such as MD4.

<h3 class="heading">Monotone is probably safe anyways</h3>

<p>Perhaps our arguments above are unconvincing, or perhaps you are the
sort of person who thinks that practice never lines up with
theory. Fair enough. Below we present <em>practical</em> procedures you
can follow to compensate for the supposed threats presented in the
paper.

<h4 class="subheading">Collision attacks</h4>

<p>A successful collision attack on <span class="sc">sha1</span>, as mentioned, does not
disrupt the <em>probability</em> features of <span class="sc">sha1</span> on benign
blocks. So if, at any time, you believe <span class="sc">sha1</span> is &ldquo;broken&rdquo;, it
does <em>not</em> mean that you cannot use it for your work with
monotone. It means, rather, that you cannot base your <em>trust</em> on
<span class="sc">sha1</span> values anymore. You must trust who you communicate with.

   <p>The way around this is reasonably simple: if you do not trust
<span class="sc">sha1</span> to prevent malicious blocks from slipping into your
communications, you can always augment it by enclosing your
communications in more security, such as tunnels or additional
signatures on your email posts. If you choose to do this, you will
still have the benefit of self-identifying blocks, you will simply
cease to trust such blocks unless they come with additional
authentication information.

   <p>If in the future <span class="sc">sha1</span> (or, indeed, <span class="sc">rsa</span>) becomes accepted as
broken we will naturally upgrade monotone to a newer hash or public
key scheme, and provide migration commands to recalculate existing
databases based on the new algorithm.

   <p>Similarly, if you do not trust our vigilance in keeping up to date
with cryptography literature, you can modify monotone to use any
stronger hash you like, at the cost of isolating your own
communications to a group using the modified version. Monotone is free
software, and runs atop <code>botan</code>, so it is both legal and
relatively simple to change it to use some other algorithm.

<p><a name="Rebuilding-ancestry"></a>

<h3 class="section">7.3 Rebuilding ancestry</h3>

<p>As described in <a href="#Historical-records">Historical records</a>, monotone revisions contain the
<span class="sc">sha1</span> hashes of their predecessors, which in turn contain the
<span class="sc">sha1</span> hashes of <em>their</em> predecessors, and so on until the
beginning of history.  This means that it is <em>mathematically
impossible</em> to modify the history of a revision, without some way to
defeat <span class="sc">sha1</span>.  This is generally a good thing; having immutable
history is the point of a version control system, after all, and it
turns out to be very important to building a <em>distributed</em> version
control system like monotone.

   <p>It does have one unfortunate consequence, though.  It means that in the
rare occasion where one <em>needs</em> to change a historical revision, it
will change the <span class="sc">sha1</span> of that revision, which will change the text
of its children, which will change their <span class="sc">sha1</span>s, and so on;
basically the entire history graph will diverge from that point
(invalidating all certs in the process).

   <p>In practice there are two situations where this might be necessary:
     <ul>
<li>bugs: monotone has occasionally allowed nonsense, uninterpretable
changesets to be generated and stored in the database, and this was not
detected until further work had been based off of them. 
<li>advances in crypto: if or when <span class="sc">sha1</span> is broken, we will need to
migrate to a different secure hash. 
</ul>
   Obviously, we hope neither of these things will happen, and we've taken
lots of precautions against the first recurring; but it is better to be
prepared.

   <p>If either of these events occur, we will provide migration commands and
explain how to use them for the situation in question; this much is
necessarily somewhat unpredictable.  In the past we've used the (now
defunct) <samp><span class="command">db rebuild</span></samp> command, and more recently the <samp><span class="command">db
rosterify</span></samp> command, for such changes as monotone developed.  These
commands were used to recreate revisions with new formats.  Because the
revision id's changed, all the existing certs that you trust also must
be reissued, signed with your key.<a rel="footnote" href="#fn-2" name="fnd-2"><sup>2</sup></a>

   <p>While such commands can reconstruct the ancestry graph in <em>your</em>
database, there are practical problems which arise when working in a
distributed work group.  For example, suppose our group consists of the
fictional developers Jim and Beth, and they need to rebuild their
ancestry graph. Jim performs a rebuild, and sends Beth an email telling
her that he has done so, but the email gets caught by Beth's spam
filter, she doesn't see it, and she blithely syncs her database with
Jim's. This creates a problem: Jim and Beth have combined the
pre-rebuild and post-rebuild databases.  Their databases now contain two
complete, parallel (but possibly overlapping) copies of their project's
ancestry.  The &ldquo;bad&rdquo; old revisions that they were trying to get rid of
are still there, mixed up with the &ldquo;good&rdquo; new revisions.

   <p>To prevent such messy situations, monotone keeps a table of branch
<dfn>epochs</dfn> in each database. An epoch is just a large bit string
associated with a branch. Initially each branch's epoch is zero. Most
monotone commands ignore epochs; they are relevant in only two
circumstances:

     <ul>
<li>When monotone rebuilds ancestry, it generates a new <em>random</em>
epoch for each branch in the database.

     <li>When monotone runs netsync between databases, it checks to make sure
that all branches involved in the synchronization have the same
epochs. If any epochs differ, the netsync is aborted with no changes
made to either database. If either side is seeing a branch for the
first time, it adopts the epoch of the other side.

   </ul>

   <p>Thus, when a user rebuilds their ancestry graph, they select a new
epoch and thus effectively disassociate with the group of colleagues
they had previously been communicating with. Other members of that
group can then decide whether to follow the rebuild user into a new
group &mdash; by pulling the newly rebuilt ancestry &mdash; or to remain
behind in the old group.

   <p>In our example, if Jim and Beth have epochs, Jim's rebuild creates a
new epoch for their branch, in his database.  This causes monotone to
reject netsync operations between Jim and Beth; it doesn't matter if
Beth loses Jim's email. When she tries to synchronize with him, she
receives an error message indicating that the epoch does not
match. She must then discuss the matter with Jim and settle on a new
course of action &mdash; probably pulling Jim's database into a fresh
database on Beth's end &ndash; before future synchronizations will succeed.

<h3 class="heading">Best practices</h3>

<p>The previous section described the theory and rationale behind rebuilds
and epochs.  Here we discuss the practical consequences of that
discussion.

   <p>If you decide you must rebuild your ancestry graph &mdash; generally by
announcement of a bug from the monotone developers &mdash; the first thing
to do is get everyone to sync their changes with the central server;
if people have unshared changes when the database is rebuilt, they
will have trouble sharing them afterwards.

   <p>Next, the project should pick a designated person to take down the
netsync server, rebuild their database, and put the server back up
with the rebuilt ancestry in it.  Everybody else should then pull this
history into a fresh database, check out again from this database, and
continue working as normal.

   <p>In complicated situations, where people have private branches, or
ancestries cross organizational boundaries, matters are more complex. 
The basic approach is to do a local rebuild, then after carefully
examining the new revision IDs to convince yourself that the rebuilt
graph is the same as the upstream subgraph, use the special <samp><span class="command">db
epoch</span></samp> commands to force your local epochs to match the upstream ones. 
(You may also want to do some fiddling with certs, to avoid getting
duplicate copies of all of them; if this situation ever arises in real
life we'll figure out how exactly that should work.)  Be very careful
when doing this; you're explicitly telling monotone to let you shoot
yourself in the foot, and it will let you.

   <p>Fortunately, this process should be extremely rare; with luck, it will
never happen at all.  But this way we're prepared.

<p><a name="Mark-Merge"></a>
<a name="Mark_002dMerge"></a>

<h3 class="section">7.4 Mark-Merge</h3>

<p>Monotone makes use of the Mark-Merge (also known as *-merge) algorithm. 
The emails reproduced below document the algorithm. Further information
can be found at <a href="http://revctrl.org/MarkMerge">revctrl.org</a>.

<h4 class="subheading">Initial mark-merge proposal</h4>

<pre class="verbatim">
From: Nathaniel Smith &lt;njs &lt;at> pobox.com>
Subject: [cdv-devel] more merging stuff (bit long...)
Newsgroups: gmane.comp.version-control.codeville.devel, gmane.comp.version-control.monotone.devel
Date: 2005-08-06 09:08:09 GMT

I set myself a toy problem a few days ago: is there a really, truly,
right way to merge two heads of an arbitrary DAG, when the object
being merged is as simple as possible: a single scalar value?

I assume that I'm given a graph, and each node in the graph has a
value, and no other annotation; I can add annotations, but they have
to be derived from the values and topology.  Oh, and I assume that no
revision has more than 2 parents; probably things can be generalized
to the case of indegree 3 or higher, but it seems like a reasonable
restriction...

So, anyway, here's what I came up with.  Perhaps you all can tell me
if it makes sense.

User model
----------

Since the goal was to be "really, truly, right", I had to figure out
what exactly that meant... basically, what I'm calling a "user model"
-- a formal definition of how the user thinks about merging, to give
an operational definition of "should conflict" and "should clean
merge".  My rules are these:
  1) whenever a user explicitly sets the value, they express a claim
     that their setting is superior to the old setting
  2) whenever a user chooses to commit a new revision, they implicitly
     affirm the validity of the decisions that led to that revision's
     parents
    Corollary of (1) and (2): whenever a user explicitly sets the
     value, they express that they consider their new setting to be
     superior to _all_ old settings
  3) A "conflict" should occur if, and only if, the settings on each
     side of the merge express parallel claims.
This in itself is not an algorithm, or anything close to it; the hope
is that it's a good description of what people actually want out of a
merge algorithm, expressed clearly enough that we can create an
algorithm that fits these desiderata.

Algorithm
---------

I'll use slightly novel notation.  Lower case letters represent values
that scalar the scalar takes.  Upper case letters represent nodes in
the graph.

Now, here's an algorithm, that is supposed to just be a transcription
of the above rules, one step more formal:
  First, we need to know where users actively expressed an intention.
  Intention is defined by (1), above.  We use * to mark where this
  occurred:

    i)      a*     graph roots are always marked

            a
    ii)     |      no mark, value was not set
            a

            a
    iii)    |      b != a, so b node marked
            b*

          a   b
    iv)    \ /
            c*
                   c is totally new, so marked
          a   a
           \ /
            c*

          a   b    we're marking places where users expressed
    v)     \ /     intention; so b should be marked iff this
            b?     was a conflict (!)

          a   a    for now I'm not special-casing the coincidental
    vi)    \ /     clean merge case, so let's consider this to be
            a?     a subclass of (v).

  That's all the cases possible.  So, suppose we go through and
  annotate our graph with *s, using the above rules; we have a graph
  with some *s peppered through it, each * representing one point that
  a user took action.

  Now, a merge algorithm per se: Let's use *(A) to mean the unique
  nearest marked ancestor of node A.  Suppose we want to merge A and
  B.  There are exactly 3 cases:
    - *(A) is an ancestor of B, but not vice versa: B wins.
    - *(B) is an ancestor of A, but not vice versa: A wins.
    - *(A) is _not_ an ancestor of B, and vice versa: conflict,
      escalate to user
  Very intuitive, right?  If B supercedes the intention that led to A,
  then B should win, and vice-versa; if not, the user has expressed
  two conflicting intentions, and that, by definition, is a conflict.

  This lets us clarify what we mean by "was a conflict" in case (v)
  above.  When we have a merge of a and b that gives b, we simple
  calculate *(a); if it is an ancestor of 'b', then we're done, but if
  it isn't, then we mark the merge node.  (Subtle point: this is
  actually not _quite_ the same as detecting whether merging 'a' and
  'b' would have given a conflict; if we somehow managed to get a
  point in the graph that would have clean merged to 'a', but in fact
  was merged to 'b', then this algorithm will still mark the merge
  node.)  For cases where the two parents differ, you have to do this
  using the losing one; for cases where the two parents are the same,
  you should check both, because it could have been a clean merge two
  different ways.  If *(a1) = *(a2), i.e., both sides have the same
  nearest marked ancestor, consider that a clean merge.

  That's all.

Examples
--------

Of course, I haven't shown you this is well-defined or anything, but
to draw out the suspense a little, have some worked examples (like
most places in this document, I draw graphs with two leaves and assume
that those are being merged):

  graph:
       a*
      / \
     a   b*
  result: *(a) is an ancestor of b, but *(b) is not an ancestor of a;
    clean merge with result 'b'.

  graph:
       a*
      / \
     b*  c*
  result: *(b) = b is not an ancestor of c, and *(c) = c is not an
    ancestor of c; conflict.

  graph:
       a*
      / \
     b*  c*  &lt;--- these are both marked, by (iii)
     |\ /|
     | X |
     |/ \|
     b*  c*  &lt;--- which means these were conflicts, and thus marked
  result: the two leaves are both marked, and thus generate a conflict,
    as above.

Right, enough of that.  Math time.

Math
----

Theorem: In a graph marked following the above rules, every node N
  will have a unique least marked ancestor M, and the values of M and N
  will be the same.
Proof: By downwards induction on the graph structure.  The base case
  are graph roots, which by (i) are always marked, so the statement is
  trivially true.  Proceeding by cases, (iii) and (iv) are trivially
  true, since they produce nodes that are themselves marked.  (ii) is
  almost as simple; in a graph 'a' -> 'a', the child obviously
  inherits the parent's unique least marked ancestor, which by
  inductive hypothesis exists.  The interesting case is (v) and (vi):
     a   b
      \ /
       b
  If the child is marked, then again the statement is trivial; so
  suppose it is not.  By definition, this only occurs when *(a) is an
  ancestor of 'b'.  But, by assumption, 'b' has a unique nearest
  ancestor, whose value is 'b'.  Therefore, *(a) is also an ancestor
  of *(b).  If we're in the weird edge case (vi) where a = b, then
  these may be the same ancestor, which is fine.  Otherwise, the fact
  that a != b, and that *(a)'s value = a's value, *(b)'s value = b's
  value, implies that *(a) is a strict ancestor of *(b).  Either way,
  the child has a unique least marked ancestor, and it is the same
  ULMA as its same-valued parent, so the ULMA also has the right
  value.  QED.

Corollary: *(N) is a well-defined function.

Corollary: The three cases mentioned in the merge algorithm are the
  only possible cases.  In particular, it cannot be that *(A) is an
  ancestor of B and *(B) is an ancestor of A simultaneously, unless
  the two values being merged are identical (and why are you running
  your merge algorithm then?).  Or in other words: ambiguous clean
  merge does not exist.
Proof: Suppose *(A) is an ancestor of B, and *(B) is an ancestor of A.
  *(B) is unique, so *(A) must also be an ancestor of *(B).
  Similarly, *(B) must be an ancestor of *(A).  Therefore:
    *(A) = *(B)
  We also have:
    value(*(A)) = value(A)
    value(*(B)) = value(B)
  which implies
    value(A) = value(B).  QED.

Therefore, the above algorithm is well-defined in all possible cases.

We can prove another somewhat interesting fact:
Theorem: If A and B would merge cleanly with A winning, then any
  descendent D of A will also merge cleanly with B, with D winning.
Proof: *(B) is an ancestor of A, and A is an ancestor of D, so *(B) is
  an ancestor of D.

I suspect that this is enough to show that clean merges are order
invariant, but I don't have a proof together ATM.

Not sure what other properties would be interesting to prove; any
suggestions?  It'd be nice to have some sort of proof about "once a
conflict is resolved, you don't have to resolve it again" -- which is
the problem that makes ambiguous clean merge so bad -- but I'm not
sure how to state such a property formally.  Something about it being
possible to fully converge a graph by resolving a finite number of
conflicts or something, perhaps?

Funky cases
-----------

There are two funky cases I know of.

Coincidental clean merge:
    |
    a
   / \
  b*  b*

Two people independently made the same change.  When we're talking
about textual changes, some people argue this should give a conflict
(reasoning that perhaps the same line _should_ be inserted twice).  In
our context that argument doesn't even apply, because these are just
scalars; so obviously this should be a clean merge.  Currently, the
only way this algorithm has to handle this is to treat it as an
"automatically resolved conflict" -- there's a real conflict here, but
the VCS, acting as an agent for the user, may decide to just go ahead
and resolve it, because it knows perfectly well what the user will do.
In this interpretation, everything works fine, all the above stuff
applies; it's somewhat dissatisfying, though, because it's a violation
of the user model -- the user has not necessarily looked at this
merge, but we put the * of user-assertion on the result anyway.  Not a
show-stopper, I guess...

It's quite possible that the above stuff could be generalized to allow
non-unique least marked ancestors, that could only arise in exactly
this case.

I'm not actually sure what the right semantics would be, though.  If
we're merging:
    |
    a
   / \
  b   b
   \ / \
    b   c
Should that be a clean merge?  'b' was set twice, and only one of
these settings was overridden; is that good enough?

Do you still have the same opinion if the graph is:
    |
    a
    |
    b
   / \
  c   b
  |  / \
  b  b  c
  \ /
   b
?  Here the reason for the second setting of 'b' was that a change
away from it was reverted; to make it extra cringe-inducing, I threw
in that change being reverted was another change to 'c'... (this may
just be an example of how any merge algorithm has some particular case
you can construct where it will get something wrong, because it
doesn't _actually_ know how to read the users's minds).

Supporting these cases may irresistably lead back to ambiguous clean,
as well:
     |
     a
    / \
   b*  c*
  / \ / \
 c*  X   b*
  \ / \ /
   c   b

The other funky case is this thing (any clever name suggestions?):
    a
   / \
  b*  c*
   \ / \
    c*  d*
Merging here will give a conflict, with my algorithm; 3-way merge
would resolve it cleanly.  Polling people on #monotone and #revctrl,
the consensus seems to be that they agree with 3-way merge, but giving
a conflict is really not _that_ bad.  (It also seems to cause some
funky effects with darcs-merge; see zooko's comments on #revctrl and
darcs-users.)

This is really a problem with the user model, rather than the
algorithm.  Apparently people do not interpret the act of resolving
the b/c merge to be "setting" the result; They seem to interpret it as
"selecting" the result of 'c'; the 'c' in the result is in some sense
the "same" 'c' as in the parent.  The difference between "setting" and
"selecting" is the universe of possible options; if you see
   a   b
    \ /
     c
then you figure that the person doing the merge was picking from all
possible resolution values; when you see
   a   b
    \ /
     b
you figure that the user was just picking between the two options
given by the parents.  My user model is too simple to take this into
account.  It's not a huge extension to the model to do so; it's quite
possible that an algorithm could be devised that gave a clean merge
here, perhaps by separately tracking each node's nearest marked
ancestor and the original source of its value as two separate things.

Relation to other work
----------------------

This algorithm is very close to the traditional codeville-merge
approach to this problem; the primary algorithmic difference is the
marking of conflict resolutions as being "changes".  The more
important new stuff here, I think, are the user model and the proofs.

Traditionally, merge algorithms are evaluated by coming up with some
set of examples, eyeballing them to make some guess as to what the
"correct" answer was, comparing that to the algorithm's output, and
then arguing with people whose intuitions were different.
Fundamentally, merging is about deterministically guessing the user's
intent in situations where the user has not expressed any intent.
Humans are very good at guessing intent; we have big chunks of squishy
hardware designed to form sophisticated models of others intents, and
it's completely impossible for a VCS to try and duplicate that in
full.  My suggestion here, with my "user model", is to seriously and
explicitly study this part of the problem.  There are complicated
trade-offs between accuracy (correctly modeling intention),
conservatism (avoiding incorrectly modeling intention), and
implementability (describing the user's thought processes exactly
isn't so useful if you can't apply it in practice).  It's hard to make
an informed judgement when we don't have a name for the thing we're
trying to optimize, and hard to evaluate an algorithm when we can't
even say what it's supposed to be doing.

I suspect the benefit of the proofs is obvious to anyone who has spent
much time banging their head against this problem; until a few days
ago I was skeptical there _was_ a way to design a merge algorithm that
didn't run into problems like ambiguous clean merge.

I'm still skeptical, of course, until people read this; merging is
like crypto, you can't trust anything until everyone's tried to break
it... so let's say I'm cautiously optimistic .  If this holds up,
I'm quite happy; between the user model and the proofs, I'm far more
confident that this does something sensible in all cases and has no
lurking edge cases than I have been in any previous algorithm.  The
few problem cases I know of display a pleasing conservatism -- perhaps
more cautious than they need to be, but even if they do cause an
occasional unnecessary conflict, once the conflict is resolved it
should stay resolved.

So... do your worst!

-- Nathaniel

--
So let us espouse a less contested notion of truth and falsehood, even
if it is philosophically debatable (if we listen to philosophers, we
must debate everything, and there would be no end to the discussion).
  -- Serendipities, Umberto Eco
</pre>

<p>Replies and further discussion concerning this email can be found in the  <a href="http://thread.gmane.org/gmane.comp.version-control.monotone.devel/4297">monotone-devel archives</a>.

<h4 class="subheading">Improvements to *-merge</h4>

<pre class="verbatim">
From: Nathaniel Smith &lt;njs@...>
Subject: improvements to *-merge
Newsgroups: gmane.comp.version-control.revctrl, gmane.comp.version-control.monotone.devel
Date: 2005-08-30 09:21:18 GMT

This is a revised version of *-merge:
  http://thread.gmane.org/gmane.comp.version-control.monotone.devel/4297
that properly handles accidental clean merges.  It does not improve
any of the other parts, just the handling of accidental clean merges.
It shows a way to relax the uniqueness of the *() operator, while
still preserving the basic results from the above email.  For clarity,
I'll say 'unique-*-merge' to refer to the algorithm given above, and
'multi-*-merge' to refer to this one.

This work is totally due to Timothy Brownawell &lt;tbrownaw@...>.
All I did was polish up the proofs and write it up.  He has a more
complex version at:
  http://article.gmane.org/gmane.comp.version-control.monotone.devel/4496
that also attempts to avoid the conflict with:
     a
    / \
   b*  c*
    \ / \
     c*  d*
and has some convergence in it, but the analysis for that is not done.

So:

User model
----------

We keep exactly the same user model as unique-*-merge:

  1) whenever a user explicitly sets the value, they express a claim
     that their setting is superior to the old setting
  2) whenever a user chooses to commit a new revision, they implicitly
     affirm the validity of the decisions that led to that revision's
     parents
    Corollary of (1) and (2): whenever a user explicitly sets the
     value, they express that they consider their new setting to be
     superior to _all_ old settings
  3) A "conflict" should occur if, and only if, the settings on each
     side of the merge express parallel claims.

The difference is that unique-*-merge does not _quite_ fulfill this
model, because in real life your algorithm will automatically resolve
coincidental clean merge cases without asking for user input; but
unique-* is not smart enough to take this into account when inferring
user intentions.

Algorithm
---------

We start by marking the graph of previous revisions.  For each node in
the graph, we either mark it (denoted by a *), or do not.  A mark
indicates our inference that a human expressed an intention at this
node.

    i)      a*     graph roots are always marked

            a1
    ii)     |      no mark, value was not set
            a2

            a
    iii)    |      b != a, so 'b' node marked
            b*

          a   b
    iv)    \ /
            c*
                   'c' is totally new, so marked
          a1  a2
           \ /
            c*

          a   b1   we're marking places where users expressed
    v)     \ /     intention; so 'b' should be marked iff this
            b2?    was a conflict

          a1  a2   'a' matches parents, and so is not marked
    vi)    \ /     (alternatively, we can say this is a special
            a3     case of (v), that is never a conflict)

Case (vi) is the only one that differs from unique-* merge.  However,
because of it, we must use a new definition of *():

Definition: By *(A), we mean we set of minimal marked ancestors of A.
"Minimal" here is used in the mathematical sense of a node in a graph
that has no descendents in that graph.

Algorithm: Given two nodes to merge, A and B, we consider four cases:
   a) value(A) = value(B): return the shared value
   b) *(A) > B: return value(B)
   c) *(B) > A: return value(A)
   d) else: conflict; escalate to user
Where "*(A) > B" means "all elements of the set *(A) are non-strict
ancestors of the revision B".  The right way to read this is as "try
(a) first, and then if that fails try (b), (c), (d) simultaneously".

Note that except for the addition of rule (a), this is a strict
generalization of the unique-* algorithm; if *(A) and *(B) are
single-element sets, then this performs _exactly_ the same
computations as the unique-* algorithm.

Now we can say what we mean by "was a conflict" in case (v) above:
given a -> b2, b1 -> b2, we leave b2 unmarked if and only if
*(a) > b1.

Examples
--------

1.
    a1*
   / \
  a2  b*

result: *(a2) = {a1}, a1 > b, so b wins.

2.
    a*
   / \
  b*  c*

result: *(b) = {b}, *(c) = {c}, neither *(b) > c nor *(c) > b, so
 conflict.

3.
    a*
   / \
  b1* b2*
   \ / \
    b3  c1*

result: *(b3) = {b1, b2}; b2 > c1, but b1 is not > c, so c does not
 win.  *(c1) = {c1}, which is not > b3.  conflict.
note: this demonstrates that this algorithm does _not_ do convergence.
Instead, it takes the conservative position that for one node to
silently beat another, the winning node must pre-empt _all_ the
intentions that created the losing node.  While it's easy to come up
with just-so stories where this is the correct thing to do (e.g., b1
and b2 each contain some other changes that independently require 'a'
to become 'b'; c1 will have fixed up b2's changes, but not b1's), this
doesn't actually mean much.  Whether this is good or bad behavior a
somewhat unresolved question, that may ultimately be answered by which
merge algorithms turn out to be more tractable...

4.
    a*
   / \
  b1* b2*
  |\ /|
  | X |
  |/ \|
  b3  c*

result: *(b3) = {b1, b2} > c.  *(c) = {c}, which is not > b3.  c wins
 cleanly.

5.
     a*
    / \
   b1* c1*
  / \ / \
 c2* X   b2*
  \ / \ /
   c3  b3

result: *(c3) = {c1, c2}; c1 > b3 but c2 is not > b3, so b3 does not
 win.  likewise, *(b3) = {b1, b2}; b1 > c3 but b2 is not > c3, so c3
 does not win either.  conflict.

6.
     a*
    / \
   b1* c1*
  / \ / \
 c2* X   b2*
  \ / \ /
   c3  b3
   |\ /|
   | X |
   |/ \|
   c4* b4*

(this was my best effort to trigger an ambiguous clean merge with this
algorithm; it fails pitifully:)
result: *(c4) = {c4}, *(b4) = {b4}, obvious conflict.

Math
----

The interesting thing about this algorithm is that all the unique-*
proofs still go through, in a generalized form.  The key one that
makes *-merge tractable is:

Theorem: In a graph marked by the above rules, given a node N, all
 nodes in *(N) will have the same value as N.
Proof: By induction.  We consider the cases (i)-(vi) above.  (i)
 through (iv) are trivially true.  (v) is interesting.  b2 is marked
 when *(a) not > b1.  b2 being marked makes that case trivial, so
 suppose *(a) > b1.  All elements of *(a) are marked, and are
 ancestors of b1; therefore, by the definition of *() and "minimal",
 they are also all ancestors of things in *(b1).  Thus no element of
 *(a) can be a minimal marked ancestor of b2.
 (vi) is also trivial, because *(a3) = *(a1) union *(a2).  QED.

We also have to do a bit of extra work because of the sets:

Corollary 1: If *(A) > B, and any element R of *(B) is R > A, then
 value(A) = value(B).
Proof: Let such an R be given.  R > A, and R marked, imply that there
 is some element S of *(A) such that R > S.
 On the other hand, *(A) > B implies that S > B.  By similar reasoning
 to the above, this means that there is some element T of *(B) such
 that S > T.  So, recapping, we have:
  nodes:   R  >  S  >  T
   from: *(B)  *(A)  *(B)
 *(B) is a set of minimal nodes, yet we have R > T and R and T both in
 *(B).  This implies that R = T.  R > S > R implies that S = R,
 because we are in a DAG.  Thus
   value(A) = value(S) = value(R) = value(B)
 QED.

Corollary 2: If *(A) > B and *(B) > A, then not only does value(A) =
 value(B), but *(A) = *(B).
Proof: By above, each element of *(B) is equal to some element of
 *(A), and vice-versa.

This is good, because it means our algorithm is well-defined.  The
only time when options (b) and (c) (in the algorithm) can
simultaneously be true, is when the two values being merged are
identical to start with.  I.e., no somewhat anomalous "4th case" of
ambiguous clean merge.

Actually, this deserves some more discussion.  With *() returning a
set, there are some more subtle "partial ambiguous clean" cases to
think about -- should we be worrying about cases where some, but not
all, of the marked ancestors are pre-empted?  This is possible, as in
example 5 above:
     a*
    / \
   b1* c1*
  / \ / \
 c2* X   b2*
  \ / \ /
   c3  b3
A hypothetical (convergence supporting?) algorithm that said A beats B
if _any_ elements of *(A) are > B would give an ambiguous clean merge
on this case.  (Maybe that wouldn't be so bad, so long as we marked
the result, but I'm in no way prepared to do any sort of sufficient
analysis right now...)

The nastiest case of this is where *(A) > B, but some elements of *(B)
are > A -- so we silently make B win, but it's really not _quite_
clear that's a good idea, since A also beat B sometimes -- and we're
ignoring those user's intentions.

This is the nice thing about Corollary 1 (and why I didn't just
collapse it into Corollary 2) -- it assures us that the only time this
_weak_ form of ambiguous clean can happen is when A and B are already
identical.  This _can_ happen, for what it's worth:
       a*
      /|\
     / | \
    /  |  \
   /   |   \
  b1*  b2*  d*
  |\   /\  /
  | \ /  \/
  |  X   b3*
  | / \ /
  |/   b4
  b5
Here *(b5) = {b3, b2}, *(b6) = {b2, b4}.  If we ignore for a moment
that b4 and b5 have the same value, this is a merge that b4 would win
and b5 would lose, even though one of b4's ancestors, i.e. b1, is
pre-empted by b5.  However, it can _only_ happen if we ignore that
they have the same value...

The one other thing we proved about unique-* merge also still applies;
the proof goes through word-for-word:
Theorem: If A and B would merge cleanly with A winning, then any
  descendent D of A will also merge cleanly with B, with D winning.
Proof: *(B) > A, and A > D, so *(B) > D.

Discussion
----------

This algorithm resolves one of the two basic problems I observed for
unique-* merge -- coincidental clean merges are now handled, well,
cleanly, and the user model is fully implemented.  However, we still
do not handle the unnamed case (you guys totally let me down when I
requested names for this case last time):
    a
   / \
  b*  c*
   \ / \
    c*  d*
which still gives a conflict.  We also, of course, continue to not
support more exotic features like convergence or implicit rollback.

Not the most exciting thing in the world.  OTOH, it does strictly
increase the complexity of algorithms that are tractable to formal
analysis.

Comments and feedback appreciated.

-- Nathaniel

--
"The problem...is that sets have a very limited range of
activities -- they can't carry pianos, for example, nor drink
beer."
</pre>

<p>Replies and further discussion concerning this email can be found in the  <a href="http://thread.gmane.org/gmane.comp.version-control.revctrl/93">monotone-devel archives</a>.

<h4 class="subheading">More on "mark-merge"</h4>

<pre class="verbatim">
From: Timothy Brownawell &lt;tbrownaw@...>
Subject: more on "mark-merge"
Newsgroups: gmane.comp.version-control.revctrl, gmane.comp.version-control.monotone.devel

Prerequisite:
http://thread.gmane.org/gmane.comp.version-control.monotone.devel/4297

A user can make 2 types of merge decisions:
(1): One parent is better than the other (represented by *)
(2): Both parents are wrong (represented by ^)

Since there are 2 types of merge decisions, it would be bad to treat all
merge decisions the same. Also, in the case of merge(a, a) = a, it is
possible for there to be multiple least decision ancestors.

=====

Define: ^(A) is the set of ancestors of A that it gets its value from
(found by setting N=A and iterating N = *(N) until there is no change)
        *(A) is the set of least ancestors of A in which the user made a
decision

note that erase_ancestors(^(A)) = ^(A),
and erase_ancestors(*(A)) = *(A)

=====

&amp; is intersection, | is union

*(A) has the same properties as before, except that it is not a single
ancestor, but a set. This set can acquire more than one member only in
the case of
   Aa    Ba
     \  /
      Ca
, where *(A) and *(B) are different; *(C) will be
erase_ancestors(*(A) | *(B))

The ancestory corollary becomes:
any ancestor C of A with value(C) != value(A) will be an ancestor of at
least one member of *(A)

When merging A and B:

# if one side knows of _all_ places that the other side was chosen, it
wins
(1)
set X = erase_ancestors(*(A) | *(B))
    if X &amp; *(B) = {}, A wins
    if X &amp; *(A) = {}, B wins
else, X contains members of both *(A) and *(B)

# if one side knows of _all_ places that the other side originated, it
wins
(2)
set Y = erase_ancestors(*(A) | ^(B))
set Z = erase_ancestors(*(B) | ^(A))
    if Y &amp; ^(B) = {} and Z &amp; ^(A) = {}, conflict
    if Y &amp; ^(B) = {}, A wins
    if Z &amp; ^(A) = {}, B wins

# if one side knows of _any_ places that the other side originated, it
wins
(3)
    if Y &amp; ^(B) != ^(B) and Z &amp; ^(A) != ^(A), conflict
    if Y &amp; ^(B) != ^(B), A wins
    if Z &amp; ^(A) != ^(A), B wins

# else, nobody knows anything
(4) conflict

(3) is convergence, and can be safely left out if unwanted

====

"Funky cases"

Coincidental clean does not exist; a mark is only needed when there is
user intervention.

    |
    a
   / \
  b   b
   \ / \
    b   c
and the example after it will resolve cleanly iff (3) is included.

     |
     a
    / \
   b*  c*
  / \ / \
 c*  X   b*
  \ / \ /
   c   b
will be a conflict.

    a
   / \
  b*  c*
   \ / \
    c*  d*
This ("the other funky case") is handled by (2), and resolves cleanly.

Tim
</pre>

<p>Replies and further discussion concerning this email can be found in the  <a href="http://thread.gmane.org/gmane.comp.version-control.revctrl/92">monotone-devel archives</a>.

<p><a name="Regexps"></a>

<h3 class="section">7.5 Regular Expression Syntax</h3>

<p>Monotone expects user-provided regular expressions in
<samp><span class="file">.mtn-ignore</span></samp> files and as the result of the
<code>get_encloser_pattern</code> Lua hook (for the <samp><span class="option">--show-encloser</span></samp>
option to <samp><span class="command">diff</span></samp>).  User-written Lua hooks may also use the
function <code>regex.search</code> as they see fit.  All these regular
expressions should be written with the same syntax, which is that
expected by the Perl-Compatible Regular Expression library (PCRE).

<!-- This file was hand-translated to Texinfo from the upstream PCRE -->
<!-- documentation file pcresyntax.3, whose copyright notice is: -->
<!-- Author: Philip Hazel, University Computing Service -->
<!-- Cambridge CB2 3QH, England -->
<!-- Last updated: 21 September 2007 -->
<!-- Copyright (c) 1997-2007 University of Cambridge. -->
<!-- Redistribution and use in source and binary forms, with or without -->
<!-- modification, are permitted provided that the following conditions are met: -->
<!-- * Redistributions of source code must retain the above copyright notice, -->
<!-- this list of conditions and the following disclaimer. -->
<!-- * Redistributions in binary form must reproduce the above copyright -->
<!-- notice, this list of conditions and the following disclaimer in the -->
<!-- documentation and/or other materials provided with the distribution. -->
<!-- * Neither the name of the University of Cambridge nor the names of its -->
<!-- contributors may be used to endorse or promote products derived from -->
<!-- this software without specific prior written permission. -->
<!-- THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" -->
<!-- AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE -->
<!-- IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE -->
<!-- ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE -->
<!-- LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR -->
<!-- CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF -->
<!-- SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS -->
<!-- INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN -->
<!-- CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) -->
<!-- ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE -->
<!-- POSSIBILITY OF SUCH DAMAGE. -->
<!-- Apart from markup translation, all mention of callouts has been -->
<!-- removed, and a few confusing references to PCRE itself or to -->
<!-- specific programming environments have been removed or clarified. -->
<p><a name="Regexp-Summary"></a>

<h4 class="subsection">7.5.1 Regexp Syntax Summary</h4>

<p>This is a quick-reference summary of the regular expression syntax
used in Monotone.

<h5 class="subsubheading">Quoting</h5>

     <dl>
<dt><code>\</code><var>x</var><dd>  where <var>x</var> is non-alphanumeric is a literal <var>x</var>
<br><dt><code>\Q...\E</code><dd>  treat enclosed characters as literal
</dl>

<h5 class="subsubheading">Characters</h5>

     <dl>
<dt><code>\a</code><dd>  alarm, that is, the BEL character (hex 07)
<br><dt><code>\c</code><var>x</var><dd>  &ldquo;control-<var>x</var>&rdquo;, where <var>x</var> is any character
<br><dt><code>\e</code><dd>  escape (hex 1B)
<br><dt><code>\f</code><dd>  formfeed (hex 0C)
<br><dt><code>\n</code><dd>  newline (hex 0A)
<br><dt><code>\r</code><dd>  carriage return (hex 0D)
<br><dt><code>\t</code><dd>  tab (hex 09)
<br><dt><code>\</code><var>ddd</var><dd>  character with octal code <var>ddd</var>, or backreference
<br><dt><code>\x</code><var>hh</var><dd>  character with hex code <var>hh</var>
<br><dt><code>\x{</code><var>hhh...</var><code>}</code><dd>  character with hex code <var>hhh...</var>
</dl>

<h5 class="subsubheading">Character Types</h5>

     <dl>
<dt><code>.</code><dd>  any character except newline;
               in dotall mode, any character whatsoever
<br><dt><code>\C</code><dd>  one byte, even in UTF-8 mode (best avoided)
<br><dt><code>\d</code><dd>  a decimal digit
<br><dt><code>\D</code><dd>  a character that is not a decimal digit
<br><dt><code>\h</code><dd>  a horizontal whitespace character
<br><dt><code>\H</code><dd>  a character that is not a horizontal whitespace character
<br><dt><code>\p{</code><var>xx</var><code>}</code><dd>  a character with the <var>xx</var> property
<br><dt><code>\P{</code><var>xx</var><code>}</code><dd>  a character without the <var>xx</var> property
<br><dt><code>\R</code><dd>  a newline sequence
<br><dt><code>\s</code><dd>  a whitespace character
<br><dt><code>\S</code><dd>  a character that is not a whitespace character
<br><dt><code>\v</code><dd>  a vertical whitespace character
<br><dt><code>\V</code><dd>  a character that is not a vertical whitespace character
<br><dt><code>\w</code><dd>  a &ldquo;word&rdquo; character
<br><dt><code>\W</code><dd>  a &ldquo;non-word&rdquo; character
<br><dt><code>\X</code><dd>  an extended Unicode sequence
</dl>

<p class="noindent">&lsquo;<samp><span class="samp">\d</span></samp>&rsquo;, &lsquo;<samp><span class="samp">\D</span></samp>&rsquo;, &lsquo;<samp><span class="samp">\s</span></samp>&rsquo;, &lsquo;<samp><span class="samp">\S</span></samp>&rsquo;, &lsquo;<samp><span class="samp">\w</span></samp>&rsquo;, and &lsquo;<samp><span class="samp">\W</span></samp>&rsquo;
recognize only ASCII characters.

<h5 class="subsubheading">General category property codes for &lsquo;<samp><span class="samp">\p</span></samp>&rsquo; and &lsquo;<samp><span class="samp">\P</span></samp>&rsquo;</h5>

     <dl>
<dt><code>C</code><dd>  Other
<br><dt><code>Cc</code><dd>  Control
<br><dt><code>Cf</code><dd>  Format
<br><dt><code>Cn</code><dd>  Unassigned
<br><dt><code>Co</code><dd>  Private use
<br><dt><code>Cs</code><dd>  Surrogate

     <br><dt><code>L</code><dd>  Letter
<br><dt><code>Ll</code><dd>  Lower case letter
<br><dt><code>Lm</code><dd>  Modifier letter
<br><dt><code>Lo</code><dd>  Other letter
<br><dt><code>Lt</code><dd>  Title case letter
<br><dt><code>Lu</code><dd>  Upper case letter
<br><dt><code>L&amp;</code><dd>  Ll, Lu, or Lt

     <br><dt><code>M</code><dd>  Mark
<br><dt><code>Mc</code><dd>  Spacing mark
<br><dt><code>Me</code><dd>  Enclosing mark
<br><dt><code>Mn</code><dd>  Non-spacing mark

     <br><dt><code>N</code><dd>  Number
<br><dt><code>Nd</code><dd>  Decimal number
<br><dt><code>Nl</code><dd>  Letter number
<br><dt><code>No</code><dd>  Other number

     <br><dt><code>P</code><dd>  Punctuation
<br><dt><code>Pc</code><dd>  Connector punctuation
<br><dt><code>Pd</code><dd>  Dash punctuation
<br><dt><code>Pe</code><dd>  Close punctuation
<br><dt><code>Pf</code><dd>  Final punctuation
<br><dt><code>Pi</code><dd>  Initial punctuation
<br><dt><code>Po</code><dd>  Other punctuation
<br><dt><code>Ps</code><dd>  Open punctuation

     <br><dt><code>S</code><dd>  Symbol
<br><dt><code>Sc</code><dd>  Currency symbol
<br><dt><code>Sk</code><dd>  Modifier symbol
<br><dt><code>Sm</code><dd>  Mathematical symbol
<br><dt><code>So</code><dd>  Other symbol

     <br><dt><code>Z</code><dd>  Separator
<br><dt><code>Zl</code><dd>  Line separator
<br><dt><code>Zp</code><dd>  Paragraph separator
<br><dt><code>Zs</code><dd>  Space separator
</dl>

<h5 class="subsubheading">Script names for &lsquo;<samp><span class="samp">\p</span></samp>&rsquo; and &lsquo;<samp><span class="samp">\P</span></samp>&rsquo;</h5>

<p>Arabic,
Armenian,
Balinese,
Bengali,
Bopomofo,
Braille,
Buginese,
Buhid,
Canadian_Aboriginal,
Cherokee,
Common,
Coptic,
Cuneiform,
Cypriot,
Cyrillic,
Deseret,
Devanagari,
Ethiopic,
Georgian,
Glagolitic,
Gothic,
Greek,
Gujarati,
Gurmukhi,
Han,
Hangul,
Hanunoo,
Hebrew,
Hiragana,
Inherited,
Kannada,
Katakana,
Kharoshthi,
Khmer,
Lao,
Latin,
Limbu,
Linear_B,
Malayalam,
Mongolian,
Myanmar,
New_Tai_Lue,
Nko,
Ogham,
Old_Italic,
Old_Persian,
Oriya,
Osmanya,
Phags_Pa,
Phoenician,
Runic,
Shavian,
Sinhala,
Syloti_Nagri,
Syriac,
Tagalog,
Tagbanwa,
Tai_Le,
Tamil,
Telugu,
Thaana,
Thai,
Tibetan,
Tifinagh,
Ugaritic,
Yi.

<h5 class="subsubheading">Character Classes</h5>

     <dl>
<dt><code>[...]</code><dd>  positive character class
<br><dt><code>[^...]</code><dd>  negative character class
<br><dt><code>[</code><var>x</var><code>-</code><var>y</var><code>]</code><dd>  range (can be used for hex characters)
<br><dt><code>[[:</code><var>xxx</var><code>:]]</code><dd>  positive POSIX named set
<br><dt><code>[[:^</code><var>xxx</var><code>:]]</code><dd>  negative POSIX named set

     <br><dt><code>alnum</code><dd>  alphanumeric
<br><dt><code>alpha</code><dd>  alphabetic
<br><dt><code>ascii</code><dd>  0-127
<br><dt><code>blank</code><dd>  space or tab
<br><dt><code>cntrl</code><dd>  control character
<br><dt><code>digit</code><dd>  decimal digit
<br><dt><code>graph</code><dd>  printing, excluding space
<br><dt><code>lower</code><dd>  lower case letter
<br><dt><code>print</code><dd>  printing, including space
<br><dt><code>punct</code><dd>  printing, excluding alphanumeric
<br><dt><code>space</code><dd>  whitespace
<br><dt><code>upper</code><dd>  upper case letter
<br><dt><code>word</code><dd>  same as &lsquo;<samp><span class="samp">\w</span></samp>&rsquo;
<br><dt><code>xdigit</code><dd>  hexadecimal digit
</dl>

   <p>In PCRE, POSIX character set names recognize only ASCII
characters. You can use &lsquo;<samp><span class="samp">\Q...\E</span></samp>&rsquo; inside a character class.

<h5 class="subsubheading">Quantifiers</h5>

     <dl>
<dt><code>?</code><dd>  0 or 1, greedy
<br><dt><code>?+</code><dd>  0 or 1, possessive
<br><dt><code>??</code><dd>  0 or 1, lazy
<br><dt><code>*</code><dd>  0 or more, greedy
<br><dt><code>*+</code><dd>  0 or more, possessive
<br><dt><code>*?</code><dd>  0 or more, lazy
<br><dt><code>+</code><dd>  1 or more, greedy
<br><dt><code>++</code><dd>  1 or more, possessive
<br><dt><code>+?</code><dd>  1 or more, lazy
<br><dt><code>{</code><var>n</var><code>}</code><dd>  exactly <var>n</var>
<br><dt><code>{</code><var>n</var><code>,</code><var>m</var><code>}</code><dd>  at least <var>n</var>, no more than <var>m</var>, greedy
<br><dt><code>{</code><var>n</var><code>,</code><var>m</var><code>}+</code><dd>  at least <var>n</var>, no more than <var>m</var>, possessive
<br><dt><code>{</code><var>n</var><code>,</code><var>m</var><code>}?</code><dd>  at least <var>n</var>, no more than <var>m</var>, lazy
<br><dt><code>{</code><var>n</var><code>,}</code><dd>  <var>n</var> or more, greedy
<br><dt><code>{</code><var>n</var><code>,}+</code><dd>  <var>n</var> or more, possessive
<br><dt><code>{</code><var>n</var><code>,}?</code><dd>  <var>n</var> or more, lazy
</dl>

<h5 class="subsubheading">Anchors and Simple Assertions</h5>

     <dl>
<dt><code>\b</code><dd>  word boundary
<br><dt><code>\B</code><dd>  not a word boundary
<br><dt><code>^</code><dd>  start of subject
               also after internal newline in multiline mode
<br><dt><code>\A</code><dd>  start of subject
<br><dt><code>$</code><dd>  end of subject
               also before newline at end of subject
               also before internal newline in multiline mode
<br><dt><code>\Z</code><dd>  end of subject
               also before newline at end of subject
<br><dt><code>\z</code><dd>  end of subject
<br><dt><code>\G</code><dd>  first matching position in subject
</dl>

<h5 class="subsubheading">Match Point Reset</h5>

     <dl>
<dt><code>\K</code><dd>  reset start of match
</dl>

<h5 class="subsubheading">Alternation</h5>

     <dl>
<dt><var>expr</var><code>|</code><var>expr</var><code>|</code><var>expr</var><code>...</code><dd></dl>

<h5 class="subsubheading">Capturing</h5>

     <dl>
<dt><code>(...)</code><dd>  capturing group
<br><dt><code>(?&lt;</code><var>name</var><code>&gt;...)</code><dd>  named capturing group (like Perl)
<br><dt><code>(?'</code><var>name</var><code>'...)</code><dd>  named capturing group (like Perl)
<br><dt><code>(?P&lt;</code><var>name</var><code>&gt;...)</code><dd>  named capturing group (like Python)
<br><dt><code>(?:...)</code><dd>  non-capturing group
<br><dt><code>(?|...)</code><dd>  non-capturing group; reset group numbers for
  capturing groups in each alternative
</dl>

<h5 class="subsubheading">Atomic Groups</h5>

     <dl>
<dt><code>(?&gt;...)</code><dd>  atomic, non-capturing group
</dl>

<h5 class="subsubheading">Comment</h5>

     <dl>
<dt><code>(?#....)</code><dd>  comment (not nestable)
</dl>

<h5 class="subsubheading">Option Setting</h5>

     <dl>
<dt><code>(?i)</code><dd>  caseless
<br><dt><code>(?J)</code><dd>  allow duplicate names
<br><dt><code>(?m)</code><dd>  multiline
<br><dt><code>(?s)</code><dd>  single line (dotall)
<br><dt><code>(?U)</code><dd>  default ungreedy (lazy)
<br><dt><code>(?x)</code><dd>  extended (ignore white space)
<br><dt><code>(?-...)</code><dd>  unset option(s)
</dl>

<h5 class="subsubheading">Lookahead and Lookbehind Assertions</h5>

     <dl>
<dt><code>(?=...)</code><dd>  positive look ahead
<br><dt><code>(?!...)</code><dd>  negative look ahead
<br><dt><code>(?&lt;=...)</code><dd>  positive look behind
<br><dt><code>(?&lt;!...)</code><dd>  negative look behind
</dl>

   <p>Each top-level branch of a look behind must be of a fixed length.

<h5 class="subsubheading">Backreferences</h5>

     <dl>
<dt><code>\</code><var>n</var><dd>  reference by number (can be ambiguous)
<br><dt><code>\g</code><var>n</var><dd>  reference by number
<br><dt><code>\g{</code><var>n</var><code>}</code><dd>  reference by number
<br><dt><code>\g{-</code><var>n</var><code>}</code><dd>  relative reference by number
<br><dt><code>\k&lt;</code><var>name</var><code>&gt;</code><dd>  reference by name (like Perl)
<br><dt><code>\k'</code><var>name</var><code>'</code><dd>  reference by name (like Perl)
<br><dt><code>\g{</code><var>name</var><code>}</code><dd>  reference by name (like Perl)
<br><dt><code>\k{</code><var>name</var><code>}</code><dd>  reference by name (like .NET)
<br><dt><code>(?P=</code><var>name</var><code>)</code><dd>  reference by name (like Python)
</dl>

<h5 class="subsubheading">Subroutine References (possibly recursive)</h5>

     <dl>
<dt><code>(?R)</code><dd>  recurse whole pattern
<br><dt><code>(?</code><var>n</var><code>)</code><dd>  call subpattern by absolute number
<br><dt><code>(?+</code><var>n</var><code>)</code><dd>  call subpattern by relative number
<br><dt><code>(?-</code><var>n</var><code>)</code><dd>  call subpattern by relative number
<br><dt><code>(?&amp;</code><var>name</var><code>)</code><dd>  call subpattern by name (like Perl)
<br><dt><code>(?P&gt;</code><var>name</var><code>)</code><dd>  call subpattern by name (like Python)
</dl>

<h5 class="subsubheading">Conditional Patterns</h5>

     <dl>
<dt><code>(?(</code><var>condition</var><code>)</code><var>yes-pattern</var><code>)</code><br><dt><code>(?(</code><var>condition</var><code>)</code><var>yes-pattern</var><code>|</code><var>no-pattern</var><code>)</code>
<br><dt><code>(?(</code><var>n</var><code>)...</code><dd>  absolute reference condition
<br><dt><code>(?(+</code><var>n</var><code>)...</code><dd>  relative reference condition
<br><dt><code>(?(-</code><var>n</var><code>)...</code><dd>  relative reference condition
<br><dt><code>(?(&lt;</code><var>name</var><code>&gt;)...</code><dd>  named reference condition (like Perl)
<br><dt><code>(?('</code><var>name</var><code>')...</code><dd>  named reference condition (like Perl)
<br><dt><code>(?(</code><var>name</var><code>)...</code><dd>  named reference condition (PCRE only)
<br><dt><code>(?(R)...</code><dd>  overall recursion condition
<br><dt><code>(?(R</code><var>n</var><code>)...</code><dd>  specific group recursion condition
<br><dt><code>(?(R&amp;</code><var>name</var><code>)...</code><dd>  specific recursion condition
<br><dt><code>(?(DEFINE)...</code><dd>  define subpattern for reference
<br><dt><code>(?(assert)...</code><dd>  assertion condition
</dl>

<h5 class="subsubheading">Backtracking Control</h5>

<p>The following act immediately they are reached:

     <dl>
<dt><code>(*ACCEPT)</code><dd>  force successful match
<br><dt><code>(*FAIL)</code><dd>  force backtrack; synonym &lsquo;<samp><span class="samp">(*F)</span></samp>&rsquo;
</dl>

   <p>The following act only when a subsequent match failure causes a backtrack to
reach them. They all force a match failure, but they differ in what happens
afterwards. Those that advance the start-of-match point do so only if the
pattern is not anchored.

     <dl>
<dt><code>(*COMMIT)</code><dd>  overall failure, no advance of starting point
<br><dt><code>(*PRUNE)</code><dd>  advance to next starting character
<br><dt><code>(*SKIP)</code><dd>  advance start to current matching position
<br><dt><code>(*THEN)</code><dd>  local failure, backtrack to next alternation
</dl>

<h5 class="subsubheading">Newline Conventions</h5>

<p>These are recognized only at the very start of the pattern or after a
&lsquo;<samp><span class="samp">(*BSR_...)</span></samp>&rsquo; option.

     <dl>
<dt><code>(*CR)</code><br><dt><code>(*LF)</code><br><dt><code>(*CRLF)</code><br><dt><code>(*ANYCRLF)</code><br><dt><code>(*ANY)</code><dd></dl>

<h5 class="subsubheading">What &lsquo;<samp><span class="samp">\R</span></samp>&rsquo; Matches</h5>

<p>These are recognized only at the very start of the pattern or after a
&lsquo;<samp><span class="samp">(*...)</span></samp>&rsquo; option that sets the newline convention.

     <dl>
<dt><code>(*BSR_ANYCRLF)</code><br><dt><code>(*BSR_UNICODE)</code><dd></dl>

<!-- This file was hand-translated to Texinfo from the upstream PCRE -->
<!-- documentation file pcrepattern.3, whose copyright notice is: -->
<!-- Author: Philip Hazel, University Computing Service -->
<!-- Cambridge CB2 3QH, England -->
<!-- Last updated: 17 September 2007 -->
<!-- Copyright (c) 1997-2007 University of Cambridge. -->
<!-- Redistribution and use in source and binary forms, with or without -->
<!-- modification, are permitted provided that the following conditions are met: -->
<!-- * Redistributions of source code must retain the above copyright notice, -->
<!-- this list of conditions and the following disclaimer. -->
<!-- * Redistributions in binary form must reproduce the above copyright -->
<!-- notice, this list of conditions and the following disclaimer in the -->
<!-- documentation and/or other materials provided with the distribution. -->
<!-- * Neither the name of the University of Cambridge nor the names of its -->
<!-- contributors may be used to endorse or promote products derived from -->
<!-- this software without specific prior written permission. -->
<!-- THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" -->
<!-- AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE -->
<!-- IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE -->
<!-- ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE -->
<!-- LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR -->
<!-- CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF -->
<!-- SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS -->
<!-- INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN -->
<!-- CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) -->
<!-- ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE -->
<!-- POSSIBILITY OF SUCH DAMAGE. -->
<!-- Apart from markup translation, all mention of callouts has been -->
<!-- removed, and confusing references to PCRE itself, its configuration -->
<!-- options and library API, or to specific programming environments -->
<!-- have been removed or clarified. -->
<p><a name="Regexp-Details"></a>

<h4 class="subsection">7.5.2 Regexp Details</h4>

<p>The syntax and semantics of PCRE regular expressions, as used in
Monotone, are described in detail below.  Regular expressions in
general are covered in a number of books, some of which have copious
examples. Jeffrey Friedl's &ldquo;Mastering Regular Expressions,&rdquo;
published by O'Reilly, covers regular expressions in great detail. 
This description is intended as reference material.

<h5 class="subsubheading">Characters and Metacharacters</h5>

<p>A regular expression is a pattern that is matched against a subject
string from left to right. Most characters stand for themselves in a
pattern, and match the corresponding characters in the subject. As a
trivial example, the pattern

<pre class="verbatim">
         The quick brown fox
</pre>

<p class="noindent">matches a portion of a subject string that is identical to
itself. When caseless matching is specified, letters are matched
independently of case.

   <p>The power of regular expressions comes from the ability to include
alternatives and repetitions in the pattern. These are encoded in the
pattern by the use of <dfn>metacharacters</dfn>, which do not stand for
themselves but instead are interpreted in some special way.

   <p>There are two different sets of metacharacters: those that are
recognized anywhere in the pattern except within square brackets, and
those that are recognized within square brackets. Outside square
brackets, the metacharacters are as follows:

     <dl>
<dt><code>\</code><dd>general escape character with several uses
<dt><code>^</code><dd>assert start of string (or line, in multiline mode)
<dt><code>$</code><dd>assert end of string (or line, in multiline mode)
<dt><code>.</code><dd>match any character except newline (by default)
<dt><code>[</code><dd>start character class definition
<dt><code>|</code><dd>start of alternative branch
<dt><code>(</code><dd>start subpattern
<dt><code>)</code><dd>end subpattern
<dt><code>?</code><dd>extends the meaning of &lsquo;<samp><span class="samp">(</span></samp>&rsquo;
         also 0 or 1 quantifier
         also quantifier minimizer
<dt><code>*</code><dd>0 or more quantifier
<dt><code>+</code><dd>1 or more quantifier
         also &ldquo;possessive quantifier&rdquo;
<dt><code>{</code><dd>start min/max quantifier
</dl>

<p class="noindent">Part of a pattern that is in square brackets is called a "character
class". In a character class the only metacharacters are:

     <dl>
<dt><code>\</code><dd>general escape character
<dt><code>^</code><dd>negate the class, but only if the first character
<dt><code>-</code><dd>indicates character range
<dt><code>[</code><dd>POSIX character class (only if followed by POSIX
           syntax)
<dt><code>]</code><dd>terminates the character class
</dl>

<p class="noindent">The following sections describe the use of each of the metacharacters.

<h5 class="subsubheading">Backslash</h5>

<p>The backslash character has several uses. Firstly, if it is followed
by a non-alphanumeric character, it takes away any special meaning
that character may have. This use of backslash as an escape character
applies both inside and outside character classes.

   <p>For example, if you want to match a &lsquo;<samp><span class="samp">*</span></samp>&rsquo; character, you write
&lsquo;<samp><span class="samp">\*</span></samp>&rsquo; in the pattern.  This escaping action applies whether or not
the following character would otherwise be interpreted as a
metacharacter, so it is always safe to precede a non-alphanumeric with
backslash to specify that it stands for itself. In particular, if you
want to match a backslash, you write &lsquo;<samp><span class="samp">\\</span></samp>&rsquo;.

   <p>If a pattern is compiled with the &lsquo;<samp><span class="samp">(?x)</span></samp>&rsquo; option, whitespace in
the pattern (other than in a character class) and characters between a
&lsquo;<samp><span class="samp">#</span></samp>&rsquo; outside a character class and the next newline are
ignored. An escaping backslash can be used to include a whitespace or
&lsquo;<samp><span class="samp">#</span></samp>&rsquo; character as part of the pattern.

   <p>If you want to remove the special meaning from a sequence of
characters, you can do so by putting them between &lsquo;<samp><span class="samp">\Q</span></samp>&rsquo; and
&lsquo;<samp><span class="samp">\E</span></samp>&rsquo;.  The &lsquo;<samp><span class="samp">\Q...\E</span></samp>&rsquo; sequence is recognized both inside and
outside character classes.

<h5 class="subsubheading">Non-printing Characters</h5>

<p>A second use of backslash provides a way of encoding non-printing characters
in patterns in a visible manner. There is no restriction on the appearance of
non-printing characters, apart from the binary zero that terminates a pattern,
but when a pattern is being prepared by text editing, it is usually easier to
use one of the following escape sequences than the binary character it
represents:

     <dl>
<dt><code>\a</code><dd>alarm, that is, the BEL character (hex 07)
<dt><code>\c</code><var>x</var><dd>"control-<var>x</var>", where <var>x</var> is any character
<dt><code>\e</code><dd>escape (hex 1B)
<dt><code>\f</code><dd>formfeed (hex 0C)
<dt><code>\n</code><dd>linefeed (hex 0A)
<dt><code>\r</code><dd>carriage return (hex 0D)
<dt><code>\t</code><dd>tab (hex 09)
<dt><code>\</code><var>ddd</var><dd>character with octal code <var>ddd</var>, or backreference
<dt><code>\x</code><var>hh</var><dd>character with hex code <var>hh</var>
<dt><code>\x{</code><var>hhh...</var><code>}</code><dd>character with hex code <var>hhh...</var>
</dl>

   <p>The precise effect of &lsquo;<samp><span class="samp">\c</span><var>x</var></samp>&rsquo; is as follows: if <var>x</var> is a lower
case letter, it is converted to upper case. Then bit 6 of the
character (hex 40) is inverted.  Thus &lsquo;<samp><span class="samp">\cz</span></samp>&rsquo; becomes hex 1A (the
&lt;SUB&gt; control character, in ASCII), but &lsquo;<samp><span class="samp">\c{</span></samp>&rsquo; becomes hex 3B
(&lsquo;<samp><span class="samp">;</span></samp>&rsquo;), and &lsquo;<samp><span class="samp">\c;</span></samp>&rsquo; becomes hex 7B (&lsquo;<samp><span class="samp">{</span></samp>&rsquo;).

<!-- the math in the next paragraph is not done with @math because -->
<!-- ``2**31'' is a much nicer thing to have in the Info file than ``2^{31}''. -->
   <p>After &lsquo;<samp><span class="samp">\x</span></samp>&rsquo;, from zero to two hexadecimal digits are read (letters
can be in upper or lower case). Any number of hexadecimal digits may
appear between &lsquo;<samp><span class="samp">\x{</span></samp>&rsquo; and &lsquo;<samp><span class="samp">}</span></samp>&rsquo;, but the value of the
character code must be less than 256 in non-UTF-8 mode, and less than
2<sup>31</sup>in UTF-8 mode. That is, the maximum value in hexadecimal is
7FFFFFFF. Note that this is bigger than the largest Unicode code
point, which is 10FFFF.

   <p>If characters other than hexadecimal digits appear between &lsquo;<samp><span class="samp">\x{</span></samp>&rsquo;
and &lsquo;<samp><span class="samp">}</span></samp>&rsquo;, or if there is no terminating &lsquo;<samp><span class="samp">}</span></samp>&rsquo;, this form of
escape is not recognized. Instead, the initial &lsquo;<samp><span class="samp">\x</span></samp>&rsquo; will be
interpreted as a basic hexadecimal escape, with no following digits,
giving a character whose value is zero.

   <p>Characters whose value is less than 256 can be defined by either of
the two syntaxes for &lsquo;<samp><span class="samp">\x</span></samp>&rsquo;. There is no difference in the way they
are handled. For example, &lsquo;<samp><span class="samp">\xdc</span></samp>&rsquo; is exactly the same as
&lsquo;<samp><span class="samp">\x{dc}</span></samp>&rsquo;.

   <p>After &lsquo;<samp><span class="samp">\0</span></samp>&rsquo; up to two further octal digits are read. If there are
fewer than two digits, just those that are present are used. Thus the
sequence &lsquo;<samp><span class="samp">\0\x\07</span></samp>&rsquo; specifies two binary zeros followed by a
&lt;BEL&gt; character (octal 007). Make sure you supply two digits after
the initial zero if the pattern character that follows is itself an
octal digit.

   <p>The handling of a backslash followed by a digit other than 0 is
complicated.  Outside a character class, PCRE reads it and any
following digits as a decimal number. If the number is less than 10,
or if there have been at least that many previous capturing left
parentheses in the expression, the entire sequence is taken as a
<dfn>back reference</dfn>. A description of how this works is given later,
following the discussion of parenthesized subpatterns.

   <p>Inside a character class, or if the decimal number is greater than 9
and there have not been that many capturing subpatterns, PCRE re-reads
up to three octal digits following the backslash, and uses them to
generate a data character. Any subsequent digits stand for
themselves. In non-UTF-8 mode, the value of a character specified in
octal must be less than &lsquo;<samp><span class="samp">\400</span></samp>&rsquo;. In UTF-8 mode, values up to
&lsquo;<samp><span class="samp">\777</span></samp>&rsquo; are permitted. For example:

     <dl>
<dt><code>\040</code><dd>is another way of writing a space
<dt><code>\40</code><dd>is the same, provided there are fewer than 40
            previous capturing subpatterns
<dt><code>\7</code><dd>is always a back reference
<dt><code>\11</code><dd>might be a back reference, or another way of
            writing a tab
<dt><code>\011</code><dd>is always a tab
<dt><code>\0113</code><dd>is a tab followed by the character &lsquo;<samp><span class="samp">3</span></samp>&rsquo;
<dt><code>\113</code><dd>might be a back reference, otherwise the
            character with octal code 113
<dt><code>\377</code><dd>might be a back reference, otherwise
            the byte consisting entirely of 1 bits
<dt><code>\81</code><dd>is either a back reference, or a binary zero
            followed by the two characters &lsquo;<samp><span class="samp">8</span></samp>&rsquo; and &lsquo;<samp><span class="samp">1</span></samp>&rsquo;
</dl>

   <p>Note that octal values of 100 or greater must not be introduced by a
leading zero, because no more than three octal digits are ever read.

   <p>All the sequences that define a single character value can be used
both inside and outside character classes. In addition, inside a
character class, the sequence &lsquo;<samp><span class="samp">\b</span></samp>&rsquo; is interpreted as the &lt;BS&gt;
character (hex 08), and the sequences &lsquo;<samp><span class="samp">\R</span></samp>&rsquo; and &lsquo;<samp><span class="samp">\X</span></samp>&rsquo; are
interpreted as the characters &lsquo;<samp><span class="samp">R</span></samp>&rsquo; and &lsquo;<samp><span class="samp">X</span></samp>&rsquo;,
respectively. Outside a character class, these sequences have
different meanings (see below).

<h5 class="subsubheading">Absolute and Relative Back References</h5>

<p>The sequence &lsquo;<samp><span class="samp">\g</span></samp>&rsquo; followed by an unsigned or a negative number,
optionally enclosed in braces, is an absolute or relative back
reference. A named back reference can be coded as
&lsquo;<samp><span class="samp">\g{name}</span></samp>&rsquo;. Back references are discussed later, following the
discussion of parenthesized subpatterns.

<h5 class="subsubheading">Generic character types</h5>

<p>Another use of backslash is for specifying generic character types. The
following are always recognized:

     <dl>
<dt><code>\d</code><dd>any decimal digit
<dt><code>\D</code><dd>any character that is not a decimal digit
<dt><code>\h</code><dd>any horizontal whitespace character
<dt><code>\H</code><dd>any character that is not a horizontal whitespace character
<dt><code>\s</code><dd>any whitespace character
<dt><code>\S</code><dd>any character that is not a whitespace character
<dt><code>\v</code><dd>any vertical whitespace character
<dt><code>\V</code><dd>any character that is not a vertical whitespace character
<dt><code>\w</code><dd>any &ldquo;word&rdquo; character
<dt><code>\W</code><dd>any &ldquo;non-word&rdquo; character
</dl>

   <p>Each pair of escape sequences partitions the complete set of
characters into two disjoint sets. Any given character matches one,
and only one, of each pair.

   <p>These character type sequences can appear both inside and outside
character classes. They each match one character of the appropriate
type. If the current matching point is at the end of the subject
string, all of them fail, since there is no character to match.

   <p>For compatibility with Perl, &lsquo;<samp><span class="samp">\s</span></samp>&rsquo; does not match the &lt;VT&gt;
character (code 11).  This makes it different from the the POSIX
&ldquo;space&rdquo; class. The &lsquo;<samp><span class="samp">\s</span></samp>&rsquo; characters are &lt;TAB&gt; (9), &lt;LF&gt;
(10), &lt;FF&gt; (12), &lt;CR&gt; (13), and &lt;SPACE&gt; (32).

   <p>In UTF-8 mode, characters with values greater than 128 never match
&lsquo;<samp><span class="samp">\d</span></samp>&rsquo;, &lsquo;<samp><span class="samp">\s</span></samp>&rsquo;, or &lsquo;<samp><span class="samp">\w</span></samp>&rsquo;, and always match &lsquo;<samp><span class="samp">\D</span></samp>&rsquo;,
&lsquo;<samp><span class="samp">\S</span></samp>&rsquo;, and &lsquo;<samp><span class="samp">\W</span></samp>&rsquo;.  These sequences retain their original
meanings from before UTF-8 support was available, mainly for
efficiency reasons.

   <p>The sequences &lsquo;<samp><span class="samp">\h</span></samp>&rsquo;, &lsquo;<samp><span class="samp">\H</span></samp>&rsquo;, &lsquo;<samp><span class="samp">\v</span></samp>&rsquo;, and &lsquo;<samp><span class="samp">\V</span></samp>&rsquo; are Perl
5.10 features. In contrast to the other sequences, these do match
certain high-valued codepoints in UTF-8 mode.  The horizontal space
characters are:

     <dl>
<dt><code>U+0009</code><dd>Horizontal tab
<dt><code>U+0020</code><dd>Space
<dt><code>U+00A0</code><dd>Non-break space
<dt><code>U+1680</code><dd>Ogham space mark
<dt><code>U+180E</code><dd>Mongolian vowel separator
<br><dt><code>U+2000</code><dd>En quad
<dt><code>U+2001</code><dd>Em quad
<dt><code>U+2002</code><dd>En space
<dt><code>U+2003</code><dd>Em space
<dt><code>U+2004</code><dd>Three-per-em space
<dt><code>U+2005</code><dd>Four-per-em space
<dt><code>U+2006</code><dd>Six-per-em space
<br><dt><code>U+2007</code><dd>Figure space
<dt><code>U+2008</code><dd>Punctuation space
<dt><code>U+2009</code><dd>Thin space
<dt><code>U+200A</code><dd>Hair space
<dt><code>U+202F</code><dd>Narrow no-break space
<dt><code>U+205F</code><dd>Medium mathematical space
<dt><code>U+3000</code><dd>Ideographic space
</dl>

<p class="noindent">The vertical space characters are:

     <dl>
<dt><code>U+000A</code><dd>Linefeed
<dt><code>U+000B</code><dd>Vertical tab
<dt><code>U+000C</code><dd>Formfeed
<dt><code>U+000D</code><dd>Carriage return
<dt><code>U+0085</code><dd>Next line
<dt><code>U+2028</code><dd>Line separator
<dt><code>U+2029</code><dd>Paragraph separator
</dl>

<p class="noindent">A &ldquo;word&rdquo; character is an underscore or any character less than 256
that is a letter or digit. The definition of letters and digits is
that used for the &ldquo;C&rdquo; locale.

<h5 class="subsubheading">Newline Conventions</h5>

<p>PCRE supports five different conventions for indicating line breaks in
strings: a single CR (carriage return) character, a single LF
(linefeed) character, the two-character sequence CRLF, any of the
three preceding, or any Unicode newline sequence.  The default is to
match any Unicode newline sequence.  It is possible to override the
default newline convention by starting a pattern string with one of
the following five sequences:

     <dl>
<dt><code>(*CR)</code><dd>  carriage return
<dt><code>(*LF)</code><dd>  linefeed
<dt><code>(*CRLF)</code><dd>  carriage return, followed by linefeed
<dt><code>(*ANYCRLF)</code><dd>  any of the three above
<dt><code>(*ANY)</code><dd>  all Unicode newline sequences
</dl>

   <p>For example, the pattern

<pre class="verbatim">
         (*CR)a.b
</pre>

<p class="noindent">changes the convention to CR. That pattern matches &lsquo;<samp><span class="samp">a\nb</span></samp>&rsquo; because
LF is no longer a newline. Note that these special settings, which are
not Perl-compatible, are recognized only at the very start of a
pattern, and that they must be in upper case. If more than one of them
is present, the last one is used.

   <p>The newline convention does not affect what the &lsquo;<samp><span class="samp">\R</span></samp>&rsquo; escape
sequence matches. By default, this is any Unicode newline sequence,
for Perl compatibility. However, this can be changed; see the
description of &lsquo;<samp><span class="samp">\R</span></samp>&rsquo; below.  A change of &lsquo;<samp><span class="samp">\R</span></samp>&rsquo; setting can be
combined with a change of newline convention.

<h5 class="subsubheading">Newline Sequences</h5>

<p>Outside a character class, by default, the escape sequence &lsquo;<samp><span class="samp">\R</span></samp>&rsquo; matches
any Unicode newline sequence. This is a Perl 5.10 feature. In
non-UTF-8 mode &lsquo;<samp><span class="samp">\R</span></samp>&rsquo; is equivalent to the following:

<pre class="verbatim">
         (?>\r\n|\n|\x0b|\f|\r|\x85)
</pre>

   <p>This is an example of an "atomic group", details of which are given
below.  This particular group matches either the two-character
sequence &lt;CR&gt; followed by &lt;LF&gt;, or one of the single
characters &lt;LF&gt; (linefeed, <code>U+000A</code>), &lt;VT&gt; (vertical tab,
<code>U+000B</code>), &lt;FF&gt; (formfeed, <code>U+000C</code>), &lt;CR&gt; (carriage
return, <code>U+000D</code>), or &lt;NEL&gt; (next line, <code>U+0085</code>). The
two-character sequence is treated as a single unit that cannot be
split.  In UTF-8 mode, two additional characters whose codepoints are
greater than 255 are added: &lt;LS&gt; (line separator, <code>U+2028</code>)
and &lt;PS&gt; (paragraph separator, <code>U+2029</code>).

   <p>It is possible to change the meaning of &lsquo;<samp><span class="samp">\R</span></samp>&rsquo; by starting a
pattern string with one of the following sequences:

     <dl>
<dt><code>(*BSR_ANYCRLF)</code><dd>&lt;CR&gt;, &lt;LF&gt;, or &lt;CR&gt;&lt;LF&gt; only
<dt><code>(*BSR_UNICODE)</code><dd>any Unicode newline sequence (the default)
</dl>

   <p>Note that these special settings, which are not Perl-compatible, are
recognized only at the very start of a pattern, and that they must be
in upper case. If more than one of them is present, the last one is
used. They can be combined with a change of newline convention, for
example, a pattern can start with:

<pre class="verbatim">
         (*ANY)(*BSR_ANYCRLF)
</pre>

<p class="noindent">Inside a character class, &lsquo;<samp><span class="samp">\R</span></samp>&rsquo; matches the letter &lsquo;<samp><span class="samp">R</span></samp>&rsquo;.

<h5 class="subsubheading">Unicode Character Properties</h5>

<p>Three additional escape sequences match characters with specific
Unicode properties.  When not in UTF-8 mode, these sequences are of
course limited to testing characters whose codepoints are less than
256, but they do work in this mode.  The extra escape sequences are:

     <dl>
<dt><code>\p{</code><var>xx</var><code>}</code><dd>a character with the <var>xx</var> property
<dt><code>\P{</code><var>xx</var><code>}</code><dd>a character without the <var>xx</var> property
<dt><code>\X</code><dd>an extended Unicode sequence
</dl>

   <p>The property names represented by <var>xx</var> above are limited to the
Unicode script names, the general category properties, and &lsquo;<samp><span class="samp">Any</span></samp>&rsquo;,
which matches any character (including newline). Other properties such
as &lsquo;<samp><span class="samp">InMusicalSymbols</span></samp>&rsquo; are not currently supported by PCRE. Note
that &lsquo;<samp><span class="samp">\P{Any}</span></samp>&rsquo; does not match any characters, so always causes
a match failure.

   <p>Sets of Unicode characters are defined as belonging to certain
scripts. A character from one of these sets can be matched using a
script name. For example:

<pre class="verbatim">
         \p{Greek}
         \P{Han}
</pre>

<p class="noindent">Those that are not part of an identified script are lumped together as
&ldquo;Common.&rdquo; The current list of scripts is:

   <p>Arabic,
Armenian,
Balinese,
Bengali,
Bopomofo,
Braille,
Buginese,
Buhid,
Canadian_Aboriginal,
Cherokee,
Common,
Coptic,
Cuneiform,
Cypriot,
Cyrillic,
Deseret,
Devanagari,
Ethiopic,
Georgian,
Glagolitic,
Gothic,
Greek,
Gujarati,
Gurmukhi,
Han,
Hangul,
Hanunoo,
Hebrew,
Hiragana,
Inherited,
Kannada,
Katakana,
Kharoshthi,
Khmer,
Lao,
Latin,
Limbu,
Linear_B,
Malayalam,
Mongolian,
Myanmar,
New_Tai_Lue,
Nko,
Ogham,
Old_Italic,
Old_Persian,
Oriya,
Osmanya,
Phags_Pa,
Phoenician,
Runic,
Shavian,
Sinhala,
Syloti_Nagri,
Syriac,
Tagalog,
Tagbanwa,
Tai_Le,
Tamil,
Telugu,
Thaana,
Thai,
Tibetan,
Tifinagh,
Ugaritic,
Yi.

   <p>Each character has exactly one general category property, specified by a
two-letter abbreviation. For compatibility with Perl, negation can be specified
by including a circumflex between the opening brace and the property name. For
example, &lsquo;<samp><span class="samp">\p{^Lu}</span></samp>&rsquo; is the same as &lsquo;<samp><span class="samp">\P{Lu}</span></samp>&rsquo;.

   <p>If only one letter is specified with &lsquo;<samp><span class="samp">\p</span></samp>&rsquo; or &lsquo;<samp><span class="samp">\P</span></samp>&rsquo;, it
includes all the general category properties that start with that
letter. In this case, in the absence of negation, the curly brackets
in the escape sequence are optional; these two examples have the same
effect:

<pre class="verbatim">
         \p{L}
         \pL
</pre>

<p class="noindent">The following general category property codes are supported:

     <dl>
<dt><code>C</code><dd>Other
<dt><code>Cc</code><dd>Control
<dt><code>Cf</code><dd>Format
<dt><code>Cn</code><dd>Unassigned
<dt><code>Co</code><dd>Private use
<dt><code>Cs</code><dd>Surrogate

     <br><dt><code>L</code><dd>Letter
<dt><code>Ll</code><dd>Lower case letter
<dt><code>Lm</code><dd>Modifier letter
<dt><code>Lo</code><dd>Other letter
<dt><code>Lt</code><dd>Title case letter
<dt><code>Lu</code><dd>Upper case letter

     <br><dt><code>M</code><dd>Mark
<dt><code>Mc</code><dd>Spacing mark
<dt><code>Me</code><dd>Enclosing mark
<dt><code>Mn</code><dd>Non-spacing mark

     <br><dt><code>N</code><dd>Number
<dt><code>Nd</code><dd>Decimal number
<dt><code>Nl</code><dd>Letter number
<dt><code>No</code><dd>Other number

     <br><dt><code>P</code><dd>Punctuation
<dt><code>Pc</code><dd>Connector punctuation
<dt><code>Pd</code><dd>Dash punctuation
<dt><code>Pe</code><dd>Close punctuation
<dt><code>Pf</code><dd>Final punctuation
<dt><code>Pi</code><dd>Initial punctuation
<dt><code>Po</code><dd>Other punctuation
<dt><code>Ps</code><dd>Open punctuation

     <br><dt><code>S</code><dd>Symbol
<dt><code>Sc</code><dd>Currency symbol
<dt><code>Sk</code><dd>Modifier symbol
<dt><code>Sm</code><dd>Mathematical symbol
<dt><code>So</code><dd>Other symbol

     <br><dt><code>Z</code><dd>Separator
<dt><code>Zl</code><dd>Line separator
<dt><code>Zp</code><dd>Paragraph separator
<dt><code>Zs</code><dd>Space separator
</dl>

   <p>The special property &lsquo;<samp><span class="samp">L&amp;</span></samp>&rsquo; is also supported: it matches a
character that has the &lsquo;<samp><span class="samp">Lu</span></samp>&rsquo;, &lsquo;<samp><span class="samp">Ll</span></samp>&rsquo;, or &lsquo;<samp><span class="samp">Lt</span></samp>&rsquo; property, in
other words, a letter that is not classified as a modifier or
&ldquo;other.&rdquo;

   <p>The &lsquo;<samp><span class="samp">Cs</span></samp>&rsquo; (Surrogate) property applies only to characters in the
range <code>U+D800</code> to <code>U+DFFF</code>. Such characters are not valid in
UTF-8 strings (see RFC 3629) and so cannot be tested by PCRE.

   <p>The long synonyms for these properties that Perl supports (such as
&lsquo;<samp><span class="samp">\p{Letter}</span></samp>&rsquo;) are not supported by PCRE, nor is it permitted to
prefix any of these properties with &lsquo;<samp><span class="samp">Is</span></samp>&rsquo;.

   <p>No character that is in the Unicode table has the &lsquo;<samp><span class="samp">Cn</span></samp>&rsquo;
(unassigned) property.  Instead, this property is assumed for any code
point that is not in the Unicode table.

   <p>Specifying caseless matching does not affect these escape sequences. For
example, &lsquo;<samp><span class="samp">\p{Lu}</span></samp>&rsquo; always matches only upper case letters.

   <p>The &lsquo;<samp><span class="samp">\X</span></samp>&rsquo; escape matches any number of Unicode characters that
form an extended Unicode sequence. &lsquo;<samp><span class="samp">\X</span></samp>&rsquo; is equivalent to

<pre class="verbatim">
         (?>\PM\pM*)
</pre>

   <p>That is, it matches a character without the &ldquo;mark&rdquo; property,
followed by zero or more characters with the &ldquo;mark&rdquo; property, and
treats the sequence as an atomic group (see below).  Characters with
the &ldquo;mark&rdquo; property are typically accents that affect the preceding
character. None of them have codepoints less than 256, so in non-UTF-8
mode &lsquo;<samp><span class="samp">\X</span></samp>&rsquo; matches any one character.

   <p>Matching characters by Unicode property is not fast, because PCRE has
to search a structure that contains data for over fifteen thousand
characters. That is why the traditional escape sequences such as
&lsquo;<samp><span class="samp">\d</span></samp>&rsquo; and &lsquo;<samp><span class="samp">\w</span></samp>&rsquo; do not use Unicode properties in PCRE.

<h5 class="subsubheading">Resetting the Match Start</h5>

<p>The escape sequence &lsquo;<samp><span class="samp">\K</span></samp>&rsquo;, which is a Perl 5.10 feature, causes
any previously matched characters not to be included in the final
matched sequence. For example, the pattern:

<pre class="verbatim">
         foo\Kbar
</pre>

<p class="noindent">matches &lsquo;<samp><span class="samp">foobar</span></samp>&rsquo;, but reports that it has matched
&lsquo;<samp><span class="samp">bar</span></samp>&rsquo;. This feature is similar to a lookbehind assertion
(described below).  However, in this case, the part of the subject
before the real match does not have to be of fixed length, as
lookbehind assertions do. The use of &lsquo;<samp><span class="samp">\K</span></samp>&rsquo; does not interfere with the
setting of captured substrings.  For example, when the pattern

<pre class="verbatim">
         (foo)\Kbar
</pre>

<p class="noindent">matches &lsquo;<samp><span class="samp">foobar</span></samp>&rsquo;, the first substring is still set to &lsquo;<samp><span class="samp">foo</span></samp>&rsquo;.

<h5 class="subsubheading">Simple assertions</h5>

<p>The final use of backslash is for certain simple assertions. An
assertion specifies a condition that has to be met at a particular
point in a match, without consuming any characters from the subject
string. The use of subpatterns for more complicated assertions is
described below.  The backslashed assertions are:

     <dl>
<dt><code>\b</code><dd>matches at a word boundary
<dt><code>\B</code><dd>matches when not at a word boundary
<dt><code>\A</code><dd>matches at the start of the subject
<dt><code>\Z</code><dd>matches at the end of the subject
          also matches before a newline at the end of the subject
<dt><code>\z</code><dd>matches only at the end of the subject
<dt><code>\G</code><dd>matches at the first matching position in the subject
</dl>

<p class="noindent">These assertions may not appear in character classes (but note that
&lsquo;<samp><span class="samp">\b</span></samp>&rsquo; has a different meaning, namely the backspace character,
inside a character class).

   <p>A word boundary is a position in the subject string where the current
character and the previous character do not both match &lsquo;<samp><span class="samp">\w</span></samp>&rsquo; or
&lsquo;<samp><span class="samp">\W</span></samp>&rsquo; (i.e. one matches &lsquo;<samp><span class="samp">\w</span></samp>&rsquo; and the other matches
&lsquo;<samp><span class="samp">\W</span></samp>&rsquo;), or the start or end of the string if the first or last
character matches &lsquo;<samp><span class="samp">\w</span></samp>&rsquo;, respectively.

   <p>The &lsquo;<samp><span class="samp">\A</span></samp>&rsquo;, &lsquo;<samp><span class="samp">\Z</span></samp>&rsquo;, and &lsquo;<samp><span class="samp">\z</span></samp>&rsquo; assertions differ from the
traditional circumflex and dollar (described in the next section) in
that they only ever match at the very start and end of the subject
string, whatever options are set. Thus, they are independent of
multiline mode. The difference between &lsquo;<samp><span class="samp">\Z</span></samp>&rsquo; and &lsquo;<samp><span class="samp">\z</span></samp>&rsquo; is that
&lsquo;<samp><span class="samp">\Z</span></samp>&rsquo; matches before a newline at the end of the string as well as
at the very end, whereas &lsquo;<samp><span class="samp">\z</span></samp>&rsquo; matches only at the end.

   <p>The &lsquo;<samp><span class="samp">\G</span></samp>&rsquo; assertion is true only when the current matching
position is at the start point of the match.  As used in Monotone,
&lsquo;<samp><span class="samp">\G</span></samp>&rsquo; is always equal to &lsquo;<samp><span class="samp">\A</span></samp>&rsquo;.

<h5 class="subsubheading">Circumflex and Dollar</h5>

<p>Outside a character class, in the default matching mode, the
circumflex character, &lsquo;<samp><span class="samp">^</span></samp>&rsquo;, is an assertion that is true only if
the current matching point is at the start of the subject string. 
Inside a character class, circumflex has an entirely different meaning
(see below).

   <p>Circumflex need not be the first character of the pattern if a number
of alternatives are involved, but it should be the first thing in each
alternative in which it appears if the pattern is ever to match that
branch. If all possible alternatives start with a circumflex, that is,
if the pattern is constrained to match only at the start of the
subject, it is said to be an &ldquo;anchored&rdquo; pattern. (There are also
other constructs that can cause a pattern to be anchored.)

   <p>A dollar character, &lsquo;<samp><span class="samp">$</span></samp>&rsquo;, is an assertion that is true only if the
current matching point is at the end of the subject string, or
immediately before a newline at the end of the string (by
default). Dollar need not be the last character of the pattern if a
number of alternatives are involved, but it should be the last item in
any branch in which it appears. Dollar has no special meaning in a
character class.

   <p>The meanings of the circumflex and dollar characters are changed if
the &lsquo;<samp><span class="samp">(?m)</span></samp>&rsquo; option is set. When this is the case, a circumflex
matches immediately after internal newlines as well as at the start of
the subject string. It does not match after a newline that ends the
string. A dollar matches before any newlines in the string, as well as
at the very end, when &lsquo;<samp><span class="samp">(?m)</span></samp>&rsquo; is set. When newline is specified as
the two-character sequence &lt;CR&gt;&lt;LF&gt;, isolated &lt;CR&gt; and
&lt;LF&gt; characters do not indicate newlines.

   <p>For example, the pattern &lsquo;<samp><span class="samp">^abc$</span></samp>&rsquo; matches the subject string
&lsquo;<samp><span class="samp">def\nabc</span></samp>&rsquo; (where &lsquo;<samp><span class="samp">\n</span></samp>&rsquo; represents a newline) in multiline
mode, but not otherwise. Consequently, patterns that are anchored in
single line mode because all branches start with ^ are not anchored in
multiline mode.

   <p>Note that the sequences &lsquo;<samp><span class="samp">\A</span></samp>&rsquo;, &lsquo;<samp><span class="samp">\Z</span></samp>&rsquo;, and &lsquo;<samp><span class="samp">\z</span></samp>&rsquo; can be
used to match the start and end of the subject in both modes, and if
all branches of a pattern start with &lsquo;<samp><span class="samp">\A</span></samp>&rsquo; it is always anchored.

<h5 class="subsubheading">Full Stop (Period, Dot)</h5>

<p>Outside a character class, a dot in the pattern matches any one
character in the subject string except (by default) a character that
signifies the end of a line. In UTF-8 mode, the matched character may
be more than one byte long.

   <p>When a line ending is defined as a single character, dot never matches
that character; when the two-character sequence &lt;CR&gt;&lt;LF&gt; is
used, dot does not match &lt;CR&gt; if it is immediately followed by
&lt;LF&gt;, but otherwise it matches all characters (including isolated
&lt;CR&gt;s and &lt;LF&gt;s). When any Unicode line endings are being
recognized, dot does not match &lt;CR&gt; or &lt;LF&gt; or any of the
other line ending characters.

   <p>The behaviour of dot with regard to newlines can be changed. If the
&lsquo;<samp><span class="samp">(?s)</span></samp>&rsquo; option is set, a dot matches any one character, without
exception. If the two-character sequence &lt;CR&gt;&lt;LF&gt; is present
in the subject string, it takes two dots to match it.

   <p>The handling of dot is entirely independent of the handling of circumflex and
dollar, the only relationship being that they both involve newlines. Dot has no
special meaning in a character class.

<h5 class="subsubheading">Matching a Single Byte</h5>

<p>Outside a character class, the escape sequence &lsquo;<samp><span class="samp">\C</span></samp>&rsquo; matches any
one byte, both in and out of UTF-8 mode. Unlike a dot, it always
matches any line-ending characters. The feature is provided in Perl in
order to match individual bytes in UTF-8 mode. Because it breaks up
UTF-8 characters into individual bytes, what remains in the string may
be a malformed UTF-8 string. For this reason, the &lsquo;<samp><span class="samp">\C</span></samp>&rsquo; escape
sequence is best avoided.

   <p>PCRE does not allow &lsquo;<samp><span class="samp">\C</span></samp>&rsquo; to appear in lookbehind assertions
(described below), because in UTF-8 mode this would make it impossible
to calculate the length of the lookbehind.

<h5 class="subsubheading">Square Brackets and Character Classes</h5>

<p>An opening square bracket introduces a character class, terminated by
a closing square bracket. A closing square bracket on its own is not
special. If a closing square bracket is required as a member of the
class, it should be the first data character in the class (after an
initial circumflex, if present) or escaped with a backslash.

   <p>A character class matches a single character in the subject. In UTF-8
mode, the character may occupy more than one byte. A matched character
must be in the set of characters defined by the class, unless the
first character in the class definition is a circumflex, in which case
the subject character must not be in the set defined by the class. If
a circumflex is actually required as a member of the class, ensure it
is not the first character, or escape it with a backslash.

   <p>For example, the character class &lsquo;<samp><span class="samp">[aeiou]</span></samp>&rsquo; matches any lower case
vowel, while &lsquo;<samp><span class="samp">[^aeiou]</span></samp>&rsquo; matches any character that is not a lower
case vowel. Note that a circumflex is just a convenient notation for
specifying the characters that are in the class by enumerating those
that are not. A class that starts with a circumflex is not an
assertion: it still consumes a character from the subject string, and
therefore it fails if the current pointer is at the end of the string.

   <p>In UTF-8 mode, characters with values greater than 255 can be included
in a class as a literal string of bytes, or by using the &lsquo;<samp><span class="samp">\x{</span></samp>&rsquo;
escaping mechanism.

   <p>When caseless matching is set, any letters in a class represent both
their upper case and lower case versions, so for example, a caseless
&lsquo;<samp><span class="samp">[aeiou]</span></samp>&rsquo; matches &lsquo;<samp><span class="samp">A</span></samp>&rsquo; as well as &lsquo;<samp><span class="samp">a</span></samp>&rsquo;, and a caseless [^aeiou]
does not match &lsquo;<samp><span class="samp">A</span></samp>&rsquo;, whereas a caseful version would. In UTF-8 mode,
PCRE always understands the concept of case for characters whose
values are less than 128, so caseless matching is always possible. For
characters with higher values, the concept of case is supported if
PCRE is compiled with Unicode property support, but not otherwise.  If
you want to use caseless matching for characters 128 and above, you
must ensure that PCRE is compiled with Unicode property support as
well as with UTF-8 support.

   <p>Characters that might indicate line breaks are never treated in any
special way when matching character classes, whatever line-ending
sequence is in use, and whatever setting of the &lsquo;<samp><span class="samp">(?s)</span></samp>&rsquo; and
&lsquo;<samp><span class="samp">(?m)</span></samp>&rsquo; options is used. A class such as &lsquo;<samp><span class="samp">[^a]</span></samp>&rsquo; always
matches one of these characters.

   <p>The minus (hyphen) character can be used to specify a range of
characters in a character class. For example, &lsquo;<samp><span class="samp">[d-m]</span></samp>&rsquo; matches any
letter between &lsquo;<samp><span class="samp">d</span></samp>&rsquo; and &lsquo;<samp><span class="samp">m</span></samp>&rsquo;, inclusive. If a minus character
is required in a class, it must be escaped with a backslash or appear
in a position where it cannot be interpreted as indicating a range,
typically as the first or last character in the class.

   <p>It is not possible to have the literal character &lsquo;<samp><span class="samp">]</span></samp>&rsquo; as the end
character of a range. A pattern such as &lsquo;<samp><span class="samp">[W-]46]</span></samp>&rsquo; is interpreted
as a class of two characters (&lsquo;<samp><span class="samp">W</span></samp>&rsquo; and &lsquo;<samp><span class="samp">-</span></samp>&rsquo;) followed by a
literal string &lsquo;<samp><span class="samp">46]</span></samp>&rsquo;, so it would match &lsquo;<samp><span class="samp">W46]</span></samp>&rsquo; or
&lsquo;<samp><span class="samp">-46]</span></samp>&rsquo;. However, if the &lsquo;<samp><span class="samp">]</span></samp>&rsquo; is escaped with a backslash it
is interpreted as the end of range, so &lsquo;<samp><span class="samp">[W-\]46]</span></samp>&rsquo; is interpreted
as a class containing a range followed by two other characters. The
octal or hexadecimal representation of &lsquo;<samp><span class="samp">]</span></samp>&rsquo; can also be used to
end a range.

   <p>Ranges operate in the collating sequence of character values. They can
also be used for characters specified numerically, for example
&lsquo;<samp><span class="samp">[\000-\037]</span></samp>&rsquo;. In UTF-8 mode, ranges can include characters whose
values are greater than 255, for example &lsquo;<samp><span class="samp">[\x{100}-\x{2ff}]</span></samp>&rsquo;.

   <p>If a range that includes letters is used when caseless matching is
set, it matches the letters in either case. For example, &lsquo;<samp><span class="samp">[W-c]</span></samp>&rsquo;
is equivalent to &lsquo;<samp><span class="samp">[][\\^_`wxyzabc]</span></samp>&rsquo;, matched caselessly.

   <p>The character types &lsquo;<samp><span class="samp">\d</span></samp>&rsquo;, &lsquo;<samp><span class="samp">\D</span></samp>&rsquo;, &lsquo;<samp><span class="samp">\p</span></samp>&rsquo;, &lsquo;<samp><span class="samp">\P</span></samp>&rsquo;,
&lsquo;<samp><span class="samp">\s</span></samp>&rsquo;, &lsquo;<samp><span class="samp">\S</span></samp>&rsquo;, &lsquo;<samp><span class="samp">\w</span></samp>&rsquo;, and &lsquo;<samp><span class="samp">\W</span></samp>&rsquo; may also appear in a
character class, and add the characters that they match to the
class. For example, &lsquo;<samp><span class="samp">[\dABCDEF]</span></samp>&rsquo; matches any hexadecimal digit. A
circumflex can conveniently be used with the upper case character
types to specify a more restricted set of characters than the matching
lower case type. For example, the class &lsquo;<samp><span class="samp">[^\W_]</span></samp>&rsquo; matches any
letter or digit, but not underscore.

   <p>The only metacharacters that are recognized in character classes are
backslash, hyphen (only where it can be interpreted as specifying a
range), circumflex (only at the start), opening square bracket (only
when it can be interpreted as introducing a POSIX class name&mdash;see the
next section), and the terminating closing square bracket. However,
escaping other non-alphanumeric characters does no harm.

<h5 class="subsubheading">POSIX Character Classes</h5>

<p>Perl supports the POSIX notation for character classes. This uses
names enclosed by &lsquo;<samp><span class="samp">[:</span></samp>&rsquo; and &lsquo;<samp><span class="samp">:]</span></samp>&rsquo; within the enclosing square
brackets. PCRE also supports this notation. For example,

<pre class="verbatim">
         [01[:alpha:]%]
</pre>

<p class="noindent">matches &lsquo;<samp><span class="samp">0</span></samp>&rsquo;, &lsquo;<samp><span class="samp">1</span></samp>&rsquo;, any alphabetic character, or &lsquo;<samp><span class="samp">%</span></samp>&rsquo;. The
supported class names are

     <dl>
<dt><code>alnum</code><dd>letters and digits
<dt><code>alpha</code><dd>letters
<dt><code>ascii</code><dd>character codes 0 &ndash; 127
<dt><code>blank</code><dd>space or tab only
<dt><code>cntrl</code><dd>control characters
<dt><code>digit</code><dd>decimal digits (same as &lsquo;<samp><span class="samp">\d</span></samp>&rsquo;)
<dt><code>graph</code><dd>printing characters, excluding space
<dt><code>lower</code><dd>lower case letters
<dt><code>print</code><dd>printing characters, including space
<dt><code>punct</code><dd>printing characters, excluding letters and digits
<dt><code>space</code><dd>white space (not quite the same as &lsquo;<samp><span class="samp">\s</span></samp>&rsquo;)
<dt><code>upper</code><dd>upper case letters
<dt><code>word</code><dd>&ldquo;word&rdquo; characters (same as &lsquo;<samp><span class="samp">\w</span></samp>&rsquo;)
<dt><code>xdigit</code><dd>hexadecimal digits
</dl>

   <p>The &ldquo;space&rdquo; characters are &lt;HT&gt; (9), &lt;LF&gt; (10), &lt;VT&gt;
(11), &lt;FF&gt; (12), &lt;CR&gt; (13), and space (32). Notice that this
list includes the &lt;VT&gt; character (code 11). This makes "space"
different to &lsquo;<samp><span class="samp">\s</span></samp>&rsquo;, which does not include &lt;VT&gt; (for Perl
compatibility).

   <p>The name &ldquo;word&rdquo; is a Perl extension, and &ldquo;blank&rdquo; is a GNU
extension from Perl 5.8. Another Perl extension is negation, which is
indicated by a &lsquo;<samp><span class="samp">^</span></samp>&rsquo; character after the colon. For example,

<pre class="verbatim">
         [12[:^digit:]]
</pre>

<p class="noindent">matches &lsquo;<samp><span class="samp">1</span></samp>&rsquo;, &lsquo;<samp><span class="samp">2</span></samp>&rsquo;, or any non-digit. PCRE (and Perl) also
recognize the POSIX syntax &lsquo;<samp><span class="samp">[.</span><var>ch</var><span class="samp">.]</span></samp>&rsquo; and &lsquo;<samp><span class="samp">[=</span><var>ch</var><span class="samp">=]</span></samp>&rsquo;
where <var>ch</var> is a &ldquo;collating element,&rdquo; but these are not
supported, and an error is given if they are encountered.

   <p>In UTF-8 mode, characters with values greater than 128 do not match
any of the POSIX character classes.

<h5 class="subsubheading">Vertical Bar</h5>

<p>Vertical bar characters are used to separate alternative patterns. For
example, the pattern

<pre class="verbatim">
         gilbert|sullivan
</pre>

<p class="noindent">matches either &lsquo;<samp><span class="samp">gilbert</span></samp>&rsquo; or &lsquo;<samp><span class="samp">sullivan</span></samp>&rsquo;. Any number of
alternatives may appear, and an empty alternative is permitted
(matching the empty string). The matching process tries each
alternative in turn, from left to right, and the first one that
succeeds is used. If the alternatives are within a subpattern (defined
below), "succeeds" means matching the rest of the main pattern as well
as the alternative in the subpattern.

<h5 class="subsubheading">Internal Option Setting</h5>

<p>The behavior of the matching engine can be adjusted from within the
pattern by a sequence of option letters enclosed between &lsquo;<samp><span class="samp">(?</span></samp>&rsquo; and
&lsquo;<samp><span class="samp">)</span></samp>&rsquo;.  The option letters are

     <dl>
<dt><code>i</code><dd>Caseless: characters in one case match the corresponding
     characters in other cases as well. 
<dt><code>m</code><dd>Multiline: &lsquo;<samp><span class="samp">^</span></samp>&rsquo; and &lsquo;<samp><span class="samp">$</span></samp>&rsquo; match at newlines
     as well as at beginning and end of string. 
<dt><code>s</code><dd>Dotall: dot matches any character, including newline characters. 
<dt><code>x</code><dd>Extended syntax: unescaped white space is ignored and embedded
     comments are possible. 
<dt><code>J</code><dd>Dupnames: names for capturing subpattern need not be unique. 
<dt><code>U</code><dd>Ungreedy: quantifiers match as few times as possible by default. 
<dt><code>X</code><dd>Extra: for forward compatibility, give an error if any escape sequence
with no defined meaning appears. 
</dl>

   <p>For example, &lsquo;<samp><span class="samp">(?im)</span></samp>&rsquo; sets caseless, multiline matching. It is
also possible to unset these options by preceding the letters with a
hyphen, and a combined setting and unsetting such as &lsquo;<samp><span class="samp">(?im-sx)</span></samp>&rsquo;
is also permitted.  (This would set the caseless and multiline options
while unsetting the dotall and extended-syntax options.)  If a letter
appears both before and after the hyphen, the option is unset.  The
lowercase option letters are Perl-compatible; the uppercase ones are
PCRE only.

   <p>When an option change occurs at top level (that is, not inside
subpattern parentheses), the change applies to the remainder of the
pattern that follows.  An option change within a subpattern (see below
for a description of subpatterns) affects only that part of the
current pattern that follows it, so

<pre class="verbatim">
         (a(?i)b)c
</pre>

<p class="noindent">matches &lsquo;<samp><span class="samp">abc</span></samp>&rsquo; and &lsquo;<samp><span class="samp">aBc</span></samp>&rsquo; and no other strings.  By this
means, options can be made to have different settings in different
parts of the pattern. Any changes made in one alternative do carry on
into subsequent branches within the same subpattern. For example,

<pre class="verbatim">
         (a(?i)b|c)
</pre>

<p class="noindent">matches &lsquo;<samp><span class="samp">ab</span></samp>&rsquo;, &lsquo;<samp><span class="samp">aB</span></samp>&rsquo;, &lsquo;<samp><span class="samp">c</span></samp>&rsquo;, and &lsquo;<samp><span class="samp">C</span></samp>&rsquo;, even though when
matching &lsquo;<samp><span class="samp">C</span></samp>&rsquo; the first branch is abandoned before the option
setting. This is because the effects of option settings happen when
the pattern is parsed. There would be some very weird behaviour
otherwise.

   <p><em>Note:</em> Unlike these options, the similar, PCRE-specific option
sequences that start with &lsquo;<samp><span class="samp">(*</span></samp>&rsquo; may appear only at the very
beginning of the pattern.  Details of these sequences are given in the
section entitled &ldquo;Newline sequences,&rdquo; above.

<h5 class="subsubheading">Subpatterns</h5>

<p>Subpatterns are delimited by parentheses (round brackets), which can
be nested.  Turning part of a pattern into a subpattern does two
things:

     <ol type=1 start=1>
<li>It localizes a set of alternatives. For example, the pattern

     <pre class="verbatim">     
              cat(aract|erpillar|)
</pre>

     <p class="noindent">matches one of the words &lsquo;<samp><span class="samp">cat</span></samp>&rsquo;, &lsquo;<samp><span class="samp">cataract</span></samp>&rsquo;, or
&lsquo;<samp><span class="samp">caterpillar</span></samp>&rsquo;. Without the parentheses, it would match
&lsquo;<samp><span class="samp">cataract</span></samp>&rsquo;, &lsquo;<samp><span class="samp">erpillar</span></samp>&rsquo; or an empty string.

     <li>It sets up the subpattern as a capturing subpattern.  As used in
Monotone this only means that during matching, the portion of the
subject string that matched the subpattern is available for back
references.  Captured subpatterns are, for instance, not available to
callers of <code>regex.search</code>.  Opening parentheses are counted from
left to right (starting from 1) to obtain numbers for the capturing
subpatterns.

     <p>For example, if the string &lsquo;<samp><span class="samp">the red king</span></samp>&rsquo; is matched against the pattern

     <pre class="verbatim">     
              the ((red|white) (king|queen))
</pre>

     <p>the captured substrings are &lsquo;<samp><span class="samp">red king</span></samp>&rsquo;, &lsquo;<samp><span class="samp">red</span></samp>&rsquo;, and
&lsquo;<samp><span class="samp">king</span></samp>&rsquo;, and are numbered 1, 2, and 3, respectively.
        </ol>

   <p>The fact that plain parentheses fulfil two functions is not always
helpful.  There are often times when a grouping subpattern is required
without a capturing requirement. If an opening parenthesis is followed
by a question mark and a colon, the subpattern does not do any
capturing, and is not counted when computing the number of any
subsequent capturing subpatterns. For example, if the string &lsquo;<samp><span class="samp">the
white queen</span></samp>&rsquo; is matched against the pattern

<pre class="verbatim">
         the ((?:red|white) (king|queen))
</pre>

<p class="noindent">the captured substrings are &lsquo;<samp><span class="samp">white queen</span></samp>&rsquo; and &lsquo;<samp><span class="samp">queen</span></samp>&rsquo;, and
are numbered 1 and 2. The maximum number of capturing subpatterns is
65535.

   <p>As a convenient shorthand, if any option settings are required at the
start of a non-capturing subpattern, the option letters may appear
between the &lsquo;<samp><span class="samp">?</span></samp>&rsquo; and the &lsquo;<samp><span class="samp">:</span></samp>&rsquo;. Thus the two patterns

<pre class="verbatim">
         (?i:saturday|sunday)
         (?:(?i)saturday|sunday)
</pre>

<p class="noindent">match exactly the same set of strings. Because alternative branches
are tried from left to right, and options are not reset until the end
of the subpattern is reached, an option setting in one branch does
affect subsequent branches, so the above patterns match &lsquo;<samp><span class="samp">SUNDAY</span></samp>&rsquo;
as well as &lsquo;<samp><span class="samp">Saturday</span></samp>&rsquo;.

<h5 class="subsubheading">Duplicate Subpattern Numbers</h5>

<p>Perl 5.10 introduced a feature whereby each alternative in a
subpattern uses the same numbers for its capturing parentheses. Such a
subpattern starts with &lsquo;<samp><span class="samp">(?|</span></samp>&rsquo; and is itself a non-capturing
subpattern. For example, consider this pattern:

<pre class="verbatim">
         (?|(Sat)ur|(Sun))day
</pre>

<p class="noindent">Because the two alternatives are inside a &lsquo;<samp><span class="samp">(?|</span></samp>&rsquo; group, both sets
of capturing parentheses are numbered one. Thus, when the pattern
matches, you can look at captured substring number one, whichever
alternative matched. This construct is useful when you want to capture
part, but not all, of one of a number of alternatives. Inside a
&lsquo;<samp><span class="samp">(?|</span></samp>&rsquo; group, parentheses are numbered as usual, but the number is
reset at the start of each branch. The numbers of any capturing
buffers that follow the subpattern start after the highest number used
in any branch. The following example is taken from the Perl
documentation.  The numbers underneath show in which buffer the
captured content will be stored.

<pre class="verbatim">
  # before  ---------------branch-reset----------- after
  / ( a )  (?| x ( y ) z | (p (q) r) | (t) u (v) ) ( z ) /x
  # 1            2         2  3        2     3     4
</pre>

<p class="noindent">A backreference or a recursive call to a numbered subpattern always
refers to the first one in the pattern with the given number.

   <p>An alternative approach to using this &ldquo;branch reset&rdquo; feature is to
use duplicate named subpatterns, as described in the next section.

<h5 class="subsubheading">Named Subpatterns</h5>

<p>Identifying capturing parentheses by number is simple, but it can be
very hard to keep track of the numbers in complicated regular
expressions. Furthermore, if an expression is modified, the numbers
may change. To help with this difficulty, PCRE supports the naming of
subpatterns. This feature was not added to Perl until release
5.10. Python had the feature earlier, and PCRE introduced it at
release 4.0, using the Python syntax. PCRE now supports both the Perl
and the Python syntax.

   <p>In PCRE, a subpattern can be named in one of three ways:
&lsquo;<samp><span class="samp">(?&lt;</span><var>name</var><span class="samp">&gt;...)</span></samp>&rsquo; or &lsquo;<samp><span class="samp">(?'</span><var>name</var><span class="samp">'...)</span></samp>&rsquo; as in Perl, or
&lsquo;<samp><span class="samp">(?P&lt;</span><var>name</var><span class="samp">&gt;...)</span></samp>&rsquo; as in Python. References to capturing
parentheses from other parts of the pattern, such as backreferences,
recursion, and conditions, can be made by name as well as by number.

   <p>Names consist of up to 32 alphanumeric characters and
underscores. Named capturing parentheses are still allocated numbers
as well as names, exactly as if the names were not present.

   <p>By default, a name must be unique within a pattern, but it is possible
to relax this constraint by setting the &lsquo;<samp><span class="samp">(?J)</span></samp>&rsquo; option. This can
be useful for patterns where only one instance of the named
parentheses can match. Suppose you want to match the name of a
weekday, either as a 3-letter abbreviation or as the full name, and in
both cases you want to extract the abbreviation. This pattern
(ignoring the line breaks) does the job:

<pre class="verbatim">
         (?Jx)
         (?&lt;DN>Mon|Fri|Sun)(?:day)?|
         (?&lt;DN>Tue)(?:sday)?|
         (?&lt;DN>Wed)(?:nesday)?|
         (?&lt;DN>Thu)(?:rsday)?|
         (?&lt;DN>Sat)(?:urday)?
</pre>

<p class="noindent">There are five capturing substrings, but only one is ever set after a
match.  (An alternative way of solving this problem is to use a
&ldquo;branch reset&rdquo; subpattern, as described in the previous section.)

<h5 class="subsubheading">Repetition</h5>

<p>Repetition is specified by <dfn>quantifiers</dfn>, which can follow any of
the following items:

     <ul>
<li>  a literal data character
<li>  the dot metacharacter
<li>  the &lsquo;<samp><span class="samp">\C</span></samp>&rsquo; escape sequence
<li>  the &lsquo;<samp><span class="samp">\X</span></samp>&rsquo; escape sequence (in UTF-8 mode with Unicode properties)
<li>  the &lsquo;<samp><span class="samp">\R</span></samp>&rsquo; escape sequence
<li>  an escape such as &lsquo;<samp><span class="samp">\d</span></samp>&rsquo; that matches a single character
<li>  a character class
<li>  a back reference (see next section)
<li>  a parenthesized subpattern (unless it is an assertion)
</ul>

   <p>The general repetition quantifier specifies a minimum and maximum
number of permitted matches, by giving the two numbers in curly
brackets (braces), separated by a comma. The numbers must be less than
65536, and the first must be less than or equal to the second. For
example:

<pre class="verbatim">
         z{2,4}
</pre>

<p class="noindent">matches &lsquo;<samp><span class="samp">zz</span></samp>&rsquo;, &lsquo;<samp><span class="samp">zzz</span></samp>&rsquo;, or &lsquo;<samp><span class="samp">zzzz</span></samp>&rsquo;. A closing brace on its
own is not a special character. If the second number is omitted, but
the comma is present, there is no upper limit; if the second number
and the comma are both omitted, the quantifier specifies an exact
number of required matches. Thus

<pre class="verbatim">
         [aeiou]{3,}
</pre>

<p class="noindent">matches at least 3 successive vowels, but may match many more, while

<pre class="verbatim">
         \d{8}
</pre>

<p class="noindent">matches exactly 8 digits. An opening curly bracket that appears in a
position where a quantifier is not allowed, or one that does not match
the syntax of a quantifier, is taken as a literal character. For
example, &lsquo;<samp><span class="samp">{,6}</span></samp>&rsquo; is not a quantifier, but a literal string of four
characters.

   <p>In UTF-8 mode, quantifiers apply to UTF-8 characters rather than to
individual bytes. Thus, for example, &lsquo;<samp><span class="samp">\x{100}{2}</span></samp>&rsquo; matches two
UTF-8 characters, each of which is represented by a two-byte
sequence. Similarly, &lsquo;<samp><span class="samp">\X{3}</span></samp>&rsquo; matches three Unicode extended
sequences, each of which may be several bytes long (and they may be of
different lengths).

   <p>The quantifier &lsquo;<samp><span class="samp">{0}</span></samp>&rsquo; is permitted, causing the expression to
behave as if the previous item and the quantifier were not present.

   <p>For convenience, the three most common quantifiers have
single-character abbreviations:

     <dl>
<dt><code>*</code><dd>is equivalent to {0,}
<dt><code>+</code><dd>is equivalent to {1,}
<dt><code>?</code><dd>is equivalent to {0,1}
</dl>

   <p>It is possible to construct infinite loops by following a subpattern that can
match no characters with a quantifier that has no upper limit, for example:

<pre class="verbatim">
         (a?)*
</pre>

<p class="noindent">Earlier versions of Perl and PCRE used to give an error at compile
time for such patterns. However, because there are cases where this
can be useful, such patterns are now accepted, but if any repetition
of the subpattern does in fact match no characters, the loop is
forcibly broken.

   <p>By default, the quantifiers are <dfn>greedy</dfn>, that is, they match as
much as possible (up to the maximum number of permitted times),
without causing the rest of the pattern to fail. The classic example
of where this gives problems is in trying to match comments in C
programs. These appear between &lsquo;<samp><span class="samp">/*</span></samp>&rsquo; and &lsquo;<samp><span class="samp">*/</span></samp>&rsquo;, and within the
comment, individual &lsquo;<samp><span class="samp">*</span></samp>&rsquo; and &lsquo;<samp><span class="samp">/</span></samp>&rsquo; characters may appear. An
attempt to match C comments by applying the pattern

<pre class="verbatim">
         /\*.*\*/
</pre>

<p class="noindent">to the string

<pre class="verbatim">
         /* first comment */  not comment  /* second comment */
</pre>

<p class="noindent">fails, because it matches the entire string owing to the greediness of
the &lsquo;<samp><span class="samp">.*</span></samp>&rsquo; item.

   <p>However, if a quantifier is followed by a question mark, it ceases to
be greedy, and instead matches the minimum number of times possible,
so the pattern

<pre class="verbatim">
         /\*.*?\*/
</pre>

<p class="noindent">does the right thing with the C comments. The meaning of the various
quantifiers is not otherwise changed, just the preferred number of
matches.  Do not confuse this use of question mark with its use as a
quantifier in its own right. Because it has two uses, it can sometimes
appear doubled, as in

<pre class="verbatim">
         \d??\d
</pre>

<p class="noindent">which matches one digit by preference, but can match two if that is the only
way the rest of the pattern matches.

   <p>If the &lsquo;<samp><span class="samp">(?U)</span></samp>&rsquo; option is set (an option that is not available in
Perl), the quantifiers are not greedy by default, but individual ones
can be made greedy by following them with a question mark. In other
words, it inverts the default behaviour.

   <p>When a parenthesized subpattern is quantified with a minimum repeat count that
is greater than 1 or with a limited maximum, more memory is required for the
compiled pattern, in proportion to the size of the minimum or maximum.

   <p>If a pattern starts with &lsquo;<samp><span class="samp">.*</span></samp>&rsquo; or &lsquo;<samp><span class="samp">.{0,}</span></samp>&rsquo; and the
&lsquo;<samp><span class="samp">(?s)</span></samp>&rsquo; option is set, thus allowing the dot to match newlines,
the pattern is implicitly anchored, because whatever follows will be
tried against every character position in the subject string, so there
is no point in retrying the overall match at any position after the
first. PCRE normally treats such a pattern as though it were preceded
by &lsquo;<samp><span class="samp">\A</span></samp>&rsquo;.

   <p>In cases where it is known that the subject string contains no
newlines, it is worth setting &lsquo;<samp><span class="samp">(?s)</span></samp>&rsquo; in order to obtain this
optimization, or alternatively using &lsquo;<samp><span class="samp">^</span></samp>&rsquo; or &lsquo;<samp><span class="samp">\A</span></samp>&rsquo; to indicate
anchoring explicitly.

   <p>However, there is one situation where the optimization cannot be
used. When .* is inside capturing parentheses that are the subject of
a backreference elsewhere in the pattern, a match at the start may
fail where a later one succeeds. Consider, for example:

<pre class="verbatim">
         (.*)abc\1
</pre>

<p class="noindent">If the subject is &lsquo;<samp><span class="samp">xyz123abc123</span></samp>&rsquo; the match point is the fourth
character. For this reason, such a pattern is not implicitly anchored.

   <p>When a capturing subpattern is repeated, the value captured is the
substring that matched the final iteration. For example, after

<pre class="verbatim">
         (tweedle[dume]{3}\s*)+
</pre>

<p class="noindent">has matched &lsquo;<samp><span class="samp">tweedledum tweedledee</span></samp>&rsquo; the value of the captured
substring is &lsquo;<samp><span class="samp">tweedledee</span></samp>&rsquo;. However, if there are nested capturing
subpatterns, the corresponding captured values may have been set in
previous iterations. For example, after

<pre class="verbatim">
         (a|(b))+
</pre>

<p class="noindent">matches &lsquo;<samp><span class="samp">aba</span></samp>&rsquo; the value of the second captured substring is &lsquo;<samp><span class="samp">b</span></samp>&rsquo;.

<h5 class="subsubheading">Atomic Grouping and Possessive Quantifiers</h5>

<p>With both maximizing (<dfn>greedy</dfn>) and minimizing (<dfn>ungreedy</dfn> or
<dfn>lazy</dfn>) repetition, failure of what follows normally causes the
repeated item to be re-evaluated to see if a different number of
repeats allows the rest of the pattern to match. Sometimes it is
useful to prevent this, either to change the nature of the match, or
to cause it fail earlier than it otherwise might, when the author of
the pattern knows there is no point in carrying on.

   <p>Consider, for example, the pattern &lsquo;<samp><span class="samp">\d+foo</span></samp>&rsquo; when applied to the
subject line

<pre class="verbatim">
         123456bar
</pre>

   <p>After matching all 6 digits and then failing to match &lsquo;<samp><span class="samp">foo</span></samp>&rsquo;, the
normal action of the matcher is to try again with only 5 digits
matching the &lsquo;<samp><span class="samp">\d+</span></samp>&rsquo; item, and then with 4, and so on, before
ultimately failing. <dfn>Atomic grouping</dfn> (a term taken from Jeffrey
Friedl's book) provides the means for specifying that once a
subpattern has matched, it is not to be re-evaluated in this way.

   <p>If we use atomic grouping for the previous example, the matcher gives
up immediately on failing to match &lsquo;<samp><span class="samp">foo</span></samp>&rsquo; the first time. The
notation is a kind of special parenthesis, starting with &lsquo;<samp><span class="samp">(?&gt;</span></samp>&rsquo; as in
this example:

<pre class="verbatim">
         (?>\d+)foo
</pre>

<p class="noindent">This kind of parenthesis &ldquo;locks up&rdquo; the part of the pattern it
contains once it has matched, and a failure further into the pattern
is prevented from backtracking into it. Backtracking past it to
previous items, however, works as normal.  Atomic grouping subpatterns
are not capturing subpatterns.

   <p>An alternative description is that a subpattern of this type matches
the string of characters that an identical standalone pattern would
match, if anchored at the current point in the subject string.

   <p>Simple cases such as the above example can be thought of as a
maximizing repeat that must swallow everything it can. So, while both
&lsquo;<samp><span class="samp">\d+</span></samp>&rsquo; and &lsquo;<samp><span class="samp">\d+?</span></samp>&rsquo; are prepared to adjust the number of digits
they match in order to make the rest of the pattern match,
&lsquo;<samp><span class="samp">(?&gt;\d+)</span></samp>&rsquo; can only match an entire sequence of digits.

   <p>Atomic groups in general can of course contain arbitrarily complicated
subpatterns, and can be nested. However, when the subpattern for an
atomic group is just a single repeated item, as in the example above,
a simpler notation, called a <dfn>possessive quantifier</dfn>, can be
used. This consists of an additional &lsquo;<samp><span class="samp">+</span></samp>&rsquo; character following a
quantifier. Using this notation, the previous example can be rewritten
as

<pre class="verbatim">
         \d++foo
</pre>

<p class="noindent">Note that a possessive quantifier can be used with an entire group, for
example:

<pre class="verbatim">
         (abc|xyz){2,3}+
</pre>

<p class="noindent">Possessive quantifiers are always greedy; the setting of the
&lsquo;<samp><span class="samp">(?U)</span></samp>&rsquo; option is ignored. They are a convenient notation for the
simpler forms of atomic group. However, there is no difference in the
meaning of a possessive quantifier and the equivalent atomic group,
though there may be a performance difference; possessive quantifiers
should be slightly faster.

   <p>The possessive quantifier syntax is an extension to the Perl 5.8
syntax.  Jeffrey Friedl originated the idea (and the name) in the
first edition of his book. Mike McCloskey liked it, so implemented it
when he built Sun's Java package, and PCRE copied it from there. It
ultimately found its way into Perl at release 5.10.

   <p>PCRE has an optimization that automatically &ldquo;possessifies&rdquo; certain
simple pattern constructs. For example, the sequence &lsquo;<samp><span class="samp">A+B</span></samp>&rsquo; is
treated as &lsquo;<samp><span class="samp">A++B</span></samp>&rsquo; because there is no point in backtracking into
a sequence of &lsquo;<samp><span class="samp">A</span></samp>&rsquo;s when &lsquo;<samp><span class="samp">B</span></samp>&rsquo; must follow.

   <p>When a pattern contains an unlimited repeat inside a subpattern that
can itself be repeated an unlimited number of times, the use of an
atomic group is the only way to avoid some failing matches taking a
very long time indeed. The pattern

<pre class="verbatim">
         (\D+|&lt;\d+>)*[!?]
</pre>

<p class="noindent">matches an unlimited number of substrings that either consist of
non-digits, or digits enclosed in &lsquo;<samp><span class="samp">&lt;&gt;</span></samp>&rsquo;, followed by either
&lsquo;<samp><span class="samp">!</span></samp>&rsquo; or &lsquo;<samp><span class="samp">?</span></samp>&rsquo;. When it matches, it runs quickly. However, if it
is applied to

<pre class="verbatim">
         aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
</pre>

<p class="noindent">it takes a long time before reporting failure. This is because the
string can be divided between the internal &lsquo;<samp><span class="samp">\D+</span></samp>&rsquo; repeat and the
external &lsquo;<samp><span class="samp">*</span></samp>&rsquo; repeat in a large number of ways, and all have to be
tried. (The example uses &lsquo;<samp><span class="samp">[!?]</span></samp>&rsquo; rather than a single character at
the end, because both PCRE and Perl have an optimization that allows
for fast failure when a single character is used. They remember the
last single character that is required for a match, and fail early if
it is not present in the string.) If the pattern is changed so that it
uses an atomic group, like this:

<pre class="verbatim">
         ((?>\D+)|&lt;\d+>)*[!?]
</pre>

<p class="noindent">sequences of non-digits cannot be broken, and failure happens quickly.

<h5 class="subsubheading">Back References</h5>

<p>Outside a character class, a backslash followed by a digit greater
than 0 (and possibly further digits) is a back reference to a
capturing subpattern earlier (that is, to its left) in the pattern,
provided there have been that many previous capturing left
parentheses.

   <p>However, if the decimal number following the backslash is less than
10, it is always taken as a back reference, and causes an error only
if there are not that many capturing left parentheses in the entire
pattern. In other words, the parentheses that are referenced need not
be to the left of the reference for numbers less than 10. A &ldquo;forward
back reference&rdquo; of this type can make sense when a repetition is
involved and the subpattern to the right has participated in an
earlier iteration.

   <p>It is not possible to have a numerical &ldquo;forward back reference&rdquo; to a
subpattern whose number is 10 or more using this syntax because a
sequence such as &lsquo;<samp><span class="samp">\50</span></samp>&rsquo; is interpreted as a character defined in
octal. See the subsection entitled &ldquo;Non-printing characters&rdquo; above
for further details of the handling of digits following a
backslash. There is no such problem when named parentheses are used. A
back reference to any subpattern is possible using named parentheses
(see below).

   <p>Another way of avoiding the ambiguity inherent in the use of digits
following a backslash is to use the &lsquo;<samp><span class="samp">\g</span></samp>&rsquo; escape sequence, which
is a feature introduced in Perl 5.10. This escape must be followed by
an unsigned number or a negative number, optionally enclosed in
braces. These examples are all identical:

<pre class="verbatim">
         (ring), \1
         (ring), \g1
         (ring), \g{1}
</pre>

   <p>An unsigned number specifies an absolute reference without the
ambiguity that is present in the older syntax. It is also useful when
literal digits follow the reference. A negative number is a relative
reference. Consider this example:

<pre class="verbatim">
         (abc(def)ghi)\g{-1}
</pre>

<p class="noindent">The sequence &lsquo;<samp><span class="samp">\g{-1}</span></samp>&rsquo; is a reference to the most recently
started capturing subpattern before &lsquo;<samp><span class="samp">\g</span></samp>&rsquo;, that is, is it
equivalent to &lsquo;<samp><span class="samp">\2</span></samp>&rsquo;. Similarly, &lsquo;<samp><span class="samp">\g{-2}</span></samp>&rsquo; would be
equivalent to &lsquo;<samp><span class="samp">\1</span></samp>&rsquo;. The use of relative references can be helpful
in long patterns, and also in patterns that are created by joining
together fragments that contain references within themselves.

   <p>A back reference matches whatever actually matched the capturing
subpattern in the current subject string, rather than anything
matching the subpattern itself (see &ldquo;Subpatterns as subroutines&rdquo; below
for a way of doing that). So the pattern

<pre class="verbatim">
         (sens|respons)e and \1ibility
</pre>

<p class="noindent">matches &lsquo;<samp><span class="samp">sense and sensibility</span></samp>&rsquo; and &lsquo;<samp><span class="samp">response and
responsibility</span></samp>&rsquo;, but not &lsquo;<samp><span class="samp">sense and responsibility</span></samp>&rsquo;. If caseful
matching is in force at the time of the back reference, the case of
letters is relevant. For example,

<pre class="verbatim">
         ((?i)rah)\s+\1
</pre>

<p class="noindent">matches &lsquo;<samp><span class="samp">rah rah</span></samp>&rsquo; and &lsquo;<samp><span class="samp">RAH RAH</span></samp>&rsquo;, but not &lsquo;<samp><span class="samp">RAH rah</span></samp>&rsquo;,
even though the original capturing subpattern is matched caselessly.

   <p>There are several different ways of writing back references to named
subpatterns. The .NET syntax &lsquo;<samp><span class="samp">\k{name}</span></samp>&rsquo; and the Perl syntax
&lsquo;<samp><span class="samp">\k&lt;name&gt;</span></samp>&rsquo; or &lsquo;<samp><span class="samp">\k'name'</span></samp>&rsquo; are supported, as is the Python
syntax (?P=name). Perl 5.10's unified back reference syntax, in which
&lsquo;<samp><span class="samp">\g</span></samp>&rsquo; can be used for both numeric and named references, is also
supported. We could rewrite the above example in any of the following
ways:

<pre class="verbatim">
         (?&lt;p1>(?i)rah)\s+\k&lt;p1>
         (?'p1'(?i)rah)\s+\k{p1}
         (?P&lt;p1>(?i)rah)\s+(?P=p1)
         (?&lt;p1>(?i)rah)\s+\g{p1}
</pre>

<p class="noindent">A subpattern that is referenced by name may appear in the pattern
before or after the reference.

   <p>There may be more than one back reference to the same subpattern. If a
subpattern has not actually been used in a particular match, any back
references to it always fail. For example, the pattern

<pre class="verbatim">
         (a|(bc))\2
</pre>

<p class="noindent">always fails if it starts to match &lsquo;<samp><span class="samp">a</span></samp>&rsquo; rather than
&lsquo;<samp><span class="samp">bc</span></samp>&rsquo;. Because there may be many capturing parentheses in a
pattern, all digits following the backslash are taken as part of a
potential back reference number. If the pattern continues with a digit
character, some delimiter must be used to terminate the back
reference. If the &lsquo;<samp><span class="samp">(?x)</span></samp>&rsquo; option is set, this can be whitespace. 
Otherwise an empty comment (see &ldquo;Comments&rdquo; below) can be used.

   <p>A back reference that occurs inside the parentheses to which it refers
fails when the subpattern is first used, so, for example, &lsquo;<samp><span class="samp">(a\1)</span></samp>&rsquo;
never matches.  However, such references can be useful inside repeated
subpatterns. For example, the pattern

<pre class="verbatim">
         (a|b\1)+
</pre>

<p class="noindent">matches any number of &lsquo;<samp><span class="samp">a</span></samp>&rsquo;s and also &lsquo;<samp><span class="samp">aba</span></samp>&rsquo;, &lsquo;<samp><span class="samp">ababbaa</span></samp>&rsquo;
etc. At each iteration of the subpattern, the back reference matches
the character string corresponding to the previous iteration. In order
for this to work, the pattern must be such that the first iteration
does not need to match the back reference. This can be done using
alternation, as in the example above, or by a quantifier with a
minimum of zero.

<h5 class="subsubheading">Assertions</h5>

<p>An assertion is a test on the characters following or preceding the
current matching point that does not actually consume any
characters. The simple assertions coded as &lsquo;<samp><span class="samp">\b</span></samp>&rsquo;, &lsquo;<samp><span class="samp">\B</span></samp>&rsquo;,
&lsquo;<samp><span class="samp">\A</span></samp>&rsquo;, &lsquo;<samp><span class="samp">\G</span></samp>&rsquo;, &lsquo;<samp><span class="samp">\Z</span></samp>&rsquo;, &lsquo;<samp><span class="samp">\z</span></samp>&rsquo;, &lsquo;<samp><span class="samp">^</span></samp>&rsquo; and &lsquo;<samp><span class="samp">$</span></samp>&rsquo; are
described above.

   <p>More complicated assertions are coded as subpatterns. There are two
kinds: those that look ahead of the current position in the subject
string, and those that look behind it. An assertion subpattern is
matched in the normal way, except that it does not cause the current
matching position to be changed.

   <p>Assertion subpatterns are not capturing subpatterns, and may not be
repeated, because it makes no sense to assert the same thing several
times. If any kind of assertion contains capturing subpatterns within
it, these are counted for the purposes of numbering the capturing
subpatterns in the whole pattern.  However, substring capturing is
carried out only for positive assertions, because it does not make
sense for negative assertions.

<h5 class="subsubheading">Lookahead Assertions</h5>

<p>Lookahead assertions start with &lsquo;<samp><span class="samp">(?=</span></samp>&rsquo; for positive assertions and
&lsquo;<samp><span class="samp">(?!</span></samp>&rsquo;  for negative assertions. For example,

<pre class="verbatim">
         \w+(?=;)
</pre>

<p class="noindent">matches a word followed by a semicolon, but does not include the semicolon in
the match, and

<pre class="verbatim">
         foo(?!bar)
</pre>

<p class="noindent">matches any occurrence of &lsquo;<samp><span class="samp">foo</span></samp>&rsquo; that is not followed by
&lsquo;<samp><span class="samp">bar</span></samp>&rsquo;. Note that the apparently similar pattern

<pre class="verbatim">
         (?!foo)bar
</pre>

<p class="noindent">does not find an occurrence of &lsquo;<samp><span class="samp">bar</span></samp>&rsquo; that is preceded by
something other than &lsquo;<samp><span class="samp">foo</span></samp>&rsquo;; it finds any occurrence of &lsquo;<samp><span class="samp">bar</span></samp>&rsquo;
whatsoever, because the assertion &lsquo;<samp><span class="samp">(?!foo)</span></samp>&rsquo; is always true when
the next three characters are &lsquo;<samp><span class="samp">bar</span></samp>&rsquo;. A lookbehind assertion is
needed to achieve the other effect.

   <p>If you want to force a matching failure at some point in a pattern,
the most convenient way to do it is with &lsquo;<samp><span class="samp">(?!)</span></samp>&rsquo; because an empty
string always matches, so an assertion that requires there not to be
an empty string must always fail.

<h5 class="subsubheading">Lookbehind Assertions</h5>

<p>Lookbehind assertions start with &lsquo;<samp><span class="samp">(?&lt;=</span></samp>&rsquo; for positive assertions
and &lsquo;<samp><span class="samp">(?&lt;!</span></samp>&rsquo;  for negative assertions. For example,

<pre class="verbatim">
         (?&lt;!foo)bar
</pre>

<p class="noindent">matches an occurrence of &lsquo;<samp><span class="samp">bar</span></samp>&rsquo; that is not preceded by
&lsquo;<samp><span class="samp">foo</span></samp>&rsquo;. The contents of a lookbehind assertion are restricted such
that all the strings it matches must have a fixed length. However, if
there are several top-level alternatives, they do not all have to have
the same fixed length. Thus

<pre class="verbatim">
         (?&lt;=bullock|donkey)
</pre>

<p class="noindent">is permitted, but

<pre class="verbatim">
         (?&lt;!dogs?|cats?)
</pre>

<p class="noindent">causes an error at compile time. Branches that match different length
strings are permitted only at the top level of a lookbehind
assertion. This is an extension compared with Perl (at least for 5.8),
which requires all branches to match the same length of string. An
assertion such as

<pre class="verbatim">
         (?&lt;=ab(c|de))
</pre>

<p class="noindent">is not permitted, because its single top-level branch can match two different
lengths, but it is acceptable if rewritten to use two top-level branches:

<pre class="verbatim">
         (?&lt;=abc|abde)
</pre>

   <p>In some cases, the Perl 5.10 escape sequence &lsquo;<samp><span class="samp">\K</span></samp>&rsquo; (see above) can
be used instead of a lookbehind assertion; this is not restricted to a
fixed-length.

   <p>The implementation of lookbehind assertions is, for each alternative,
to temporarily move the current position back by the fixed length and
then try to match. If there are insufficient characters before the
current position, the assertion fails.

   <p>PCRE does not allow the &lsquo;<samp><span class="samp">\C</span></samp>&rsquo; escape (which matches a single byte
in UTF-8 mode) to appear in lookbehind assertions, because it makes it
impossible to calculate the length of the lookbehind. The &lsquo;<samp><span class="samp">\X</span></samp>&rsquo;
and &lsquo;<samp><span class="samp">\R</span></samp>&rsquo; escapes, which can match different numbers of bytes, are
also not permitted.

   <p>Possessive quantifiers can be used in conjunction with lookbehind
assertions to specify efficient matching at the end of the subject
string. Consider a simple pattern such as

<pre class="verbatim">
         abcd$
</pre>

<p class="noindent">when applied to a long string that does not match. Because matching
proceeds from left to right, PCRE will look for each &lsquo;<samp><span class="samp">a</span></samp>&rsquo; in the
subject and then see if what follows matches the rest of the
pattern. If the pattern is specified as

<pre class="verbatim">
         ^.*abcd$
</pre>

<p class="noindent">the initial &lsquo;<samp><span class="samp">.*</span></samp>&rsquo; matches the entire string at first, but when this fails
(because there is no following &lsquo;<samp><span class="samp">a</span></samp>&rsquo;), it backtracks to match all
but the last character, then all but the last two characters, and so
on. Once again the search for &lsquo;<samp><span class="samp">a</span></samp>&rsquo; covers the entire string, from
right to left, so we are no better off. However, if the pattern is
written as

<pre class="verbatim">
         ^.*+(?&lt;=abcd)
</pre>

<p class="noindent">there can be no backtracking for the &lsquo;<samp><span class="samp">.*+</span></samp>&rsquo; item; it can match
only the entire string. The subsequent lookbehind assertion does a
single test on the last four characters. If it fails, the match fails
immediately. For long strings, this approach makes a significant
difference to the processing time.

<h5 class="subsubheading">Using multiple assertions</h5>

<p>Several assertions (of any sort) may occur in succession. For example,

<pre class="verbatim">
         (?&lt;=\d{3})(?&lt;!999)foo
</pre>

<p class="noindent">matches &lsquo;<samp><span class="samp">foo</span></samp>&rsquo; preceded by three digits that are not
&lsquo;<samp><span class="samp">999</span></samp>&rsquo;. Notice that each of the assertions is applied
independently at the same point in the subject string. First there is
a check that the previous three characters are all digits, and then
there is a check that the same three characters are not &lsquo;<samp><span class="samp">999</span></samp>&rsquo;. 
This pattern does <em>not</em> match &lsquo;<samp><span class="samp">foo</span></samp>&rsquo; preceded by six
characters, the first of which are digits and the last three of which
are not &lsquo;<samp><span class="samp">999</span></samp>&rsquo;. For example, it doesn't match &lsquo;<samp><span class="samp">123abcfoo</span></samp>&rsquo;. A
pattern to do that is

<pre class="verbatim">
         (?&lt;=\d{3}...)(?&lt;!999)foo
</pre>

<p class="noindent">This time the first assertion looks at the preceding six characters,
checking that the first three are digits, and then the second
assertion checks that the preceding three characters are not
&lsquo;<samp><span class="samp">999</span></samp>&rsquo;.

   <p>Assertions can be nested in any combination. For example,

<pre class="verbatim">
         (?&lt;=(?&lt;!foo)bar)baz
</pre>

<p class="noindent">matches an occurrence of &lsquo;<samp><span class="samp">baz</span></samp>&rsquo; that is preceded by &lsquo;<samp><span class="samp">bar</span></samp>&rsquo;
which in turn is not preceded by &lsquo;<samp><span class="samp">foo</span></samp>&rsquo;, while

<pre class="verbatim">
         (?&lt;=\d{3}(?!999)...)foo
</pre>

<p class="noindent">is another pattern that matches &lsquo;<samp><span class="samp">foo</span></samp>&rsquo; preceded by three digits
and any three characters that are not &lsquo;<samp><span class="samp">999</span></samp>&rsquo;.

<h5 class="subsubheading">Conditional Subpatterns</h5>

<p>It is possible to cause the matching process to obey a subpattern
conditionally or to choose between two alternative subpatterns,
depending on the result of an assertion, or whether a previous
capturing subpattern matched or not. The two possible forms of
conditional subpattern are

     <ul>
<li>         (?(<var>condition</var>)<var>yes-pattern</var>)
<li>         (?(<var>condition</var>)<var>yes-pattern</var>|<var>no-pattern</var>)
</ul>

   <p>If the <var>condition</var> is satisfied, the <var>yes-pattern</var> is used;
otherwise the <var>no-pattern</var> (if present) is used. If there are more
than two alternatives in the subpattern, a compile-time error occurs.

   <p>There are four kinds of condition: references to subpatterns,
references to recursion, a pseudo-condition called &lsquo;<samp><span class="samp">DEFINE</span></samp>&rsquo;, and
assertions.

<h5 class="subsubheading">Checking for a used subpattern by number</h5>

<p>If the text between the parentheses consists of a sequence of digits,
the condition is true if the capturing subpattern of that number has
previously matched. An alternative notation is to precede the digits
with a plus or minus sign. In this case, the subpattern number is
relative rather than absolute.  The most recently opened parentheses
can be referenced by &lsquo;<samp><span class="samp">(?(-1)</span></samp>&rsquo;, the next most recent by
&lsquo;<samp><span class="samp">(?(-2)</span></samp>&rsquo;, and so on. In looping constructs it can also make sense
to refer to subsequent groups with constructs such as &lsquo;<samp><span class="samp">(?(+2)</span></samp>&rsquo;.

   <p>Consider the following pattern, which contains non-significant white
space to make it more readable and to divide it into three parts for
ease of discussion (assume a preceding &lsquo;<samp><span class="samp">(?x)</span></samp>&rsquo;):

<pre class="verbatim">
         ( \( )?    [^()]+    (?(1) \) )
</pre>

   <p>The first part matches an optional opening parenthesis, and if that
character is present, sets it as the first captured substring. The
second part matches one or more characters that are not
parentheses. The third part is a conditional subpattern that tests
whether the first set of parentheses matched or not. If they did, that
is, if subject started with an opening parenthesis, the condition is
true, and so the yes-pattern is executed and a closing parenthesis is
required. Otherwise, since no-pattern is not present, the subpattern
matches nothing. In other words, this pattern matches a sequence of
non-parentheses, optionally enclosed in parentheses.

   <p>If you were embedding this pattern in a larger one, you could use a
relative reference:

<pre class="verbatim">
         ...other stuff... ( \( )?    [^()]+    (?(-1) \) ) ...
</pre>

   <p>This makes the fragment independent of the parentheses in the larger pattern.

<h5 class="subsubheading">Checking for a used subpattern by name</h5>

<p>Perl uses the syntax &lsquo;<samp><span class="samp">(?(&lt;name&gt;)...)</span></samp>&rsquo; or &lsquo;<samp><span class="samp">(?('name')...)</span></samp>&rsquo; to
test for a used subpattern by name. For compatibility with earlier
versions of PCRE, which had this facility before Perl, the syntax
&lsquo;<samp><span class="samp">(?(name)...)</span></samp>&rsquo; is also recognized. However, there is a possible
ambiguity with this syntax, because subpattern names may consist
entirely of digits. PCRE looks first for a named subpattern; if it
cannot find one and the name consists entirely of digits, PCRE looks
for a subpattern of that number, which must be greater than
zero. Using subpattern names that consist entirely of digits is not
recommended.

   <p>Rewriting the above example to use a named subpattern gives this:

<pre class="verbatim">
         (?&lt;OPEN> \( )?    [^()]+    (?(&lt;OPEN>) \) )
</pre>

<h5 class="subsubheading">Checking for pattern recursion</h5>

<p>If the condition is the string &lsquo;<samp><span class="samp">(R)</span></samp>&rsquo;, and there is no subpattern
with the name &lsquo;<samp><span class="samp">R</span></samp>&rsquo;, the condition is true if a recursive call to
the whole pattern or any subpattern has been made. If digits or a name
preceded by ampersand follow the letter &lsquo;<samp><span class="samp">R</span></samp>&rsquo;, for example:

<pre class="verbatim">
         (?(R3)...) or (?(R&amp;name)...)
</pre>

<p class="noindent">the condition is true if the most recent recursion is into the
subpattern whose number or name is given. This condition does not
check the entire recursion stack.

   <p>At &ldquo;top level,&rdquo; all these recursion test conditions are false. Recursive
patterns are described below.

<h5 class="subsubheading">Defining subpatterns for use by reference only</h5>

<p>If the condition is the string &lsquo;<samp><span class="samp">(DEFINE)</span></samp>&rsquo;, and there is no
subpattern with the name &lsquo;<samp><span class="samp">DEFINE</span></samp>&rsquo;, the condition is always
false. In this case, there may be only one alternative in the
subpattern. It is always skipped if control reaches this point in the
pattern; the idea of DEFINE is that it can be used to define
<dfn>subroutines</dfn> that can be referenced from elsewhere. (The use of
subroutines is described below.) For example, a pattern to match an
IPv4 address could be written like this (ignore whitespace and line
breaks):

<pre class="verbatim">
         (?(DEFINE) (?&lt;byte> 2[0-4]\d | 25[0-5] | 1\d\d | [1-9]?\d) )
         \b (?&amp;byte) (\.(?&amp;byte)){3} \b
</pre>

   <p>The first part of the pattern is a DEFINE group inside which a another
group named "byte" is defined. This matches an individual component of
an IPv4 address (a number less than 256). When matching takes place,
this part of the pattern is skipped because DEFINE acts like a false
condition.

   <p>The rest of the pattern uses references to the named group to match
the four dot-separated components of an IPv4 address, insisting on a
word boundary at each end.

<h5 class="subsubheading">Assertion conditions</h5>

<p>If the condition is not in any of the above formats, it must be an
assertion.  This may be a positive or negative lookahead or lookbehind
assertion. Consider this pattern, again containing non-significant
white space, and with the two alternatives on the second line:

<pre class="verbatim">
         (?(?=[^a-z]*[a-z])
         \d{2}-[a-z]{3}-\d{2}  |  \d{2}-\d{2}-\d{2} )
</pre>

   <p>The condition is a positive lookahead assertion that matches an
optional sequence of non-letters followed by a letter. In other words,
it tests for the presence of at least one letter in the subject. If a
letter is found, the subject is matched against the first alternative;
otherwise it is matched against the second. This pattern matches
strings in one of the two forms &lsquo;<samp><var>dd</var><span class="samp">-</span><var>aaa</var><span class="samp">-</span><var>dd</var></samp>&rsquo; or
&lsquo;<samp><var>dd</var><span class="samp">-</span><var>dd</var><span class="samp">-</span><var>dd</var></samp>&rsquo;, where <var>aaa</var> are letters and
<var>dd</var> are digits.

<h5 class="subsubheading">Comments</h5>

<p>The sequence &lsquo;<samp><span class="samp">(?#</span></samp>&rsquo; marks the start of a comment that continues up
to the next closing parenthesis. Nested parentheses are not
permitted. The characters that make up a comment play no part in the
pattern matching at all.

   <p>If the &lsquo;<samp><span class="samp">(?x)</span></samp>&rsquo; option is set, an unescaped &lsquo;<samp><span class="samp">#</span></samp>&rsquo; character
outside a character class introduces a comment that continues to
immediately after the next newline in the pattern.

<h5 class="subsubheading">Recursive Patterns</h5>

<p>Consider the problem of matching a string in parentheses, allowing for
unlimited nested parentheses. Without the use of recursion, the best
that can be done is to use a pattern that matches up to some fixed
depth of nesting. It is not possible to handle an arbitrary nesting
depth.

   <p>PCRE supports special syntax for recursion of the entire pattern, and
also for individual subpattern recursion. After its introduction in
PCRE and Python, this kind of recursion was introduced into Perl at
release 5.10.

   <p>A special item that consists of &lsquo;<samp><span class="samp">(?</span></samp>&rsquo; followed by a number greater
than zero and a closing parenthesis is a recursive call of the
subpattern of the given number, provided that it occurs inside that
subpattern. (If not, it is a subroutine call, which is described in
the next section.) The special item &lsquo;<samp><span class="samp">(?R)</span></samp>&rsquo; or &lsquo;<samp><span class="samp">(?0)</span></samp>&rsquo; is a
recursive call of the entire regular expression.

   <p>In PCRE (like Python, but unlike Perl), a recursive subpattern call is
always treated as an atomic group. That is, once it has matched some
of the subject string, it is never re-entered, even if it contains
untried alternatives and there is a subsequent matching failure.

   <p>This PCRE pattern solves the nested parentheses problem (whitespace is
insignificant):

<pre class="verbatim">
         \( ( (?>[^()]+) | (?R) )* \)
</pre>

   <p>First it matches an opening parenthesis. Then it matches any number of
substrings which can either be a sequence of non-parentheses, or a
recursive match of the pattern itself (that is, a correctly
parenthesized substring).  Finally there is a closing parenthesis.

   <p>If this were part of a larger pattern, you would not want to recurse
the entire pattern, so instead you could use this:

<pre class="verbatim">
         ( \( ( (?>[^()]+) | (?1) )* \) )
</pre>

<p class="noindent">We have put the pattern into parentheses, and caused the recursion to
refer to them instead of the whole pattern.

   <p>In a larger pattern, keeping track of parenthesis numbers can be
tricky. This is made easier by the use of relative references. (A Perl
5.10 feature.)  Instead of &lsquo;<samp><span class="samp">(?1)</span></samp>&rsquo; in the pattern above you can
write &lsquo;<samp><span class="samp">(?-2)</span></samp>&rsquo; to refer to the second most recently opened
parentheses preceding the recursion. In other words, a negative number
counts capturing parentheses leftwards from the point at which it is
encountered.

   <p>It is also possible to refer to subsequently opened parentheses, by
writing references such as &lsquo;<samp><span class="samp">(?+2)</span></samp>&rsquo;. However, these cannot be
recursive because the reference is not inside the parentheses that are
referenced. They are always subroutine calls, as described in the next
section.

   <p>An alternative approach is to use named parentheses instead. The Perl
syntax for this is &lsquo;<samp><span class="samp">(?&amp;name)</span></samp>&rsquo;; PCRE's earlier syntax
&lsquo;<samp><span class="samp">(?P&gt;name)</span></samp>&rsquo; is also supported. We could rewrite the above example
as follows:

<pre class="verbatim">
         (?&lt;pn> \( ( (?>[^()]+) | (?&amp;pn) )* \) )
</pre>

<p class="noindent">If there is more than one subpattern with the same name, the earliest
one is used.

   <p>This particular example pattern that we have been looking at contains
nested unlimited repeats, and so the use of atomic grouping for
matching strings of non-parentheses is important when applying the
pattern to strings that do not match. For example, when this pattern
is applied to

<pre class="verbatim">
         (aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa()
</pre>

<p class="noindent">it fails quickly. However, if atomic grouping is not used, the match
runs for a very long time indeed because there are so many different
ways the &lsquo;<samp><span class="samp">+</span></samp>&rsquo; and &lsquo;<samp><span class="samp">*</span></samp>&rsquo; repeats can carve up the subject, and
all have to be tested before failure can be reported.

   <p>At the end of a match, the values set for any capturing subpatterns
are those from the outermost level of the recursion at which the
subpattern value is set.  If the pattern above is matched against

<pre class="verbatim">
         (ab(cd)ef)
</pre>

<p class="noindent">the value for the capturing parentheses is &lsquo;<samp><span class="samp">ef</span></samp>&rsquo;, which is the
last value taken on at the top level. If additional parentheses are
added, giving

<pre class="verbatim">
         \( ( ( (?>[^()]+) | (?R) )* ) \)
            ^                        ^
@end example

@noindent
the string they capture is @samp{ab(cd)ef}, the contents of the top
level parentheses.

Do not confuse the @samp{(?R)} item with the condition @samp{(?(R)},
which tests for recursion.  Consider this pattern, which matches text
in angle brackets, allowing for arbitrary nesting. Only digits are
allowed in nested brackets (that is, when recursing), whereas any
characters are permitted at the outer level.

@verbatim
         &lt; (?: (?(R) \d++  | [^&lt;>]*+) | (?R)) * >
</pre>

<p class="noindent">In this pattern, &lsquo;<samp><span class="samp">(?(R)</span></samp>&rsquo; is the start of a conditional
subpattern, with two different alternatives for the recursive and
non-recursive cases. The &lsquo;<samp><span class="samp">(?R)</span></samp>&rsquo; item is the actual recursive
call.

<h5 class="subsubheading">Subpatterns as Subroutines</h5>

<p>If the syntax for a recursive subpattern reference (either by number
or by name) is used outside the parentheses to which it refers, it
operates like a subroutine in a programming language. The called
subpattern may be defined before or after the reference. A numbered
reference can be absolute or relative, as in these examples:

<pre class="verbatim">
         (...(absolute)...)...(?2)...
         (...(relative)...)...(?-1)...
         (...(?+1)...(relative)...
</pre>

   <p>An earlier example pointed out that the pattern

<pre class="verbatim">
         (sens|respons)e and \1ibility
</pre>

<p class="noindent">matches &lsquo;<samp><span class="samp">sense and sensibility</span></samp>&rsquo; and &lsquo;<samp><span class="samp">response and
responsibility</span></samp>&rsquo;, but not &lsquo;<samp><span class="samp">sense and responsibility</span></samp>&rsquo;. If instead
the pattern

<pre class="verbatim">
         (sens|respons)e and (?1)ibility
</pre>

<p class="noindent">is used, it does match &lsquo;<samp><span class="samp">sense and responsibility</span></samp>&rsquo; as well as the
other two strings. Another example is given in the discussion of
DEFINE above.

   <p>Like recursive subpatterns, a subroutine call is always treated as an
atomic group. That is, once it has matched some of the subject string,
it is never re-entered, even if it contains untried alternatives and
there is a subsequent matching failure.

   <p>When a subpattern is used as a subroutine, processing options such as
case-independence are fixed when the subpattern is defined. They
cannot be changed for different calls. For example, consider this
pattern:

<pre class="verbatim">
         (abc)(?i:(?-1))
</pre>

   <p>It matches &lsquo;<samp><span class="samp">abcabc</span></samp>&rsquo;. It does not match &lsquo;<samp><span class="samp">abcABC</span></samp>&rsquo; because the
change of processing option does not affect the called subpattern.

<h5 class="subsubheading">Backtracking Control</h5>

<p>Perl 5.10 introduced a number of special <dfn>backtracking control
verbs</dfn>, which are described in the Perl documentation as
&ldquo;experimental and subject to change or removal in a future version of
Perl.&rdquo; It goes on to say: &ldquo;Their usage in production code should be
noted to avoid problems during upgrades.&rdquo; The same remarks apply to
the PCRE features described in this section.

   <p>The new verbs make use of what was previously invalid syntax: an
opening parenthesis followed by an asterisk. In Perl, they are
generally of the form &lsquo;<samp><span class="samp">(*VERB:ARG)</span></samp>&rsquo; but PCRE does not support the
use of arguments, so its general form is just &lsquo;<samp><span class="samp">(*VERB)</span></samp>&rsquo;. Any
number of these verbs may occur in a pattern. There are two kinds:

<h5 class="subsubheading">Verbs that act immediately</h5>

<p>The following verbs act as soon as they are encountered:

     <dl>
<dt><code>(*ACCEPT)</code><dd>
This verb causes the match to end successfully, skipping the remainder
of the pattern. When inside a recursion, only the innermost pattern is
ended immediately. PCRE differs from Perl in what happens if the
&lsquo;<samp><span class="samp">(*ACCEPT)</span></samp>&rsquo; is inside capturing parentheses. In Perl, the data so
far is captured: in PCRE no data is captured. For example:

     <pre class="verbatim">     
              A(A|B(*ACCEPT)|C)D
</pre>

     <p>This matches &lsquo;<samp><span class="samp">AB</span></samp>&rsquo;, &lsquo;<samp><span class="samp">AAD</span></samp>&rsquo;, or &lsquo;<samp><span class="samp">ACD</span></samp>&rsquo;, but when it matches
&lsquo;<samp><span class="samp">AB</span></samp>&rsquo;, no data is captured.

     <dt><code>(*FAIL) </code><span class="roman">or</span><code> (*F)</code><dd>
This verb causes the match to fail, forcing backtracking to occur. It
is equivalent to &lsquo;<samp><span class="samp">(?!)</span></samp>&rsquo; but easier to read.  It is not clear
whether there is any use for this without the ability to execute code
in the middle of the pattern (which Perl has but PCRE in Monotone does
not). 
</dl>

<h5 class="subsubheading">Verbs that act after backtracking</h5>

<p>The following verbs do nothing when they are encountered. Matching
continues with what follows, but if there is no subsequent match, a
failure is forced.  The verbs differ in exactly what kind of failure
occurs.

     <dl>
<dt><code>(*COMMIT)</code><dd>
This verb causes the whole match to fail outright if the rest of the
pattern does not match. Even if the pattern is unanchored, no further
attempts to find a match by advancing the start point take place. Once
<code>(*COMMIT)</code> has been passed, the regular expression engine is
committed to finding a match at the current starting point, or not at
all. For example:

     <pre class="verbatim">     
              a+(*COMMIT)b
</pre>

     <p>This matches &lsquo;<samp><span class="samp">xxaab</span></samp>&rsquo; but not &lsquo;<samp><span class="samp">aacaab</span></samp>&rsquo;. It can be thought of
as a kind of dynamic anchor, or &ldquo;I've started, so I must finish.&rdquo;

     <dt><code>(*PRUNE)</code><dd>
This verb causes the match to fail at the current position if the rest
of the pattern does not match. If the pattern is unanchored, the
normal &ldquo;bump-along&rdquo; advance to the next starting character then
happens. Backtracking can occur as usual to the left of
<code>(*PRUNE)</code>, or when matching to the right of <code>(*PRUNE)</code>, but
if there is no match to the right, backtracking cannot cross
<code>(*PRUNE)</code>.  In simple cases, the use of <code>(*PRUNE)</code> is just
an alternative to an atomic group or possessive quantifier, but there
are some uses of <code>(*PRUNE)</code> that cannot be expressed in any other
way.

     <dt><code>(*SKIP)</code><dd>
This verb is like <code>(*PRUNE)</code>, except that if the pattern is
unanchored, the "bumpalong" advance is not to the next character, but
to the position in the subject where <code>(*SKIP)</code> was
encountered. <code>(*SKIP)</code> signifies that whatever text was matched
leading up to it cannot be part of a successful match. Consider:

     <pre class="verbatim">     
              a+(*SKIP)b
</pre>

     <p>If the subject is &lsquo;<samp><span class="samp">aaaac...</span></samp>&rsquo;, after the first match attempt fails
(starting at the first character in the string), the starting point
skips on to start the next attempt at &lsquo;<samp><span class="samp">c</span></samp>&rsquo;. Note that a possessive
quantifer does not have the same effect in this example; although it
would suppress backtracking during the first match attempt, the second
attempt would start at the second character instead of skipping on to
&lsquo;<samp><span class="samp">c</span></samp>&rsquo;.

     <dt><code>(*THEN)</code><dd>
This verb causes a skip to the next alternation if the rest of the
pattern does not match. That is, it cancels pending backtracking, but
only within the current alternation. Its name comes from the
observation that it can be used for a pattern-based if-then-else
block:

     <pre class="verbatim">     
              ( COND1 (*THEN) FOO 
              | COND2 (*THEN) BAR 
              | COND3 (*THEN) BAZ ) ...
</pre>

     <p>If the &lsquo;<samp><span class="samp">COND1</span></samp>&rsquo; pattern matches, &lsquo;<samp><span class="samp">FOO</span></samp>&rsquo; is tried (and possibly
further items after the end of the group if &lsquo;<samp><span class="samp">FOO</span></samp>&rsquo; succeeds); on
failure the matcher skips to the second alternative and tries
&lsquo;<samp><span class="samp">COND2</span></samp>&rsquo;, without backtracking into COND1. If <code>(*THEN)</code> is used
outside of any alternation, it acts exactly like <code>(*PRUNE)</code>. 
</dl>

<p><a name="Default-hooks"></a>

<h2 class="appendix">Appendix A Default hooks</h2>

<p>This section contains the entire source code of the standard hook file,
that is built in to the monotone executable, and read before any user
hooks files (unless <samp><span class="option">--nostd</span></samp> is passed).  It contains the
default values for all hooks.

<pre class="verbatim">
-- this is the standard set of lua hooks for monotone;
-- user-provided files can override it or add to it.

function temp_file(namehint)
   local tdir
   tdir = os.getenv("TMPDIR")
   if tdir == nil then tdir = os.getenv("TMP") end
   if tdir == nil then tdir = os.getenv("TEMP") end
   if tdir == nil then tdir = "/tmp" end
   local filename
   if namehint == nil then
      filename = string.format("%s/mtn.XXXXXX", tdir)
   else
      filename = string.format("%s/mtn.%s.XXXXXX", tdir, namehint)
   end
   local name = mkstemp(filename)
   local file = io.open(name, "r+")
   return file, name
end

function execute(path, ...)
   local pid
   local ret = -1
   pid = spawn(path, unpack(arg))
   if (pid ~= -1) then ret, pid = wait(pid) end
   return ret
end

function execute_redirected(stdin, stdout, stderr, path, ...)
   local pid
   local ret = -1
   io.flush();
   pid = spawn_redirected(stdin, stdout, stderr, path, unpack(arg))
   if (pid ~= -1) then ret, pid = wait(pid) end
   return ret
end

-- Wrapper around execute to let user confirm in the case where a subprocess
-- returns immediately
-- This is needed to work around some brokenness with some merge tools
-- (e.g. on OS X)
function execute_confirm(path, ...)
   ret = execute(path, unpack(arg))

   if (ret ~= 0)
   then
      print(gettext("Press enter"))
   else
      print(gettext("Press enter when the subprocess has completed"))
   end
   io.read()
   return ret
end

-- attributes are persistent metadata about files (such as execute
-- bit, ACLs, various special flags) which we want to have set and
-- re-set any time the files are modified. the attributes themselves
-- are stored in the roster associated with the revision. each (f,k,v)
-- attribute triple turns into a call to attr_functions[k](f,v) in lua.

if (attr_init_functions == nil) then
   attr_init_functions = {}
end

attr_init_functions["mtn:execute"] =
   function(filename)
      if (is_executable(filename)) then
        return "true"
      else
        return nil
      end
   end

attr_init_functions["mtn:manual_merge"] =
   function(filename)
      if (binary_file(filename)) then
        return "true" -- binary files must be merged manually
      else
        return nil
      end
   end

if (attr_functions == nil) then
   attr_functions = {}
end

attr_functions["mtn:execute"] =
   function(filename, value)
      if (value == "true") then
         make_executable(filename)
      end
   end

function dir_matches(name, dir)
   -- helper for ignore_file, matching files within dir, or dir itself.
   -- eg for dir of 'CVS', matches CVS/, CVS/*, */CVS/ and */CVS/*
   if (string.find(name, "^" .. dir .. "/")) then return true end
   if (string.find(name, "^" .. dir .. "$")) then return true end
   if (string.find(name, "/" .. dir .. "/")) then return true end
   if (string.find(name, "/" .. dir .. "$")) then return true end
   return false
end

function ignore_file(name)
   -- project specific
   if (ignored_files == nil) then
      ignored_files = {}
      local ignfile = io.open(".mtn-ignore", "r")
      if (ignfile ~= nil) then
         local line = ignfile:read()
         while (line ~= nil) do
            if line ~= "" then
                table.insert(ignored_files, line)
            end
            line = ignfile:read()
         end
         io.close(ignfile)
      end
   end

   local warn_reported_file = false
   for i, line in pairs(ignored_files)
   do
      if (line ~= nil) then
         local pcallstatus, result = pcall(function() 
	    return regex.search(line, name) 
	 end)
         if pcallstatus == true then
            -- no error from the regex.search call
            if result == true then return true end
         else
            -- regex.search had a problem, warn the user their 
            -- .mtn-ignore file syntax is wrong
	    if not warn_reported_file then
	       io.stderr:write("mtn: warning: while matching file '"
	       		       .. name .. "':\n")
	       warn_reported_file = true
	    end
            io.stderr:write(".mtn-ignore:" .. i .. ": warning: " .. result
	    		    .. "\n\t- skipping this regex for "
			    .. "all remaining files.\n")
            ignored_files[i] = nil
         end
      end
   end

   local file_pats = {
      -- c/c++
      "%.a$", "%.so$", "%.o$", "%.la$", "%.lo$", "^core$",
      "/core$", "/core%.%d+$",
      -- java
      "%.class$",
      -- python
      "%.pyc$", "%.pyo$",
      -- gettext
      "%.g?mo$",
      -- intltool
      "%.intltool%-merge%-cache$",
      -- TeX
      "%.aux$",
      -- backup files
      "%.bak$", "%.orig$", "%.rej$", "%~$",
      -- vim creates .foo.swp files
      "%.[^/]*%.swp$",
      -- emacs creates #foo# files
      "%#[^/]*%#$",
      -- other VCSes (where metadata is stored in named files):
      "%.scc$",
      -- desktop/directory configuration metadata
      "^%.DS_Store$", "/%.DS_Store$", "^desktop%.ini$", "/desktop%.ini$"
   }

   local dir_pats = {
      -- autotools detritus:
      "autom4te%.cache", "%.deps", "%.libs",
      -- Cons/SCons detritus:
      "%.consign", "%.sconsign",
      -- other VCSes (where metadata is stored in named dirs):
      "CVS", "%.svn", "SCCS", "_darcs", "%.cdv", "%.git", "%.bzr", "%.hg"
   }

   for _, pat in ipairs(file_pats) do
      if string.find(name, pat) then return true end
   end
   for _, pat in ipairs(dir_pats) do
      if dir_matches(name, pat) then return true end
   end

   return false;
end

-- return true means "binary", false means "text",
-- nil means "unknown, try to guess"
function binary_file(name)
   -- some known binaries, return true
   local bin_pats = {
      "%.gif$", "%.jpe?g$", "%.png$", "%.bz2$", "%.gz$", "%.zip$",
      "%.class$", "%.jar$", "%.war$", "%.ear$"
   }

   -- some known text, return false
   local txt_pats = {
      "%.cc?$", "%.cxx$", "%.hh?$", "%.hxx$", "%.cpp$", "%.hpp$",
      "%.lua$", "%.texi$", "%.sql$", "%.java$"
   }

   local lowname=string.lower(name)
   for _, pat in ipairs(bin_pats) do
      if string.find(lowname, pat) then return true end
   end
   for _, pat in ipairs(txt_pats) do
      if string.find(lowname, pat) then return false end
   end

   -- unknown - read file and use the guess-binary
   -- monotone built-in function
   return guess_binary_file_contents(name)
end

-- given a file name, return a regular expression which will match
-- lines that name top-level constructs in that file, or "", to disable
-- matching.
function get_encloser_pattern(name)
   -- texinfo has special sectioning commands
   if (string.find(name, "%.texi$")) then
      -- sectioning commands in texinfo: @node, @chapter, @top,
      -- @((sub)?sub)?section, @unnumbered(((sub)?sub)?sec)?,
      -- @appendix(((sub)?sub)?sec)?, @(|major|chap|sub(sub)?)heading
      return ("^@("
              .. "node|chapter|top"
              .. "|((sub)?sub)?section"
              .. "|(unnumbered|appendix)(((sub)?sub)?sec)?"
              .. "|(major|chap|sub(sub)?)?heading"
              .. ")")
   end
   -- LaTeX has special sectioning commands.  This rule is applied to ordinary
   -- .tex files too, since there's no reliable way to distinguish those from
   -- latex files anyway, and there's no good pattern we could use for
   -- arbitrary plain TeX anyway.
   if (string.find(name, "%.tex$")
       or string.find(name, "%.ltx$")
       or string.find(name, "%.latex$")) then
      return ("\\\\("
              .. "part|chapter|paragraph|subparagraph"
              .. "|((sub)?sub)?section"
              .. ")")
   end
   -- There's no good way to find section headings in raw text, and trying
   -- just gives distracting output, so don't even try.
   if (string.find(name, "%.txt$")
       or string.upper(name) == "README") then
      return ""
   end
   -- This default is correct surprisingly often -- in pretty much any text
   -- written with code-like indentation.
   return "^[[:alnum:]$_]"
end

function edit_comment(basetext, user_log_message)
   local exe = nil
   if (program_exists_in_path("vi")) then exe = "vi" end
   if (string.sub(get_ostype(), 1, 6) ~= "CYGWIN" and program_exists_in_path("notepad.exe")) then exe = "notepad.exe" end
   local debian_editor = io.open("/usr/bin/editor")
   if (debian_editor ~= nil) then
      debian_editor:close()
      exe = "/usr/bin/editor"
   end
   local visual = os.getenv("VISUAL")
   if (visual ~= nil) then exe = visual end
   local editor = os.getenv("EDITOR")
   if (editor ~= nil) then exe = editor end

   if (exe == nil) then
      io.write("Could not find editor to enter commit message\n"
               .. "Try setting the environment variable EDITOR\n")
      return nil
   end

   local tmp, tname = temp_file()
   if (tmp == nil) then return nil end
   basetext = "MTN: " .. string.gsub(basetext, "\n", "\nMTN: ") .. "\n"
   tmp:write(user_log_message)
   if user_log_message == "" or string.sub(user_log_message, -1) ~= "\n" then
      tmp:write("\n")
   end
   tmp:write(basetext)
   io.close(tmp)

   if (execute(exe, tname) ~= 0) then
      io.write(string.format(gettext("Error running editor '%s' to enter log message\n"),
                             exe))
      os.remove(tname)
      return nil
   end

   tmp = io.open(tname, "r")
   if (tmp == nil) then os.remove(tname); return nil end
   local res = ""
   local line = tmp:read()
   while(line ~= nil) do
      if (not string.find(line, "^MTN:")) then
         res = res .. line .. "\n"
      end
      line = tmp:read()
   end
   io.close(tmp)
   os.remove(tname)
   return res
end


function persist_phrase_ok()
   return true
end


function use_inodeprints()
   return false
end


-- trust evaluation hooks

function intersection(a,b)
   local s={}
   local t={}
   for k,v in pairs(a) do s[v] = 1 end
   for k,v in pairs(b) do if s[v] ~= nil then table.insert(t,v) end end
   return t
end

function get_revision_cert_trust(signers, id, name, val)
   return true
end

function get_manifest_cert_trust(signers, id, name, val)
   return true
end

function get_file_cert_trust(signers, id, name, val)
   return true
end

function accept_testresult_change(old_results, new_results)
   local reqfile = io.open("_MTN/wanted-testresults", "r")
   if (reqfile == nil) then return true end
   local line = reqfile:read()
   local required = {}
   while (line ~= nil)
   do
      required[line] = true
      line = reqfile:read()
   end
   io.close(reqfile)
   for test, res in pairs(required)
   do
      if old_results[test] == true and new_results[test] ~= true
      then
         return false
      end
   end
   return true
end

-- merger support

-- Fields in the mergers structure:
-- cmd       : a function that performs the merge operation using the chosen
--             program, best try.
-- available : a function that checks that the needed program is installed and
--             in $PATH
-- wanted    : a function that checks if the user doesn't want to use this
--             method, and returns false if so.  This should normally return
--             true, but in some cases, especially when the merger is really
--             an editor, the user might have a preference in EDITOR and we
--             need to respect that.
--             NOTE: wanted is only used when the user has NOT defined the
--             `merger' variable or the MTN_MERGE environment variable.
mergers = {}

-- This merger is designed to fail if there are any conflicts without trying to resolve them
mergers.fail = {
   cmd = function (tbl) return false end,
   available = function () return true end,
   wanted = function () return true end
}

mergers.meld = {
   cmd = function (tbl)
      io.write (string.format("\nWARNING: 'meld' was choosen to perform external 3-way merge.\n"..
          "You should merge all changes to *CENTER* file due to limitation of program\n"..
          "arguments.\n\n"))
      local path = "meld"
      local ret = execute(path, tbl.lfile, tbl.afile, tbl.rfile)
      if (ret ~= 0) then
         io.write(string.format(gettext("Error running merger '%s'\n"), path))
         return false
      end
      return tbl.afile
   end ,
   available = function () return program_exists_in_path("meld") end,
   wanted = function () return true end
}

mergers.tortoise = {
   cmd = function (tbl)
      local path = "tortoisemerge"
      local ret = execute(path,
                          string.format("/base:%s", tbl.afile),
                          string.format("/theirs:%s", tbl.lfile),
                          string.format("/mine:%s", tbl.rfile),
                          string.format("/merged:%s", tbl.outfile))
      if (ret ~= 0) then
         io.write(string.format(gettext("Error running merger '%s'\n"), path))
         return false
      end
      return tbl.outfile
   end ,
   available = function() return program_exists_in_path ("tortoisemerge") end,
   wanted = function () return true end
}

mergers.vim = {
   cmd = function (tbl)
      function execute_diff3(mine, yours, out)
	 local diff3_args = {
	    "diff3",
	    "--merge",
	    "--easy-only",
	 }
	 table.insert(diff3_args, string.gsub(mine, "\\", "/") .. "")
	 table.insert(diff3_args, string.gsub(tbl.afile, "\\", "/") .. "")
	 table.insert(diff3_args, string.gsub(yours, "\\", "/") .. "")
      
	 return execute_redirected("", string.gsub(out, "\\", "/"), "", unpack(diff3_args))
      end

      io.write (string.format("\nWARNING: 'vim' was choosen to perform external 3-way merge.\n"..
          "You should merge all changes to *LEFT* file due to limitation of program\n"..
          "arguments.\n\n"))
      
      local vim
      if os.getenv ("DISPLAY") ~= nil and program_exists_in_path ("gvim") then
	 vim = "gvim"
      else
	 vim = "vim"
      end

      local lfile_merged = tbl.lfile .. ".merged"
      local rfile_merged = tbl.rfile .. ".merged"

      -- first merge lfile using diff3
      local ret = execute_diff3(tbl.lfile, tbl.rfile, lfile_merged)
      if ret == 2 then
         io.write(string.format(gettext("Error running diff3 for merger '%s'\n"), vim))
         os.remove(lfile_merged)
	 return false
      end

      -- now merge rfile using diff3
      ret = execute_diff3(tbl.rfile, tbl.lfile, rfile_merged)
      if ret == 2 then
         io.write(string.format(gettext("Error running diff3 for merger '%s'\n"), vim))
         os.remove(lfile_merged)
         os.remove(rfile_merged)
	 return false
      end
      
      os.rename(lfile_merged, tbl.lfile)
      os.rename(rfile_merged, tbl.rfile)
      
      local ret = execute(vim, "-f", "-d", "-c", string.format("file %s", tbl.outfile),
                          tbl.lfile, tbl.rfile)
      if (ret ~= 0) then
         io.write(string.format(gettext("Error running merger '%s'\n"), vim))
         return false
      end
      return tbl.outfile
   end ,
   available =
      function ()
	 return program_exists_in_path("diff3") and
            (program_exists_in_path("vim") or
	    program_exists_in_path("gvim"))
      end ,
   wanted =
      function ()
	 local editor = os.getenv("EDITOR")
	 if editor and
	    not (string.find(editor, "vim") or
		 string.find(editor, "gvim")) then
	    return false
	 end
	 return true
      end
}

mergers.rcsmerge = {
   cmd = function (tbl)
      -- XXX: This is tough - should we check if conflict markers stay or not?
      -- If so, we should certainly give the user some way to still force
      -- the merge to proceed since they can appear in the files (and I saw
      -- that). --pasky
      local merge = os.getenv("MTN_RCSMERGE")
      if execute(merge, tbl.lfile, tbl.afile, tbl.rfile) == 0 then
         copy_text_file(tbl.lfile, tbl.outfile);
         return tbl.outfile
      end
      local ret = execute("vim", "-f", "-c", string.format("file %s", tbl.outfile
),
                          tbl.lfile)
      if (ret ~= 0) then
         io.write(string.format(gettext("Error running merger '%s'\n"), "vim"))
         return false
      end
      return tbl.outfile
   end,
   available =
      function ()
	 local merge = os.getenv("MTN_RCSMERGE")
	 return merge and
	    program_exists_in_path(merge) and program_exists_in_path("vim")
      end ,
   wanted = function () return os.getenv("MTN_RCSMERGE") ~= nil end
}

--  GNU diffutils based merging
mergers.diffutils = {
    --  merge procedure execution
    cmd = function (tbl)
        --  parse options
        local option = {}
        option.partial = false
        option.diff3opts = ""
        option.sdiffopts = ""
        local options = os.getenv("MTN_MERGE_DIFFUTILS")
        if options ~= nil then
            for spec in string.gmatch(options, "%s*(%w[^,]*)%s*,?") do
                local name, value = string.match(spec, "^(%w+)=([^,]*)")
                if name == nil then
                    name = spec
                    value = true
                end
                if type(option[name]) == "nil" then
                    io.write("mtn: " .. string.format(gettext("invalid \"diffutils\" merger option \"%s\""), name) .. "\n")
                    return false
                end
                option[name] = value
            end
        end

        --  determine the diff3(1) command
        local diff3 = {
            "diff3",
            "--merge",
            "--label", string.format("%s [left]",     tbl.left_path ),
            "--label", string.format("%s [ancestor]", tbl.anc_path  ),
            "--label", string.format("%s [right]",    tbl.right_path),
        }
        if option.diff3opts ~= "" then
            for opt in string.gmatch(option.diff3opts, "%s*([^%s]+)%s*") do
                table.insert(diff3, opt)
            end
        end
        table.insert(diff3, string.gsub(tbl.lfile, "\\", "/") .. "")
        table.insert(diff3, string.gsub(tbl.afile, "\\", "/") .. "")
        table.insert(diff3, string.gsub(tbl.rfile, "\\", "/") .. "")

        --  dispatch according to major operation mode
        if option.partial then
            --  partial batch/non-modal 3-way merge "resolution":
            --  simply merge content with help of conflict markers
            io.write("mtn: " .. gettext("3-way merge via GNU diffutils, resolving conflicts via conflict markers") .. "\n")
            local ret = execute_redirected("", string.gsub(tbl.outfile, "\\", "/"), "", unpack(diff3))
            if ret == 2 then
                io.write("mtn: " .. gettext("error running GNU diffutils 3-way difference/merge tool \"diff3\"") .. "\n")
                return false
            end
            return tbl.outfile
        else
            --  real interactive/modal 3/2-way merge resolution:
            --  display 3-way merge conflict and perform 2-way merge resolution
            io.write("mtn: " .. gettext("3-way merge via GNU diffutils, resolving conflicts via interactive prompt") .. "\n")

            --  display 3-way merge conflict (batch)
            io.write("\n")
            io.write("mtn: " .. gettext("---- CONFLICT SUMMARY ------------------------------------------------") .. "\n")
            local ret = execute(unpack(diff3))
            if ret == 2 then
                io.write("mtn: " .. gettext("error running GNU diffutils 3-way difference/merge tool \"diff3\"") .. "\n")
                return false
            end

            --  perform 2-way merge resolution (interactive)
            io.write("\n")
            io.write("mtn: " .. gettext("---- CONFLICT RESOLUTION ---------------------------------------------") .. "\n")
            local sdiff = {
                "sdiff",
                "--diff-program=diff",
                "--suppress-common-lines",
                "--minimal",
                "--output=" .. string.gsub(tbl.outfile, "\\", "/")
            }
            if option.sdiffopts ~= "" then
                for opt in string.gmatch(option.sdiffopts, "%s*([^%s]+)%s*") do
                    table.insert(sdiff, opt)
                end
            end
            table.insert(sdiff, string.gsub(tbl.lfile, "\\", "/") .. "")
            table.insert(sdiff, string.gsub(tbl.rfile, "\\", "/") .. "")
            local ret = execute(unpack(sdiff))
            if ret == 2 then
                io.write("mtn: " .. gettext("error running GNU diffutils 2-way merging tool \"sdiff\"") .. "\n")
                return false
            end
            return tbl.outfile
        end
    end,

    --  merge procedure availability check
    available = function ()
        --  make sure the GNU diffutils tools are available
        return program_exists_in_path("diff3") and
               program_exists_in_path("sdiff") and
               program_exists_in_path("diff");
    end,

    --  merge procedure request check
    wanted = function ()
        --  assume it is requested (if it is available at all)
        return true
    end
}   

mergers.emacs = {
   cmd = function (tbl)
      local emacs
      if program_exists_in_path("xemacs") then
         emacs = "xemacs"
      else
         emacs = "emacs"
      end
      local elisp = "(ediff-merge-files-with-ancestor \"%s\" \"%s\" \"%s\" nil \"%s\")"
      -- Converting backslashes is necessary on Win32 MinGW; emacs
      -- lisp string syntax says '\' is an escape.
      local ret = execute(emacs, "--eval",
                          string.format(elisp,
                          string.gsub (tbl.lfile, "\\", "/"),
                          string.gsub (tbl.rfile, "\\", "/"),
                          string.gsub (tbl.afile, "\\", "/"),
                          string.gsub (tbl.outfile, "\\", "/")))
      if (ret ~= 0) then
         io.write(string.format(gettext("Error running merger '%s'\n"), emacs))
         return false
      end
      return tbl.outfile
   end,
   available =
      function ()
	 return program_exists_in_path("xemacs") or
	    program_exists_in_path("emacs")
      end ,
   wanted =
      function ()
	 local editor = os.getenv("EDITOR")
	 if editor and
	    not (string.find(editor, "emacs") or
		 string.find(editor, "gnu")) then
	    return false
	 end
	 return true
      end
}

mergers.xxdiff = {
   cmd = function (tbl)
      local path = "xxdiff"
      local ret = execute(path,
                        "--title1", tbl.left_path,
                        "--title2", tbl.right_path,
                        "--title3", tbl.merged_path,
                        tbl.lfile, tbl.afile, tbl.rfile,
                        "--merge",
                        "--merged-filename", tbl.outfile,
                        "--exit-with-merge-status")
      if (ret ~= 0) then
         io.write(string.format(gettext("Error running merger '%s'\n"), path))
         return false
      end
      return tbl.outfile
   end,
   available = function () return program_exists_in_path("xxdiff") end,
   wanted = function () return true end
}

mergers.kdiff3 = {
   cmd = function (tbl)
      local path = "kdiff3"
      local ret = execute(path,
                          "--L1", tbl.anc_path,
                          "--L2", tbl.left_path,
                          "--L3", tbl.right_path,
                          tbl.afile, tbl.lfile, tbl.rfile,
                          "--merge",
                          "--o", tbl.outfile)
      if (ret ~= 0) then
         io.write(string.format(gettext("Error running merger '%s'\n"), path))
         return false
      end
      return tbl.outfile
   end,
   available = function () return program_exists_in_path("kdiff3") end,
   wanted = function () return true end
}

mergers.opendiff = {
   cmd = function (tbl)
      local path = "opendiff"
      -- As opendiff immediately returns, let user confirm manually
      local ret = execute_confirm(path,
                                  tbl.lfile,tbl.rfile,
                                  "-ancestor",tbl.afile,
                                  "-merge",tbl.outfile)
      if (ret ~= 0) then
         io.write(string.format(gettext("Error running merger '%s'\n"), path))
         return false
      end
      return tbl.outfile
   end,
   available = function () return program_exists_in_path("opendiff") end,
   wanted = function () return true end
}

function write_to_temporary_file(data, namehint)
   tmp, filename = temp_file(namehint)
   if (tmp == nil) then
      return nil
   end;
   tmp:write(data)
   io.close(tmp)
   return filename
end

function copy_text_file(srcname, destname)
   src = io.open(srcname, "r")
   if (src == nil) then return nil end
   dest = io.open(destname, "w")
   if (dest == nil) then return nil end

   while true do
      local line = src:read()
      if line == nil then break end
      dest:write(line, "\n")
   end

   io.close(dest)
   io.close(src)
end

function read_contents_of_file(filename, mode)
   tmp = io.open(filename, mode)
   if (tmp == nil) then
      return nil
   end
   local data = tmp:read("*a")
   io.close(tmp)
   return data
end

function program_exists_in_path(program)
   return existsonpath(program) == 0
end

function get_preferred_merge3_command (tbl)
   local default_order = {"kdiff3", "xxdiff", "opendiff", "tortoise", "emacs", "vim", "meld", "diffutils"}
   local function existmerger(name)
      local m = mergers[name]
      if type(m) == "table" and m.available(tbl) then
         return m.cmd
      end
      return nil
   end
   local function trymerger(name)
      local m = mergers[name]
      if type(m) == "table" and m.available(tbl) and m.wanted(tbl) then
         return m.cmd
      end
      return nil
   end
   -- Check if there's a merger given by the user.
   local mkey = os.getenv("MTN_MERGE")
   if not mkey then mkey = merger end
   if not mkey and os.getenv("MTN_RCSMERGE") then mkey = "rcsmerge" end
   -- If there was a user-given merger, see if it exists.  If it does, return
   -- the cmd function.  If not, return nil.
   local c
   if mkey then c = existmerger(mkey) end
   if c then return c,mkey end
   if mkey then return nil,mkey end
   -- If there wasn't any user-given merger, take the first that's available
   -- and wanted.
   for _,mkey in ipairs(default_order) do
      c = trymerger(mkey) ; if c then return c,mkey end
   end
end

function merge3 (anc_path, left_path, right_path, merged_path, ancestor, left, right)
   local ret = nil
   local tbl = {}

   tbl.anc_path = anc_path
   tbl.left_path = left_path
   tbl.right_path = right_path

   tbl.merged_path = merged_path
   tbl.afile = nil
   tbl.lfile = nil
   tbl.rfile = nil
   tbl.outfile = nil
   tbl.meld_exists = false
   tbl.lfile = write_to_temporary_file (left, "left")
   tbl.afile = write_to_temporary_file (ancestor, "ancestor")
   tbl.rfile = write_to_temporary_file (right, "right")
   tbl.outfile = write_to_temporary_file ("", "merged")

   if tbl.lfile ~= nil and tbl.rfile ~= nil and tbl.afile ~= nil and tbl.outfile ~= nil
   then
      local cmd,mkey = get_preferred_merge3_command (tbl)
      if cmd ~=nil
      then
         io.write ("mtn: " .. string.format(gettext("executing external 3-way merge via \"%s\" merger\n"), mkey))
         ret = cmd (tbl)
         if not ret then
            ret = nil
         else
            ret = read_contents_of_file (ret, "r")
            if string.len (ret) == 0
            then
               ret = nil
            end
         end
      else
	 if mkey then
	    io.write (string.format("The possible commands for the "..mkey.." merger aren't available.\n"..
                "You may want to check that $MTN_MERGE or the lua variable `merger' is set\n"..
                "to something available.  If you want to use vim or emacs, you can also\n"..
		"set $EDITOR to something appropriate.\n"))
	 else
	    io.write (string.format("No external 3-way merge command found.\n"..
                "You may want to check that $EDITOR is set to an editor that supports 3-way\n"..
                "merge, set this explicitly in your get_preferred_merge3_command hook,\n"..
                "or add a 3-way merge program to your path.\n"))
	 end
      end
   end

   os.remove (tbl.lfile)
   os.remove (tbl.rfile)
   os.remove (tbl.afile)
   os.remove (tbl.outfile)

   return ret
end

-- expansion of values used in selector completion

function expand_selector(str)

   -- something which looks like a generic cert pattern
   if string.find(str, "^[^=]*=.*$")
   then
      return ("c:" .. str)
   end

   -- something which looks like an email address
   if string.find(str, "[%w%-_]+@[%w%-_]+")
   then
      return ("a:" .. str)
   end

   -- something which looks like a branch name
   if string.find(str, "[%w%-]+%.[%w%-]+")
   then
      return ("b:" .. str)
   end

   -- a sequence of nothing but hex digits
   if string.find(str, "^%x+$")
   then
      return ("i:" .. str)
   end

   -- tries to expand as a date
   local dtstr = expand_date(str)
   if  dtstr ~= nil
   then
      return ("d:" .. dtstr)
   end

   return nil
end

-- expansion of a date expression
function expand_date(str)
   -- simple date patterns
   if string.find(str, "^19%d%d%-%d%d")
      or string.find(str, "^20%d%d%-%d%d")
   then
      return (str)
   end

   -- "now"
   if str == "now"
   then
      local t = os.time(os.date('!*t'))
      return os.date("%FT%T", t)
   end

   -- today don't uses the time         # for xgettext's sake, an extra quote
   if str == "today"
   then
      local t = os.time(os.date('!*t'))
      return os.date("%F", t)
   end

   -- "yesterday", the source of all hangovers
   if str == "yesterday"
   then
      local t = os.time(os.date('!*t'))
      return os.date("%F", t - 86400)
   end

   -- "CVS style" relative dates such as "3 weeks ago"
   local trans = {
      minute = 60;
      hour = 3600;
      day = 86400;
      week = 604800;
      month = 2678400;
      year = 31536000
   }
   local pos, len, n, type = string.find(str, "(%d+) ([minutehordaywk]+)s? ago")
   if trans[type] ~= nil
   then
      local t = os.time(os.date('!*t'))
      if trans[type] &lt;= 3600
      then
        return os.date("%FT%T", t - (n * trans[type]))
      else
        return os.date("%F", t - (n * trans[type]))
      end
   end

   return nil
end


external_diff_default_args = "-u"

-- default external diff, works for gnu diff
function external_diff(file_path, data_old, data_new, is_binary, diff_args, rev_old, rev_new)
   local old_file = write_to_temporary_file(data_old);
   local new_file = write_to_temporary_file(data_new);

   if diff_args == nil then diff_args = external_diff_default_args end
   execute("diff", diff_args, "--label", file_path .. "\told", old_file, "--label", file_path .. "\tnew", new_file);

   os.remove (old_file);
   os.remove (new_file);
end

-- netsync permissions hooks (and helper)

function globish_match(glob, str)
      local pcallstatus, result = pcall(function() if (globish.match(glob, str)) then return true else return false end end)
      if pcallstatus == true then
          -- no error
          return result
      else
          -- globish.match had a problem
          return nil
      end
end

function get_netsync_read_permitted(branch, ident)
   local permfile = io.open(get_confdir() .. "/read-permissions", "r")
   if (permfile == nil) then return false end
   local dat = permfile:read("*a")
   io.close(permfile)
   local res = parse_basic_io(dat)
   if res == nil then
      io.stderr:write("file read-permissions cannot be parsed\n")
      return false
   end
   local matches = false
   local cont = false
   for i, item in pairs(res)
   do
      -- legal names: pattern, allow, deny, continue
      if item.name == "pattern" then
         if matches and not cont then return false end
         matches = false
         cont = false
         for j, val in pairs(item.values) do
            if globish_match(val, branch) then matches = true end
         end
      elseif item.name == "allow" then if matches then
         for j, val in pairs(item.values) do
            if val == "*" then return true end
            if val == "" and ident == nil then return true end
            if globish_match(val, ident) then return true end
         end
      end elseif item.name == "deny" then if matches then
         for j, val in pairs(item.values) do
            if val == "*" then return false end
            if val == "" and ident == nil then return false end
            if globish_match(val, ident) then return false end
         end
      end elseif item.name == "continue" then if matches then
         cont = true
         for j, val in pairs(item.values) do
            if val == "false" or val == "no" then cont = false end
         end
      end elseif item.name ~= "comment" then
         io.stderr:write("unknown symbol in read-permissions: " .. item.name .. "\n")
         return false
      end
   end
   return false
end

function get_netsync_write_permitted(ident)
   local permfile = io.open(get_confdir() .. "/write-permissions", "r")
   if (permfile == nil) then
      return false
   end
   local matches = false
   local line = permfile:read()
   while (not matches and line ~= nil) do
      local _, _, ln = string.find(line, "%s*([^%s]*)%s*")
      if ln == "*" then matches = true end
      if globish_match(ln, ident) then matches = true end
      line = permfile:read()
   end
   io.close(permfile)
   return matches
end

-- This is a simple function which assumes you're going to be spawning
-- a copy of mtn, so reuses a common bit at the end for converting
-- local args into remote args. You might need to massage the logic a
-- bit if this doesn't fit your assumptions.

function get_netsync_connect_command(uri, args)

        local argv = nil

        if uri["scheme"] == "ssh"
                and uri["host"]
                and uri["path"] then

                argv = { "ssh" }
                if uri["user"] then
                        table.insert(argv, "-l")
                        table.insert(argv, uri["user"])
                end
                if uri["port"] then
                        table.insert(argv, "-p")
                        table.insert(argv, uri["port"])
                end

                -- ssh://host/~/dir/file.mtn or
                -- ssh://host/~user/dir/file.mtn should be home-relative
                if string.find(uri["path"], "^/~") then
                        uri["path"] = string.sub(uri["path"], 2)
                end

                table.insert(argv, uri["host"])
        end

        if uri["scheme"] == "file" and uri["path"] then
                argv = { }
        end

        if uri["scheme"] == "ssh+ux"
                and uri["host"]
                and uri["path"] then

                argv = { "ssh" }
                if uri["user"] then
                        table.insert(argv, "-l")
                        table.insert(argv, uri["user"])
                end
                if uri["port"] then
                        table.insert(argv, "-p")
                        table.insert(argv, uri["port"])
                end

                -- ssh://host/~/dir/file.mtn or
                -- ssh://host/~user/dir/file.mtn should be home-relative
                if string.find(uri["path"], "^/~") then
                        uri["path"] = string.sub(uri["path"], 2)
                end

                table.insert(argv, uri["host"])
                table.insert(argv, get_remote_unix_socket_command(uri["host"]))
                table.insert(argv, "-")
                table.insert(argv, "UNIX-CONNECT:" .. uri["path"])
        else
            -- start remote monotone process
            if argv then

                    table.insert(argv, get_mtn_command(uri["host"]))

                    if args["debug"] then
                            table.insert(argv, "--debug")
                    else
                            table.insert(argv, "--quiet")
                    end

                    table.insert(argv, "--db")
                    table.insert(argv, uri["path"])
                    table.insert(argv, "serve")
                    table.insert(argv, "--stdio")
                    table.insert(argv, "--no-transport-auth")

            end
        end
        return argv
end

function use_transport_auth(uri)
        if uri["scheme"] == "ssh"
        or uri["scheme"] == "ssh+ux"
        or uri["scheme"] == "file" then
                return false
        else
                return true
        end
end

function get_mtn_command(host)
        return "mtn"
end

function get_remote_unix_socket_command(host)
    return "socat"
end

do
   -- Hook functions are tables containing any of the following 6 items
   -- with associated functions:
   --
   --   startup			Corresponds to note_mtn_startup()
   --   start			Corresponds to note_netsync_start()
   --   revision_received	Corresponds to note_netsync_revision_received()
   --   cert_received		Corresponds to note_netsync_cert_received()
   --   pubkey_received		Corresponds to note_netsync_pubkey_received()
   --   end			Corresponds to note_netsync_end()
   --
   -- Those functions take exactly the same arguments as the corresponding
   -- global functions, but return a different kind of value, a tuple
   -- composed of a return code and a value to be returned back to monotone.
   -- The codes are strings:
   -- "continue" and "stop"
   -- When the code "continue" is returned and there's another notifier, the
   -- second value is ignored and the next notifier is called.  Otherwise,
   -- the second value is returned immediately.
   local hook_functions = {}
   local supported_items = {
      "startup",
      "start", "revision_received", "cert_received", "pubkey_received", "end"
   }

   function _hook_functions_helper(f,...)
      local s = "continue"
      local v = nil
      for _,n in pairs(hook_functions) do
	 if n[f] then
	    s,v = n[f](...)
	 end
	 if s ~= "continue" then
	    break
	 end
      end
      return v
   end
   function note_mtn_startup(...)
      return _hook_functions_helper("startup",...)
   end
   function note_netsync_start(...)
      return _hook_functions_helper("start",...)
   end
   function note_netsync_revision_received(...)
      return _hook_functions_helper("revision_received",...)
   end
   function note_netsync_cert_received(...)
      return _hook_functions_helper("cert_received",...)
   end
   function note_netsync_pubkey_received(...)
      return _hook_functions_helper("pubkey_received",...)
   end
   function note_netsync_end(...)
      return _hook_functions_helper("end",...)
   end

   function add_hook_functions(functions, precedence)
      if type(functions) ~= "table" or type(precedence) ~= "number" then
	 return false, "Invalid type"
      end
      if hook_functions[precedence] then
	 return false, "Precedence already taken"
      end

      local unknown_items = ""
      local warning = nil
      local is_member =
	 function (s,t)
	    for k,v in pairs(t) do if s == v then return true end end
	    return false
	 end

      for n,f in pairs(functions) do
	 if type(n) == "string" then
	    if not is_member(n, supported_items) then
	       if unknown_items ~= "" then
		  unknown_items = unknown_items .. ","
	       end
	       unknown_items = unknown_items .. n
	    end
	    if type(f) ~= "function" then
	       return false, "Value for functions item "..n.." isn't a function"
	    end
	 else
	    warning = "Non-string item keys found in functions table"
	 end
      end

      if warning == nil and unknown_items ~= "" then
	 warning = "Unknown item(s) " .. unknown_items .. " in functions table"
      end

      hook_functions[precedence] = functions
      return true, warning
   end
   function push_hook_functions(functions)
      local n = table.maxn(hook_functions) + 1
      return add_hook_functions(functions, n)
   end

   -- Kept for backward compatibility
   function add_netsync_notifier(notifier, precedence)
      return add_hook_functions(notifier, precedence)
   end
   function push_netsync_notifier(notifier)
      return push_hook_functions(notifier)
   end
end
</pre>
<a name="General-Index"></a>

<h2 class="unnumbered">General Index</h2>

<ul class="index-cp" compact>
<li><a href="#index-accept_005ftestresult_005fchange-_0028_0040var_007bold_005fresults_007d_002c-_0040var_007bnew_005fresults_007d_0029-209"><code>accept_testresult_change (</code><var>old_results</var><code>, </code><var>new_results</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-alias_005fcommand_0028_0040var_007boriginal_007d_002c-_0040var_007balias_007d_0029-219"><code>alias_command(</code><var>original</var><code>, </code><var>alias</var><code>)</code></a>: <a href="#Additional-Lua-Functions">Additional Lua Functions</a></li>
<li><a href="#index-attr_005ffunctions-_005b_0040var_007battribute_007d_005d-_0028_0040var_007bfilename_007d_002c-_0040var_007bvalue_007d_0029-216"><code>attr_functions [</code><var>attribute</var><code>] (</code><var>filename</var><code>, </code><var>value</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-attr_005finit_005ffunctions-_005b_0040var_007battribute_007d_005d-_0028_0040var_007bfilename_007d_0029-217"><code>attr_init_functions [</code><var>attribute</var><code>] (</code><var>filename</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-edit_005fcomment-_0028_0040var_007bcommentary_007d_002c-_0040var_007buser_005flog_005fmessage_007d_0029-198"><code>edit_comment (</code><var>commentary</var><code>, </code><var>user_log_message</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-existonpath_0028_0040var_007bpossible_005fcommand_007d_0029-220"><code>existonpath(</code><var>possible_command</var><code>)</code></a>: <a href="#Additional-Lua-Functions">Additional Lua Functions</a></li>
<li><a href="#index-expand_005fdate-_0028_0040var_007bstr_007d_0029-215"><code>expand_date (</code><var>str</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-expand_005fselector-_0028_0040var_007bstr_007d_0029-214"><code>expand_selector (</code><var>str</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-external_005fdiff-_0028_0040var_007bfile_005fpath_007d_002c-_0040var_007bold_005fdata_007d_002c-_0040var_007bnew_005fdata_007d_002c-_0040var_007bis_005fbinary_007d_002c-_0040var_007bdiff_005fargs_007d_002c-_0040var_007bold_005frev_007d_002c-_0040var_007bnew_005frev_007d_0029-211"><code>external_diff (</code><var>file_path</var><code>, </code><var>old_data</var><code>, </code><var>new_data</var><code>, </code><var>is_binary</var><code>, </code><var>diff_args</var><code>, </code><var>old_rev</var><code>, </code><var>new_rev</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-get_005fauthor-_0028_0040var_007bbranchname_007d_002c-_0040var_007bkeypair_005fid_007d_0029-197"><code>get_author (</code><var>branchname</var><code>, </code><var>keypair_id</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-get_005fbranch_005fkey-_0028_0040var_007bbranchname_007d_0029-194"><code>get_branch_key (</code><var>branchname</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-get_005fconfdir_0028_0029-221"><code>get_confdir()</code></a>: <a href="#Additional-Lua-Functions">Additional Lua Functions</a></li>
<li><a href="#index-get_005fencloser_005fpattern-_0028_0040var_007bfile_005fpath_007d_0029-210"><code>get_encloser_pattern (</code><var>file_path</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-get_005fmtn_005fcommand_0028_0040var_007bhost_007d_0029-207"><code>get_mtn_command(</code><var>host</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-get_005fnetsync_005fconnect_005fcommand-_0028_0040var_007buri_007d_002c-_0040var_007bargs_007d_0029-205"><code>get_netsync_connect_command (</code><var>uri</var><code>, </code><var>args</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-get_005fnetsync_005fkey_0028_0040var_007bserver_007d_002c-_0040var_007binclude_007d_002c-_0040var_007bexclude_007d_0029-195"><code>get_netsync_key(</code><var>server</var><code>, </code><var>include</var><code>, </code><var>exclude</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-get_005fnetsync_005fread_005fpermitted-_0028_0040var_007bbranch_007d_002c-_0040var_007bidentity_007d_0029-203"><code>get_netsync_read_permitted (</code><var>branch</var><code>, </code><var>identity</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-get_005fnetsync_005fwrite_005fpermitted-_0028_0040var_007bidentity_007d_0029-204"><code>get_netsync_write_permitted (</code><var>identity</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-get_005fostype_0028_0029-222"><code>get_ostype()</code></a>: <a href="#Additional-Lua-Functions">Additional Lua Functions</a></li>
<li><a href="#index-get_005fpassphrase-_0028_0040var_007bkeypair_005fid_007d_0029-196"><code>get_passphrase (</code><var>keypair_id</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-get_005fpreferred_005fmerge3_005fcommand_0028_0040var_007btbl_007d_0029-213"><code>get_preferred_merge3_command(</code><var>tbl</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-get_005frevision_005fcert_005ftrust-_0028_0040var_007bsigners_007d_002c-_0040var_007bid_007d_002c-_0040var_007bname_007d_002c-_0040var_007bval_007d_0029-208"><code>get_revision_cert_trust (</code><var>signers</var><code>, </code><var>id</var><code>, </code><var>name</var><code>, </code><var>val</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-guess_005fbinary_005ffile_005fcontents_0028_0040var_007bfilespec_007d_0029-223"><code>guess_binary_file_contents(</code><var>filespec</var><code>)</code></a>: <a href="#Additional-Lua-Functions">Additional Lua Functions</a></li>
<li><a href="#index-ignore_005fbranch-_0028_0040var_007bbranchname_007d_0029-202"><code>ignore_branch (</code><var>branchname</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-ignore_005ffile-_0028_0040var_007bfilename_007d_0029-201"><code>ignore_file (</code><var>filename</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-include_0028_0040var_007bscriptfile_007d_0029-224"><code>include(</code><var>scriptfile</var><code>)</code></a>: <a href="#Additional-Lua-Functions">Additional Lua Functions</a></li>
<li><a href="#index-includedir_0028_0040var_007bscriptpath_007d_0029-225"><code>includedir(</code><var>scriptpath</var><code>)</code></a>: <a href="#Additional-Lua-Functions">Additional Lua Functions</a></li>
<li><a href="#index-includedirpattern_0028_0040var_007bscriptpath_007d_002c-_0040var_007bpattern_007d_0029-226"><code>includedirpattern(</code><var>scriptpath</var><code>, </code><var>pattern</var><code>)</code></a>: <a href="#Additional-Lua-Functions">Additional Lua Functions</a></li>
<li><a href="#index-is_005fexecutable_0028_0040var_007bfilespec_007d_0029-227"><code>is_executable(</code><var>filespec</var><code>)</code></a>: <a href="#Additional-Lua-Functions">Additional Lua Functions</a></li>
<li><a href="#index-kill_0028_0040var_007bpid_007d-_005b_002c-_0040var_007bsignal_007d_005d_0029-228"><code>kill(</code><var>pid</var><code> [, </code><var>signal</var><code>])</code></a>: <a href="#Additional-Lua-Functions">Additional Lua Functions</a></li>
<li><a href="#index-make_005fexecutable_0028_0040var_007bfilespec_007d_0029-229"><code>make_executable(</code><var>filespec</var><code>)</code></a>: <a href="#Additional-Lua-Functions">Additional Lua Functions</a></li>
<li><a href="#index-match_0028_0040var_007bglob_007d_002c-_0040var_007bstring_007d_0029-230"><code>match(</code><var>glob</var><code>, </code><var>string</var><code>)</code></a>: <a href="#Additional-Lua-Functions">Additional Lua Functions</a></li>
<li><a href="#index-merge3-_0028_0040var_007bancestor_005fpath_007d_002c-_0040var_007bleft_005fpath_007d_002c-_0040var_007bright_005fpath_007d_002c-_0040var_007bmerged_005fpath_007d_002c-_0040var_007bancestor_005ftext_007d_002c-_0040var_007bleft_005ftext_007d_002c-_0040var_007bright_005ftext_007d_0029-212"><code>merge3 (</code><var>ancestor_path</var><code>, </code><var>left_path</var><code>, </code><var>right_path</var><code>, </code><var>merged_path</var><code>, </code><var>ancestor_text</var><code>, </code><var>left_text</var><code>, </code><var>right_text</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-mkstemp_0028_0040var_007btemplate_007d_0029-231"><code>mkstemp(</code><var>template</var><code>)</code></a>: <a href="#Additional-Lua-Functions">Additional Lua Functions</a></li>
<li><a href="#index-mtn-_002d_002dbranch_003d_0040var_007bbranchname_007d-checkout-_0040var_007bdirectory_007d-5"><code>mtn --branch=</code><var>branchname</var><code> checkout </code><var>directory</var></a>: <a href="#Tree">Tree</a></li>
<li><a href="#index-mtn-_002d_002dbranch_003d_0040var_007bbranchname_007d-co-_0040var_007bdirectory_007d-6"><code>mtn --branch=</code><var>branchname</var><code> co </code><var>directory</var></a>: <a href="#Tree">Tree</a></li>
<li><a href="#index-mtn-_005b_002d_002dbookkeep_002donly_005d-drop-_0040var_007bpathname_002e_002e_002e_007d-20"><code>mtn [--bookkeep-only] drop </code><var>pathname...</var></a>: <a href="#Workspace">Workspace</a></li>
<li><a href="#index-mtn-_005b_002d_002dbookkeep_002donly_005d-mv-_0040var_007bsrc_007d-_0040var_007bdst_007d-23"><code>mtn [--bookkeep-only] mv </code><var>src</var> <var>dst</var></a>: <a href="#Workspace">Workspace</a></li>
<li><a href="#index-mtn-_005b_002d_002dbookkeep_002donly_005d-mv-_0040var_007bsrc1_007d-_0040var_007b_002e_002e_002e_007d-_0040var_007bdst_002f_007d-25"><code>mtn [--bookkeep-only] mv </code><var>src1</var> <var>...</var> <var>dst/</var></a>: <a href="#Workspace">Workspace</a></li>
<li><a href="#index-mtn-_005b_002d_002dbookkeep_002donly_005d-rename-_0040var_007bsrc_007d-_0040var_007bdst_007d-22"><code>mtn [--bookkeep-only] rename </code><var>src</var> <var>dst</var></a>: <a href="#Workspace">Workspace</a></li>
<li><a href="#index-mtn-_005b_002d_002dbookkeep_002donly_005d-rename-_0040var_007bsrc1_007d-_0040var_007b_002e_002e_002e_007d-_0040var_007bdst_002f_007d-24"><code>mtn [--bookkeep-only] rename </code><var>src1</var> <var>...</var> <var>dst/</var></a>: <a href="#Workspace">Workspace</a></li>
<li><a href="#index-mtn-_005b_002d_002dno_002drespect_002dignore_005d-mkdir-_0040var_007bdirectory_002e_002e_002e_007d-19"><code>mtn [--no-respect-ignore] mkdir </code><var>directory...</var></a>: <a href="#Workspace">Workspace</a></li>
<li><a href="#index-mtn-add-_002d_002dunknown-18"><code>mtn add --unknown</code></a>: <a href="#Workspace">Workspace</a></li>
<li><a href="#index-mtn-add-_0040var_007bpathname_002e_002e_002e_007d-17"><code>mtn add </code><var>pathname...</var></a>: <a href="#Workspace">Workspace</a></li>
<li><a href="#index-mtn-annotate-_005b_002d_002drevision_003d_0040var_007bid_007d_005d-_005b_002d_002drevs_002donly_005d-_0040var_007bfile_007d-56"><code>mtn annotate [--revision=</code><var>id</var><code>] [--revs-only] </code><var>file</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-annotate-_0040var_007bfile_007d-55"><code>mtn annotate </code><var>file</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-approve-_0040var_007bid_007d-111"><code>mtn approve </code><var>id</var></a>: <a href="#Certificate">Certificate</a></li>
<li><a href="#index-mtn-automate-ancestors-_0040var_007brev1_007d-_005b_0040var_007brev2_007d-_005b_002e_002e_002e_005d_005d-141"><code>mtn automate ancestors </code><var>rev1</var><code> [</code><var>rev2</var><code> [...]]</code></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-ancestry_005fdifference-_0040var_007bnew_007d-_005b_0040var_007bold1_007d-_005b_0040var_007bold2_007d-_005b_002e_002e_002e_005d_005d_005d-149"><code>mtn automate ancestry_difference </code><var>new</var><code> [</code><var>old1</var><code> [</code><var>old2</var><code> [...]]]</code></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-branches-152"><code>mtn automate branches</code></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-cert-_0040var_007brevision_007d-_0040var_007bname_007d-_0040var_007bvalue_007d-184"><code>mtn automate cert </code><var>revision</var> <var>name</var> <var>value</var></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-certs-_0040var_007bid_007d-157"><code>mtn automate certs </code><var>id</var></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-children-_0040var_007brev_007d-145"><code>mtn automate children </code><var>rev</var></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-common_005fancestors-_0040var_007brev1_007d-_005b_0040var_007brev2_007d-_005b_002e_002e_002e_005d_005d-142"><code>mtn automate common_ancestors </code><var>rev1</var><code> [</code><var>rev2</var><code> [...]]</code></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-content_005fdiff-_005b_002d_002drevision_003d_0040var_007bid1_007d-_005b_002d_002drevision_003d_0040var_007bid2_007d_005d_005d-_005b_0040var_007bfiles_007d-_002e_002e_002e_005d-168"><code>mtn automate content_diff [--revision=</code><var>id1</var><code> [--revision=</code><var>id2</var><code>]] [</code><var>files</var><code> ...]</code></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-descendents-_0040var_007brev1_007d-_005b_0040var_007brev2_007d-_005b_002e_002e_002e_005d_005d-144"><code>mtn automate descendents </code><var>rev1</var><code> [</code><var>rev2</var><code> [...]]</code></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-drop_005fattribute-_0040var_007bpath_007d-_005b_0040var_007bkey_007d_005d-167"><code>mtn automate drop_attribute </code><var>path</var><code> [</code><var>key</var><code>]</code></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-drop_005fdb_005fvariables-_0040var_007bdomain_007d-_005b_0040var_007bname_007d_005d-181"><code>mtn automate drop_db_variables </code><var>domain</var><code> [</code><var>name</var><code>]</code></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-erase_005fancestors-_005b_0040var_007brev1_007d-_005b_0040var_007brev2_007d-_005b_002e_002e_002e_005d_005d_005d-147"><code>mtn automate erase_ancestors [</code><var>rev1</var><code> [</code><var>rev2</var><code> [...]]]</code></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-get_005fattributes-_0040var_007bpath_007d-165"><code>mtn automate get_attributes </code><var>path</var></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-get_005fbase_005frevision_005fid-161"><code>mtn automate get_base_revision_id</code></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-get_005fcontent_005fchanged-_0040var_007bid_007d-_0040var_007bfile_007d-177"><code>mtn automate get_content_changed </code><var>id</var> <var>file</var></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-get_005fcorresponding_005fpath-_0040var_007bsource_005fid_007d-_0040var_007bfile_007d-_0040var_007btarget_005fid_007d-178"><code>mtn automate get_corresponding_path </code><var>source_id</var> <var>file</var> <var>target_id</var></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-get_005fcurrent_005frevision-_005b_002d_002dexclude-_0040var_007bexcl_007d_005d-_005b_002d_002ddepth_003d_0040var_007bdepth_007d_005d-_005b_0040var_007bpath_007d-_002e_002e_002e_005d-160"><code>mtn automate get_current_revision [--exclude </code><var>excl</var><code>] [--depth=</code><var>depth</var><code>] [</code><var>path</var><code> ...]</code></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-get_005fcurrent_005frevision_005fid-162"><code>mtn automate get_current_revision_id</code></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-get_005fdb_005fvariables-_005b_0040var_007bdomain_007d_005d-179"><code>mtn automate get_db_variables [</code><var>domain</var><code>]</code></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-get_005ffile-_0040var_007bid_007d-169"><code>mtn automate get_file </code><var>id</var></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-get_005ffile_005fof-_0040var_007bfilename_007d-_005b_002d_002drevision_003d_0040var_007bid_007d_005d-170"><code>mtn automate get_file_of </code><var>filename</var><code> [--revision=</code><var>id</var><code>]</code></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-get_005fmanifest_005fof-163"><code>mtn automate get_manifest_of</code></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-get_005fmanifest_005fof-_0040var_007brevid_007d-164"><code>mtn automate get_manifest_of </code><var>revid</var></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-get_005foption-_0040var_007boption_007d-171"><code>mtn automate get_option </code><var>option</var></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-get_005frevision-_0040var_007bid_007d-159"><code>mtn automate get_revision </code><var>id</var></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-graph-146"><code>mtn automate graph</code></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-heads-_005b_0040var_007bbranch_007d_005d-140"><code>mtn automate heads [</code><var>branch</var><code>]</code></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-identify-_0040var_007bpath_007d-155"><code>mtn automate identify </code><var>path</var></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-interface_005fversion-139"><code>mtn automate interface_version</code></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-inventory-_005b_0040option_007boptions_002e_002e_002e_007d_005d-_005b_0040var_007bfiles_002e_002e_002e_007d_005d-156"><code>mtn automate inventory [</code><samp><span class="option">options...</span></samp><code>] [</code><var>files...</var><code>]</code></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-keys-172"><code>mtn automate keys</code></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-leaves-150"><code>mtn automate leaves</code></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-packet_005ffor_005fcerts-_0040var_007bid_007d-174"><code>mtn automate packet_for_certs </code><var>id</var></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-packet_005ffor_005ffdata-_0040var_007bid_007d-175"><code>mtn automate packet_for_fdata </code><var>id</var></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-packet_005ffor_005ffdata-_0040var_007bid_007d-119"><code>mtn automate packet_for_fdata </code><var>id</var></a>: <a href="#Packet-I_002fO">Packet I/O</a></li>
<li><a href="#index-mtn-automate-packet_005ffor_005ffdelta-_0040var_007bfrom_002did_007d-_0040var_007bto_002did_007d-176"><code>mtn automate packet_for_fdelta </code><var>from-id</var> <var>to-id</var></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-packet_005ffor_005ffdelta-_0040var_007bid1_007d-_0040var_007bid2_007d-121"><code>mtn automate packet_for_fdelta </code><var>id1</var> <var>id2</var></a>: <a href="#Packet-I_002fO">Packet I/O</a></li>
<li><a href="#index-mtn-automate-packet_005ffor_005frdata-_0040var_007bid_007d-173"><code>mtn automate packet_for_rdata </code><var>id</var></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-packet_005ffor_005frdata-_0040var_007bid_007d-120"><code>mtn automate packet_for_rdata </code><var>id</var></a>: <a href="#Packet-I_002fO">Packet I/O</a></li>
<li><a href="#index-mtn-automate-packets_005ffor_005fcerts-_0040var_007bid_007d-118"><code>mtn automate packets_for_certs </code><var>id</var></a>: <a href="#Packet-I_002fO">Packet I/O</a></li>
<li><a href="#index-mtn-automate-parents-_0040var_007brev_007d-143"><code>mtn automate parents </code><var>rev</var></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-put_005ffile-_005b_0040var_007bbase_002did_007d_005d-_0040var_007bcontents_007d-182"><code>mtn automate put_file [</code><var>base-id</var><code>] </code><var>contents</var></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-put_005frevision-_0040var_007brevision_002ddata_007d-183"><code>mtn automate put_revision </code><var>revision-data</var></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-roots-151"><code>mtn automate roots</code></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-select-_0040var_007bselector_007d-154"><code>mtn automate select </code><var>selector</var></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-set_005fattribute-_0040var_007bpath_007d-_0040var_007bkey_007d-_0040var_007bvalue_007d-166"><code>mtn automate set_attribute </code><var>path</var> <var>key</var> <var>value</var></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-set_005fdb_005fvariable-_0040var_007bdomain_007d-_0040var_007bname_007d-_0040var_007bvalue_007d-180"><code>mtn automate set_db_variable </code><var>domain</var> <var>name</var> <var>value</var></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-stdio-158"><code>mtn automate stdio</code></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-tags-_005b_0040var_007bbranch_005fpattern_007d_005d-153"><code>mtn automate tags [</code><var>branch_pattern</var><code>]</code></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-automate-toposort-_005b_0040var_007brev1_007d-_005b_0040var_007brev2_007d-_005b_002e_002e_002e_005d_005d_005d-148"><code>mtn automate toposort [</code><var>rev1</var><code> [</code><var>rev2</var><code> [...]]]</code></a>: <a href="#Automation">Automation</a></li>
<li><a href="#index-mtn-cat-_002d_002drevision_003d_0040var_007bid_007d-_0040var_007bpath_007d-2"><code>mtn cat --revision=</code><var>id</var> <var>path</var></a>: <a href="#Tree">Tree</a></li>
<li><a href="#index-mtn-cat-_0040var_007bpath_007d-1"><code>mtn cat </code><var>path</var></a>: <a href="#Tree">Tree</a></li>
<li><a href="#index-mtn-cert-_0040var_007bid_007d-_0040var_007bcertname_007d-109"><code>mtn cert </code><var>id</var> <var>certname</var></a>: <a href="#Certificate">Certificate</a></li>
<li><a href="#index-mtn-cert-_0040var_007bid_007d-_0040var_007bcertname_007d-_0040var_007bcertval_007d-110"><code>mtn cert </code><var>id</var> <var>certname</var> <var>certval</var></a>: <a href="#Certificate">Certificate</a></li>
<li><a href="#index-mtn-checkout-_002d_002drevision_003d_0040var_007bid_007d-_0040var_007bdirectory_007d-3"><code>mtn checkout --revision=</code><var>id</var> <var>directory</var></a>: <a href="#Tree">Tree</a></li>
<li><a href="#index-mtn-ci-27"><code>mtn ci</code></a>: <a href="#Workspace">Workspace</a></li>
<li><a href="#index-mtn-ci-_002d_002dmessage_002dfile_003d_0040var_007blogfile_007d-31"><code>mtn ci --message-file=</code><var>logfile</var></a>: <a href="#Workspace">Workspace</a></li>
<li><a href="#index-mtn-ci-_002d_002dmessage_002dfile_003d_0040var_007blogfile_007d-_0040var_007bpathname_002e_002e_002e_007d-37"><code>mtn ci --message-file=</code><var>logfile</var> <var>pathname...</var></a>: <a href="#Workspace">Workspace</a></li>
<li><a href="#index-mtn-ci-_002d_002dmessage_003d_0040var_007blogmsg_007d-_005b_002d_002dmessage_003d_0040var_007blogmsg_007d_002e_002e_002e_005d-29"><code>mtn ci --message=</code><var>logmsg</var><code> [--message=</code><var>logmsg</var><code>...]</code></a>: <a href="#Workspace">Workspace</a></li>
<li><a href="#index-mtn-ci-_002d_002dmessage_003d_0040var_007blogmsg_007d-_005b_002d_002dmessage_003d_0040var_007blogmsg_007d_002e_002e_002e_005d-_0040var_007bpathname_002e_002e_002e_007d-35"><code>mtn ci --message=</code><var>logmsg</var><code> [--message=</code><var>logmsg</var><code>...] </code><var>pathname...</var></a>: <a href="#Workspace">Workspace</a></li>
<li><a href="#index-mtn-ci-_0040var_007bpathname_002e_002e_002e_007d-33"><code>mtn ci </code><var>pathname...</var></a>: <a href="#Workspace">Workspace</a></li>
<li><a href="#index-mtn-clone-_002d_002dbranch_003d_0040var_007bbranchname_007d-_0040var_007baddress_007d-_0040var_007bdirectory_007d-7"><code>mtn clone --branch=</code><var>branchname</var> <var>address</var> <var>directory</var></a>: <a href="#Tree">Tree</a></li>
<li><a href="#index-mtn-co-_002d_002drevision_003d_0040var_007bid_007d-_0040var_007bdirectory_007d-4"><code>mtn co --revision=</code><var>id</var> <var>directory</var></a>: <a href="#Tree">Tree</a></li>
<li><a href="#index-mtn-comment-_0040var_007bid_007d-112"><code>mtn comment </code><var>id</var></a>: <a href="#Certificate">Certificate</a></li>
<li><a href="#index-mtn-comment-_0040var_007bid_007d-_0040var_007bcomment_007d-113"><code>mtn comment </code><var>id</var> <var>comment</var></a>: <a href="#Certificate">Certificate</a></li>
<li><a href="#index-mtn-commit-26"><code>mtn commit</code></a>: <a href="#Workspace">Workspace</a></li>
<li><a href="#index-mtn-commit-_002d_002dmessage_002dfile_003d_0040var_007blogfile_007d-30"><code>mtn commit --message-file=</code><var>logfile</var></a>: <a href="#Workspace">Workspace</a></li>
<li><a href="#index-mtn-commit-_002d_002dmessage_002dfile_003d_0040var_007blogfile_007d-_0040var_007bpathname_002e_002e_002e_007d-36"><code>mtn commit --message-file=</code><var>logfile</var> <var>pathname...</var></a>: <a href="#Workspace">Workspace</a></li>
<li><a href="#index-mtn-commit-_002d_002dmessage_003d_0040var_007blogmsg_007d-_005b_002d_002dmessage_003d_0040var_007blogmsg_007d_002e_002e_002e_005d-28"><code>mtn commit --message=</code><var>logmsg</var><code> [--message=</code><var>logmsg</var><code>...]</code></a>: <a href="#Workspace">Workspace</a></li>
<li><a href="#index-mtn-commit-_002d_002dmessage_003d_0040var_007blogmsg_007d-_005b_002d_002dmessage_003d_0040var_007blogmsg_007d_002e_002e_002e_005d-_0040var_007bpathname_002e_002e_002e_007d-34"><code>mtn commit --message=</code><var>logmsg</var><code> [--message=</code><var>logmsg</var><code>...] </code><var>pathname...</var></a>: <a href="#Workspace">Workspace</a></li>
<li><a href="#index-mtn-commit-_0040var_007bpathname_002e_002e_002e_007d-32"><code>mtn commit </code><var>pathname...</var></a>: <a href="#Workspace">Workspace</a></li>
<li><a href="#index-mtn-complete-_005b_002d_002dbrief_005d-key-_0040var_007bpartial_002did_007d-58"><code>mtn complete [--brief] key </code><var>partial-id</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-complete-_005b_002d_002dbrief_005d-revision-_0040var_007bpartial_002did_007d-59"><code>mtn complete [--brief] revision </code><var>partial-id</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-complete-file-_0040var_007bpartial_002did_007d-57"><code>mtn complete file </code><var>partial-id</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-cvs_005fimport-_0040var_007bpathname_007d-186"><code>mtn cvs_import </code><var>pathname</var></a>: <a href="#RCS">RCS</a></li>
<li><a href="#index-mtn-db-check-_002d_002ddb_003d_0040var_007bdbfile_007d-134"><code>mtn db check --db=</code><var>dbfile</var></a>: <a href="#Database">Database</a></li>
<li><a href="#index-mtn-db-dump-_002d_002ddb_003d_0040var_007bdbfile_007d-131"><code>mtn db dump --db=</code><var>dbfile</var></a>: <a href="#Database">Database</a></li>
<li><a href="#index-mtn-db-execute-_0040var_007bsql_002dstatement_007d-138"><code>mtn db execute </code><var>sql-statement</var></a>: <a href="#Database">Database</a></li>
<li><a href="#index-mtn-db-info-_002d_002ddb_003d_0040var_007bdbfile_007d-129"><code>mtn db info --db=</code><var>dbfile</var></a>: <a href="#Database">Database</a></li>
<li><a href="#index-mtn-db-init-_002d_002ddb_003d_0040var_007bdbfile_007d-128"><code>mtn db init --db=</code><var>dbfile</var></a>: <a href="#Database">Database</a></li>
<li><a href="#index-mtn-db-kill_005fbranch_005fcerts_005flocally-_0040var_007bbranch_007d-136"><code>mtn db kill_branch_certs_locally </code><var>branch</var></a>: <a href="#Database">Database</a></li>
<li><a href="#index-mtn-db-kill_005frev_005flocally-_0040var_007bid_007d-135"><code>mtn db kill_rev_locally </code><var>id</var></a>: <a href="#Database">Database</a></li>
<li><a href="#index-mtn-db-kill_005ftag_005flocally-_0040var_007btag_007d-137"><code>mtn db kill_tag_locally </code><var>tag</var></a>: <a href="#Database">Database</a></li>
<li><a href="#index-mtn-db-load-_002d_002ddb_003d_0040var_007bdbfile_007d-132"><code>mtn db load --db=</code><var>dbfile</var></a>: <a href="#Database">Database</a></li>
<li><a href="#index-mtn-db-migrate-_002d_002ddb_003d_0040var_007bdbfile_007d-133"><code>mtn db migrate --db=</code><var>dbfile</var></a>: <a href="#Database">Database</a></li>
<li><a href="#index-mtn-db-version-_002d_002ddb_003d_0040var_007bdbfile_007d-130"><code>mtn db version --db=</code><var>dbfile</var></a>: <a href="#Database">Database</a></li>
<li><a href="#index-mtn-diff-_002d_002dcontext-_005b_002d_002dshow_002dencloser_005d-61"><code>mtn diff --context [--show-encloser]</code></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-diff-_002d_002dexternal-_005b_002d_002ddiff_002dargs_003d_0040var_007bargstring_007d_005d-62"><code>mtn diff --external [--diff-args=</code><var>argstring</var><code>]</code></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-diff-_002d_002drevision_003d_0040var_007bid_007d-64"><code>mtn diff --revision=</code><var>id</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-diff-_002d_002drevision_003d_0040var_007bid_007d-_0040var_007bpathname_002e_002e_002e_007d-65"><code>mtn diff --revision=</code><var>id</var> <var>pathname...</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-diff-_002d_002drevision_003d_0040var_007bid1_007d-_002d_002drevision_003d_0040var_007bid2_007d-66"><code>mtn diff --revision=</code><var>id1</var><code> --revision=</code><var>id2</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-diff-_002d_002drevision_003d_0040var_007bid1_007d-_002d_002drevision_003d_0040var_007bid2_007d-_0040var_007bpathname_002e_002e_002e_007d-67"><code>mtn diff --revision=</code><var>id1</var><code> --revision=</code><var>id2</var> <var>pathname...</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-diff-_005b_002d_002dunified_005d-_005b_002d_002dshow_002dencloser_005d-60"><code>mtn diff [--unified] [--show-encloser]</code></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-diff-_0040var_007bpathname_002e_002e_002e_007d-63"><code>mtn diff </code><var>pathname...</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-disapprove-_0040var_007bid_007d-8"><code>mtn disapprove </code><var>id</var></a>: <a href="#Tree">Tree</a></li>
<li><a href="#index-mtn-drop-_002d_002dmissing-21"><code>mtn drop --missing</code></a>: <a href="#Workspace">Workspace</a></li>
<li><a href="#index-mtn-dropkey-_0040var_007bkeyid_007d-104"><code>mtn dropkey </code><var>keyid</var></a>: <a href="#Key-and-Cert-Trust">Key and Cert Trust</a></li>
<li><a href="#index-mtn-explicit_005fmerge-_0040var_007bid_007d-_0040var_007bid_007d-_0040var_007bdestbranch_007d-12"><code>mtn explicit_merge </code><var>id</var> <var>id</var> <var>destbranch</var></a>: <a href="#Tree">Tree</a></li>
<li><a href="#index-mtn-genkey-_0040var_007bkeyid_007d-103"><code>mtn genkey </code><var>keyid</var></a>: <a href="#Key-and-Cert-Trust">Key and Cert Trust</a></li>
<li><a href="#index-mtn-heads-_002d_002dbranch_003d_0040var_007bbranchname_007d-9"><code>mtn heads --branch=</code><var>branchname</var></a>: <a href="#Tree">Tree</a></li>
<li><a href="#index-mtn-import-_002d_002dbranch_003d_0040var_007bbranch_007d-_005b_002d_002dmessage_003d_0040var_007bmessage_007d_005d-_005b_002d_002ddry_002drun_005d-_0040var_007bdir_007d-14"><code>mtn import --branch=</code><var>branch</var><code> [--message=</code><var>message</var><code>] [--dry-run] </code><var>dir</var></a>: <a href="#Tree">Tree</a></li>
<li><a href="#index-mtn-import-_002d_002drevision_003d_0040var_007brevision_007d-_005b_002d_002dmessage_003d_0040var_007bmessage_007d_005d-_005b_002d_002ddry_002drun_005d-_0040var_007bdir_007d-15"><code>mtn import --revision=</code><var>revision</var><code> [--message=</code><var>message</var><code>] [--dry-run] </code><var>dir</var></a>: <a href="#Tree">Tree</a></li>
<li><a href="#index-mtn-list-branches-74"><code>mtn list branches</code></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-list-certs-_0040var_007bid_007d-68"><code>mtn list certs </code><var>id</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-list-changed-98"><code>mtn list changed</code></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-list-changed-_0040var_007bpathname_002e_002e_002e_007d-100"><code>mtn list changed </code><var>pathname...</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-list-ignored-90"><code>mtn list ignored</code></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-list-ignored-_0040var_007bpathname_002e_002e_002e_007d-92"><code>mtn list ignored </code><var>pathname...</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-list-keys-70"><code>mtn list keys</code></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-list-keys-_0040var_007bpattern_007d-72"><code>mtn list keys </code><var>pattern</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-list-known-82"><code>mtn list known</code></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-list-known-_0040var_007bpathname_002e_002e_002e_007d-84"><code>mtn list known </code><var>pathname...</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-list-missing-94"><code>mtn list missing</code></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-list-missing-_0040var_007bpathname_002e_002e_002e_007d-96"><code>mtn list missing </code><var>pathname...</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-list-tags-76"><code>mtn list tags</code></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-list-unknown-86"><code>mtn list unknown</code></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-list-unknown-_0040var_007bpathname_002e_002e_002e_007d-88"><code>mtn list unknown </code><var>pathname...</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-list-vars-78"><code>mtn list vars</code></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-list-vars-_0040var_007bdomain_007d-80"><code>mtn list vars </code><var>domain</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-log-53"><code>mtn log</code></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-log-_005b_002d_002dlast_003d_0040var_007bn_007d_005d-_005b_002d_002dnext_003d_0040var_007bn_007d_005d-_005b_002d_002dfrom_003d_0040var_007bid_007d-_005b_002e_002e_002e_005d_005d-_005b_002d_002dto_003d_0040var_007bid_007d-_005b_002e_002e_002e_005d_005d-_005b_002d_002dbrief_005d-_005b_002d_002dno_002dmerges_005d-_005b_002d_002dno_002dfiles_005d-_005b_002d_002ddiffs_005d-_005b_0040var_007bfile_007d-_005b_002e_002e_002e_005d_005d-54"><code>mtn log [--last=</code><var>n</var><code>] [--next=</code><var>n</var><code>] [--from=</code><var>id</var><code> [...]] [--to=</code><var>id</var><code> [...]] [--brief] [--no-merges] [--no-files] [--diffs] [</code><var>file</var><code> [...]]</code></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-ls-branches-75"><code>mtn ls branches</code></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-ls-certs-_0040var_007bid_007d-69"><code>mtn ls certs </code><var>id</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-ls-changed-99"><code>mtn ls changed</code></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-ls-changed-_0040var_007bpathname_002e_002e_002e_007d-101"><code>mtn ls changed </code><var>pathname...</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-ls-ignored-91"><code>mtn ls ignored</code></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-ls-ignored-_0040var_007bpathname_002e_002e_002e_007d-93"><code>mtn ls ignored </code><var>pathname...</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-ls-keys-71"><code>mtn ls keys</code></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-ls-keys-_0040var_007bpattern_007d-73"><code>mtn ls keys </code><var>pattern</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-ls-known-83"><code>mtn ls known</code></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-ls-known-_0040var_007bpathname_002e_002e_002e_007d-85"><code>mtn ls known </code><var>pathname...</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-ls-missing-95"><code>mtn ls missing</code></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-ls-missing-_0040var_007bpathname_002e_002e_002e_007d-97"><code>mtn ls missing </code><var>pathname...</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-ls-tags-77"><code>mtn ls tags</code></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-ls-unknown-87"><code>mtn ls unknown</code></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-ls-unknown-_0040var_007bpathname_002e_002e_002e_007d-89"><code>mtn ls unknown </code><var>pathname...</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-ls-vars-79"><code>mtn ls vars</code></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-ls-vars-_0040var_007bdomain_007d-81"><code>mtn ls vars </code><var>domain</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-merge-_005b_002d_002dbranch_003d_0040var_007bbranchname_007d_005d-10"><code>mtn merge [--branch=</code><var>branchname</var><code>]</code></a>: <a href="#Tree">Tree</a></li>
<li><a href="#index-mtn-merge_005finto_005fdir-_0040var_007bsourcebranch_007d-_0040var_007bdestbranch_007d-_0040var_007bdir_007d-13"><code>mtn merge_into_dir </code><var>sourcebranch</var> <var>destbranch</var> <var>dir</var></a>: <a href="#Tree">Tree</a></li>
<li><a href="#index-mtn-passphrase-_0040var_007bid_007d-105"><code>mtn passphrase </code><var>id</var></a>: <a href="#Key-and-Cert-Trust">Key and Cert Trust</a></li>
<li><a href="#index-mtn-pivot_005froot-_005b_002d_002dbookkeep_002donly_005d-pivot_005froot-_0040var_007bnew_005froot_007d-_0040var_007bput_005fold_007d-45"><code>mtn pivot_root [--bookkeep-only] pivot_root </code><var>new_root</var> <var>put_old</var></a>: <a href="#Workspace">Workspace</a></li>
<li><a href="#index-mtn-pluck-_002d_002drevision_003d_0040var_007bfrom_007d-_002d_002drevision_003d_0040var_007bto_007d-43"><code>mtn pluck --revision=</code><var>from</var><code> --revision=</code><var>to</var></a>: <a href="#Workspace">Workspace</a></li>
<li><a href="#index-mtn-pluck-_002d_002drevision_003d_0040var_007bto_007d-42"><code>mtn pluck --revision=</code><var>to</var></a>: <a href="#Workspace">Workspace</a></li>
<li><a href="#index-mtn-privkey-_0040var_007bkeyid_007d-122"><code>mtn privkey </code><var>keyid</var></a>: <a href="#Packet-I_002fO">Packet I/O</a></li>
<li><a href="#index-mtn-propagate-_0040var_007bsourcebranch_007d-_0040var_007bdestbranch_007d-11"><code>mtn propagate </code><var>sourcebranch</var> <var>destbranch</var></a>: <a href="#Tree">Tree</a></li>
<li><a href="#index-mtn-pubkey-_0040var_007bkeyid_007d-123"><code>mtn pubkey </code><var>keyid</var></a>: <a href="#Packet-I_002fO">Packet I/O</a></li>
<li><a href="#index-mtn-pull-_005b_002d_002dset_002ddefault_005d-_005b_0040var_007buri_002dor_002daddress_007d_005d-_005b_0040var_007bglob_007d-_005b_002e_002e_002e_005d-_005b_002d_002dexclude_003d_0040var_007bexclude_002dglob_007d_005d_005d_005d-48"><code>mtn pull [--set-default] [</code><var>uri-or-address</var><code>] [</code><var>glob</var><code> [...] [--exclude=</code><var>exclude-glob</var><code>]]]</code></a>: <a href="#Network">Network</a></li>
<li><a href="#index-mtn-push-_005b_002d_002dset_002ddefault_005d-_005b_0040var_007buri_002dor_002daddress_007d_005d-_005b_0040var_007bglob_007d-_005b_002e_002e_002e_005d-_005b_002d_002dexclude_003d_0040var_007bexclude_002dglob_007d_005d_005d_005d-49"><code>mtn push [--set-default] [</code><var>uri-or-address</var><code>] [</code><var>glob</var><code> [...] [--exclude=</code><var>exclude-glob</var><code>]]]</code></a>: <a href="#Network">Network</a></li>
<li><a href="#index-mtn-rcs_005fimport-_0040var_007bfilename_002e_002e_002e_007d-185"><code>mtn rcs_import </code><var>filename...</var></a>: <a href="#RCS">RCS</a></li>
<li><a href="#index-mtn-read-124"><code>mtn read</code></a>: <a href="#Packet-I_002fO">Packet I/O</a></li>
<li><a href="#index-mtn-read-_0040var_007bfile1_007d-_0040var_007bfile2_002e_002e_002e_007d-125"><code>mtn read </code><var>file1</var> <var>file2...</var></a>: <a href="#Packet-I_002fO">Packet I/O</a></li>
<li><a href="#index-mtn-refresh_005finodeprints-44"><code>mtn refresh_inodeprints</code></a>: <a href="#Workspace">Workspace</a></li>
<li><a href="#index-mtn-revert-_002d_002dmissing-_0040var_007bpathname_002e_002e_002e_007d-39"><code>mtn revert --missing </code><var>pathname...</var></a>: <a href="#Workspace">Workspace</a></li>
<li><a href="#index-mtn-revert-_0040var_007bpathname_002e_002e_002e_007d-38"><code>mtn revert </code><var>pathname...</var></a>: <a href="#Workspace">Workspace</a></li>
<li><a href="#index-mtn-serve-_002d_002dstdio-_005b_002d_002dno_002dtransport_002dauth_005d-47"><code>mtn serve --stdio [--no-transport-auth]</code></a>: <a href="#Network">Network</a></li>
<li><a href="#index-mtn-serve-_005b_002d_002dbind_003d_005b_0040var_007baddress_007d_005d_005b_003a_0040var_007bport_007d_005d_005d-46"><code>mtn serve [--bind=[</code><var>address</var><code>][:</code><var>port</var><code>]]</code></a>: <a href="#Network">Network</a></li>
<li><a href="#index-mtn-set-_0040var_007bdomain_007d-_0040var_007bname_007d-_0040var_007bvalue_007d-126"><code>mtn set </code><var>domain</var> <var>name</var> <var>value</var></a>: <a href="#Database">Database</a></li>
<li><a href="#index-mtn-setup-_005b_0040var_007bdirectory_007d_005d-16"><code>mtn setup [</code><var>directory</var><code>]</code></a>: <a href="#Workspace">Workspace</a></li>
<li><a href="#index-mtn-show_005fconflicts-_0040var_007brev_007d-_0040var_007brev_007d-102"><code>mtn show_conflicts </code><var>rev</var> <var>rev</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-ssh_005fagent_005fadd-107"><code>mtn ssh_agent_add</code></a>: <a href="#Key-and-Cert-Trust">Key and Cert Trust</a></li>
<li><a href="#index-mtn-ssh_005fagent_005fexport-_0040var_007bfilename_007d-108"><code>mtn ssh_agent_export </code><var>filename</var></a>: <a href="#Key-and-Cert-Trust">Key and Cert Trust</a></li>
<li><a href="#index-mtn-status-51"><code>mtn status</code></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-status-_0040var_007bpathname_002e_002e_002e_007d-52"><code>mtn status </code><var>pathname...</var></a>: <a href="#Informative">Informative</a></li>
<li><a href="#index-mtn-suspend-_0040var_007bid_007d-114"><code>mtn suspend </code><var>id</var></a>: <a href="#Certificate">Certificate</a></li>
<li><a href="#index-mtn-sync-_005b_002d_002dset_002ddefault_005d-_005b_0040var_007buri_002dor_002daddress_007d_005d-_005b_0040var_007bglob_007d-_005b_002e_002e_002e_005d-_005b_002d_002dexclude_003d_0040var_007bexclude_002dglob_007d_005d_005d_005d-50"><code>mtn sync [--set-default] [</code><var>uri-or-address</var><code>] [</code><var>glob</var><code> [...] [--exclude=</code><var>exclude-glob</var><code>]]]</code></a>: <a href="#Network">Network</a></li>
<li><a href="#index-mtn-tag-_0040var_007bid_007d-_0040var_007btagname_007d-115"><code>mtn tag </code><var>id</var> <var>tagname</var></a>: <a href="#Certificate">Certificate</a></li>
<li><a href="#index-mtn-testresult-_0040var_007bid_007d-0-116"><code>mtn testresult </code><var>id</var><code> 0</code></a>: <a href="#Certificate">Certificate</a></li>
<li><a href="#index-mtn-testresult-_0040var_007bid_007d-1-117"><code>mtn testresult </code><var>id</var><code> 1</code></a>: <a href="#Certificate">Certificate</a></li>
<li><a href="#index-mtn-trusted-_0040var_007bid_007d-_0040var_007bcertname_007d-_0040var_007bcertval_007d-_0040var_007bsigners_007d-106"><code>mtn trusted </code><var>id</var> <var>certname</var> <var>certval</var> <var>signers</var></a>: <a href="#Key-and-Cert-Trust">Key and Cert Trust</a></li>
<li><a href="#index-mtn-unset-_0040var_007bdomain_007d-_0040var_007bname_007d-127"><code>mtn unset </code><var>domain</var> <var>name</var></a>: <a href="#Database">Database</a></li>
<li><a href="#index-mtn-update-40"><code>mtn update</code></a>: <a href="#Workspace">Workspace</a></li>
<li><a href="#index-mtn-update-_002d_002drevision_003d_0040var_007brevision_007d-41"><code>mtn update --revision=</code><var>revision</var></a>: <a href="#Workspace">Workspace</a></li>
<li><a href="#index-mtn_005fautomate_0028-_002e_002e_002e-_0029-232"><code>mtn_automate( ... )</code></a>: <a href="#Additional-Lua-Functions">Additional Lua Functions</a></li>
<li><a href="#index-note_005fcommit-_0028_0040var_007bnew_005fid_007d_002c-_0040var_007brevision_007d_002c-_0040var_007bcerts_007d_0029-187"><code>note_commit (</code><var>new_id</var><code>, </code><var>revision</var><code>, </code><var>certs</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-note_005fmtn_005fstartup-_0028_002e_002e_002e_0029-193"><code>note_mtn_startup (...)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-note_005fnetsync_005fcert_005freceived-_0028_0040var_007brev_005fid_007d_002c-_0040var_007bkey_007d_002c-_0040var_007bname_007d_002c-_0040var_007bvalue_007d_002c-_0040var_007bsession_005fid_007d_0029-190"><code>note_netsync_cert_received (</code><var>rev_id</var><code>, </code><var>key</var><code>, </code><var>name</var><code>, </code><var>value</var><code>, </code><var>session_id</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-note_005fnetsync_005fend-_0028_0040var_007bsession_005fid_007d_002c-_0040var_007bstatus_007d_002c-192"><code>note_netsync_end (</code><var>session_id</var><code>, </code><var>status</var><code>,</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-note_005fnetsync_005fpubkey_005freceived-_0028_0040var_007bkeyname_007d_002c-_0040var_007bsession_005fid_007d_0029-191"><code>note_netsync_pubkey_received (</code><var>keyname</var><code>, </code><var>session_id</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-note_005fnetsync_005frevision_005freceived-_0028_0040var_007bnew_005fid_007d_002c-_0040var_007brevision_007d_002c-_0040var_007bcerts_007d_002c-_0040var_007bsession_005fid_007d_0029-189"><code>note_netsync_revision_received (</code><var>new_id</var><code>, </code><var>revision</var><code>, </code><var>certs</var><code>, </code><var>session_id</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-note_005fnetsync_005fstart-_0028_0040var_007bsession_005fid_007d_002c-_0040var_007bmy_005frole_007d_002c-_0040var_007bsync_005ftype_007d_002c-188"><code>note_netsync_start (</code><var>session_id</var><code>, </code><var>my_role</var><code>, </code><var>sync_type</var><code>,</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-parse_005fbasic_005fio_0028_0040var_007bdata_007d_0029-233"><code>parse_basic_io(</code><var>data</var><code>)</code></a>: <a href="#Additional-Lua-Functions">Additional Lua Functions</a></li>
<li><a href="#index-persist_005fphrase_005fok-_0028_0029-199"><code>persist_phrase_ok ()</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-regex_002esearch_0028_0040var_007bregexp_007d_002c-_0040var_007bstring_007d_0029-234"><code>regex.search(</code><var>regexp</var><code>, </code><var>string</var><code>)</code></a>: <a href="#Additional-Lua-Functions">Additional Lua Functions</a></li>
<li><a href="#index-register_005fcommand_0028_0040var_007bname_007d_002c-_0040var_007bparams_007d_002c-_0040var_007babstract_007d_002c-_0040var_007bdescription_007d_002c-_0040var_007bfunction_007d_0029-235"><code>register_command(</code><var>name</var><code>, </code><var>params</var><code>, </code><var>abstract</var><code>, </code><var>description</var><code>, </code><var>function</var><code>)</code></a>: <a href="#Additional-Lua-Functions">Additional Lua Functions</a></li>
<li><a href="#index-server_005frequest_005fsync_0028_0040var_007bwhat_007d_002c-_0040var_007baddress_007d_002c-_0040var_007binclude_007d_002c-_0040var_007bexclude_007d_0029-236"><code>server_request_sync(</code><var>what</var><code>, </code><var>address</var><code>, </code><var>include</var><code>, </code><var>exclude</var><code>)</code></a>: <a href="#Additional-Lua-Functions">Additional Lua Functions</a></li>
<li><a href="#index-sleep_0028_0040var_007bseconds_007d_0029-237"><code>sleep(</code><var>seconds</var><code>)</code></a>: <a href="#Additional-Lua-Functions">Additional Lua Functions</a></li>
<li><a href="#index-spawn_0028_0040var_007bexecutable_007d-_005b_002c-_0040var_007bargs-_002e_002e_002e_007d_005d_0029-238"><code>spawn(</code><var>executable</var><code> [, </code><var>args ...</var><code>])</code></a>: <a href="#Additional-Lua-Functions">Additional Lua Functions</a></li>
<li><a href="#index-spawn_005fpipe_0028_0040var_007bexecutable_007d-_005b_002c-_0040var_007bargs-_002e_002e_002e_007d_005d_0029-239"><code>spawn_pipe(</code><var>executable</var><code> [, </code><var>args ...</var><code>])</code></a>: <a href="#Additional-Lua-Functions">Additional Lua Functions</a></li>
<li><a href="#index-spawn_005fredirected_0028_0040var_007binfile_007d_002c-_0040var_007boutfile_007d_002c-_0040var_007berrfile_007d_002c-_0040var_007bexecutable_007d-_005b_002c-_0040var_007bargs-_002e_002e_002e_007d_005d_0029-240"><code>spawn_redirected(</code><var>infile</var><code>, </code><var>outfile</var><code>, </code><var>errfile</var><code>, </code><var>executable</var><code> [, </code><var>args ...</var><code>])</code></a>: <a href="#Additional-Lua-Functions">Additional Lua Functions</a></li>
<li><a href="#index-use_005finodeprints-_0028_0029-200"><code>use_inodeprints ()</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-use_005ftransport_005fauth-_0028_0040var_007buri_007d_0029-206"><code>use_transport_auth (</code><var>uri</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-validate_005fcommit_005fmessage-_0028_0040var_007bmessage_007d_002c-_0040var_007brevision_005ftext_007d_002c-_0040var_007bbranchname_007d_0029-218"><code>validate_commit_message (</code><var>message</var><code>, </code><var>revision_text</var><code>, </code><var>branchname</var><code>)</code></a>: <a href="#Hooks">Hooks</a></li>
<li><a href="#index-wait_0028_0040var_007bpid_007d_0029-241"><code>wait(</code><var>pid</var><code>)</code></a>: <a href="#Additional-Lua-Functions">Additional Lua Functions</a></li>
   </ul><div class="footnote">
<hr>
<a name="texinfo-footnotes-in-document"></a><h4>Fotnoter</h4><p class="footnote"><small>[<a name="fn-1" href="#fnd-1">1</a>]</small> We
say <span class="sc">sha1</span> values are &ldquo;unique&rdquo; here, when in fact there is a
small probability of two different versions having the same <span class="sc">sha1</span>
value. This probability is very small, so we discount it.</p>

   <p class="footnote"><small>[<a name="fn-2" href="#fnd-2">2</a>]</small> Regardless of who originally
signed the certs, after the rebuild they will be signed by you.  This
means you should be somewhat careful when rebuilding, but it is
unavoidable &mdash; if you could sign with other people's keys, that would
be a rather serious security problem!</p>

   <hr></div>

</body></html>

